
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Mybatis · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">数据库</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    Mybaties与Redies简介.Assets
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="mybaties与Redies简介.html">
            
                <a href="mybaties与Redies简介.html">
            
                    
                    Mybaties与Redies简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    Mybatis.Assets
            
                </span>
            

            
        </li>
    
        <li class="chapter active" data-level="1.5" data-path="mybatis.html">
            
                <a href="mybatis.html">
            
                    
                    Mybatis
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" >
            
                <span>
            
                    
                    MybatisPlus.Assets
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="mybatisPlus.html">
            
                <a href="mybatisPlus.html">
            
                    
                    MybatisPlus
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" >
            
                <span>
            
                    
                    Mysql.Assets
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="mysql.html">
            
                <a href="mysql.html">
            
                    
                    Mysql
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" >
            
                <span>
            
                    
                    索引.Assets
            
                </span>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Mybatis</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="mybatis--&#x7684;&#x4F18;&#x7F3A;&#x70B9;">mybatis  &#x7684;&#x4F18;&#x7F3A;&#x70B9;</h2>
<p>MyBatis &#x907F;&#x514D;&#x4E86;&#x51E0;&#x4E4E;&#x6240;&#x6709;&#x7684; JDBC &#x4EE3;&#x7801;&#x548C;&#x624B;&#x52A8;&#x8BBE;&#x7F6E;&#x53C2;&#x6570;&#x4EE5;&#x53CA;&#x83B7;&#x53D6;&#x7ED3;&#x679C;&#x96C6;&#x3002;MyBatis &#x53EF;&#x4EE5;&#x5BF9;&#x914D;&#x7F6E;&#x548C;&#x539F;&#x751F;Map&#x4F7F;&#x7528;&#x7B80;&#x5355;&#x7684; XML &#x6216;&#x6CE8;&#x89E3;&#xFF08;&#x5B9E;&#x4F53;&#x548C;&#x6570;&#x636E;&#x5E93;&#x7684;&#x6620;&#x5C04;&#x53EF;&#x4EE5;&#x5728;XML&#x4E2D;&#x95F4;&#x4E2D;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x6CE8;&#x89E3;&#xFF09;&#xFF0C;&#x5C06;&#x63A5;&#x53E3;&#x548C; Java &#x7684; POJOs(Plain Old Java Objects,&#x666E;&#x901A;&#x7684; Java&#x5BF9;&#x8C61;)&#x6620;&#x5C04;&#x6210;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x7684;&#x8BB0;&#x5F55;&#x3002;</p>
<p><strong>&#x4E00;&#x3001;MyBatis&#x6846;&#x67B6;&#x7684;&#x4F18;&#x70B9;&#xFF1A;</strong></p>
<p>&#x3000;&#x3000;1. &#x4E0E;JDBC&#x76F8;&#x6BD4;&#xFF0C;&#x51CF;&#x5C11;&#x4E86;50%&#x4EE5;&#x4E0A;&#x7684;&#x4EE3;&#x7801;&#x91CF;&#x3002;&#xFF08;Mybatis&#x4E2D;Connection&#x7684;commit&#x7B49;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x4E5F;&#x662F;jdbc&#x5B9E;&#x73B0;&#x7684;&#xFF09;</p>
<p>&#x3000;&#x3000;2. MyBatis&#x8BED;&#x6CD5;&#x8F83;&#x4E3A;&#x7B80;&#x5355;&#xFF0C;&#x5C0F;&#x5DE7;&#x5E76;&#x4E14;&#x7B80;&#x5355;&#x6613;&#x5B66;&#x3002;</p>
<p>&#x3000;&#x3000;3. sql&#x5B9E;&#x73B0;&#x7075;&#x6D3B;&#xFF0C;SQL&#x5199;&#x5728;XML&#x91CC;&#xFF0C;&#x4ECE;&#x7A0B;&#x5E8F;&#x4EE3;&#x7801;&#x4E2D;&#x5F7B;&#x5E95;&#x5206;&#x79BB;&#xFF0C;&#x964D;&#x4F4E;&#x8026;&#x5408;&#x5EA6;&#xFF0C;&#x4FBF;&#x4E8E;&#x7EDF;&#x4E00;&#x7BA1;&#x7406;&#x548C;&#x4F18;&#x5316;&#xFF0C;&#x53EF;&#x91CD;&#x7528;&#x3002;</p>
<p>&#x3000;&#x3000;<strong>4. &#x63D0;&#x4F9B;XML&#x6807;&#x7B7E;&#xFF0C;&#x652F;&#x6301;&#x7F16;&#x5199;&#x52A8;&#x6001;SQL&#x8BED;&#x53E5;&#xFF08;XML&#x4E2D;&#x4F7F;&#x7528;if, else&#xFF09;&#x3002;</strong></p>
<p>&#x3000;&#x3000;5. &#x63D0;&#x4F9B;&#x6620;&#x5C04;&#x6807;&#x7B7E;&#xFF0C;&#x652F;&#x6301;&#x5BF9;&#x8C61;&#x4E0E;<a href="http://lib.csdn.net/base/mysql" target="_blank">&#x6570;&#x636E;&#x5E93;</a>&#x7684;ORM&#x5B57;&#x6BB5;&#x5173;&#x7CFB;&#x6620;&#x5C04;&#xFF08;&#x5728;XML&#x4E2D;&#x914D;&#x7F6E;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x6CE8;&#x89E3;&#xFF09;&#x3002;</p>
<p><strong>&#x4E8C;&#x3001;MyBatis&#x6846;&#x67B6;&#x7684;&#x7F3A;&#x70B9;&#xFF1A;</strong></p>
<p>&#x3000;&#x3000;<strong>1. SQL&#x8BED;&#x53E5;&#x7684;&#x7F16;&#x5199;&#x5DE5;&#x4F5C;&#x91CF;&#x8F83;&#x5927;&#xFF0C;&#x5C24;&#x5176;&#x662F;&#x5B57;&#x6BB5;&#x591A;&#x3001;&#x5173;&#x8054;&#x8868;&#x591A;&#x65F6;&#xFF0C;&#x66F4;&#x662F;&#x5982;&#x6B64;&#xFF0C;&#x5BF9;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x7F16;&#x5199;SQL&#x8BED;&#x53E5;&#x7684;&#x529F;&#x5E95;&#x6709;&#x4E00;&#x5B9A;&#x8981;&#x6C42;&#x3002;</strong></p>
<p>&#x3000;&#x3000;<strong>2. SQL&#x8BED;&#x53E5;&#x4F9D;&#x8D56;&#x4E8E;&#x6570;&#x636E;&#x5E93;&#xFF0C;&#x5BFC;&#x81F4;&#x6570;&#x636E;&#x5E93;&#x79FB;&#x690D;&#x6027;&#x5DEE;&#xFF0C;&#x4E0D;&#x80FD;&#x968F;&#x610F;&#x66F4;&#x6362;&#x6570;&#x636E;&#x5E93;&#x3002;</strong></p>
<h2 id="&#x5165;&#x95E8;&#x6848;&#x4F8B;">&#x5165;&#x95E8;&#x6848;&#x4F8B;</h2>
<p><img src="F:\Typora&#x6570;&#x636E;&#x50A8;&#x5B58;\&#x6570;&#x636E;&#x5E93;\mybatis.assets\image-20200718213831059.png" alt="image-20200718213831059"></p>
<ul>
<li>&#x5B9E;&#x4F53;&#x7C7B;&#x5C5E;&#x6027;&#x548C;&#x8868;&#x7684;&#x5217;&#x540D;&#x9700;&#x8981;&#x4FDD;&#x6301;&#x4E00;&#x81F4;&#x7684;&#x539F;&#x56E0;&#x662F;excutor&#x4E2D;&#x6267;&#x884C;&#x5B8C;sql&#x8BED;&#x53E5;&#x540E;&#x8FD4;&#x56DE;&#x7684;&#x5217;&#x540D;&#x9700;&#x8981;&#x548C;&#x4F60;&#x63A5;&#x6536;&#x7684;&#x5B9E;&#x4F53;&#x7C7B;&#x7684;&#x5C5E;&#x6027;&#x4E00;&#x81F4;&#x624D;&#x80FD;&#x6210;&#x529F;&#x7ED9;&#x5B9E;&#x4F53;&#x7C7B;&#x8D4B;&#x503C;&#x3002;</li>
</ul>
<blockquote>
<ul>
<li><strong>&#x7531;&#x4E8E;&#x5728; Windows &#x73AF;&#x5883;&#x4E0B; MySQL &#x4E0D;&#x533A;&#x5206;&#x5927;&#x5C0F;&#xFF0C;&#x6240;&#x4EE5; <code>userName</code> &#x7B49;&#x540C; <code>username</code> &#xFF0C;&#x4E0D;&#x8FC7;&#x8981;&#x6CE8;&#x610F;&#x5728; Linux &#x73AF;&#x5883;&#x4E0B; MySQL &#x4E25;&#x683C;&#x533A;&#x522B;&#x5927;&#x5C0F;&#x5199;&#x3002;</strong></li>
<li><p><strong>&#x4E3A;&#x4E86;&#x89E3;&#x51B3;&#x5B9E;&#x4F53;&#x7C7B;&#x5C5E;&#x6027;&#x540D;&#x4E0E;&#x6570;&#x636E;&#x5E93;&#x8868;&#x5217;&#x540D;&#x4E0D;&#x4E00;&#x81F4;&#xFF0C;&#x6709;&#x4EE5;&#x4E0B;&#x89E3;&#x51B3;&#x65B9;&#x6CD5;&#xFF1A;</strong></p>
</li>
<li><p><strong>&#x5728; SQL &#x8BED;&#x53E5;&#x4E2D;&#x4E3A;&#x6240;&#x6709;&#x5217;&#x8D77;&#x522B;&#x540D;&#xFF0C;&#x4F7F;&#x522B;&#x540D;&#x4E0E;&#x5B9E;&#x4F53;&#x7C7B;&#x5C5E;&#x6027;&#x540D;&#x4E00;&#x81F4;&#xFF08;&#x6267;&#x884C;&#x6548;&#x7387;&#x76F8;&#x5BF9;&#x9AD8;&#xFF0C;&#x5F00;&#x53D1;&#x6548;&#x7387;&#x4F4E;&#xFF09;</strong></p>
</li>
</ul>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;listAllUsers&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;cn.ykf.pojo.User&quot;</span>&gt;</span>
</code></pre>
<ol>
<li><strong>&#x4F7F;&#x7528; resultMap &#x5B8C;&#x6210;&#x7ED3;&#x679C;&#x96C6;&#x5230;&#x5B9E;&#x4F53;&#x7C7B;&#x7684;&#x6620;&#x5C04;&#xFF08;&#x6267;&#x884C;&#x6548;&#x7387;&#x76F8;&#x5BF9;&#x4F4E;&#xFF0C;&#x5F00;&#x53D1;&#x6548;&#x7387;&#x9AD8;&#xFF09;</strong><pre><code>&lt;mapper namespace=&quot;cn.ykf.mapper.UserMapper&quot;&gt;
 &lt;!-- &#x914D;&#x7F6E; resultMap &#xFF0C;&#x5B8C;&#x6210;&#x5B9E;&#x4F53;&#x7C7B;&#x4E0E;&#x6570;&#x636E;&#x5E93;&#x8868;&#x7684;&#x6620;&#x5C04; --&gt;
 &lt;resultMap id=&quot;userMap&quot; type=&quot;cn.ykf.pojo.User&quot;&gt;
     &lt;id property=&quot;userId&quot; column=&quot;id&quot; /&gt;
     &lt;result property=&quot;userName&quot; column=&quot;username&quot;/&gt;
     &lt;result property=&quot;userBirthday&quot; column=&quot;birthday&quot;/&gt;
     &lt;result property=&quot;userAddress&quot; column=&quot;address&quot;/&gt;
     &lt;result property=&quot;userSex&quot; column=&quot;sex&quot;/&gt;
 &lt;/resultMap&gt;
 &lt;!-- &#x914D;&#x7F6E;&#x67E5;&#x8BE2;&#x6240;&#x6709;&#x7528;&#x6237; --&gt;
 &lt;select id=&quot;listAllUsers&quot; resultMap=&quot;userMap&quot;&gt;
    SELECT * FROM user
 &lt;/select&gt;
&lt;/mapper&gt;
</code></pre></li>
</ol>
</blockquote>
<p><img src="F:\Typora&#x6570;&#x636E;&#x50A8;&#x5B58;\&#x6570;&#x636E;&#x5E93;\mybatis.assets\image-20200718222122318.png![image-20200719121634547](F:\Typora&#x6570;&#x636E;&#x50A8;&#x5B58;\&#x6570;&#x636E;&#x5E93;\mybatis.assets\image-20200719121634547.png" alt="image-20200718222122318"></p>
<h5 id="&#x6240;&#x7528;&#x6A21;&#x5F0F;">&#x6240;&#x7528;&#x6A21;&#x5F0F;</h5>
<p><img src="F:\Typora&#x6570;&#x636E;&#x50A8;&#x5B58;\&#x6570;&#x636E;&#x5E93;\mybatis.assets\image-20200719131042766.png" alt="image-20200719131042766"></p>
<p><strong>Mybatis &#x5728;&#x4F7F;&#x7528;&#x4EE3;&#x7406; Mapper &#x7684;&#x65B9;&#x5F0F;&#xFF08;session.getMapper(xxx.class)&#xFF09;&#x5B9E;&#x73B0;&#x589E;&#x5220;&#x67E5;&#x6539;&#x7684;&#x65F6;&#x5019;&#x53EA;&#x505A;&#x4E86;&#x4EE5;&#x4E0B;&#x4E24;&#x4EF6;&#x4E8B;&#xFF08;&#x5212;&#x91CD;&#x70B9;&#xFF09;</strong></p>
<ul>
<li>&#x521B;&#x5EFA;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;</li>
<li>&#x5728;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x4E2D;&#x8C03;&#x7528; selectList</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20200127102223857.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2ExMDkyODgyNTgw,size_16,color_FFFFFF,t_70#pic_center" alt="img" style="zoom:200%;"></p>
<h5 id="&#x81EA;&#x5B9A;&#x4E49;mybatis&#x6D41;&#x7A0B;">&#x81EA;&#x5B9A;&#x4E49;mybatis&#x6D41;&#x7A0B;</h5>
<ul>
<li><a href="https://blog.csdn.net/a1092882580/article/details/104086181" target="_blank">https://blog.csdn.net/a1092882580/article/details/104086181</a></li>
<li>day01_eesy_04mybatis</li>
</ul>
<p><img src="F:\Typora&#x6570;&#x636E;&#x50A8;&#x5B58;\&#x6570;&#x636E;&#x5E93;\mybatis.assets\image-20200720083531672.png" alt="image-20200720083531672"></p>
<p><img src="F:\Typora&#x6570;&#x636E;&#x50A8;&#x5B58;\&#x6570;&#x636E;&#x5E93;\mybatis.assets\image-20200720083645169.png" alt="image-20200720083645169"></p>
<ul>
<li><p><strong>sqlsessionfactoryBuilder&#x7684;&#x4F5C;&#x7528;&#x662F;&#x5C06;xml&#x7684;&#x89E3;&#x6790;&#x90E8;&#x5206;&#x4E0E;factory&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#x62FF;&#x51FA;&#x6765;&#xFF0C;&#x4FBF;&#x4E8E;xml&#x89E3;&#x6790;&#x5668;&#x7EF4;&#x62A4;&#x548C;&#x4F7F;&#x5F97;factory&#x522B;&#x592A;&#x81C3;&#x80BF;</strong></p>
</li>
<li><p>&#x7F16;&#x5199;&#x8BFB;&#x53D6;&#x914D;&#x7F6E;&#x6587;&#x4EF6;Resource&#x7C7B;&#xFF0C;&#x83B7;&#x5F97;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x5B57;&#x8282;&#x6D41;&#xFF08;XMLConfigBuilder&#x5F62;&#x53C2;&#xFF09;</p>
</li>
<li>&#x7F16;&#x5199;SqlsessionFactoryBuilder&#x7C7B;</li>
<li>&#x51C6;&#x5907;&#x5DE5;&#x5177;&#x7C7B;XMLConfigBuilder,&#x7528;&#x4E8E;&#x89E3;&#x6790;XML&#x6587;&#x4EF6;&#xFF08;SqlsessionfactoryBuilder&#x4F7F;&#x7528;&#xFF09;</li>
<li>&#x51C6;&#x5907;&#x81EA;&#x5B9A;&#x4E49;&#x6CE8;&#x89E3;&#x63A5;&#x53E3;&#x3001;&#x914D;&#x7F6E;&#x7C7B;Configuration&#x3001;&#x5C01;&#x88C5;Sql&#x8BED;&#x53E5;&#x548C;&#x7ED3;&#x679C;&#x7C7B;&#x578B;&#x7684;Mapper&#x7C7B;&#xFF08;XMLConfigBuilder&#x4FDD;&#x5B58;&#x89E3;&#x6790;&#x4FE1;&#x606F;&#xFF09;</li>
<li>&#x7F16;&#x5199;SqlsessionFactory&#x63A5;&#x53E3;&#x3001;&#x5B9E;&#x73B0;SqlsessionFacatory&#xFF08;SqlsessionFactoryBuilder&#x751F;&#x6210;&#x5BF9;&#x8C61;&#xFF09;</li>
<li>&#x7F16;&#x5199;Sqlsession&#x63A5;&#x53E3;&#xFF0C;&#x5B9E;&#x73B0;Sqlsession&#xFF08;SqlsessionFactory&#x751F;&#x6210;&#x5BF9;&#x8C61;&#xFF09;</li>
<li>&#x7F16;&#x5199;&#x94FE;&#x63A5;&#x6570;&#x636E;&#x5E93;&#x7684;&#x5DE5;&#x5177;&#x7C7B;DataSourceUtil&#xFF0C;&#x7F16;&#x5199;&#x4EE3;&#x7406;&#x7C7B;MapperProxy(Implements InvocationHandler&#xFF0C;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x8C03;&#x7528;Executor&#x7684;selectList&#x65B9;&#x6CD5;)&#xFF08;sqlSession&#x7C7B;&#x4F7F;&#x7528;&#xFF09;</li>
<li>&#x7F16;&#x5199;Exector&#x7C7B;&#xFF0C;&#x7528;&#x4E8E;&#x6267;&#x884C;jdbc&#x64CD;&#x4F5C;&#xFF08;MapperProxy&#x4F7F;&#x7528;&#xFF09;</li>
</ul>
<h2 id="curd">CURD</h2>
<ul>
<li><p>&#x83B7;&#x53D6;&#x53C2;&#x6570;&#x65F6;</p>
</li>
<li><p>parameterType = &quot;&#x4E0E;&#x8868;&#x5BF9;&#x5E94;&#x7684;&#x5B9E;&#x4F53;&#x7C7B;&quot;</p>
</li>
<li><h1 id="&#x5B9E;&#x4F53;&#x7C7B;&#x5C5E;&#x6027;&#xFF1A;-&#x8BFB;&#x53D6;&#x5B9E;&#x4F53;&#x7C7B;&#x7684;&#x5C5E;&#x6027;">{&#x5B9E;&#x4F53;&#x7C7B;&#x5C5E;&#x6027;}&#xFF1A; &#x8BFB;&#x53D6;&#x5B9E;&#x4F53;&#x7C7B;&#x7684;&#x5C5E;&#x6027;</h1>
</li>
</ul>
<h4 id="&#x6A21;&#x7CCA;&#x67E5;&#x8BE2;">&#x6A21;&#x7CCA;&#x67E5;&#x8BE2;</h4>
<ul>
<li><h1 id="&#x9700;&#x8981;&#x5728;&#x6D4B;&#x8BD5;&#x7C7B;&#x4E2D;&#x81EA;&#x5DF1;&#x5BB6;&#x7B49;&#x901A;&#x914D;&#x7B26;&#xFF0C;&#x50CF;preparedstatement-&#xFF0C;&#x53EF;&#x4EE5;&#x6709;&#x6548;&#x9632;&#x6B62;sql&#x6CE8;&#x5165;&#xFF0C;&#x5219;&#x53EF;&#x80FD;&#x5BFC;&#x81F4;sql&#x6CE8;&#x5165;&#x6210;&#x529F;&#x3002;">{} &#x9700;&#x8981;&#x5728;&#x6D4B;&#x8BD5;&#x7C7B;&#x4E2D;&#x81EA;&#x5DF1;&#x5BB6;%&#x7B49;&#x901A;&#x914D;&#x7B26;&#xFF0C;<strong>&#x50CF;PreparedStatement &#xFF0C;#{}&#x53EF;&#x4EE5;&#x6709;&#x6548;&#x9632;&#x6B62;sql&#x6CE8;&#x5165;&#xFF0C;${}&#x5219;&#x53EF;&#x80FD;&#x5BFC;&#x81F4;sql&#x6CE8;&#x5165;&#x6210;&#x529F;&#x3002;</strong></h1>
<pre><code>public void testListUsersByName() {
List&lt;User&gt; users = mapper.listUsersByName(&quot;%&#x738B;%&quot;);
// &#x4F7F;&#x7528; Stream &#x6D41; + &#x65B9;&#x6CD5;&#x5F15;&#x7528;&#xFF0C;&#x9700;&#x8981;&#x81F3;&#x5C11;jdk8
users.forEach(System.out::println);
}
&#x7531;&#x4E8E;&#x6620;&#x5C04;&#x6587;&#x4EF6;&#x4E2D;&#x7684; SQL &#x8BED;&#x53E5;&#x5E76;&#x6CA1;&#x6709;&#x5BF9;&#x53C2;&#x6570;&#x8FDB;&#x884C;&#x6A21;&#x7CCA;&#x67E5;&#x8BE2;&#x5904;&#x7406;&#xFF0C;&#x6240;&#x4EE5;&#x5728;&#x8C03;&#x7528;&#x65B9;&#x6CD5;&#x7684;&#x65F6;&#x5019;&#x6211;&#x4EEC;&#x5FC5;&#x987B;&#x624B;&#x52A8;&#x4E3A;&#x67E5;&#x8BE2;&#x7684;&#x5173;&#x952E;&#x5B57;&#x8FDB;&#x884C;%&#x62FC;&#x63A5;&#xFF0C;&#x8FD9;&#x6837;&#x5F88;&#x4E0D;&#x65B9;&#x4FBF;&#x3002;&#x5982;&#x679C;&#x60F3;&#x8C03;&#x7528;&#x65B9;&#x6CD5;&#x67E5;&#x8BE2;&#x65F6;&#xFF0C;&#x53EA;&#x4F20;&#x5165;&#x67E5;&#x8BE2;&#x7684;&#x5173;&#x952E;&#x5B57;&#xFF0C;&#x90A3;&#x4E48;&#x53EF;&#x4EE5;&#x91C7;&#x7528;&#x4EE5;&#x4E0B;&#x65B9;&#x6CD5; &#xFF1A;
SELECT * FROM user WHERE username LIKE concat(&apos;%&apos;,#{name},&apos;%&apos;);
SELECT * FROM user WHERE username LIKE &quot;%&quot;#{name}&quot;%&quot;&#xFF1B;
</code></pre></li>
</ul>
<p><img src="F:\Typora&#x6570;&#x636E;&#x50A8;&#x5B58;\&#x6570;&#x636E;&#x5E93;\mybatis.assets\image-20200720154032187.png" alt="image-20200720154032187"></p>
<h4 id="parametertype">parameterType</h4>
<ul>
<li><p>&#x7B80;&#x5355;&#x5BF9;&#x8C61;</p>
</li>
<li><p>&#x4F20;&#x9012;pojo&#x5BF9;&#x8C61;</p>
<p>&#x9996;&#x5148;&#x4ECB;&#x7ECD;&#x4E00;&#x4E0B; OGNL &#x8868;&#x8FBE;&#x5F0F;
&#x5168;&#x79F0; Object Graphic Navigation Language &#xFF0C;&#x5373;&#x5BF9;&#x8C61;&#x56FE;&#x5BFC;&#x822A;&#x8BED;&#x8A00;</p>
<p>&#x5B83;&#x662F;&#x901A;&#x8FC7;&#x5BF9;&#x8C61;&#x7684;&#x53D6;&#x503C;&#x65B9;&#x6CD5;&#x6765;&#x83B7;&#x53D6;&#x6570;&#x636E;&#x3002;&#x5728;&#x5199;&#x6CD5;&#x4E0A;&#x628A;get&#x7ED9;&#x7701;&#x7565;&#x4E86;&#x3002;</p>
</li>
<li><p>&#x4F20;&#x9012;pojo&#x5305;&#x88C5;&#x5BF9;&#x8C61;
&#x5728;&#x5F00;&#x53D1;&#x4E2D;&#x5982;&#x679C;&#x60F3;&#x5B9E;&#x73B0;&#x590D;&#x6742;&#x67E5;&#x8BE2; &#xFF0C;&#x67E5;&#x8BE2;&#x6761;&#x4EF6;&#x4E0D;&#x4EC5;&#x5305;&#x62EC;&#x7528;&#x6237;&#x67E5;&#x8BE2;&#x6761;&#x4EF6;&#xFF0C;&#x8FD8;&#x5305;&#x62EC;&#x5176;&#x5B83;&#x7684;&#x67E5;&#x8BE2;&#x6761;&#x4EF6;&#xFF08;&#x6BD4;&#x5982;&#x5C06;&#x7528;&#x6237;&#x8D2D;&#x4E70;&#x5546;&#x54C1;&#x4FE1;&#x606F;&#x4E5F;&#x4F5C;&#x4E3A;&#x67E5;&#x8BE2;&#x6761;&#x4EF6;&#xFF09;&#xFF0C;&#x8FD9;&#x65F6;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; pojo &#x5305;&#x88C5;&#x5BF9;&#x8C61;&#x4F20;&#x9012;&#x8F93;&#x5165;&#x53C2;&#x6570;&#xFF0C;&#x5373;&#x5C06;&#x591A;&#x4E2A;&#x9700;&#x8981;&#x64CD;&#x4F5C;&#x7684;&#x7C7B;&#x653E;&#x5230;&#x4E00;&#x4E2A;&#x603B;&#x4F53;&#x7C7B;&#x4E2D;</p>
</li>
</ul>
<h4 id="&#x5B9E;&#x4F53;&#x7C7B;&#x5C5E;&#x6027;&#x540D;&#x4E0E;&#x6570;&#x636E;&#x5E93;&#x8868;&#x5217;&#x540D;&#x4E0D;&#x4E00;&#x81F4;"><strong>&#x5B9E;&#x4F53;&#x7C7B;&#x5C5E;&#x6027;&#x540D;&#x4E0E;&#x6570;&#x636E;&#x5E93;&#x8868;&#x5217;&#x540D;&#x4E0D;&#x4E00;&#x81F4;</strong></h4>
<p><strong>&#x5728;&#x67D0;&#x4E9B;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5B9E;&#x4F53;&#x7C7B;&#x7684;&#x5C5E;&#x6027;&#x548C;&#x6570;&#x636E;&#x5E93;&#x8868;&#x7684;&#x5217;&#x540D;&#x5E76;&#x4E0D;&#x4E00;&#x81F4;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x4F1A;&#x51FA;&#x73B0;&#x67E5;&#x8BE2;&#x7ED3;&#x679C;&#x65E0;&#x6CD5;&#x5C01;&#x88C5;&#x8FDB;&#x5B9E;&#x4F53;&#x7C7B;&#x3002;&#x56E0;&#x4E3A;select&#x7684;&#x8FD4;&#x56DE;&#x7684;&#x6570;&#x636E;&#x662F;&#x4F9D;&#x636E;&#x5217;&#x540D;&#x4E0E;&#x5B9E;&#x4F53;&#x7C7B;&#x5C5E;&#x6027;&#x7684;&#x5BF9;&#x5E94;&#x5173;&#x7CFB;&#x8FDB;&#x884C;&#x8D4B;&#x503C;&#x7684;&#xFF0C;&#x5931;&#x8D25;&#x4FBF;&#x4E3A;&#x7A7A;&#xFF0C;&#x4FEE;&#x6539;&#x5B9E;&#x4F53;&#x7C7B;&#x8FDB;&#x884C;&#x6F14;&#x793A;</strong></p>
<p><img src="F:\Typora&#x6570;&#x636E;&#x50A8;&#x5B58;\&#x6570;&#x636E;&#x5E93;\mybatis.assets\image-20200720223047768.png" alt="image-20200720223047768"></p>
<ol>
<li><strong>&#x5728; SQL &#x8BED;&#x53E5;&#x4E2D;&#x4E3A;&#x6240;&#x6709;&#x5217;&#x8D77;&#x522B;&#x540D;&#xFF0C;&#x4F7F;&#x522B;&#x540D;&#x4E0E;&#x5B9E;&#x4F53;&#x7C7B;&#x5C5E;&#x6027;&#x540D;&#x4E00;&#x81F4;&#xFF08;&#x6267;&#x884C;&#x6548;&#x7387;&#x76F8;&#x5BF9;&#x9AD8;&#xFF0C;&#x5F00;&#x53D1;&#x6548;&#x7387;&#x4F4E;&#xFF09;</strong></li>
</ol>
<pre><code>&lt;select id=&quot;listAllUsers&quot; resultType=&quot;cn.ykf.pojo.User&quot;&gt;
    SELECT id AS userId, username AS userName, birthday AS userBirthday, sex AS userSex, address AS userAddress FROM user
&lt;/select&gt;
</code></pre><ol>
<li><strong>&#x4F7F;&#x7528; resultMap &#x5B8C;&#x6210;&#x7ED3;&#x679C;&#x96C6;&#x5230;&#x5B9E;&#x4F53;&#x7C7B;&#x7684;&#x6620;&#x5C04;&#xFF08;&#x6267;&#x884C;&#x6548;&#x7387;&#x76F8;&#x5BF9;&#x4F4E;&#xFF0C;&#x5F00;&#x53D1;&#x6548;&#x7387;&#x9AD8;&#xFF09;</strong></li>
</ol>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;cn.ykf.mapper.UserMapper&quot;</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- &#x914D;&#x7F6E; resultMap &#xFF0C;&#x5B8C;&#x6210;&#x5B9E;&#x4F53;&#x7C7B;&#x4E0E;&#x6570;&#x636E;&#x5E93;&#x8868;&#x7684;&#x6620;&#x5C04; --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;userMap&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;cn.ykf.pojo.User&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;userId&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;id&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;userName&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;username&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;userBirthday&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;birthday&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;userAddress&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;address&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;userSex&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;sex&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- &#x914D;&#x7F6E;&#x67E5;&#x8BE2;&#x6240;&#x6709;&#x7528;&#x6237; --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;listAllUsers&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;userMap&quot;</span>&gt;</span>
       SELECT * FROM user
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span>
</code></pre>
<h4 id="&#x4F7F;&#x7528;dao&#x5B9E;&#x73B0;&#x7C7B;&#xFF08;&#x5212;&#x91CD;&#x70B9;-&#x5BF9;&#x6BD4;&#x6E90;&#x7801;&#xFF09;">&#x4F7F;&#x7528;Dao&#x5B9E;&#x73B0;&#x7C7B;&#xFF08;&#x5212;&#x91CD;&#x70B9;-&gt;&#x5BF9;&#x6BD4;&#x6E90;&#x7801;&#xFF09;</h4>
<ul>
<li><strong>&#x82E5;&#x4F7F;&#x7528;sqlsession&#xFF08;defaultSqlSession&#xFF09;&#x7684;selectList&#x7B49;&#x65B9;&#x6CD5;&#xFF0C;&#x5C31;&#x662F;&#x5BF9;&#x4F20;&#x5165;&#x7684;&#x5355;&#x4E2A;&#x65B9;&#x6CD5;&#xFF08;&#x201C;statement&#x201D;&#xFF0C;arg&#xFF09;&#x8FDB;&#x884C;&#x76F8;&#x5E94;executor(CachingExecutor-&gt;SimpleExecutor(extends BaseExecutor))&#x64CD;&#x4F5C;</strong></li>
<li><strong>&#x63A5;&#x7740;&#x8FDB;&#x5165;&#x6267;&#x884C;SQL&#x8BED;&#x53E5;&#x5904;&#x7406;&#xFF08;MyBatis&#x5728;&#x7B2C;&#x4E00;&#x6B21;&#x6267;&#x884C;SQL&#x64CD;&#x4F5C;&#x65F6;&#xFF0C;&#x5728;&#x83B7;&#x53D6;Statement&#x65F6;&#xFF0C;&#x4F1A;&#x53BB;&#x83B7;&#x53D6;&#x6570;&#x636E;&#x5E93;&#x94FE;&#x63A5;&#xFF0C;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x914D;&#x7F6E;&#x7684;&#x6570;&#x636E;&#x6E90;&#x4E3A;POOLED&#xFF0C;&#x8FD9;&#x91CC;&#x4F1A;&#x4F7F;&#x7528;PooledDataSource&#x6765;&#x83B7;&#x53D6;connection&#xFF09;&#xFF0C;statementHandler&#xFF08;RoutingStatementHandler-&gt;PreparedStatementHandler(extends BaseStatementHandler)&#xFF09;</strong></li>
<li><strong>&#x63A5;&#x7740;&#x5C01;&#x88C5;&#x5904;&#x7406;ResultSetHandler&#xFF08;DefaultResultSetHandler&#xFF09;&#xFF0C;&#x63A5;&#x7740;&#x8C03;&#x7528;excute&#x65B9;&#x6CD5;&#x8FDB;&#x884C;JDBC&#x7684;&#x64CD;&#x4F5C;&#x5E76;&#x8FDB;&#x884C;&#x5C01;&#x88C5;&#xFF0C;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x96C6;&#x3002;</strong></li>
</ul>
<h4 id="&#x4F7F;&#x7528;dao&#x4EE3;&#x7406;&#x7C7B;&#xFF08;&#x5212;&#x91CD;&#x70B9;-&#x5BF9;&#x6BD4;&#x6E90;&#x7801;&#x3001;&#x81EA;&#x5B9A;&#x4E49;mybatis&#xFF09;">&#x4F7F;&#x7528;Dao&#x4EE3;&#x7406;&#x7C7B;&#xFF08;&#x5212;&#x91CD;&#x70B9;-&gt;&#x5BF9;&#x6BD4;&#x6E90;&#x7801;&#x3001;&#x81EA;&#x5B9A;&#x4E49;mybatis&#xFF09;</h4>
<ul>
<li><strong>&#x82E5;&#x662F;&#x7528;getmapper&#x5219;&#x662F;&#x4F1A;&#x5728;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x8C03;&#x7528;&#x65B9;&#x6CD5;&#x65F6;&#x8C03;&#x7528;&#x52A8;&#x6001;&#x4EE3;&#x7406;&#x7684;proxyhadler&#x5BF9;&#x50CF;&#x4E2D;&#x7684;invoke&#x65B9;&#x6CD5;&#x8FDB;&#x884C;&#x589E;&#x5F3A;&#xFF0C;&#x589E;&#x5F3A;&#x65F6;&#x5BF9;&#x8C03;&#x7528;&#x7684;&#x65B9;&#x6CD5;&#x8FDB;&#x884C;switch case &#x9009;&#x62E9;&#xFF0C;&#x7EE7;&#x800C;&#x8C03;&#x7528;sqlsession&#x7684;&#x76F8;&#x5E94;CRUD&#x65B9;&#x6CD5;&#xFF08;&#x5373;&#x4E0A;&#x9762;&#x7684;&#x6D41;&#x7A0B;&#xFF09;&#xFF0C;&#x8FD4;&#x56DE;&#x4E86;&#x4E00;&#x4E2A;&#x6574;&#x4E2A;&#x589E;&#x5F3A;&#x7684;&#x4EE3;&#x7406;&#x7C7B;&#x5B9E;&#x4F8B;&#xFF0C;&#x518D;&#x8C03;&#x7528;&#x5B9E;&#x4F8B;&#x65B9;&#x6CD5;&#x65F6;&#x589E;&#x5F3A;&#x8FD4;&#x56DE;&#x589E;&#x5F3A;&#x540E;&#x7684;&#x7ED3;&#x679C;&#x96C6;&#x3002;</strong></li>
</ul>
<h4 id="propeties">propeties</h4>
<ul>
<li><p>&#x5168;&#x5C40;&#x53D8;&#x91CF;</p>
<p>&#x7B2C;&#x4E00;&#x79CD;&#xFF0C;&#x91C7;&#x7528;&#x5168;&#x5C40;&#x7684;&#x5185;&#x90E8;&#x914D;&#x7F6E;&#x3002;&#x91C7;&#x7528;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x7684;&#x8BDD;&#xFF0C;&#x5982;&#x679C;&#x9700;&#x8981;&#x914D;&#x7F6E;&#x591A;&#x4E2A;&#x6570;&#x636E;&#x5E93;&#x73AF;&#x5883;&#xFF0C;&#x90A3;&#x4E48;&#x50CF; username&#x3001;password &#x7B49;&#x5C5E;&#x6027;&#x5C31;&#x53EF;&#x4EE5;&#x590D;&#x7528;&#xFF0C;&#x63D0;&#x9AD8;&#x5F00;&#x53D1;&#x6548;&#x7387;&#x3002;</p>
<p>```xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</p>
<p>&lt;!DOCTYPE configuration</p>
<pre><code>    PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;
    &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;
</code></pre><p><configuration></configuration></p>
<pre><code>&lt;!-- &#x5168;&#x5C40;&#x53D8;&#x91CF; --&gt;
&lt;properties&gt;
    &lt;property name=&quot;driver&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;
    &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://localhost:3306/db_mybatis&quot;/&gt;
    &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt;
    &lt;property name=&quot;password&quot; value=&quot;123456&quot;/&gt;
&lt;/properties&gt;
</code></pre></li>
</ul>
<pre><code>  &lt;!--&#x914D;&#x7F6E;&#x73AF;&#x5883;--&gt;
  &lt;environments default=&quot;development&quot;&gt;
      &lt;environment id=&quot;development&quot;&gt;
          &lt;!-- &#x914D;&#x7F6E;&#x4E8B;&#x52A1;&#x7C7B;&#x578B; --&gt;
          &lt;transactionManager type=&quot;JDBC&quot;/&gt;
          &lt;!-- &#x914D;&#x7F6E;&#x6570;&#x636E;&#x6E90;&#xFF08;&#x8FDE;&#x63A5;&#x6C60;&#xFF09; --&gt;
          &lt;dataSource type=&quot;POOLED&quot;&gt;
              &lt;property name=&quot;driver&quot; value=&quot;${driver}&quot;/&gt;
              &lt;property name=&quot;url&quot; value=&quot;${url}&quot;/&gt;
              &lt;property name=&quot;username&quot; value=&quot;${username}&quot;/&gt;
              &lt;property name=&quot;password&quot; value=&quot;${password}&quot;/&gt;
          &lt;/dataSource&gt;
      &lt;/environment&gt;
  &lt;/environments&gt;

  &lt;!-- &#x6307;&#x5B9A;&#x6620;&#x5C04;&#x6587;&#x4EF6; --&gt;
  &lt;mappers&gt;
      &lt;mapper resource=&quot;UserMapper.xml&quot;/&gt;
  &lt;/mappers&gt;
</code></pre><p>  &lt;/configuration&gt;</p>
<pre><code>


* resource&#xFF1A;

![image-20200720212414351](F:\Typora&#x6570;&#x636E;&#x50A8;&#x5B58;\&#x6570;&#x636E;&#x5E93;\mybatis.assets\image-20200720212414351.png)

* url

![image-20200720212823840](F:\Typora&#x6570;&#x636E;&#x50A8;&#x5B58;\&#x6570;&#x636E;&#x5E93;\mybatis.assets\image-20200720212823840.png)

#### typeAliases &#x6807;&#x7B7E;

&#x4E4B;&#x524D;&#x5728;&#x7F16;&#x5199;&#x6620;&#x5C04;&#x6587;&#x4EF6;&#x7684;&#x65F6;&#x5019;&#xFF0C; resultType &#x8FD9;&#x4E2A;&#x5C5E;&#x6027;&#x53EF;&#x4EE5;&#x5199; int&#x3001;INT &#x7B49;&#xFF0C;&#x5C31;&#x662F;&#x56E0;&#x4E3A; Mybatis &#x7ED9;&#x8FD9;&#x4E9B;&#x7C7B;&#x578B;&#x8D77;&#x4E86;&#x522B;&#x540D;&#x3002;Mybatis &#x5185;&#x7F6E;&#x7684;&#x522B;&#x540D;&#x5982;&#x8868;&#x683C;&#x6240;&#x793A;&#xFF1A;
&lt;img src=&quot;F:\Typora&#x6570;&#x636E;&#x50A8;&#x5B58;\&#x6570;&#x636E;&#x5E93;\mybatis.assets\image-20200720223623594.png&quot; alt=&quot;image-20200720223623594&quot;  /&gt;
&#x5982;&#x679C;&#x6211;&#x4EEC;&#x4E5F;&#x60F3;&#x7ED9;&#x67D0;&#x4E2A;&#x5B9E;&#x4F53;&#x7C7B;&#x6307;&#x5B9A;&#x522B;&#x540D;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x91C7;&#x7528; typeAliases &#x6807;&#x7B7E;&#x3002;&#x7528;&#x6CD5;&#x5982;&#x4E0B;&#xFF1A;
</code></pre><configuration>
    <!--配置别名-->
    <typealiases>
        <typealias type="cn.ykf.pojo.User" alias="user">
    </typealias></typealiases>
    <!-- 其他配置省略... -->
</configuration>
```

typeAlias &#x5B50;&#x6807;&#x7B7E;&#x7528;&#x4E8E;&#x914D;&#x7F6E;&#x522B;&#x540D;&#x3002;&#x5176;&#x4E2D; type &#x5C5E;&#x6027;&#x7528;&#x4E8E;&#x6307;&#x5B9A;&#x8981;&#x914D;&#x7F6E;&#x7684;&#x7C7B;&#x7684;&#x5168;&#x9650;&#x5B9A;&#x7C7B;&#x540D;&#xFF08;&#x8BE5;&#x7C7B;&#x53EA;&#x80FD;&#x662F;&#x67D0;&#x4E2A;domain&#x5B9E;&#x4F53;&#x7C7B;&#xFF09;, alias &#x5C5E;&#x6027;&#x6307;&#x5B9A;&#x522B;&#x540D;&#x3002;&#x4E00;&#x65E6;&#x6307;&#x5B9A;&#x4E86;&#x522B;&#x540D;&#xFF0C;&#x90A3;&#x4E48;&#x522B;&#x540D;&#x5C31;&#x4E0D;&#x518D;&#x533A;&#x5206;&#x5927;&#x5C0F;&#x5199;&#x3002;
&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x6B64;&#x65F6;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728;&#x6620;&#x5C04;&#x6587;&#x4EF6;&#x4E2D;&#x8FD9;&#x6837;&#x5199; resultType=&quot;user&quot; &#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x5199; resultType=&quot;USER&quot;&#x3002;
&#x5F53;&#x6211;&#x4EEC;&#x6709;&#x591A;&#x4E2A;&#x5B9E;&#x4F53;&#x7C7B;&#x9700;&#x8981;&#x8D77;&#x522B;&#x540D;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; package &#x6807;&#x7B7E;&#x3002;


&#x5F53;&#x6211;&#x4EEC;&#x6709;&#x591A;&#x4E2A;&#x5B9E;&#x4F53;&#x7C7B;&#x9700;&#x8981;&#x8D77;&#x522B;&#x540D;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; package &#x6807;&#x7B7E;&#x3002;

```
<typealiases><!--在configuration中使用-->
    <!-- 包下所有实体类起别名 -->
    <package name="cn.ykf.pojo">
</package></typealiases>
```

package &#x6807;&#x7B7E;&#x6307;&#x5B9A;&#x8981;&#x914D;&#x7F6E;&#x522B;&#x540D;&#x7684;&#x5305;&#xFF0C;&#x5F53;&#x6307;&#x5B9A;&#x4E4B;&#x540E;&#xFF0C;&#x8BE5;&#x5305;&#x4E0B;&#x7684;**&#x6240;&#x6709;&#x5B9E;&#x4F53;&#x7C7B;&#x90FD;&#x4F1A;&#x6CE8;&#x518C;&#x522B;&#x540D;**&#xFF0C;&#x5E76;&#x4E14;**&#x7C7B;&#x540D;&#x5C31;&#x662F;&#x522B;&#x540D;**&#xFF0C;&#x4E0D;&#x518D;&#x533A;&#x5206;&#x5927;&#x5C0F;&#x5199;
package &#x6807;&#x7B7E;&#x8FD8;&#x53EF;&#x4EE5;&#x5C06;**&#x67D0;&#x4E2A;&#x5305;&#x5185;&#x7684;&#x6620;&#x5C04;&#x5668;&#x63A5;&#x53E3;&#x5B9E;&#x73B0;&#x5168;&#x90E8;&#x6CE8;&#x518C;&#x4E3A;&#x6620;&#x5C04;&#x5668;**&#xFF0C;&#x5982;&#x4E0B;&#x6240;&#x793A;

```
<!-- 指定映射文件 -->
<mappers>
    <package name="cn.ykf.mapper">
</package></mappers>
```

&#x8FD9;&#x6837;&#x914D;&#x7F6E;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x65E0;&#x9700;&#x4E00;&#x4E2A;&#x4E00;&#x4E2A;&#x5730;&#x914D;&#x7F6E; Mapper &#x63A5;&#x53E3;&#x4E86;&#x3002;&#x4E0D;&#x8FC7;&#xFF0C;**&#x8FD9;&#x79CD;&#x914D;&#x7F6E;&#x65B9;&#x5F0F;&#x7684;&#x524D;&#x63D0;&#x662F;&#x6620;&#x5C04;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4F4D;&#x7F6E;&#x5FC5;&#x987B;&#x548C;dao&#x63A5;&#x53E3;&#x7684;&#x5305;&#x7ED3;&#x6784;&#x76F8;&#x540C;**

&gt; * mapper&#x7684;recourse&#x52A0;&#x8F7D;&#xFF0C;&#x626B;&#x63CF;&#x6620;&#x5C04;&#x6587;&#x4EF6;&#x6765;&#x67E5;&#x627E;&#x63A5;&#x53E3;&#x7C7B;&#xFF0C;&#x6620;&#x5C04;&#x6587;&#x4EF6;&#x547D;&#x540D;&#x4E3A;**&#x63A5;&#x53E3;&#x5168;&#x7C7B;&#x540D;**&#xFF08;&#x63A5;&#x53E3;&#x7C7B;&#x540D;&#x53EF;&#x4EE5;&#x548C;&#x6620;&#x5C04;&#x6587;&#x4EF6;&#x540D;&#x4E0D;&#x540C;&#xFF0C;&#x56E0;&#x4E3A;&#x6620;&#x5C04;&#x6587;&#x4EF6;&#x6709;namespace&#xFF09;&#xFF0C;&#x4F46;&#x53EF;&#x4EE5;dao&#x63A5;&#x53E3;&#x548C;mapper&#x6587;&#x4EF6;&#x4E0D;&#x5728;&#x540C;&#x4E00;&#x8DEF;&#x5F84;&#x4E0B;,**mybatis&#x539F;&#x59CB;&#x5F00;&#x53D1;Dao.xml&#x6587;&#x4EF6;&#x4E0E;&#x63A5;&#x53E3;&#x6587;&#x4EF6;&#x4E0D;&#x5728;&#x540C;&#x4E00;&#x8DEF;&#x5F84;&#x4E0B;,&#x4EC5;&#x80FD;&#x7528;resource&#x52A0;&#x8F7D;&#x6620;&#x5C04;&#x6587;&#x4EF6;**
&gt; * mapper&#x7684;class&#x52A0;&#x8F7D;&#xFF0C;&#x4EC5;&#x9002;&#x7528;&#x4E8E;&#x7C7B;&#x8DEF;&#x5F84;&#x4E0B;,**&#x63A5;&#x53E3;&#x6587;&#x4EF6;&#x4E0E;&#x6620;&#x5C04;&#x6587;&#x4EF6;&#x5728;&#x540C;&#x4E00;&#x8DEF;&#x5F84;&#x4E0B;**,&#x4E14;**&#x63A5;&#x53E3;&#x540D;&#x4E0E;&#x6620;&#x5C04;&#x6587;&#x4EF6;&#x540D;&#x76F8;&#x540C;**&#x7684;&#x60C5;&#x51B5;.&#xFF08;&#x626B;&#x63CF;&#x63A5;&#x53E3;&#x7C7B;&#x6765;&#x67E5;&#x627E;&#x6620;&#x5C04;&#x6587;&#x4EF6;&#xFF0C;&#x6CE8;&#x89E3;&#x7684;&#x65F6;&#x5019;&#x7528;&#x7684;&#x591A;&#xFF09;
&gt; * package,&#x9002;&#x7528;&#x4E8E;&#x7C7B;&#x8DEF;&#x5F84;&#x4E0B;,&#x63A5;&#x53E3;&#x6587;&#x4EF6;&#x4E0E;&#x6620;&#x5C04;&#x6587;&#x4EF6;&#x5728;**&#x540C;&#x4E00;&#x8DEF;&#x5F84;**&#x4E0B;,&#x4E14;&#x63A5;&#x53E3;&#x540D;&#x4E0E;&#x6620;&#x5C04;**&#x6587;&#x4EF6;&#x540D;&#x76F8;&#x540C;**&#x7684;&#x60C5;&#x51B5;.(package &#x7684;&#x4F18;&#x52BF;&#x662F;&#x82E5;&#x5728;&#x540C;&#x4E00;&#x8DEF;&#x5F84;&#x4E14;&#x63A5;&#x53E3;&#x540D;&#x4E0E;&#x6620;&#x5C04;**&#x6587;&#x4EF6;&#x540D;&#x76F8;&#x540C;**&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x5B9A;&#x4F4D;&#x5230;&#x5305;&#x540D;&#x5C31;&#x884C;&#xFF0C;&#x4E0D;&#x8981;&#x5B9A;&#x4F4D;&#x5230;&#x6BCF;&#x4E2A;&#x7C7B;&#x540D;)
&gt;
&gt;
&gt; package&#x5B9A;&#x4F4D;&#x65F6;&#xFF0C;&#x82E5;&#x5305;&#x4E0D;&#x540C;&#x4E14;&#x5199;&#x7684;&#x4E3A;xml&#x6240;&#x5728;&#x7684;&#x5305;&#xFF0C;&#x4F1A;&#x62A5;Type interface com.itheima.dao.IUserDao is not known to the MapperRegistry.
&gt;
&gt; &#x82E5;&#x5199;&#x7684;&#x4E3A;&#x63A5;&#x53E3;&#x7684;&#x5305;&#xFF0C;&#x5219;&#x76F4;&#x63A5;&#x627E;&#x4E0D;&#x5230;statement
&gt;

&gt; Mybatis&#x4E2D;&#x63A5;&#x53E3;&#x548C;&#x5BF9;&#x5E94;&#x7684;mapper&#x6587;&#x4EF6;**&#x4E0D;&#x4E00;&#x5B9A;&#x8981;&#x653E;&#x5728;&#x540C;&#x4E00;&#x4E2A;&#x5305;&#x4E0B;**&#xFF0C;&#x653E;&#x5728;&#x4E00;&#x8D77;&#x7684;&#x76EE;&#x7684;&#x662F;&#x4E3A;&#x4E86;Mybatis&#x8FDB;&#x884C;&#x81EA;&#x52A8;&#x626B;&#x63CF;&#xFF0C;&#x5E76;&#x4E14;&#x8981;&#x6CE8;&#x610F;&#x6B64;&#x65F6;java&#x63A5;&#x53E3;&#x7C7B;&#x7684;&#x540D;&#x79F0;&#x548C;mapper&#x6587;&#x4EF6;&#x7684;&#x540D;&#x79F0;&#x8981;&#x76F8;&#x540C;&#xFF0C;&#x5426;&#x5219;&#x4F1A;&#x62A5;&#x5F02;&#x5E38;&#xFF0C;&#x7531;&#x4E8E;&#x6B64;&#x65F6;**Mybatis&#x4F1A;&#x81EA;&#x52A8;&#x89E3;&#x6790;&#x5BF9;&#x5E94;&#x7684;&#x63A5;&#x53E3;&#x548C;&#x76F8;&#x5E94;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;**&#xFF08;class&#x548C;package&#xFF09;&#xFF0C;&#x6240;&#x4EE5;&#x5C31;&#x4E0D;&#x9700;&#x8981;&#x914D;&#x7F6E;mapper&#x6587;&#x4EF6;&#x7684;&#x4F4D;&#x7F6E;&#x4E86;&#x3002;**&#x56E0;&#x4E3A;&#x901A;&#x5E38;&#x7684;xml&#x6587;&#x4EF6;&#x7684;namespace&#x3001;id&#x9700;&#x8981;&#x5230;&#x63A5;&#x53E3;&#x7C7B;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x800C;&#x6B64;&#x65F6;mybatis&#x6700;&#x5148;&#x5F00;&#x59CB;&#x7684;&#x662F; XML&#x7684;&#x89E3;&#x6790;&#xFF0C;&#x82E5;&#x662F;&#x4E0D;&#x540C;&#x5305;&#xFF0C;config.xml&#x8C03;&#x7528;&#x7684;&#x5C06;&#x662F;mappers&#x4E2D;mapper&#x7684;&#x5305;&#xFF08;&#x548C;&#x63A5;&#x53E3;&#x7C7B;&#x4E0D;&#x5728;&#x540C;&#x4E00;&#x7EA7;&#xFF09;&#xFF0C;&#x5C1A;&#x672A;&#x5C06;&#x5176;&#x4ED6;&#x7684;&#x4E3A;&#x7528;&#x5230;&#x7684;&#x63A5;&#x53E3;&#x7C7B;&#x7684;&#x7ED3;&#x6784;&#x4FE1;&#x606F;&#x901A;&#x8FC7;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;&#x52A0;&#x8F7D;&#x5230;JVM&#x7684;&#x65B9;&#x6CD5;&#x533A;&#x4E2D;&#xFF0C;&#x56E0;&#x6B64;&#x4F1A;&#x7F3A;&#x4E4F;&#x76F8;&#x5173;&#x7684;&#x4FE1;&#x606F;&#x7EC4;&#x6210;mappers&#x7684;&#x6210;&#x5458;&#x5BF9;&#x8C61;&#xFF0C;&#x8C03;&#x7528;&#x5931;&#x8D25;&#x5BFC;&#x81F4;&#x62A5;&#x9519;&#x3002;&#x800C;&#x82E5;&#x662F;&#x5728;&#x540C;&#x4E00;&#x4E2A;&#x5305;&#xFF0C;&#x7F16;&#x8BD1;&#x6210;.class&#x5230;target&#x5305;&#x4E2D;&#x65F6;&#xFF0C;recourse&#x548C;java&#x5305;&#x4F1A;&#x5408;&#x5E76;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x81EA;&#x52A8;&#x5BFB;&#x627E;&#x540C;&#x4E00;&#x7EA7;&#x4E2D;&#x662F;&#x5426;&#x6709;&#x5BF9;&#x5E94;&#x7684;&#x540C;&#x540D;&#x63A5;&#x53E3;&#x4FE1;&#x606F;&#xFF0C;&#x4FBF;&#x53EF;&#x7701;&#x53BB;&#x914D;&#x7F6E;&#x7684;&#x9EBB;&#x70E6;**&#xFF0C;resouce&#x4E0D;&#x7528;&#x53D7;&#x6B64;&#x62D8;&#x675F;&#x80AF;&#x5B9A;&#x989D;&#x5916;&#x8C03;&#x7528;&#x4E86;&#x522B;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x4F1A;&#x9020;&#x6210;&#x66F4;&#x591A;&#x7684;&#x8D44;&#x6E90;&#x6D6A;&#x8D39;&#xFF0C;&#x4E3A;&#x4E86;&#x7279;&#x6B8A;&#x9700;&#x6C42;&#x8BBE;&#x8BA1;&#x7684;&#x3002;
&gt;
&gt; 1. &#x63A5;&#x53E3;&#x548C;&#x6587;&#x4EF6;&#x5728;&#x540C;&#x4E00;&#x4E2A;&#x5305;&#x4E2D;
&gt;    1.1 &#x9ED8;&#x8BA4;maven&#x6784;&#x5EFA;
&gt;    &#x5982;&#x679C;&#x5728;&#x5DE5;&#x7A0B;&#x4E2D;&#x4F7F;&#x7528;&#x4E86;maven&#x6784;&#x5EFA;&#x5DE5;&#x5177;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x4F1A;&#x51FA;&#x73B0;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x5728;&#x5178;&#x578B;&#x7684;maven&#x5DE5;&#x7A0B;&#x4E2D;&#xFF0C;&#x76EE;&#x5F55;&#x7ED3;&#x6784;&#x6709;&#xFF1A;src/main/java&#x548C;src/main/resources&#xFF0C;&#x524D;&#x8005;&#x662F;&#x7528;&#x6765;&#x5B58;&#x653E;java&#x6E90;&#x4EE3;&#x7801;&#x7684;&#xFF0C;&#x540E;&#x8005;&#x5219;&#x662F;&#x5B58;&#x653E;&#x4E00;&#x4E9B;&#x8D44;&#x6E90;&#x6587;&#x4EF6;&#xFF0C;&#x6BD4;&#x5982;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7B49;&#xFF0C;**&#x5728;&#x9ED8;&#x8BA4;&#x7684;&#x60C5;&#x51B5;&#x4E0B;maven&#x6253;&#x5305;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5BF9;&#x4E8E;src/main/java&#x76EE;&#x5F55;&#x53EA;&#x6253;&#x5305;&#x6E90;&#x4EE3;&#x7801;&#xFF0C;&#x800C;&#x4E0D;&#x4F1A;&#x6253;&#x5305;&#x5176;&#x4ED6;&#x6587;&#x4EF6;&#x3002;&#x6240;&#x4EE5;&#x6B64;&#x65F6;&#x5982;&#x679C;&#x628A;&#x5BF9;&#x5E94;&#x7684;mapper&#x6587;&#x4EF6;&#x653E;&#x5230;src/main/java&#x76EE;&#x5F55;&#x4E0B;&#x65F6;&#xFF0C;&#x4E0D;&#x4F1A;&#x6253;&#x5305;&#x5230;&#x6700;&#x7EC8;&#x7684;jar&#x6587;&#x4EF6;&#x5939;&#x4E2D;&#xFF0C;&#x4E5F;&#x4E0D;&#x4F1A;&#x8F93;&#x51FA;&#x5230;target&#x6587;&#x4EF6;&#x5939;&#x4E2D;&#xFF0C;**&#x7531;&#x4E8E;&#x5728;&#x8FDB;&#x884C;&#x5355;&#x5143;&#x6D4B;&#x8BD5;&#x7684;&#x65F6;&#x5019;&#x6267;&#x884C;&#x7684;&#x662F;/target&#x76EE;&#x5F55;&#x4E0B;/test-classes&#x4E0B;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x6240;&#x4EE5;&#x5728;&#x6D4B;&#x8BD5;&#x7684;&#x65F6;&#x5019;&#x4E5F;&#x4E0D;&#x4F1A;&#x6210;&#x529F;&#x3002;
&gt;
&gt;    &#x4E3A;&#x4E86;&#x5B9E;&#x73B0;&#x5728;maven&#x9ED8;&#x8BA4;&#x73AF;&#x5883;&#x4E0B;&#x6253;&#x5305;&#x65F6;&#xFF0C;Mybatis&#x7684;&#x63A5;&#x53E3;&#x548C;mapper&#x6587;&#x4EF6;&#x5728;&#x540C;&#x4E00;&#x5305;&#x4E2D;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5C06;&#x63A5;&#x53E3;&#x6587;&#x4EF6;&#x653E;&#x5728;src/main/java&#x67D0;&#x4E2A;&#x5305;&#x4E2D;&#xFF0C;&#x800C;&#x5728;src/main/resources&#x76EE;&#x5F55;&#x4E2D;&#x5EFA;&#x7ACB;&#x540C;&#x6837;&#x7684;&#x5305;&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x79CD;&#x7EA6;&#x5B9A;&#x4F18;&#x4E8E;&#x914D;&#x7F6E;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x8FD9;&#x6837;&#x5728;maven&#x6253;&#x5305;&#x7684;&#x65F6;&#x5019;&#x5C31;&#x4F1A;&#x5C06;src/main/java&#x548C;src/main/resources&#x76F8;&#x540C;&#x5305;&#x4E0B;&#x7684;&#x6587;&#x4EF6;&#x5408;&#x5E76;&#x5230;&#x540C;&#x4E00;&#x5305;&#x4E2D;&#x3002;
&gt;
&gt;    &#x5728;&#x9ED8;&#x8BA4;maven&#x6253;&#x5305;&#x7684;&#x73AF;&#x5883;&#x4E0B;&#xFF0C;&#x4E0D;&#x8981;&#x5C06;&#x63A5;&#x53E3;&#x6587;&#x4EF6;&#x548C;mapper&#x6587;&#x4EF6;&#x5168;&#x90E8;&#x653E;&#x5230;src/main/java&#xFF0C;&#x8FD9;&#x6837;&#x4E5F;&#x4E0D;&#x4F1A;&#x628A;mapper&#x6587;&#x4EF6;&#x6253;&#x5305;&#x8FDB;&#x53BB;
&gt;
&gt; &#x7B80;&#x8981;&#x7684;&#x8FC7;&#x7A0B;&#x5982;&#x4E0B;&#xFF08;&#x4E0E;&#x5982;&#x4E0B;&#x7684;&#x4F8B;&#x5B50;&#x65E0;&#x5173;&#xFF09;&#xFF1A;
&gt;
&gt; ```
&gt; src/main/java
&gt;     edu.zju.mapper
&gt;        UserMapper.java
&gt; src/main/resources
&gt;     config.xml
&gt;     edu.zju.mapper
&gt;         UserMapper.xml
&gt; ```
&gt;
&gt; &#x5982;&#x4E0A;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x5728;maven&#x6253;&#x5305;&#x4E4B;&#x540E;&#x7684;&#x76EE;&#x5F55;&#x5982;&#x4E0B;&#xFF1A;
&gt;
&gt; ```
&gt; -src/main/java
&gt;     -config.xml
&gt;     -edu.zju.mapper
&gt;         -UserMapper.java
&gt;         -UserMapper.xml
&gt; ```
&gt;
&gt; 2.1 &#x66F4;&#x6539;maven&#x6784;&#x5EFA;&#x914D;&#x7F6E;
&gt;
&gt; &#x5982;&#x679C;&#x4E0D;&#x60F3;&#x5C06;&#x63A5;&#x53E3;&#x548C;mapper&#x6587;&#x4EF6;&#x5206;&#x522B;&#x653E;&#x5230;`src/main/java`&#x548C;`src/main/resources`&#x4E2D;&#xFF0C;&#x800C;&#x662F;&#x5168;&#x90E8;&#x653E;&#x5230;`src/main/java`&#xFF0C;&#x90A3;&#x4E48;&#x5728;&#x6784;&#x5EFA;&#x7684;&#x65F6;&#x5019;&#x9700;&#x8981;&#x6307;&#x5B9A;maven&#x6253;&#x5305;&#x9700;&#x8981;&#x5305;&#x62EC;xml&#x6587;&#x4EF6;&#xFF0C;&#x5177;&#x4F53;&#x914D;&#x7F6E;&#x5982;&#x4E0B;&#xFF1A;
&gt;
&gt; ```
&gt; <build>
&gt;     <resources>
&gt;         <resource>
&gt;             <directory>src/main/java</directory>
&gt;             <includes>
&gt;                 <include>**/*.xml</include>
&gt;             </includes>
&gt;             <filtering>false</filtering>
&gt;         </resource>
&gt;     </resources>
&gt; </build>
&gt; ```
&gt;
&gt; 

#### &#x52A8;&#x6001;SQL

###### if

```
<!-- 根据查询条件进行复合查询 -->
<select id="listUsersByCondition" parametertype="cn.ykf.pojo.User" resulttype="cn.ykf.pojo.User">
    SELECT * FROM user WHERE 1 = 1
    <if test="username != null and username != &apos;&apos;">
        AND username LIKE CONCAT(&apos;%&apos;,#{username},&apos;%&apos;)
    </if>
    <if test="sex != null and sex != &apos;&apos;">
        AND sex = #{sex}
    </if>
    <if test="address != null and address != &apos;&apos;">
        AND address = #{address}
    </if>
    <if test="birthday != null">
        AND birthday = #{birthday}
    </if>
</select>
&#x8FD9;&#x91CC;&#x52A0;&#x4E0A; WHERE 1 =1 &#x662F;&#x9632;&#x6B62;&#x6240;&#x6709;&#x6761;&#x4EF6;&#x90FD;&#x4E3A;&#x7A7A;&#x65F6;&#x62FC;&#x63A5; SQL &#x8BED;&#x53E5;&#x51FA;&#x9519;&#x3002;&#x56E0;&#x4E3A;&#x4E0D;&#x52A0;&#x4E0A; 1 = 1 &#x8FD9;&#x4E2A;&#x6052;&#x7B49;&#x6761;&#x4EF6;&#x7684;&#x8BDD;&#xFF0C;&#x5982;&#x679C;&#x540E;&#x9762;&#x67E5;&#x8BE2;&#x6761;&#x4EF6;&#x90FD;&#x6CA1;&#x62FC;&#x63A5;&#x6210;&#x529F;&#xFF0C;&#x90A3;&#x4E48; SQL &#x8BED;&#x53E5;&#x6700;&#x540E;&#x4F1A;&#x5E26;&#x6709;&#x4E00;&#x4E2A; WHERE &#x5173;&#x952E;&#x5B57;&#x800C;&#x6CA1;&#x6709;&#x6761;&#x4EF6;&#xFF0C;&#x4E0D;&#x7B26;&#x5408; SQL &#x8BED;&#x6CD5;&#x3002;
<if></if> &#x6807;&#x7B7E;&#x4E2D; test &#x5C5E;&#x6027;&#x662F;&#x5FC5;&#x987B;&#x7684;&#xFF0C;&#x8868;&#x793A;&#x5224;&#x65AD;&#x7684;&#x6761;&#x4EF6;&#x3002;&#x5176;&#x4E2D;&#x6709;&#x51E0;&#x70B9;&#x9700;&#x8981;&#x6CE8;&#x610F;&#xFF1A;
&#x5982;&#x679C; test &#x6709;&#x591A;&#x4E2A;&#x6761;&#x4EF6;&#xFF0C;&#x90A3;&#x4E48;&#x5FC5;&#x987B;&#x4F7F;&#x7528; and &#x8FDB;&#x884C;&#x8FDE;&#x63A5;&#xFF0C;&#x800C;&#x4E0D;&#x80FD;&#x4F7F;&#x7528; Java &#x4E2D;&#x7684; &amp;&amp; &#x8FD0;&#x7B97;&#x7B26;,mybatis&#x81EA;&#x5DF1;&#x8BBE;&#x7ACB;&#x7684;&#xFF0C;&#x9700;&#x8981;&#x7B26;&#x5408;&#x4ED6;&#x7684;XML&#x89E3;&#x6790;&#x89C4;&#x5219;&#x3002;
test &#x4E2D;&#x7684;&#x53C2;&#x6570;&#x540D;&#x79F0;&#x5FC5;&#x987B;&#x4E0E;&#x5B9E;&#x4F53;&#x7C7B;&#x7684;&#x5C5E;&#x6027;&#x4FDD;&#x6301;&#x4E00;&#x81F4;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x548C; #{&#x53C2;&#x6570;&#x7B26;&#x53F7;} &#x4FDD;&#x6301;&#x4E00;&#x81F4;&#x3002;
&#x5982;&#x679C;&#x5224;&#x65AD;&#x6761;&#x4EF6;&#x4E3A;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x90A3;&#x4E48;&#x9664;&#x4E86;&#x5224;&#x65AD;&#x662F;&#x5426;&#x4E3A; null &#x5916;&#xFF0C;&#x6700;&#x597D;&#x4E5F;&#x5224;&#x65AD;&#x4E00;&#x4E0B;&#x662F;&#x5426;&#x4E3A;&#x7A7A;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&apos;&apos; &#xFF0C;&#x9632;&#x6B62; SQL&#x8BED;&#x53E5;&#x5C06;&#x5176;&#x4F5C;&#x4E3A;&#x6761;&#x4EF6;&#x67E5;&#x8BE2;&#x3002;
```



###### where

```
<select id="listUsersByCondition" parametertype="cn.ykf.pojo.User" resulttype="cn.ykf.pojo.User">
    SELECT * FROM user
    <where>
        <if test="username != null and username != &apos;&apos;">
            AND username LIKE CONCAT(&apos;%&apos;,#{username},&apos;%&apos;)
        </if>
        <if test="sex != null and sex != &apos;&apos;">
            AND sex = #{sex}
        </if>
        <if test="address != null and address != &apos;&apos;">
            AND address = #{address}
        </if>
        <if test="birthday != null">
            AND birthday = #{birthday}
        </if>
    </where>
</select>
&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#xFF0C;&#x76F8;&#x6BD4;&#x4E4B;&#x524D;&#x7684; SQL &#x8BED;&#x53E5;&#xFF0C;&#x6211;&#x4EEC;&#x5C11;&#x5199;&#x4E86; WHERE 1 = 1&#xFF0C;&#x800C;&#x662F;&#x4F7F;&#x7528; <where></where> &#x6807;&#x7B7E;&#x6765;&#x4EE3;&#x66FF;&#x5B83;&#x3002;
<where></where> &#x6807;&#x7B7E;&#x53EA;&#x4F1A;&#x5728;&#x81F3;&#x5C11;&#x6709;&#x4E00;&#x4E2A;&#x5B50;&#x5143;&#x7D20;&#x7684;&#x6761;&#x4EF6;&#x8FD4;&#x56DE; SQL &#x5B50;&#x53E5;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x624D;&#x53BB;&#x63D2;&#x5165; WHERE &#x5B50;&#x53E5;&#x3002;&#x800C;&#x4E14;&#xFF0C;&#x82E5;&#x8BED;&#x53E5;&#x7684;&#x5F00;&#x5934;&#x4E3A; AND &#x6216; OR&#xFF0C;<where></where> &#x6807;&#x7B7E;&#x4E5F;&#x4F1A;&#x5C06;&#x5B83;&#x4EEC;&#x53BB;&#x9664;&#x3002;
&#x7B80;&#x5355;&#x6765;&#x8BF4;&#xFF0C;&#x5C31;&#x662F;&#x8BE5;&#x6807;&#x7B7E;&#x53EF;&#x4EE5;&#x52A8;&#x6001;&#x6DFB;&#x52A0; WHERE &#x5173;&#x952E;&#x5B57;&#xFF0C;&#x5E76;&#x4E14;&#x5254;&#x9664;&#x6389; SQL &#x8BED;&#x53E5;&#x4E2D;&#x591A;&#x4F59;&#x7684; AND &#x6216;&#x8005; OR&#x3002;
```

###### foreach

&#x5047;&#x5982;&#x6211;&#x4EEC;&#x73B0;&#x5728;&#x6709;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x9700;&#x6C42;&#xFF0C;&#x5C31;&#x662F;&#x6839;&#x636E;&#x4E00;&#x4E2A; id &#x96C6;&#x5408;&#xFF0C;&#x6765;&#x67E5;&#x8BE2;&#x51FA; id &#x5728;&#x8BE5;&#x96C6;&#x5408;&#x4E2D;&#x7684;&#x6240;&#x6709;&#x7528;&#x6237;&#xFF0C;&#x90A3;&#x4E48;&#x53C8;&#x8BE5;&#x600E;&#x4E48;&#x5B9E;&#x73B0;&#x5462;&#xFF1F;
&#x5982;&#x679C;&#x4F7F;&#x7528;&#x666E;&#x901A; SQL &#x8BED;&#x53E5;&#x7684;&#x8BDD;&#xFF0C;&#x90A3;&#x4E48;&#x67E5;&#x8BE2;&#x8BED;&#x53E5;&#x5E94;&#x8BE5;&#x8FD9;&#x6837;&#x5199;&#xFF1A;SELECT * FROM user WHERE id IN(41,42,43);
&#x56E0;&#x6B64;&#xFF0C;&#x5982;&#x679C;&#x60F3;&#x4F7F;&#x7528;&#x52A8;&#x6001; SQL &#x6765;&#x5B8C;&#x6210;&#x7684;&#x8BDD;&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x5C31;&#x5E94;&#x8BE5;&#x8003;&#x8651;&#x5982;&#x4F55;&#x62FC;&#x63A5;&#x4E0A; id IN(41,42,43) &#x8FD9;&#x4E00;&#x4E32;&#x5185;&#x5BB9;&#xFF0C;&#x8FD9;&#x65F6;&#x5019;&#xFF0C;&#x6211;&#x4EEC;&#x7684; <foreach></foreach> &#x6807;&#x7B7E;&#x5C31;&#x51FA;&#x573A;&#x4E86;&#x3002;

**foreach&#x5143;&#x7D20;&#x7684;&#x5C5E;&#x6027;&#x4E3B;&#x8981;&#x6709; item&#xFF0C;index&#xFF0C;collection&#xFF0C;open&#xFF0C;separator&#xFF0C;close&#x3002;**

```
item&#x8868;&#x793A;&#x96C6;&#x5408;&#x4E2D;&#x6BCF;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#x8FDB;&#x884C;&#x8FED;&#x4EE3;&#x65F6;&#x7684;&#x522B;&#x540D;&#xFF0C;
index&#x6307; &#x5B9A;&#x4E00;&#x4E2A;&#x540D;&#x5B57;&#xFF0C;&#x7528;&#x4E8E;&#x8868;&#x793A;&#x5728;&#x8FED;&#x4EE3;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x6BCF;&#x6B21;&#x8FED;&#x4EE3;&#x5230;&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;
open&#x8868;&#x793A;&#x8BE5;&#x8BED;&#x53E5;&#x4EE5;&#x4EC0;&#x4E48;&#x5F00;&#x59CB;&#xFF0C;
separator&#x8868;&#x793A;&#x5728;&#x6BCF;&#x6B21;&#x8FDB;&#x884C;&#x8FED;&#x4EE3;&#x4E4B;&#x95F4;&#x4EE5;&#x4EC0;&#x4E48;&#x7B26;&#x53F7;&#x4F5C;&#x4E3A;&#x5206;&#x9694; &#x7B26;&#xFF0C;
close&#x8868;&#x793A;&#x4EE5;&#x4EC0;&#x4E48;&#x7ED3;&#x675F;&#x3002;12345
```

&#x5728;&#x4F7F;&#x7528;foreach&#x7684;&#x65F6;&#x5019;&#x6700;&#x5173;&#x952E;&#x7684;&#x4E5F;&#x662F;&#x6700;&#x5BB9;&#x6613;&#x51FA;&#x9519;&#x7684;&#x5C31;&#x662F;collection&#x5C5E;&#x6027;&#xFF0C;&#x8BE5;&#x5C5E;&#x6027;&#x662F;&#x5FC5;&#x987B;&#x6307;&#x5B9A;&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x5728;&#x4E0D;&#x540C;&#x60C5;&#x51B5; &#x4E0B;&#xFF0C;&#x8BE5;&#x5C5E;&#x6027;&#x7684;&#x503C;&#x662F;&#x4E0D;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x4E3B;&#x8981;&#x6709;&#x4E00;&#x4E0B;3&#x79CD;&#x60C5;&#x51B5;&#xFF1A;

```
1. &#x5982;&#x679C;&#x4F20;&#x5165;&#x7684;&#x7684;&#x662F;&#x4E00;&#x4E2A;&#x666E;&#x901A;&#x5BF9;&#x8C61;&#xFF08;&#x6CA1;&#x6709;&#x7279;&#x6B8A;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF09;&#xFF0C;&#x800C;&#x8BE5;&#x7C7B;&#x4E2D;&#x6709;list&#x7B49;collection&#x5C5E;&#x6027;&#x7684;&#xFF0C;&#x9700;&#x8981;&#x7528;&#x5230;&#x8BE5;&#x5C5E;&#x6027;&#x5E76;&#x9700;&#x8981;foreach&#xFF0C;collection&#x5219;&#x4E3A;&#x5176;&#x4E2D;&#x5C5E;&#x6027;&#x7684;&#x503C;&#xFF0C;&#x5373;&#x7528;&#x7684;&#x4E3A;&#x5305;&#x88C5;&#x7C7B;Vo&#x65F6;&#x3002;
2. &#x5982;&#x679C;&#x4F20;&#x5165;&#x7684;&#x662F;&#x5355;&#x53C2;&#x6570;&#x4E14;&#x53C2;&#x6570;&#x7C7B;&#x578B;&#x662F;&#x4E00;&#x4E2A;List&#x7684;&#x65F6;&#x5019;&#xFF0C;collection&#x5C5E;&#x6027;&#x503C;&#x4E3A;list
3. &#x5982;&#x679C;&#x4F20;&#x5165;&#x7684;&#x662F;&#x5355;&#x53C2;&#x6570;&#x4E14;&#x53C2;&#x6570;&#x7C7B;&#x578B;&#x662F;&#x4E00;&#x4E2A;array&#x6570;&#x7EC4;&#x7684;&#x65F6;&#x5019;&#xFF0C;collection&#x7684;&#x5C5E;&#x6027;&#x503C;&#x4E3A;array
4. &#x5982;&#x679C;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x662F;&#x591A;&#x4E2A;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x9700;&#x8981;&#x628A;&#x5B83;&#x4EEC;&#x5C01;&#x88C5;&#x6210;&#x4E00;&#x4E2A;Map&#x4E86;&#xFF0C;collection&#x7684;&#x5C5E;&#x6027;&#x503C;&#x4E3A;map&#x7684;key&#x5C5E;&#x6027;
```

```
<!-- 根据id集合查询用户 -->
<select id="listUsersByIds" parametertype="cn.ykf.pojo.QueryVo" resulttype="cn.ykf.pojo.User">
    SELECT * FROM user
    <where>
        <if test="ids != null and ids.size &gt; 0">
            <foreach collection="ids" open="AND id IN (" close=")" item="id" separator=",">
                #{id}
            </foreach>
        </if>
    </where>
</select>
<foreach></foreach> &#x6807;&#x7B7E;&#x7528;&#x4E8E;&#x904D;&#x5386;&#x96C6;&#x5408;&#xFF0C;&#x6BCF;&#x4E2A;&#x5C5E;&#x6027;&#x7684;&#x4F5C;&#x7528;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;
collection &#xFF1A; &#x4EE3;&#x8868;&#x8981;&#x904D;&#x5386;&#x7684;&#x96C6;&#x5408;&#x6216;&#x6570;&#x7EC4;&#xFF0C;&#x8FD9;&#x4E2A;&#x5C5E;&#x6027;&#x662F;&#x5FC5;&#x987B;&#x7684;&#x3002;&#x5982;&#x679C;&#x662F;&#x904D;&#x5386;&#x6570;&#x7EC4;&#xFF0C;&#x90A3;&#x4E48;&#x8BE5;&#x503C;&#x53EA;&#x80FD;&#x4E3A; array
open &#xFF1A; &#x4EE3;&#x8868;&#x8BED;&#x53E5;&#x7684;&#x5F00;&#x59CB;&#x90E8;&#x4EFD;&#x3002;
close &#xFF1A; &#x4EE3;&#x8868;&#x8BED;&#x53E5;&#x7684;&#x7ED3;&#x675F;&#x90E8;&#x4EFD;&#x3002;
item &#xFF1A; &#x4EE3;&#x8868;&#x904D;&#x5386;&#x96C6;&#x5408;&#x65F6;&#x7684;&#x6BCF;&#x4E2A;&#x5143;&#x7D20;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x4E00;&#x4E2A;&#x4E34;&#x65F6;&#x53D8;&#x91CF;&#x3002;
separator &#xFF1A; &#x4EE3;&#x8868;&#x62FC;&#x63A5;&#x6BCF;&#x4E2A;&#x5143;&#x7D20;&#x4E4B;&#x95F4;&#x7684;&#x5206;&#x9694;&#x7B26;&#x3002;
&#x4F60;&#x53EF;&#x4EE5;&#x5C06;&#x4EFB;&#x4F55;&#x53EF;&#x8FED;&#x4EE3;&#x5BF9;&#x8C61;&#xFF08;&#x5982; List&#x3001;Set &#x7B49;&#xFF09;&#x3001;Map &#x5BF9;&#x8C61;&#x6216;&#x8005;&#x6570;&#x7EC4;&#x5BF9;&#x8C61;&#x4F20;&#x9012;&#x7ED9; foreach &#x4F5C;&#x4E3A;&#x96C6;&#x5408;&#x53C2;&#x6570;&#x3002;&#x5F53;&#x4F7F;&#x7528;&#x53EF;&#x8FED;&#x4EE3;&#x5BF9;&#x8C61;&#x6216;&#x8005;&#x6570;&#x7EC4;&#x65F6;&#xFF0C;index &#x662F;&#x5F53;&#x524D;&#x8FED;&#x4EE3;&#x7684;&#x6B21;&#x6570;&#xFF0C;item &#x7684;&#x503C;&#x662F;&#x672C;&#x6B21;&#x8FED;&#x4EE3;&#x83B7;&#x53D6;&#x7684;&#x5143;&#x7D20;&#x3002;&#x5F53;&#x4F7F;&#x7528; Map &#x5BF9;&#x8C61;&#xFF08;&#x6216;&#x8005; Map.Entry &#x5BF9;&#x8C61;&#x7684;&#x96C6;&#x5408;&#xFF09;&#x65F6;&#xFF0C;index &#x662F;&#x952E;&#xFF0C;item &#x662F;&#x503C;&#x3002;
&#x6CE8;&#x610F;&#xFF0C;SQL &#x8BED;&#x53E5;&#x4E2D;&#x7684;&#x53C2;&#x6570;&#x7B26;&#x53F7; #{id} &#x5E94;&#x8BE5;&#x4E0E; item=&quot;id&quot; &#x4FDD;&#x6301;&#x4E00;&#x81F4;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;item &#x5C5E;&#x6027;&#x5982;&#x679C;&#x628A;&#x4E34;&#x65F6;&#x53D8;&#x91CF;&#x58F0;&#x660E;&#x4E3A; uid &#x7684;&#x8BDD;&#xFF0C;&#x90A3;&#x4E48;&#x4F7F;&#x7528;&#x65F6;&#x5C31;&#x5FC5;&#x987B;&#x5199;&#x6210; #{uid}&#x3002;
```

###### &#x5B9A;&#x4E49; SQL &#x7247;&#x6BB5;

- **&#x5728;&#x4E0A;&#x9762;&#x7684;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5728;&#x6BCF;&#x6761; SQL &#x4E2D;&#x90FD;&#x7528;&#x5230;&#x4E86; `SELECT \* FROM user` &#xFF0C;&#x56E0;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x628A;&#x8BE5;&#x8BED;&#x53E5;&#x5B9A;&#x4E49;&#x4E3A; SQL &#x7247;&#x6BB5;&#xFF0C;&#x4EE5;&#x4F9B;&#x590D;&#x7528;&#xFF0C;&#x51CF;&#x5C11;&#x5DE5;&#x4F5C;&#x91CF;&#x3002;**
- **&#x9996;&#x5148;&#x5728;&#x6620;&#x5C04;&#x6587;&#x4EF6;&#x4E2D;&#x5B9A;&#x4E49;&#x4EE3;&#x7801;&#x7247;&#x6BB5;**

```
<!-- 定义代码片段 -->
<sql id="defaultSql">
    SELECT * FROM user
</sql>

```
&#x63A5;&#x7740;&#x5C31;&#x53EF;&#x4EE5;&#x5728;&#x9700;&#x8981;&#x7684;&#x5730;&#x65B9;&#x5F15;&#x7528;&#x8BE5;&#x7247;&#x6BB5;&#x4E86;
```
<!-- 根据id集合查询用户 -->
<select id="listUsersByIds" parametertype="cn.ykf.pojo.QueryVo" resultmap="userMap">
    <!-- 引用代码片段 -->
    <include refid="defaultSql"></include>
    <where>
        <if test="ids != null and ids.size &gt; 0">
            <foreach collection="ids" open="AND id IN (" close=")" item="id" separator=",">
                #{id}
            </foreach>
        </if>
    </where>
</select>
```



## &#x8FDE;&#x63A5;&#x6C60;

&#x6211;&#x4EEC;&#x5728;&#x914D;&#x7F6E;&#x6570;&#x636E;&#x6E90;&#x7684;&#x65F6;&#x5019;&#x4E00;&#x822C;&#x90FD;==&#x5DF2;&#x7ECF;&#x914D;&#x7F6E;&#x597D;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;&#x6C60;&#x7684;&#x53C2;&#x6570;==&#xFF0C;&#x7136;&#x540E;&#x6570;&#x636E;&#x6E90;&#x4F1A;&#x81EA;&#x52A8;&#x5E2E;&#x6211;&#x4EEC;&#x7EF4;&#x62A4;&#x8FD9;&#x4E9B;&#x3002;&#x6240;&#x6709;&#x8FD9;&#x4E9B;&#x5BF9;&#x5F00;&#x53D1;&#x8005;&#x800C;&#x8A00;&#x662F;&#x900F;&#x660E;&#x7684;&#x3002;

&#x5728; Mybatis &#x4E2D;&#xFF0C;&#x6570;&#x636E;&#x6E90; dataSource &#x5171;&#x6709;&#x4E09;&#x7C7B;&#xFF0C;&#x5206;&#x522B;&#x662F;&#xFF1A;
UNPOOLED &#xFF1A; &#x4E0D;&#x4F7F;&#x7528;&#x8FDE;&#x63A5;&#x6C60;&#x7684;&#x6570;&#x636E;&#x6E90;&#x3002;&#x91C7;&#x7528;&#x4F20;&#x7EDF;&#x7684; javax.sql.DataSource &#x89C4;&#x8303;&#x4E2D;&#x7684;&#x8FDE;&#x63A5;&#x6C60;&#xFF0C;Mybatis &#x4E2D;&#x6709;&#x9488;&#x5BF9;&#x89C4;&#x8303;&#x7684;&#x5B9E;&#x73B0;
POOLED &#xFF1A; &#x4F7F;&#x7528;&#x8FDE;&#x63A5;&#x6C60;&#x7684;&#x6570;&#x636E;&#x6E90;&#x3002;&#x91C7;&#x7528;&#x6C60;&#x7684;&#x601D;&#x60F3;
JNDI &#xFF1A; &#x4F7F;&#x7528; JNDI &#x5B9E;&#x73B0;&#x7684;&#x6570;&#x636E;&#x6E90;&#xFF0C;&#x91C7;&#x7528;&#x670D;&#x52A1;&#x5668;&#x63D0;&#x4F9B;&#x7684; JNDI &#x6280;&#x672F;&#x5B9E;&#x73B0;&#xFF0C;&#x6765;&#x83B7;&#x53D6; DataSource &#x5BF9;&#x8C61;&#xFF0C;&#x4E0D;&#x540C;&#x7684;&#x670D;&#x52A1;&#x5668;&#x6240;&#x80FD;&#x62FF;&#x5230;&#x7684; DataSource &#x662F;&#x4E0D;&#x4E00;&#x6837;&#x7684;&#x3002;&#xFF08;&#x5982;&#x679C;&#x4E0D;&#x662F;web&#x6216;&#x8005;maven&#x7684;war&#x5DE5;&#x7A0B;&#xFF0C;&#x662F;&#x4E0D;&#x80FD;&#x4F7F;&#x7528;&#x7684;&#xFF0C;tomcat-dbcp&#x8FDE;&#x63A5;&#x6C60;&#xFF1A;**&#x56E0;&#x4E3A;&#x9700;&#x8981;&#x76F8;&#x5E94;&#x7684;&#x4EE3;&#x7801;&#x9700;&#x8981;&#x5728;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x624D;&#x80FD;&#x542F;&#x52A8;&#xFF0C;&#x8FDE;&#x63A5;&#x6C60;&#x8FDE;&#x63A5;&#x7684;&#x6570;&#x636E;&#x6E90;&#x662F;&#x90E8;&#x7F72;&#x5728;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x7684;&#xFF0C;&#x5982;tomcat&#x4F60;&#x53EF;&#x4EE5;&#x5728;servlet&#x6216;&#x8005;jsp&#xFF08;&#x6700;&#x7EC8;&#x8FD8;&#x662F;&#x4F1A;&#x8F6C;&#x6362;&#x6210;servlet&#xFF09;&#x4E0A;&#x8FDB;&#x884C;sqlsession&#x7684;&#x521B;&#x5EFA;&#x624D;&#x80FD;&#x5728;jndi&#x4E0A;getConnection&#x5230;&#x76F8;&#x5E94;&#x7684;connection&#xFF0C;&#x901A;&#x8FC7;&#x6D4F;&#x89C8;&#x5668;&#x6216;&#x5BA2;&#x6237;&#x7AEF;&#x5BF9;&#x670D;&#x52A1;&#x5668;&#x7684;&#x8BBF;&#x95EE;&#x8C03;&#x7528;&#x4E86;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x90E8;&#x7F72;&#x7684;&#x6709;&#x76F8;&#x5E94;&#x9700;&#x8981;&#x8FDE;&#x63A5;&#x6570;&#x636E;&#x5E93;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x624D;&#x80FD;&#x8C03;&#x7528;&#x670D;&#x52A1;&#x5668;&#x8FDE;&#x63A5;&#x7684;&#x6570;&#x636E;&#x5E93;&#x6E90;**&#xFF09;

&gt; &#x8FDE;&#x63A5;&#x6C60;&#x548C;&#x7EBF;&#x7A0B;&#x6C60;&#xFF1A;
&gt;
&gt; &#x8FDE;&#x63A5;&#x6C60;&#xFF1A;&#xFF08;&#x964D;&#x4F4E;&#x7269;&#x7406;&#x8FDE;&#x63A5;&#x635F;&#x8017;&#xFF09;
&gt; 1&#x3001;&#x8FDE;&#x63A5;&#x6C60;&#x662F;&#x9762;&#x5411;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;&#x7684;
&gt; 2&#x3001;&#x8FDE;&#x63A5;&#x6C60;&#x662F;&#x4E3A;&#x4E86;&#x4F18;&#x5316;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;&#x8D44;&#x6E90;
&gt; 3&#x3001;&#x8FDE;&#x63A5;&#x6C60;&#x6709;&#x70B9;&#x7C7B;&#x4F3C;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x505A;&#x4F18;&#x5316;
&gt;
&gt; &#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;&#x662F;&#x4E00;&#x9879;&#x6709;&#x9650;&#x7684;&#x6602;&#x8D35;&#x8D44;&#x6E90;&#xFF0C;&#x4E00;&#x4E2A;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;&#x5BF9;&#x8C61;&#x5747;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;&#x7269;&#x7406;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;&#xFF0C;&#x6BCF;&#x6B21;&#x64CD;&#x4F5C;&#x90FD;&#x6253;&#x5F00;&#x4E00;&#x4E2A;&#x7269;&#x7406;&#x8FDE;&#x63A5;&#xFF0C;&#x4F7F;&#x7528;&#x5B8C;&#x90FD;&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#xFF0C;&#x8FD9;&#x6837;&#x9020;&#x6210;&#x7CFB;&#x7EDF;&#x7684;&#x6027;&#x80FD;&#x4F4E;&#x4E0B;&#x3002; &#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;&#x6C60;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x662F;&#x5728;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x542F;&#x52A8;&#x65F6;&#x5EFA;&#x7ACB;&#x8DB3;&#x591F;&#x7684;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;&#xFF0C;&#x5E76;&#x5C06;&#x8FD9;&#x4E9B;&#x8FDE;&#x63A5;&#x7EC4;&#x6210;&#x4E00;&#x4E2A;&#x8FDE;&#x63A5;&#x6C60;&#xFF0C;&#x7531;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x52A8;&#x6001;&#x5730;&#x5BF9;&#x6C60;&#x4E2D;&#x7684;&#x8FDE;&#x63A5;&#x8FDB;&#x884C;&#x7533;&#x8BF7;&#x3001;&#x4F7F;&#x7528;&#x548C;&#x91CA;&#x653E;&#x3002;**&#x5BF9;&#x4E8E;&#x591A;&#x4E8E;&#x8FDE;&#x63A5;&#x6C60;&#x4E2D;&#x8FDE;&#x63A5;&#x6570;&#x7684;&#x5E76;&#x53D1;&#x8BF7;&#x6C42;&#xFF0C;&#x5E94;&#x8BE5;&#x5728;&#x8BF7;&#x6C42;&#x961F;&#x5217;&#x4E2D;&#x6392;&#x961F;&#x7B49;&#x5F85;&#x3002;&#x5E76;&#x4E14;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x53EF;&#x4EE5;&#x6839;&#x636E;&#x6C60;&#x4E2D;&#x8FDE;&#x63A5;&#x7684;&#x4F7F;&#x7528;&#x7387;&#xFF0C;&#x52A8;&#x6001;&#x589E;&#x52A0;&#x6216;&#x51CF;&#x5C11;&#x6C60;&#x4E2D;&#x7684;&#x8FDE;&#x63A5;&#x6570;**&#x3002; 
&gt;
&gt; &#x7EBF;&#x7A0B;&#x6C60;&#xFF1A;&#xFF08;&#x964D;&#x4F4E;&#x7EBF;&#x7A0B;&#x521B;&#x5EFA;&#x9500;&#x6BC1;&#x635F;&#x8017;&#xFF09;
&gt; 1.&#x3001;&#x7EBF;&#x7A0B;&#x6C60;&#x662F;&#x9762;&#x5411;&#x540E;&#x53F0;&#x7A0B;&#x5E8F;&#x7684;
&gt; 2&#x3001;&#x7EBF;&#x7A0B;&#x6C60;&#x662F;&#x662F;&#x4E3A;&#x4E86;&#x63D0;&#x9AD8;&#x5185;&#x5B58;&#x548C;CPU&#x6548;&#x7387;
&gt; 3&#x3001;&#x7EBF;&#x7A0B;&#x6C60;&#x6709;&#x70B9;&#x7C7B;&#x4F3C;&#x4E8E;&#x5728;&#x670D;&#x52A1;&#x7AEF;&#x505A;&#x4F18;&#x5316;
&gt;
&gt; &#x7EBF;&#x7A0B;&#x6C60;&#x662F;&#x4E00;&#x6B21;&#x6027;&#x521B;&#x5EFA;&#x4E00;&#x5B9A;&#x6570;&#x91CF;&#x7684;&#x7EBF;&#x7A0B;&#xFF08;&#x5E94;&#x8BE5;&#x53EF;&#x4EE5;&#x914D;&#x7F6E;&#x521D;&#x59CB;&#x7EBF;&#x7A0B;&#x6570;&#x91CF;&#x7684;&#xFF09;&#xFF0C;&#x5F53;&#x7528;&#x8BF7;&#x6C42;&#x8FC7;&#x6765;&#x4E0D;&#x7528;&#x53BB;&#x521B;&#x5EFA;&#x65B0;&#x7684;&#x7EBF;&#x7A0B;&#xFF0C;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x5DF2;&#x521B;&#x5EFA;&#x7684;&#x7EBF;&#x7A0B;&#xFF0C;&#x4F7F;&#x7528;&#x540E;&#x53C8;&#x653E;&#x56DE;&#x5230;&#x7EBF;&#x7A0B;&#x6C60;&#x4E2D;&#x3002;
&gt; &#x907F;&#x514D;&#x4E86;&#x9891;&#x7E41;&#x521B;&#x5EFA;&#x7EBF;&#x7A0B;&#xFF0C;&#x53CA;&#x9500;&#x6BC1;&#x7EBF;&#x7A0B;&#x7684;&#x7CFB;&#x7EDF;&#x5F00;&#x9500;&#xFF0C;&#x63D0;&#x9AD8;&#x662F;&#x5185;&#x5B58;&#x548C;CPU&#x6548;&#x7387;&#x3002;
&gt;
&gt; &#x76F8;&#x540C;&#x70B9;&#xFF1A;
&gt; &#x90FD;&#x662F;&#x4E8B;&#x5148;&#x51C6;&#x5907;&#x597D;&#x8D44;&#x6E90;&#xFF0C;&#x907F;&#x514D;&#x9891;&#x7E41;&#x521B;&#x5EFA;&#x548C;&#x9500;&#x6BC1;&#x7684;&#x4EE3;&#x4EF7;&#x3002;
&gt;
&gt; &#x6269;&#x5C55;&#xFF1A;
&gt; &#x5BF9;&#x8C61;&#x6C60;&#xFF1A;
&gt; &#x5BF9;&#x8C61;&#x6C60;&#x6280;&#x672F;&#x57FA;&#x672C;&#x539F;&#x7406;&#x7684;&#x6838;&#x5FC3;&#x6709;&#x4E24;&#x70B9;&#xFF1A;&#x7F13;&#x5B58;&#x548C;&#x5171;&#x4EAB;&#xFF0C;&#x5373;&#x5BF9;&#x4E8E;&#x90A3;&#x4E9B;&#x88AB;&#x9891;&#x7E41;&#x4F7F;&#x7528;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x5728;&#x4F7F;&#x7528;&#x5B8C;&#x540E;&#xFF0C;&#x4E0D;&#x7ACB;&#x5373;&#x5C06;&#x5B83;&#x4EEC;&#x91CA;&#x653E;&#xFF0C;&#x800C;&#x662F;&#x5C06;&#x5B83;&#x4EEC;&#x7F13;&#x5B58;&#x8D77;&#x6765;&#xFF0C;&#x4EE5;&#x4F9B;&#x540E;&#x7EED;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x91CD;&#x590D;&#x4F7F;&#x7528;&#xFF0C;&#x4ECE;&#x800C;&#x51CF;&#x5C11;&#x521B;&#x5EFA;&#x5BF9;&#x8C61;&#x548C;&#x91CA;&#x653E;&#x5BF9;&#x8C61;&#x7684;&#x6B21;&#x6570;&#xFF0C;&#x8FDB;&#x800C;&#x6539;&#x5584;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x6027;&#x80FD;&#x3002;&#x4E8B;&#x5B9E;&#x4E0A;&#xFF0C;&#x7531;&#x4E8E;&#x5BF9;&#x8C61;&#x6C60;&#x6280;&#x672F;&#x5C06;&#x5BF9;&#x8C61;&#x9650;&#x5236;&#x5728;&#x4E00;&#x5B9A;&#x7684;&#x6570;&#x91CF;&#xFF0C;&#x4E5F;&#x6709;&#x6548;&#x5730;&#x51CF;&#x5C11;&#x4E86;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5185;&#x5B58;&#x4E0A;&#x7684;&#x5F00;&#x9500;&#x3002;
&gt;
&gt; &#x5BF9;&#x4E8E;&#x4E24;&#x8005;&#x662F;&#x5426;&#x6709;&#x8054;&#x7CFB;&#xFF1A;
&gt;
&gt; 1. &#x9996;&#x5148;&#xFF0C;&#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x8981;&#x542F;&#x52A8;&#xFF0C;&#x90FD;&#x9700;&#x8981;&#x4F9D;&#x8D56;&#x4E8E;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x7684;&#x8C03;&#x7528;&#xFF0C;&#x5426;&#x5219;&#xFF0C;&#x5373;&#x4F7F;&#x8FDE;&#x63A5;&#x5728;&#x8FDE;&#x63A5;&#x6C60;&#x91CC;&#xFF0C;&#x6CA1;&#x6709;&#x65AD;&#x5F00;&#x8FDE;&#x63A5;&#xFF0C;&#x4E5F;&#x65E0;&#x6CD5;&#x505A;&#x51FA;&#x884C;&#x4E3A;
&gt; 2. &#x5F53;&#x7EBF;&#x7A0B;&#x4F7F;&#x7528;&#x5B8C;&#x65F6;&#xFF0C;&#x4F1A;&#x5C06;&#x8FDE;&#x63A5;&#x4E0E;&#x7EBF;&#x7A0B;&#x89E3;&#x7ED1;&#x4EA4;&#x8FD8;&#x4E8E;&#x8FDE;&#x63A5;&#x6C60;
&gt; 3. &#x4E00;&#x822C;&#x4F1A;&#x662F;&#x591A;&#x4E2A;&#x8FDE;&#x63A5;&#x5E76;&#x53D1;&#x6267;&#x884C;&#xFF0C;&#x5373;&#x9700;&#x8981;&#x591A;&#x4E2A;&#x7EBF;&#x7A0B;&#xFF0C;&#x56E0;&#x6B64;&#x524D;&#x9762;&#x4E5F;&#x6709;&#x7EBF;&#x7A0B;&#x6C60;&#x7684;&#x7BA1;&#x7406;
&gt; 4. &#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x90FD;&#x662F;&#x7EBF;&#x7A0B;&#x5B89;&#x5168;&#x7684;&#xFF0C;&#x7528;synchronized&#x9501;&#x4F4F;
&gt;
&gt; ```
&gt; while(conn == null) {
&gt;     synchronized(this.state) {
&gt;         PoolState var10000;
&gt;         if (!this.state.idleConnections.isEmpty()) {
&gt;             conn = (PooledConnection)this.state.idleConnections.remove(0);
&gt;             if (log.isDebugEnabled()) {
&gt;                 log.debug(&quot;Checked out connection &quot; + conn.getRealHashCode() + &quot; from pool.&quot;);
&gt;             }
&gt;         } else if (this.state.activeConnections.size() &lt; this.poolMaximumActiveConnections) {
&gt;             conn = new PooledConnection(this.dataSource.getConnection(), this);
&gt;             if (log.isDebugEnabled()) {
&gt;                 log.debug(&quot;Created connection &quot; + conn.getRealHashCode() + &quot;.&quot;);
&gt;             }
&gt;         } else {
&gt;             PooledConnection oldestActiveConnection = (PooledConnection)this.state.activeConnections.get(0);
&gt;             long longestCheckoutTime = oldestActiveConnection.getCheckoutTime();
&gt;             if (longestCheckoutTime &gt; (long)this.poolMaximumCheckoutTime) {
&gt;                 ++this.state.claimedOverdueConnectionCount;
&gt;                 var10000 = this.state;
&gt;                 var10000.accumulatedCheckoutTimeOfOverdueConnections += longestCheckoutTime;
&gt;                 var10000 = this.state;
&gt;                 var10000.accumulatedCheckoutTime += longestCheckoutTime;
&gt;                 this.state.activeConnections.remove(oldestActiveConnection);
&gt;                 if (!oldestActiveConnection.getRealConnection().getAutoCommit()) {
&gt;                     try {
&gt;                         oldestActiveConnection.getRealConnection().rollback();
&gt;                     } catch (SQLException var16) {
&gt;                         log.debug(&quot;Bad connection. Could not roll back&quot;);
&gt;                     }
&gt;                 }
&gt; 
&gt;                 conn = new PooledConnection(oldestActiveConnection.getRealConnection(), this);
&gt;                 conn.setCreatedTimestamp(oldestActiveConnection.getCreatedTimestamp());
&gt;                 conn.setLastUsedTimestamp(oldestActiveConnection.getLastUsedTimestamp());
&gt;                 oldestActiveConnection.invalidate();
&gt;                 if (log.isDebugEnabled()) {
&gt;                     log.debug(&quot;Claimed overdue connection &quot; + conn.getRealHashCode() + &quot;.&quot;);
&gt;                 }
&gt;             } else {
&gt;                 try {
&gt;                     if (!countedWait) {
&gt;                         ++this.state.hadToWaitCount;
&gt;                         countedWait = true;
&gt;                     }
&gt; 
&gt;                     if (log.isDebugEnabled()) {
&gt;                         log.debug(&quot;Waiting as long as &quot; + this.poolTimeToWait + &quot; milliseconds for connection.&quot;);
&gt;                     }
&gt; 
&gt;                     long wt = System.currentTimeMillis();
&gt;                     this.state.wait((long)this.poolTimeToWait);
&gt;                     var10000 = this.state;
&gt;                     var10000.accumulatedWaitTime += System.currentTimeMillis() - wt;
&gt;                 } catch (InterruptedException var17) {
&gt;                     break;
&gt;                 }
&gt;             }
&gt;         }
&gt; ```

- **&#x5982;&#x679C;&#x60F3;&#x8981;&#x4FEE;&#x6539; Mybatis &#x4F7F;&#x7528;&#x7684;&#x6570;&#x636E;&#x6E90;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x53EF;&#x4EE5;&#x5728; Mybatis &#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x4FEE;&#x6539;&#xFF1A;**&#xFF08;&#x8FD9;&#x91CC; `type` &#x5C5E;&#x6027;&#x7684;&#x53D6;&#x503C;&#x5C31;&#x662F;&#x4E3A;`POOLED&#x3001;UNPOOLED&#x3001;JNDI` &#x3002;&#xFF09;

```
<!-- 配置数据源（连接池） -->
<datasource type="POOLED">
    <property name="driver" value="${jdbc.driver}">
    <property name="url" value="${jdbc.url}">
    <property name="username" value="${jdbc.username}">
    <property name="password" value="${jdbc.password}">
</property></property></property></property></datasource>

```

**&#x67E5;&#x770B; `POOLED` &#x7684;&#x5B9E;&#x73B0; `PooledDataSource` &#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x83B7;&#x53D6;&#x8FDE;&#x63A5;&#x65F6;&#x91C7;&#x7528;&#x4E86;&#x6C60;&#x7684;&#x601D;&#x60F3;&#xFF0C;&#x5927;&#x6982;&#x6D41;&#x7A0B;&#x5982;&#x4E0B;&#x56FE;&#xFF08;&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x4ECB;&#x7ECD;&#xFF0C;&#x4E0D;&#x5168;&#x9762;&#xFF09;**

```java
protected DataSource createDataSource() throws SQLException {
    if (this.closed) {
        throw new SQLException(&quot;Data source is closed&quot;);
    } else if (this.dataSource != null) {
        return this.dataSource;
    } else {
        synchronized(this) {// &#x7EBF;&#x7A0B;&#x5B89;&#x5168;
            if (this.dataSource != null) {
                return this.dataSource;
            } else {
                this.jmxRegister();
                ConnectionFactory driverConnectionFactory = this.createConnectionFactory();// &#x7EBF;&#x521B;&#x5EFA;&#x6570;&#x636E;&#x5E93;&#x7684;&#x8FDE;&#x63A5;&#x5DE5;&#x5382;
                boolean success = false;

                PoolableConnectionFactory poolableConnectionFactory;
                try {
                    poolableConnectionFactory = this.createPoolableConnectionFactory(driverConnectionFactory);
                    poolableConnectionFactory.setPoolStatements(this.poolPreparedStatements);
                    poolableConnectionFactory.setMaxOpenPreparedStatements(this.maxOpenPreparedStatements);
                    success = true;
                } catch (SQLException var21) {
                    throw var21;
                } catch (RuntimeException var22) {
                    throw var22;
                } catch (Exception var23) {
                    throw new SQLException(&quot;Error creating connection factory&quot;, var23);
                }

                if (success) {
                    this.createConnectionPool(poolableConnectionFactory);// &#x771F;&#x6B63;&#x7684;&#x521B;&#x5EFA;&#x8FDE;&#x63A5;&#x6C60;&#x7684;&#x90E8;&#x5206;
                }

                success = false;

                DataSource newDataSource;
                try {
                    newDataSource = this.createDataSourceInstance();// &#x518D;&#x521B;&#x5EFA;&#x6570;&#x636E;&#x6E90;
                    newDataSource.setLogWriter(this.logWriter);
                    success = true;
                } catch (SQLException var18) {
                    throw var18;
                } catch (RuntimeException var19) {
                    throw var19;
                } catch (Exception var20) {
                    throw new SQLException(&quot;Error creating datasource&quot;, var20);
                } finally {
                    if (!success) {
                        this.closeConnectionPool();// &#x521B;&#x5EFA;&#x5931;&#x8D25;&#xFF0C;&#x56DE;&#x6EDA;
                    }
                }

                try {
                    for(int i = 0; i &lt; this.initialSize; ++i) {
                        this.connectionPool.addObject();// &#x6839;&#x636E;&#x914D;&#x7F6E;&#xFF0C;&#x521D;&#x59CB;&#x5316;&#x4E00;&#x5B9A;&#x6570;&#x91CF;&#x7684;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;
                    }
                } catch (Exception var25) {
                    this.closeConnectionPool();
                    throw new SQLException(&quot;Error preloading the connection pool&quot;, var25);
                }

                this.startPoolMaintenance();
                this.dataSource = newDataSource;
                return this.dataSource;
            }
        }
    }
}
```
**&#x67E5;&#x770B; `UNPOOLED` &#x7684;&#x5B9E;&#x73B0; `UnpooledDataSource` &#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x6BCF;&#x6B21;&#x83B7;&#x53D6;&#x8FDE;&#x63A5;&#x65F6;&#x90FD;&#x4F1A;&#x6CE8;&#x518C;&#x9A71;&#x52A8;&#x5E76;&#x521B;&#x5EFA;&#x65B0;&#x8FDE;&#x63A5;&#xFF0C;&#x5927;&#x6982;&#x6D41;&#x7A0B;&#x5982;&#x4E0B;&#x56FE;&#xFF08;&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x4ECB;&#x7ECD;&#xFF0C;&#x4E0D;&#x5168;&#x9762;&#xFF09;**

![UnpooledDataSource](https://img-blog.csdnimg.cn/202002031056597.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2ExMDkyODgyNTgw,size_16,color_FFFFFF,t_70#pic_center)

## sqlsession&#x548C;connection

* &#x4E00;&#x4E2A;sqlsession&#x4E00;&#x822C;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;connection&#xFF0C;&#x5E76;&#x4E14;mybatis&#x9ED8;&#x8BA4;&#x6BCF;&#x6B21;&#x83B7;&#x53D6;session&#x90FD;&#x4F1A;&#x5F00;&#x542F;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#xFF0C;&#x4E14;&#x4E0D;&#x81EA;&#x52A8;&#x63D0;&#x4EA4;&#x4E8B;&#x52A1;&#x3002;&#x5982;&#x679C;&#x66F4;&#x65B0;&#x64CD;&#x4F5C;&#x5B8C;&#x6210;&#x540E;&#x4E0D;&#x624B;&#x52A8;commit&#xFF0C;&#x5219;&#x5728;&#x8FDE;&#x63A5;&#x65AD;&#x5F00;&#x65F6;&#x4F1A;&#x5C06;&#x66F4;&#x65B0;&#x64CD;&#x4F5C;&#x56DE;&#x6EDA;&#xFF0C;&#x4E00;&#x4E2A;sqlSession(&#x4E00;&#x4E2A;transaction)&#x4E2D;&#x53EF;&#x4EE5;&#x591A;&#x6B21;commit&#xFF0C;commit&#x540E;cache&#x548C;statement&#x5237;&#x65B0;&#xFF08;&#x4E00;&#x822C;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#xFF08;transaction&#xFF09;&#x53EA;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;sqlseesion&#xFF0C;&#x4E5F;&#x5373;&#x4E00;&#x4E2A;connection&#xFF0C;&#x5206;&#x5E03;&#x5F0F;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#x53EF;&#x4EE5;&#x5BF9;&#x5E94;&#x591A;&#x4E2A;connection&#xFF09;&#xFF0C;&#x53EA;&#x6709;close&#x540E;&#x540C;&#x65F6;&#x5173;&#x95ED;sqlsession&#x548C;transaction&#xFF08;transaction&#x53EF;&#x4EE5;&#x7531;factory&#x5173;&#x95ED;&#xFF09;&#x5E76;&#x8FD4;&#x56DE;connection&#x3002;mybatis&#x7684;transaction&#x57FA;&#x672C;&#x6CA1;&#x6DFB;&#x52A0;&#x4EC0;&#x4E48;&#x529F;&#x80FD;&#xFF0C;&#x5927;&#x90E8;&#x5206;&#x4EC5;&#x72B6;&#x6001;&#x5224;&#x65AD;&#x540E;&#x4EA4;&#x7531;connection&#xFF08;&#x518D;&#x7531;jdbc&#xFF09;&#x6267;&#x884C;&#x3002;&#x53EF;&#x80FD;&#x662F;&#x4E3A;&#x4E86;&#x7ED9;spring&#x7B49;&#x6846;&#x67B6;&#x5BB9;&#x6613;&#x7EC4;&#x8F6C;&#x81EA;&#x5DF1;&#x7684;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x673A;&#x5236;&#x3002;
* mybatis&#x4E00;&#x822C;&#x7531;&#x4E00;&#x4E2A;sqlsession&#x7ECF;&#x8FC7;getmapper&#x5B8C;&#x6210;&#x5BF9;dao&#x7684;&#x591A;&#x6B21;&#x8C03;&#x7528;&#xFF0C;&#x4E4B;&#x540E;&#x518D;commit&#xFF0C;&#x8FD9;&#x4E5F;&#x662F;&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#x80FD;&#x8FD0;&#x884C;&#x7684;&#x539F;&#x56E0;

#### sqlsession&#x4E0E;transaction

**&#xFF08;&#x7B2C;&#x4E00;&#x4E2A;JdbcTransactionFactory&#x3001;&#x7B2C;&#x4E8C;&#x4E2A;defaultsqlsessonfactory&#xFF09;&#xFF1A;**

&#x7528;transactionFactory&#x521B;&#x5EFA;&#x76F8;&#x5E94;&#x7684;transaction&#xFF0C;&#x7528;&#x521B;&#x5EFA;&#x51FA;&#x7684;tx&#x6765;&#x521B;&#x5EFA;executor&#xFF0C;&#x518D;&#x7528;executor&#x548C;&#x914D;&#x7F6E;&#x4FE1;&#x606F;&#x6765;&#x521B;&#x5EFA;defaulSqlsession

```

public class JdbcTransactionFactory implements TransactionFactory {
    public JdbcTransactionFactory() {
    }

    public void setProperties(Properties props) {
    }

    public Transaction newTransaction(Connection conn) {
        return new JdbcTransaction(conn);
    }

    public Transaction newTransaction(DataSource ds, TransactionIsolationLevel level, boolean autoCommit) {
        return new JdbcTransaction(ds, level, autoCommit);
    }
}

```

```
public class DefaultSqlSessionFactory implements SqlSessionFactory {

public SqlSession openSession(ExecutorType execType, Connection connection) {
    return this.openSessionFromConnection(execType, connection);
}
 private SqlSession openSessionFromConnection(ExecutorType execType, Connection connection) {//&#x5206;&#x4E3A;&#x4E24;&#x79CD;&#x521B;&#x5EFA;&#xFF08;dataSource&#x3001;fromConnection&#xFF09;&#xFF0C;&#x4E0E;Spring&#x6574;&#x5408;&#x65F6;transactionFactory&#x7684;&#x5B9E;&#x4F8B;&#x662F;SpringtransactionFactory
        DefaultSqlSession var8;
        try {
            boolean autoCommit;
            try {
                autoCommit = connection.getAutoCommit();
            } catch (SQLException var13) {
                autoCommit = true;
            }

            Environment environment = this.configuration.getEnvironment();
            TransactionFactory transactionFactory = this.getTransactionFactoryFromEnvironment(environment);
            Transaction tx = transactionFactory.newTransaction(connection);
            Executor executor = this.configuration.newExecutor(tx, execType);
            var8 = new DefaultSqlSession(this.configuration, executor, autoCommit);
        } catch (Exception var14) {
            throw ExceptionFactory.wrapException(&quot;Error opening session.  Cause: &quot; + var14, var14);
        } finally {
            ErrorContext.instance().reset();
        }

        return var8;
    }
 private SqlSession openSessionFromConnection(ExecutorType execType, Connection connection) {
        DefaultSqlSession var8;
        try {
            boolean autoCommit;
            try {
                autoCommit = connection.getAutoCommit();
            } catch (SQLException var13) {
                autoCommit = true;
            }

            Environment environment = this.configuration.getEnvironment();
            TransactionFactory transactionFactory = this.getTransactionFactoryFromEnvironment(environment);
            Transaction tx = transactionFactory.newTransaction(connection);
            Executor executor = this.configuration.newExecutor(tx, execType);
            var8 = new DefaultSqlSession(this.configuration, executor, autoCommit);
        } catch (Exception var14) {
            throw ExceptionFactory.wrapException(&quot;Error opening session.  Cause: &quot; + var14, var14);
        } finally {
            ErrorContext.instance().reset();
        }

        return var8;
    }

```

#### sqlsession&#x5BF9;executor&#x7684;&#x8C03;&#x7528;

**&#xFF08;defaultSqlsession&#xFF09;**

  ```
 public class DefaultSqlSession implements SqlSession {

 public <e> List<e> selectList(String statement, Object parameter, RowBounds rowBounds) {
      List var5;
      try {
          MappedStatement ms = this.configuration.getMappedStatement(statement);
          var5 = this.executor.query(ms, this.wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);
      } catch (Exception var9) {
          throw ExceptionFactory.wrapException(&quot;Error querying database.  Cause: &quot; + var9, var9);
      } finally {
          ErrorContext.instance().reset();
      }

      return var5;
  }
  public int update(String statement, Object parameter) {
          int var4;
          try {
              this.dirty = true;
              MappedStatement ms = this.configuration.getMappedStatement(statement);
              var4 = this.executor.update(ms, this.wrapCollection(parameter));
          } catch (Exception var8) {
              throw ExceptionFactory.wrapException(&quot;Error updating database.  Cause: &quot; + var8, var8);
          } finally {
              ErrorContext.instance().reset();
          }

          return var4;
      }
   public void commit(boolean force) {
          try {
              this.executor.commit(this.isCommitOrRollbackRequired(force));
              this.dirty = false;
          } catch (Exception var6) {
              throw ExceptionFactory.wrapException(&quot;Error committing transaction.  Cause: &quot; + var6, var6);
          } finally {
              ErrorContext.instance().reset();
          }

      }

       public void rollback(boolean force) {
          try {
              this.executor.rollback(this.isCommitOrRollbackRequired(force));
              this.dirty = false;
          } catch (Exception var6) {
              throw ExceptionFactory.wrapException(&quot;Error rolling back transaction.  Cause: &quot; + var6, var6);
          } finally {
              ErrorContext.instance().reset();
          }

      }
  ```

* sqlsession&#x65E0;&#x8BBA;&#x6267;&#x884C;sql&#x8BED;&#x53E5;&#x8FD8;&#x662F;&#x5BF9;&#x4E8B;&#x7269;&#x7684;&#x7BA1;&#x7406;&#xFF0C;&#x90FD;&#x4F1A;&#x8F6C;&#x7531;executor&#x6267;&#x884C;

#### executor&#x5BF9;sql&#x7684;&#x6267;&#x884C;

* &#xFF08;simpleExecutor  extends baseExecutor&#xFF09;  sqlsession-&gt;executor-&gt;connection
* &#x7531;configuration&#x4EE5;&#x53CA;&#x53C2;&#x6570;&#x751F;&#x6210;&#x8BED;&#x53E5;&#x5904;&#x7406;&#x5BF9;&#x8C61;  handler&#xFF0C;&#x518D;&#x8C03;&#x7528;preaparement&#x65B9;&#x6CD5;&#x5BF9;handler&#x8FDB;&#x884C;connection&#x7684;&#x83B7;&#x53D6;&#x4E0E;&#x8FDE;&#x63A5;&#xFF08;&#x5F53;&#x7136;&#x4E5F;&#x901A;&#x8FC7;&#x4E86;transaction&#xFF0C;&#x7528;&#x7684;&#x662F;&#x7236;&#x7C7B;baseEexcutor&#x7684;&#x65B9;&#x6CD5;&#xFF09;
* &#x4E4B;&#x540E;&#x5C06;&#x64CD;&#x4F5C;&#x90FD;&#x4EA4;&#x7ED9;&#x4E86;handler&#xFF0C;&#x7ECF;&#x8FC7;&#x5B9E;&#x73B0;&#x4E86;statementhandler&#x63A5;&#x53E3;&#x7684;RoutingStatementHandler-&gt;PreparedStatementHandler(extends BaseStatementHandler)&#x4E4B;&#x540E;&#x7684;preparedstatement&#x7B49;statement&#x540E;&#xFF0C;&#x4FBF;&#x662F;jdbc&#x7684;excute&#x64CD;&#x4F5C;&#x4E0E;result&#x7684;&#x5C01;&#x88C5;
* &#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#x7684;&#x53D1;&#x751F;&#x4E5F;&#x5728;&#x5904;&#x7406;&#x540E;&#x53D1;&#x751F;

```
public class SimpleExecutor extends BaseExecutor {
    public SimpleExecutor(Configuration configuration, Transaction transaction) {
        super(configuration, transaction);
    }

    public int doUpdate(MappedStatement ms, Object parameter) throws SQLException {
        Statement stmt = null;

        int var6;
        try {
            Configuration configuration = ms.getConfiguration();
            StatementHandler handler = configuration.newStatementHandler(this, ms, parameter, RowBounds.DEFAULT, (ResultHandler)null, (BoundSql)null);
            stmt = this.prepareStatement(handler, ms.getStatementLog());
            var6 = handler.update(stmt);
        } finally {
            this.closeStatement(stmt);
        }

        return var6;
    }

    public <e> List<e> doQuery(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql) throws SQLException {
        Statement stmt = null;

        List var9;
        try {
            Configuration configuration = ms.getConfiguration();
            StatementHandler handler = configuration.newStatementHandler(this.wrapper, ms, parameter, rowBounds, resultHandler, boundSql);
            stmt = this.prepareStatement(handler, ms.getStatementLog());
            var9 = handler.query(stmt, resultHandler);
        } finally {
            this.closeStatement(stmt);
        }

        return var9;
    }

     private Statement prepareStatement(StatementHandler handler, Log statementLog) throws SQLException {
        Connection connection = this.getConnection(statementLog);
        Statement stmt = handler.prepare(connection, this.transaction.getTimeout());
        handler.parameterize(stmt);
        return stmt;
    }
```

```
public abstract class BaseExecutor implements Executor {

protected Connection getConnection(Log statementLog) throws SQLException {
    Connection connection = this.transaction.getConnection();
    return statementLog.isDebugEnabled() ? ConnectionLogger.newInstance(connection, statementLog, this.queryStack) : connection;
}
}
```

#### executor&#x5BF9;&#x4E8B;&#x52A1;&#x7684;&#x5904;&#x7406;

* &#x7531;simpleExecutor&#x5BF9;&#x8C61;&#x5904;&#x7406;&#xFF0C;&#x4F46;&#x7528;&#x7684;&#x65B9;&#x6CD5;&#x90FD;&#x7EE7;&#x627F;&#x81EA;baseExecutor
* sqlsession(&#x5E26;&#x7740;&#x5728;sqlsessionfactory&#x521B;&#x5EFA;&#x7684;transaction)-&gt;executor(transaction)-&gt;transaction.commit/close&#xB7;&#xB7;&#xB7;&#xB7;&#xB7;
* executor &#x5C06;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x4EA4;&#x7ED9;&#x4E86; transaction&#xFF0C;commit/rollback&#x7B49;&#x5BF9;cache&#x548C;statement&#x7684;&#x6E05;&#x7A7A;&#xFF08;clearLocalCache&#xFF0C;flushStatements&#xFF09;&#x4E5F;&#x5728;&#x8FD9;&#x91CC;&#x5F00;&#x59CB;&#x8FDB;&#x884C;&#x3002;
* **&#x5728;sqlsession&#x7684;close&#x524D;&#xFF0C;&#x5BF9;sql&#x8BED;&#x53E5;&#x7684;&#x6267;&#x884C;&#x90FD;&#x4F1A;&#x7528;getConnection&#x521B;&#x5EFA;&#x7684;&#x8FDE;&#x63A5;&#x8FDB;&#x884C;sql&#x8BED;&#x53E5;&#x7684;&#x6267;&#x884C;&#xFF0C;commit&#x4E5F;&#x5E76;&#x4E0D;&#x4F1A;&#x8BF4;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#xFF08;transaction&#xFF09;&#xFF0C;&#x800C;&#x662F;&#x6E05;&#x7A7A;cache&#x548C;statement&#x5E76;&#x63D0;&#x4EA4;jdbc&#x6267;&#x884C;&#x540E;&#x7684;&#x7ED3;&#x679C;&#x5230;mysql&#x3002;&#x6B64;&#x65F6;&#x4ECD;&#x53EF;&#x4EE5;&#x7528;commit&#x540E;&#x7684;sqlsession&#x548C;transaction&#x8FDB;&#x884C;getMapper&#x4EE3;&#x7406;&#x5E76;&#x8C03;&#x7528;&#x63A5;&#x53E3;&#x65B9;&#x6CD5;&#xFF0C;&#x53EA;&#x6709;close&#x540E;&#x4E24;&#x8005;&#x624D;&#x4F1A;&#x6D88;&#x5931;**

```
public class SimpleExecutor extends BaseExecutor {

public Transaction getTransaction() {
    if (this.closed) {
        throw new ExecutorException(&quot;Executor was closed.&quot;);
    } else {
        return this.transaction;
    }
}

public void close(boolean forceRollback) {
    try {
        try {
            this.rollback(forceRollback);
        } finally {
            if (this.transaction != null) {
                this.transaction.close();
            }

        }
    } catch (SQLException var11) {
        log.warn(&quot;Unexpected exception on closing transaction.  Cause: &quot; + var11);
    } finally {
        this.transaction = null;
        this.deferredLoads = null;
        this.localCache = null;
        this.localOutputParameterCache = null;
        this.closed = true;
    }

}
public void commit(boolean required) throws SQLException {
        if (this.closed) {
            throw new ExecutorException(&quot;Cannot commit, transaction is already closed&quot;);
        } else {
            this.clearLocalCache();
            this.flushStatements();
            if (required) {
                this.transaction.commit();
            }

        }
    }
 public void rollback(boolean required) throws SQLException {
        if (!this.closed) {
            try {
                this.clearLocalCache();
                this.flushStatements(true);
            } finally {
                if (required) {
                    this.transaction.rollback();
                }

            }
        }

    }

public void clearLocalCache() {
        if (!this.closed) {
            this.localCache.clear();
            this.localOutputParameterCache.clear();
        }

    }
```

#### transaction&#x5230;connection

* JdbcTransaction
* &#x7531;transaction&#x5BF9;&#x4E0E;connection &#x7684;commit/colse&#x8FDB;&#x884C;&#x7BA1;&#x7406;&#x3002;

```java
public class JdbcTransaction implements Transaction {


public JdbcTransaction(Connection connection) {
    this.connection = connection;
}

public Connection getConnection() throws SQLException {
    if (this.connection == null) {
        this.openConnection();
    }

    return this.connection;
}

public void commit() throws SQLException {
    if (this.connection != null &amp;&amp; !this.connection.getAutoCommit()) {
        if (log.isDebugEnabled()) {
            log.debug(&quot;Committing JDBC Connection [&quot; + this.connection + &quot;]&quot;);
        }

        this.connection.commit();
    }

}

public void rollback() throws SQLException {
    if (this.connection != null &amp;&amp; !this.connection.getAutoCommit()) {
        if (log.isDebugEnabled()) {
            log.debug(&quot;Rolling back JDBC Connection [&quot; + this.connection + &quot;]&quot;);
        }

        this.connection.rollback();
    }

}

public void close() throws SQLException {
    if (this.connection != null) {
        this.resetAutoCommit();
        if (log.isDebugEnabled()) {
            log.debug(&quot;Closing JDBC Connection [&quot; + this.connection + &quot;]&quot;);
        }

        this.connection.close();
    }

}
}
```

#### connection

* connectionImp&#x7C7B;
* &#x4ECE;&#x8FD9;&#x5F00;&#x59CB;&#x4FBF;&#x662F;com.mysql.jdbc&#x5305;&#x7684;&#x4E1C;&#x897F;&#x4E86;&#xFF0C;&#x5C31;&#x662F;&#x4E0E;&#x6570;&#x636E;&#x5E93;&#x76F4;&#x63A5;&#x8FDB;&#x884C;&#x4EA4;&#x63A5;&#x7684;&#x90E8;&#x5206;&#x4E86;

```java
public class ConnectionImpl extends ConnectionPropertiesImpl implements Connection {

public void commit() throws SQLException {
    synchronized(this.getMutex()) {
        this.checkClosed();

        try {
            if (this.connectionLifecycleInterceptors != null) {
                IterateBlock iter = new IterateBlock(this.connectionLifecycleInterceptors.iterator()) {
                    void forEach(Object each) throws SQLException {
                        if (!((ConnectionLifecycleInterceptor)each).commit()) {
                            this.stopIterating = true;
                        }

                    }
                };
                iter.doForAll();
                if (!iter.fullIteration()) {
                    return;
                }
            }

            if (this.autoCommit &amp;&amp; !this.getRelaxAutoCommit()) {
                throw SQLError.createSQLException(&quot;Can&apos;t call commit when autocommit=true&quot;);
            }

            if (this.transactionsSupported) {
                if (this.getUseLocalSessionState() &amp;&amp; this.versionMeetsMinimum(5, 0, 0) &amp;&amp; !this.io.inTransactionOnServer()) {
                    return;
                }

                this.execSQL((StatementImpl)null, &quot;commit&quot;, -1, (Buffer)null, 1003, 1007, false, this.database, (Field[])null, false);
            }
        } catch (SQLException var8) {
            if (&quot;08S01&quot;.equals(var8.getSQLState())) {
                throw SQLError.createSQLException(&quot;Communications link failure during commit(). Transaction resolution unknown.&quot;, &quot;08007&quot;);
            }

            throw var8;
        } finally {
            this.needsPing = this.getReconnectAtTxEnd();
        }

    }
}
}
```








![&#x5728;&#x8FD9;&#x91CC;&#x63D2;&#x5165;&#x56FE;&#x7247;&#x63CF;&#x8FF0;](https://img-blog.csdnimg.cn/20200621235803927.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjQ5MDM4Mw==,size_16,color_FFFFFF,t_70)

## &#x591A;&#x8868;&#x67E5;&#x8BE2;

1. &#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x63A5;&#x6536;&#x591A;&#x8868;&#x6D88;&#x606F;&#x7684;&#x5B9E;&#x4F53;&#x7C7B;

2. &#x4E00;&#x5BF9;&#x4E00;&#xFF1A;&#x5EFA;&#x7ACB;&#x4E24;&#x8005;&#x7684;&#x8868;&#xFF0C;&#x5728;**&#x4E00;**&#x4E2D;&#x7684;&#x5B9E;&#x4F53;&#x7C7B;&#x6DFB;&#x52A0;**&#x4E00;**&#x7684;&#x7C7B;&#x4E3A;&#x6210;&#x5458;&#x53D8;&#x91CF;&#xFF0C;&#x4F7F;&#x7528;resultmap&#x6620;&#x5C04;&#x3002;

   &#x4E00;&#x5BF9;&#x591A;&#xFF1A; &#x5EFA;&#x7ACB;&#x4E24;&#x8005;&#x7684;&#x8868;&#xFF0C;&#x5B9E;&#x4F53;&#x7C7B;&#x4E0A;&#x8F6C;&#x6362;&#x6210;&#x76F8;&#x5E94;&#x7684;&#x4E00;&#x5BF9;&#x591A;&#x7684;&#x5173;&#x7CFB;&#xFF0C;&#x5728;**&#x4E00;**&#x4E2D;&#x7684;&#x5B9E;&#x4F53;&#x7C7B;&#x6DFB;&#x52A0;**&#x591A;**&#x7684;&#x7C7B;&#x4E3A;&#x6210;&#x5458;&#x53D8;&#x91CF;&#xFF0C;&#x4F7F;&#x7528;resultmap&#x6620;&#x5C04;&#x3002;

   &#x591A;&#x5BF9;&#x591A;&#xFF1A; &#x5EFA;&#x7ACB;&#x4E24;&#x8005;&#x7684;&#x8868;&#x5E76;&#x5EFA;&#x7ACB;&#x4E2D;&#x95F4;&#x8868;&#xFF0C;&#x5B9E;&#x4F53;&#x7C7B;(&#x4E0E;&#x4E00;&#x5BF9;&#x591A;&#x4E00;&#x81F4;)&#x8F6C;&#x6362;&#x6210;&#x76F8;&#x5E94;&#x7684;&#x4E00;&#x5BF9;&#x591A;&#x7684;&#x5173;&#x7CFB;&#xFF0C;&#x5728;**&#x4E00;**&#x4E2D;&#x7684;&#x5B9E;&#x4F53;&#x7C7B;&#x6DFB;&#x52A0;**&#x591A;**&#x7684;&#x7C7B;&#x4E3A;&#x6210;&#x5458;&#x53D8;&#x91CF;&#xFF0C;&#x4F7F;&#x7528;resultmap&#x6620;&#x5C04;(&#x4E0E;&#x4E00;&#x5BF9;&#x591A;&#x4E00;&#x81F4;)&#xFF0C;&#x4E2D;&#x95F4;&#x8868;&#x88AB;sql&#x8BED;&#x53E5;&#x4E2D;&#x7528;&#x6765;&#x4E0E;&#x5176;&#x4ED6;sql&#x5173;&#x952E;&#x5B57;&#x548C;&#x51FD;&#x6570;&#x8FDB;&#x884C;&#x8868;&#x7684;&#x62FC;&#x63A5;



###### &#x4E00;&#x5BF9;&#x4E00;

**&#x9996;&#x5148;&#x7F16;&#x5199; SQL &#x8BED;&#x53E5;&#xFF0C;&#x5982;&#x679C;&#x60F3;&#x8981;&#x8FBE;&#x5230;&#x4E0A;&#x8FF0;&#x6548;&#x679C;&#xFF0C;&#x90A3;&#x4E48; SQL &#x8BED;&#x53E5;&#x53EF;&#x4EE5;&#x8FD9;&#x6837;&#x5199;&#xFF1A;**

```
SELECT U.*, a.id AS aid, a.uid, a.money from account a, user u WHERE a.uid = u.id;
```

- **&#x4E3A;&#x4E86;&#x53EF;&#x4EE5;&#x63A5;&#x6536;&#x8FD9;&#x6761;&#x8BED;&#x53E5;&#x7684;&#x67E5;&#x8BE2;&#x7ED3;&#x679C;&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x5E94;&#x8BE5;&#x5BF9;&#x8D26;&#x6237;&#x5B9E;&#x4F53;&#x7C7B; `Account` &#x8FDB;&#x884C;&#x4FEE;&#x6539;&#xFF0C;&#x4E3A;&#x5176;&#x589E;&#x52A0;&#x6210;&#x5458;&#x53D8;&#x91CF; `User` &#x6765;&#x63A5;&#x6536;&#x67E5;&#x8BE2;&#x51FA;&#x7684;&#x7528;&#x6237;&#x4FE1;&#x606F;&#xFF08;&#x4ECE;&#x8868;&#x5B9E;&#x4F53;&#x5E94;&#x8BE5;&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x4E3B;&#x8868;&#x5B9E;&#x4F53;&#x7684;&#x5BF9;&#x8C61;&#x5F15;&#x7528;&#xFF09;&#xFF1A;**

```
public class Account implements Serializable {
    // &#x5176;&#x4ED6;&#x6210;&#x5458;&#x4E0D;&#x5C55;&#x793A;...

    /**
     * &#x8D26;&#x6237;&#x5BF9;&#x5E94;&#x7684;&#x7528;&#x6237;&#x4FE1;&#x606F;,&#x4ECE;&#x8868;&#x5B9E;&#x4F53;&#x5E94;&#x8BE5;&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x4E3B;&#x8868;&#x5B9E;&#x4F53;&#x7684;&#x5BF9;&#x8C61;&#x5F15;&#x7528;
     */
    private User user;

    public User getUser() {
        return user;
    }

    public void setUser(User user) {
        this.user = user;
    }

    // &#x5176;&#x4ED6;setter()/getter()&#x4E0D;&#x5C55;&#x793A;...

    @Override
    public String toString() {
        return &quot;Account{&quot; +
                &quot;id=&quot; + id +
                &quot;, uid=&quot; + uid +
                &quot;, money=&quot; + money +
                &quot;, user=&quot; + user +
                &apos;}&apos;;
    }
```
* &#x56E0;&#x4E3A;&#x6B64;&#x65F6;&#x8D26;&#x6237;&#x5B9E;&#x4F53;&#x7C7B; Account &#x5DF2;&#x7ECF;&#x53D1;&#x751F;&#x4E86;&#x53D8;&#x5316;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5E94;&#x8BE5;&#x5728;&#x6620;&#x5C04;&#x6587;&#x4EF6;&#x5B9A;&#x4E49;&#x7528;&#x4E8E;&#x5C01;&#x88C5;&#x5E26;&#x6709; User &#x4FE1;&#x606F;&#x7684; Account &#x7684;&#x6620;&#x5C04;&#x96C6;&#x5408;resultMap

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.ykf.mapper.AccountMapper">
    <!-- 定义可以封装带有User的Account的 resultMap -->
    <resultmap id="AccountWithUserMap" type="cn.ykf.pojo.Account">
        <id property="id" column="aid">
        <result property="uid" column="uid">
        <result property="money" column="money">
        <!-- 关联 User 对象 -->
        <association property="user" javatype="cn.ykf.pojo.User">
            <id property="id" column="id">
            <result property="username" column="username">
            <result property="sex" column="sex">
            <result property="birthday" column="birthday">
            <result property="address" column="address">
        </result></result></result></result></id></association>
    </result></result></id></resultmap>
    <!-- 配置查询所有账户，带有用户信息 -->
    <select id="listAllAccounts" resultmap="AccountWithUserMap">
        SELECT U.*, a.id AS aid, a.uid, a.money from account a, user u WHERE a.uid = u.id
    </select>
</mapper>
<association></association> &#x7528;&#x4E8E;&#x4E00;&#x5BF9;&#x4E00;&#x6620;&#x5C04;&#xFF0C;&#x5176;&#x4E2D;&#x7684; property &#x5C5E;&#x6027;&#x8868;&#x793A;&#x8981;&#x5173;&#x8054;&#x7684;&#x5C5E;&#x6027;&#xFF0C;javaType &#x8868;&#x793A;&#x5F85;&#x5173;&#x8054;&#x7684;&#x5B9E;&#x4F53;&#x7C7B;&#x7684;&#x5168;&#x9650;&#x5B9A;&#x7C7B;&#x540D;&#x3002;
&#x6CE8;&#x610F;&#xFF0C;&#x56E0;&#x4E3A; SQL &#x8BED;&#x53E5;&#x4E2D;&#x4E3A; account &#x8868;&#x7684; id &#x5B57;&#x6BB5;&#x8D77;&#x4E86;&#x522B;&#x540D; aid &#xFF0C;&#x6240;&#x4EE5;&#x5728;&#x5B9A;&#x4E49; resultMap &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x8BB0;&#x5F97;&#x4E3B;&#x5B57;&#x6BB5;&#x5199; column=&quot;aid&quot;&#xFF0C;&#x800C;&#x4E0D;&#x662F; column=&quot;id&quot;&#x3002;
```

###### &#x4E00;&#x5BF9;&#x591A;

- **&#x6211;&#x4EEC;&#x5E94;&#x8BE5;&#x91C7;&#x7528;&#x5916;&#x8FDE;&#x63A5;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x4F7F;&#x5F97;&#x6CA1;&#x6709;&#x8D26;&#x6237;&#x7684;&#x7528;&#x6237;&#x4E5F;&#x53EF;&#x4EE5;&#x67E5;&#x8BE2;&#x51FA;&#x6765;&#xFF1A;**

```
SELECT u.*, a.id AS aid, a.uid, a.money FROM user u LEFT OUTER JOIN account a ON u.id = a.uid;
```

- **&#x4E3A;&#x4E86;&#x53EF;&#x4EE5;&#x63A5;&#x6536;&#x8FD9;&#x6761;&#x8BED;&#x53E5;&#x7684;&#x67E5;&#x8BE2;&#x7ED3;&#x679C;&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x5E94;&#x8BE5;&#x5BF9;&#x7528;&#x6237;&#x5B9E;&#x4F53;&#x7C7B; `User` &#x8FDB;&#x884C;&#x4FEE;&#x6539;&#xFF0C;&#x4E3A;&#x5176;&#x589E;&#x52A0;&#x6210;&#x5458;&#x53D8;&#x91CF; `accounts` &#x6765;&#x63A5;&#x6536;&#x67E5;&#x8BE2;&#x51FA;&#x7684;&#x8D26;&#x6237;&#x4FE1;&#x606F;&#xFF08;&#x4E3B;&#x8868;&#x5B9E;&#x4F53;&#x5E94;&#x8BE5;&#x5305;&#x542B;&#x4ECE;&#x8868;&#x5B9E;&#x4F53;&#x7684;&#x96C6;&#x5408;&#x5F15;&#x7528;&#xFF09;&#xFF1A;**

```java
public class User implements Serializable {
    // &#x5176;&#x4ED6;&#x6210;&#x5458;&#x7701;&#x7565;&#x4E0D;&#x5C55;&#x793A;...

    /**
     * &#x4E00;&#x5BF9;&#x591A;&#x5173;&#x7CFB;&#x6620;&#x5C04;&#xFF1A;&#x4E3B;&#x8868;&#x5B9E;&#x4F53;&#x5E94;&#x8BE5;&#x5305;&#x542B;&#x4ECE;&#x8868;&#x5B9E;&#x4F53;&#x7684;&#x96C6;&#x5408;&#x5F15;&#x7528;
     */
    private List<account> accounts;

    public List<account> getAccounts() {
        return accounts;
    }

    public void setAccounts(List<account> accounts) {
        this.accounts = accounts;
    }

    // &#x5176;&#x4ED6;setter()/getter()&#x7701;&#x7565;&#x4E0D;&#x5C55;&#x793A;...

    @Override
    public String toString() {
        return &quot;User{&quot; +
                &quot;id=&quot; + id +
                &quot;, username=&apos;&quot; + username + &apos;\&apos;&apos; +
                &quot;, birthday=&quot; + birthday +
                &quot;, sex=&apos;&quot; + sex + &apos;\&apos;&apos; +
                &quot;, address=&apos;&quot; + address + &apos;\&apos;&apos; +
                &quot;, accounts=&quot; + accounts +
                &apos;}&apos;;
    }
```

- **&#x4FEE;&#x6539;&#x6620;&#x5C04;&#x6587;&#x4EF6;**

```
<mapper namespace="cn.ykf.mapper.UserMapper">
    <!-- 配置 resultMap ，完成实体类与数据库表的映射 -->
    <resultmap id="UserWithAccountsMap" type="cn.ykf.pojo.User">
        <id property="id" column="id">
        <result property="username" column="username">
        <result property="sex" column="sex">
        <result property="birthday" column="birthday">
        <result property="address" column="address">
        <!-- 配置user对象中accounts集合的映射 -->
        <collection property="accounts" oftype="cn.ykf.pojo.Account">
            <id property="id" column="aid">
            <result property="uid" column="uid">
            <result property="money" column="money">
        </result></result></id></collection>
    </result></result></result></result></id></resultmap>
    <!-- 配置查询所有用户，并且带有账户信息 -->
    <select id="listAllUsers" resultmap="UserWithAccountsMap">
        SELECT u.*, a.id AS aid, a.uid, a.money FROM user u LEFT OUTER JOIN account a ON u.id = a.uid;
    </select>
</mapper>
<collection></collection> &#x7528;&#x4E8E;&#x4E00;&#x5BF9;&#x591A;&#x6620;&#x5C04;&#xFF0C;&#x5176;&#x4E2D;&#x7684; property &#x5C5E;&#x6027;&#x8868;&#x793A;&#x8981;&#x5173;&#x8054;&#x7684;&#x96C6;&#x5408;&#xFF0C;ofType &#x8868;&#x793A;&#x96C6;&#x5408;&#x4E2D;&#x7684;&#x5B9E;&#x4F53;&#x7C7B;&#x7684;&#x5168;&#x9650;&#x5B9A;&#x7C7B;&#x540D;&#x3002;

```

###### &#x591A;&#x5BF9;&#x591A;

- **&#x4FEE;&#x6539;&#x7528;&#x6237;&#x5B9E;&#x4F53;&#x7C7B; `User` &#xFF0C;&#x5E76;&#x6DFB;&#x52A0;&#x89D2;&#x8272;&#x5B9E;&#x4F53;&#x7C7B; `Role`&#xFF0C;&#x4E3A;&#x4E86;&#x80FD;&#x4F53;&#x73B0;&#x51FA;&#x591A;&#x5BF9;&#x591A;&#x7684;&#x5173;&#x7CFB;&#xFF0C;&#x4E24;&#x4E2A;&#x5B9E;&#x4F53;&#x7C7B;&#x90FD;&#x5FC5;&#x987B;&#x5305;&#x542B;&#x5BF9;&#x65B9;&#x7684;&#x4E00;&#x4E2A;&#x96C6;&#x5408;&#x5F15;&#x7528;&#xFF08;&#x591A;&#x5BF9;&#x591A;&#x5173;&#x7CFB;&#x5176;&#x5B9E;&#x6211;&#x4EEC;&#x770B;&#x6210;&#x662F;&#x53CC;&#x5411;&#x7684;&#x4E00;&#x5BF9;&#x591A;&#x5173;&#x7CFB;&#xFF09;**

```java
public class User implements Serializable {
    /**
     * &#x591A;&#x5BF9;&#x591A;&#x5173;&#x7CFB;&#x6620;&#x5C04;&#xFF1A;&#x5305;&#x542B;&#x5BF9;&#x65B9;&#x7684;&#x96C6;&#x5408;&#x5F15;&#x7528;
     */
    private List<role> roles;

    public List<role> getRoles() {
        return roles;
    }

    public void setRoles(List<role> roles) {
        this.roles = roles;
    }

    @Override
    public String toString() {
        return &quot;User{&quot; +
                &quot;id=&quot; + id +
                &quot;, username=&apos;&quot; + username + &apos;\&apos;&apos; +
                &quot;, birthday=&quot; + birthday +
                &quot;, sex=&apos;&quot; + sex + &apos;\&apos;&apos; +
                &quot;, address=&apos;&quot; + address + &apos;\&apos;&apos; +
                &quot;, accounts=&quot; + accounts +
                &quot;, roles=&quot; + roles +
                &apos;}&apos;;
       }
```

```
public class Role implements Serializable {
    private Integer roleId;
    private String roleName;
    private String roleDesc;
    /**
     * &#x591A;&#x5BF9;&#x591A;&#x5173;&#x7CFB;&#x6620;&#x5C04;&#xFF1A;&#x6301;&#x6709;&#x5BF9;&#x65B9;&#x96C6;&#x5408;&#x5F15;&#x7528;
     */
    private List<user> users;

    public List<user> getUsers() {
        return users;
    }

    public void setUsers(List<user> users) {
        this.users = users;
    }

    public Integer getRoleId() {
        return roleId;
    }

    public void setRoleId(Integer roleId) {
        this.roleId = roleId;
    }

    public String getRoleName() {
        return roleName;
    }

    public void setRoleName(String roleName) {
        this.roleName = roleName;
    }

    public String getRoleDesc() {
        return roleDesc;
    }

    public void setRoleDesc(String roleDesc) {
        this.roleDesc = roleDesc;
    }

    @Override
    public String toString() {
        return &quot;Role{&quot; +
                &quot;roleId=&quot; + roleId +
                &quot;, roleName=&apos;&quot; + roleName + &apos;\&apos;&apos; +
                &quot;, roleDesc=&apos;&quot; + roleDesc + &apos;\&apos;&apos; +
                &quot;, users=&quot; + users +
                &apos;}&apos;;
    }
}
```

- **&#x4E3A;&#x4E86;&#x786E;&#x4FDD;&#x6240;&#x6709;&#x7528;&#x6237;&#xFF08;&#x65E0;&#x8BBA;&#x662F;&#x5426;&#x5177;&#x6709;&#x89D2;&#x8272;&#xFF09;&#x90FD;&#x53EF;&#x4EE5;&#x88AB;&#x67E5;&#x8BE2;&#x51FA;&#x6765;&#xFF0C;&#x5E94;&#x8BE5;&#x4F7F;&#x7528;&#x5DE6;&#x8FDE;&#x63A5;**

```SELECT u.*, r.id as rid, r.role_name, r.role_desc FROM user u
SELECT u.*, r.id as rid, r.role_name, r.role_desc FROM user u
    LEFT OUTER JOIN user_role ur ON u.id = ur.uid
    LEFT OUTER JOIN role r ON ur.rid = r.id;

```

- **&#x5F00;&#x59CB;&#x7F16;&#x5199;&#x63A5;&#x53E3;&#x5C42;&#x548C;&#x6620;&#x5C04;&#x6587;&#x4EF6;**

```
/**
 * &#x67E5;&#x8BE2;&#x6240;&#x6709;&#x7528;&#x6237;&#x4FE1;&#x606F;&#xFF0C;&#x5305;&#x542B;&#x7528;&#x6237;&#x6240;&#x62E5;&#x6709;&#x7684;&#x89D2;&#x8272;&#x4FE1;&#x606F;
 * @return
 */
List<user> listUsersWithRoles();
```

```
<mapper namespace="cn.ykf.mapper.UserMapper">
    <resultmap id="UserWithRolesMap" type="cn.ykf.pojo.User">
        <id property="id" column="id">
        <result property="username" column="username">
        <result property="sex" column="sex">
        <result property="birthday" column="birthday">
        <result property="address" column="address">
        <!-- 配置user对象中roles集合的映射 -->
        <collection property="roles" oftype="cn.ykf.pojo.Role">
            <id property="roleId" column="rid">
            <result property="roleName" column="role_name">
            <result property="roleDesc" column="role_desc">
        </result></result></id></collection>
    </result></result></result></result></id></resultmap>
    <!-- 查询所有用户，并且带有角色信息 -->
    <select id="listUsersWithRoles" resultmap="UserWithRolesMap">
        SELECT u.*, r.id as rid, r.role_name, r.role_desc FROM user u
            LEFT OUTER JOIN user_role ur ON u.id = ur.uid
            LEFT OUTER JOIN role r ON ur.rid = r.id
    </select>
</mapper>
```

## &#x52A0;&#x8F7D;

###  &#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x548C;&#x7ACB;&#x5373;&#x52A0;&#x8F7D;

&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x9488;&#x5BF9;&#x7EA7;&#x8054;&#x4F7F;&#x7528;&#x7684;&#xFF0C;&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x7684;&#x76EE;&#x7684;&#x662F;&#x51CF;&#x5C11;&#x5185;&#x5B58;&#x7684;&#x6D6A;&#x8D39;&#x548C;&#x51CF;&#x8F7B;&#x7CFB;&#x7EDF;&#x8D1F;&#x62C5;&#x3002;



**&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x9700;&#x8981;&#x7684;&#x914D;&#x7F6E;&#xFF1A;**

| &#x8BBE;&#x7F6E;&#x53C2;&#x6570;               | &#x63CF;&#x8FF0;                                                         | &#x6709;&#x6548;&#x503C;                 | &#x9ED8;&#x8BA4;&#x503C;                         |
| ---------------------- | ------------------------------------------------------------ | ---------------------- | ------------------------------ |
| lazyLoadingEnabled     | &#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x7684;&#x5168;&#x5C40;&#x5F00;&#x5173;&#x3002;&#x5F53;&#x5F00;&#x542F;&#x65F6;&#xFF0C;&#x6240;&#x6709;&#x5173;&#x8054;&#x5BF9;&#x8C61;&#x90FD;&#x4F1A;&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x3002; &#x7279;&#x5B9A;&#x5173;&#x8054;&#x5173;&#x7CFB;&#x4E2D;&#x53EF;&#x901A;&#x8FC7;&#x8BBE;&#x7F6E;fetchType&#x5C5E;&#x6027;&#x6765;&#x8986;&#x76D6;&#x8BE5;&#x9879;&#x7684;&#x5F00;&#x5173;&#x72B6;&#x6001;&#x3002; | true&#x3001;false            | false                          |
| aggressiveLazyLoading  | &#x5F53;&#x5F00;&#x542F;&#x65F6;&#xFF0C;&#x4EFB;&#x4F55;&#x65B9;&#x6CD5;&#x7684;&#x8C03;&#x7528;&#x90FD;&#x4F1A;&#x52A0;&#x8F7D;&#x8BE5;&#x5BF9;&#x8C61;&#x7684;&#x6240;&#x6709;&#x5C5E;&#x6027;&#x3002;&#x5426;&#x5219;&#xFF0C;&#x6BCF;&#x4E2A;&#x5C5E;&#x6027;&#x4F1A;&#x6309;&#x9700;&#x52A0;&#x8F7D;&#xFF08;&#x53C2;&#x8003;lazyLoadTriggerMethods). | true&#x3001;false            | false (true in &#x2264;3.4.1)         |
| lazyLoadTriggerMethods | &#x6307;&#x5B9A;&#x54EA;&#x4E2A;&#x5BF9;&#x8C61;&#x7684;&#x65B9;&#x6CD5;&#x89E6;&#x53D1;&#x4E00;&#x6B21;&#x5168;&#x90E8;&#x5C5E;&#x6027;&#x52A0;&#x8F7D;&#x3002;                     | &#x7528;&#x9017;&#x53F7;&#x5206;&#x9694;&#x7684;&#x65B9;&#x6CD5;&#x5217;&#x8868;&#x3002; | equals,clone,hashCode,toString |

```xml
<configuration>
    <settings>
        <!-- 开启延迟加载 -->
        <setting name="lazyLoadingEnabled" value="true">
        <setting name="aggressiveLazyLoading" value="false">
        <setting name="lazyLoadTriggerMethods" value="equals,clone,hashCode,toString">
      </setting></setting></setting></settings>
</configuration>

<pre><code>
**&#x5F00;&#x542F;&#x61D2;&#x52A0;&#x8F7D;&#x4E00;&#x5B9A;&#x8981;&#x4E24;&#x4E2A;&#x5C5E;&#x6027;&#x90FD;&#x914D;&#x7F6E;&#x5417;&#xFF1F;**
&#x4E0D;&#x662F;&#x7684;&#xFF0C;&#x771F;&#x6B63;&#x5F00;&#x542F;&#x61D2;&#x52A0;&#x8F7D;&#x6807;&#x7B7E;&#x7684;&#x53EA;&#x662F;lazyLoadingEnabled&#xFF1A;true&#x8868;&#x793A;&#x5F00;&#x542F;&#xFF0C;false&#x8868;&#x793A;&#x5173;&#x95ED;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;false&#x3002;
**&#x5982;&#x679C;&#x6211;&#x4E0D;&#x60F3;&#x5C06;&#x5168;&#x90E8;&#x7684;&#x7EA7;&#x8054;&#x90FD;&#x8BBE;&#x8BA1;&#x61D2;&#x52A0;&#x8F7D;&#x600E;&#x4E48;&#x529E;&#xFF1F;**
association&#x548C;collection&#x6709;&#x4E2A;fetchType&#x5C5E;&#x6027;&#x53EF;&#x4EE5;&#x8986;&#x76D6;&#x5168;&#x5C40;&#x7684;&#x61D2;&#x52A0;&#x8F7D;&#x72B6;&#x6001;&#xFF1A;eager&#x8868;&#x793A;&#x8FD9;&#x4E2A;&#x7EA7;&#x8054;&#x4E0D;&#x4F7F;&#x7528;&#x61D2;&#x52A0;&#x8F7D;&#x8981;&#x7ACB;&#x5373;&#x52A0;&#x8F7D;&#xFF0C;lazy&#x8868;&#x793A;&#x4F7F;&#x7528;&#x61D2;&#x52A0;&#x8F7D;&#x3002;

**&#x65E2;&#x7136;fetchType&#x53EF;&#x4EE5;&#x63A7;&#x5236;&#x61D2;&#x52A0;&#x8F7D;&#x90A3;&#x4E48;&#x6211;&#x4EC5;&#x4EC5;&#x914D;&#x7F6E;fetchType&#x4E0D;&#x914D;&#x7F6E;&#x5168;&#x5C40;&#x7684;&#x53EF;&#x4EE5;&#x5417;&#xFF1F;**
&#x53EF;&#x4EE5;&#x7684;&#x3002;
**aggressiveLazyLoading&#x662F;&#x505A;&#x4EC0;&#x4E48;&#x4E48;&#x7684;&#xFF1F;**
&#x5B83;&#x662F;&#x63A7;&#x5236;&#x5177;&#x6709;&#x61D2;&#x52A0;&#x8F7D;&#x7279;&#x6027;&#x7684;&#x5BF9;&#x8C61;&#x7684;&#x5C5E;&#x6027;&#x7684;&#x52A0;&#x8F7D;&#x60C5;&#x51B5;&#x7684;&#x3002;(&#x61D2;&#x52A0;&#x8F7D;&#x5BF9;&#x8C61;&#x5728;&#x88AB;&#x8C03;&#x7528;&#x65B9;&#x6CD5;&#x6216;&#x5C5E;&#x6027;&#x65F6;&#xFF0C;)
true&#x8868;&#x793A;&#x5982;&#x679C;&#x5BF9;&#x5177;&#x6709;&#x61D2;&#x52A0;&#x8F7D;&#x7279;&#x6027;&#x7684;&#x5BF9;&#x8C61;&#x7684;&#x4EFB;&#x610F;&#x8C03;&#x7528;&#x4F1A;&#x5BFC;&#x81F4;&#x8FD9;&#x4E2A;**&#x5BF9;&#x8C61;&#x7684;&#x5B8C;&#x6574;&#x52A0;&#x8F7D;**&#xFF0C;false&#x8868;&#x793A;&#x6BCF;&#x79CD;&#x5C5E;&#x6027;&#x6309;&#x7167;&#x9700;&#x8981;&#x52A0;&#x8F7D;&#x3002;

**&#x5982;&#x679C;&#x6211;&#x4EC5;&#x4EC5;&#x4F7F;&#x7528;aggressiveLazyLoading&#x4E0D;&#x4F7F;&#x7528;lazyLoadingEnabled&#x8FD8;&#x6709;&#x80FD;&#x6309;&#x9700;&#x52A0;&#x8F7D;&#x5417;&#xFF1F;&#x5373;&#x8C03;&#x7528;getName&#x4E0D;&#x6267;&#x884C;role&#x7684;sql&#x8BED;&#x53E5;&#xFF0C;&#x5C31;&#x50CF;&#x7B2C;&#x4E00;&#x79CD;&#x60C5;&#x51B5;&#x90A3;&#x6837;**
&#x5982;&#x679C;&#x4E0D;&#x5F00;&#x542F;&#x61D2;&#x52A0;&#x8F7D;&#xFF0C;&#x5728;&#x6267;&#x884C;user&#x7684;sql&#x8BED;&#x53E5;&#x65F6;&#x4E5F;&#x5C06;&#x6267;&#x884C;role&#x7684;sql&#x8BED;&#x53E5;&#x3002;&#x56E0;&#x6B64;&#x4E0D;&#x80FD;&#x5B9E;&#x73B0;&#x9700;&#x6C42;&#x3002;

```xml
&lt;mapper namespace=&quot;org.apache.ibatis.submitted.lazy_properties.Mapper&quot;&gt;

  &lt;resultMap type=&quot;org.apache.ibatis.submitted.lazy_properties.User&quot;
    id=&quot;user&quot;&gt;
    &lt;id property=&quot;id&quot; column=&quot;id&quot; /&gt;
    &lt;result property=&quot;name&quot; column=&quot;name&quot; /&gt;
  &lt;/resultMap&gt;
  &lt;!-- &#x7ED3;&#x679C;&#x5BF9;&#x8C61; --&gt;
  &lt;resultMap type=&quot;org.apache.ibatis.submitted.lazy_properties.User&quot; id=&quot;userWithLazyProperties&quot; extends=&quot;user&quot;&gt;
    &lt;!-- &#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x5BF9;&#x8C61;lazy1 --&gt;
    &lt;association property=&quot;lazy1&quot; column=&quot;id&quot; select=&quot;getLazy1&quot; fetchType=&quot;lazy&quot; /&gt;
    &lt;!-- &#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x5BF9;&#x8C61;lazy2 --&gt;
    &lt;association property=&quot;lazy2&quot; column=&quot;id&quot; select=&quot;getLazy2&quot; fetchType=&quot;lazy&quot; /&gt;
    &lt;!-- &#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x96C6;&#x5408;lazy3 --&gt; 
    &lt;collection property=&quot;lazy3&quot; column=&quot;id&quot; select=&quot;getLazy3&quot; fetchType=&quot;lazy&quot; /&gt;
  &lt;/resultMap&gt;
  &lt;!-- &#x6267;&#x884C;&#x7684;&#x67E5;&#x8BE2; --&gt;
  &lt;select id=&quot;getUser&quot; resultMap=&quot;userWithLazyProperties&quot;&gt;
    select * from users where id = #{id}
  &lt;/select&gt;
&lt;/mapper&gt;
</code></pre><blockquote>
<ol>
<li>&#x8C03;&#x7528;getUser&#x67E5;&#x8BE2;&#x6570;&#x636E;&#xFF0C;&#x4ECE;&#x67E5;&#x8BE2;&#x7ED3;&#x679C;&#x96C6;&#x89E3;&#x6790;&#x6570;&#x636E;&#x5230;User&#x5BF9;&#x8C61;&#xFF0C;&#x5F53;&#x6570;&#x636E;&#x89E3;&#x6790;&#x5230;lazy1&#xFF0C;lazy2&#xFF0C;lazy3&#x5224;&#x65AD;&#x9700;&#x8981;&#x6267;&#x884C;&#x5173;&#x8054;&#x67E5;&#x8BE2;</li>
<li>lazyLoadingEnabled=true&#xFF0C;&#x5C06;&#x521B;&#x5EFA;lazy1&#xFF0C;lazy2&#xFF0C;lazy3&#x5BF9;&#x5E94;&#x7684;Proxy&#x5EF6;&#x8FDF;&#x6267;&#x884C;&#x5BF9;&#x8C61;lazyLoader&#xFF0C;&#x5E76;&#x4FDD;&#x5B58;</li>
<li>&#x5F53;&#x903B;&#x8F91;&#x89E6;&#x53D1;lazyLoadTriggerMethods &#x5BF9;&#x5E94;&#x7684;&#x65B9;&#x6CD5;&#xFF08;equals,clone,hashCode,toString&#xFF09;&#x5219;&#x6267;&#x884C;&#x5168;&#x90E8;&#x5C5E;&#x6027;&#x52A0;&#x8F7D;</li>
<li>&#x5982;&#x679C;aggressiveLazyLoading=true&#xFF0C;&#x53EA;&#x8981;&#x89E6;&#x53D1;&#x5230;&#x5BF9;&#x8C61;&#x4EFB;&#x4F55;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x5C31;&#x4F1A;&#x7ACB;&#x5373;&#x52A0;&#x8F7D;&#x6240;&#x6709;&#x5C5E;&#x6027;&#x7684;&#x52A0;&#x8F7D;</li>
</ol>
</blockquote>
<h3 id="&#x5B9E;&#x73B0;&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x4E00;&#x5BF9;&#x4E00;&#x3001;&#x4E00;&#x5BF9;&#x591A;">&#x5B9E;&#x73B0;&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;(&#x4E00;&#x5BF9;&#x4E00;&#x3001;&#x4E00;&#x5BF9;&#x591A;)</h3>
<ul>
<li>&#x5B9E;&#x73B0;&#x4EE5;&#x4E0B;&#x9700;&#x6C42;&#xFF1A;<ul>
<li>&#x5F53;&#x67E5;&#x8BE2;&#x8D26;&#x6237;&#x4FE1;&#x606F;&#x65F6;&#x4F7F;&#x7528;&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x3002;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x7528;&#x6237;&#x4FE1;&#x606F;&#x7684;&#x8BDD;&#xFF0C;&#x90A3;&#x4E48;&#x53EA;&#x67E5;&#x8BE2;&#x8D26;&#x6237;&#x4FE1;&#x606F;&#xFF1B;&#x53EA;&#x6709;&#x5F53;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x7528;&#x6237;&#x4FE1;&#x606F;&#x65F6;&#xFF0C;&#x624D;&#x53BB;&#x5173;&#x8054;&#x67E5;&#x8BE2;</li>
</ul>
</li>
<li>dao&#xFF1A;</li>
</ul>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> com.itheima.dao;

<span class="hljs-keyword">import</span> com.itheima.doamin.Account;
<span class="hljs-keyword">import</span> com.itheima.doamin.User;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">IAccountDao</span> </span>{
    <span class="hljs-function">List&lt;Account&gt; <span class="hljs-title">findAll</span><span class="hljs-params">()</span></span>;

    <span class="hljs-function">List&lt;Account&gt; <span class="hljs-title">selectUserById</span> <span class="hljs-params">(Integer uid)</span></span>;
}
</code></pre>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> com.itheima.dao;

<span class="hljs-keyword">import</span> com.itheima.doamin.User;
<span class="hljs-keyword">import</span> sun.nio.cs.US_ASCII;

<span class="hljs-keyword">import</span> javax.jws.soap.SOAPBinding;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">IUserDao</span> </span>{
    <span class="hljs-function">List&lt;User&gt; <span class="hljs-title">findAll</span><span class="hljs-params">()</span></span>;

    <span class="hljs-function">User <span class="hljs-title">findById</span><span class="hljs-params">(Integer userId)</span></span>;


}
</code></pre>
<ul>
<li><p>domain:</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> com.itheima.doamin;

<span class="hljs-keyword">import</span> javax.jws.soap.SOAPBinding;
<span class="hljs-keyword">import</span> java.io.Serializable;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Account</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>{
    <span class="hljs-keyword">private</span> Integer id;
    <span class="hljs-keyword">private</span> Integer uid;
    <span class="hljs-keyword">private</span> Double money;

    <span class="hljs-keyword">private</span> User user;

    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">getUser</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> user;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUser</span><span class="hljs-params">(User user)</span> </span>{
        <span class="hljs-keyword">this</span>.user = user;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setId</span><span class="hljs-params">(Integer id)</span> </span>{
        <span class="hljs-keyword">this</span>.id = id;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getUid</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> uid;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUid</span><span class="hljs-params">(Integer uid)</span> </span>{
        <span class="hljs-keyword">this</span>.uid = uid;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Double <span class="hljs-title">getMoney</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> money;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setMoney</span><span class="hljs-params">(Double money)</span> </span>{
        <span class="hljs-keyword">this</span>.money = money;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Account{&quot;</span> +
                <span class="hljs-string">&quot;id=&quot;</span> + id +
                <span class="hljs-string">&quot;, uid=&quot;</span> + uid +
                <span class="hljs-string">&quot;, money=&quot;</span> + money +
                <span class="hljs-string">&apos;}&apos;</span>;
    }
}
</code></pre>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> com.itheima.doamin;

<span class="hljs-keyword">import</span> java.io.Serializable;
<span class="hljs-keyword">import</span> java.util.Date;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>{
    <span class="hljs-keyword">private</span> Integer id;
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String address;
    <span class="hljs-keyword">private</span> String sex;
    <span class="hljs-keyword">private</span> Date birthday;

    <span class="hljs-keyword">private</span> List&lt;Account&gt;  accounts;

    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Account&gt; <span class="hljs-title">getAccounts</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> accounts;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAccounts</span><span class="hljs-params">(List&lt;Account&gt; accounts)</span> </span>{
        <span class="hljs-keyword">this</span>.accounts = accounts;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getUsername</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> username;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getAddress</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> address;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getSex</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> sex;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Date <span class="hljs-title">getBirthday</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> birthday;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setId</span><span class="hljs-params">(Integer id)</span> </span>{
        <span class="hljs-keyword">this</span>.id = id;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUsername</span><span class="hljs-params">(String username)</span> </span>{
        <span class="hljs-keyword">this</span>.username = username;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAddress</span><span class="hljs-params">(String address)</span> </span>{
        <span class="hljs-keyword">this</span>.address = address;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setSex</span><span class="hljs-params">(String sex)</span> </span>{
        <span class="hljs-keyword">this</span>.sex = sex;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setBirthday</span><span class="hljs-params">(Date birthday)</span> </span>{
        <span class="hljs-keyword">this</span>.birthday = birthday;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;User{&quot;</span> +
                <span class="hljs-string">&quot;id=&quot;</span> + id +
                <span class="hljs-string">&quot;, username=&apos;&quot;</span> + username + <span class="hljs-string">&apos;\&apos;&apos;</span> +
                <span class="hljs-string">&quot;, address=&apos;&quot;</span> + address + <span class="hljs-string">&apos;\&apos;&apos;</span> +
                <span class="hljs-string">&quot;, sex=&apos;&quot;</span> + sex + <span class="hljs-string">&apos;\&apos;&apos;</span> +
                <span class="hljs-string">&quot;, birthday=&quot;</span> + birthday +
                <span class="hljs-string">&apos;}&apos;</span>;
    }
}
</code></pre>
</li>
<li><p>&#x914D;&#x7F6E;xml&#xFF1A;</p>
<p>IAccountDao.xml&#xFF1A;</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> <span class="hljs-meta">?&gt;</span></span>
<span class="hljs-meta">&lt;!DOCTYPE mapper
        PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;
        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.itheima.dao.IAccountDao&quot;</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- &#x5B9A;&#x4E49;&#x53EF;&#x4EE5;&#x5C01;&#x88C5;&#x5E26;&#x6709;User&#x7684;Account&#x7684; resultMap --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;AccountWithUserMap&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;Account&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;aid&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;uid&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;uid&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;money&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;money&quot;</span>/&gt;</span>
        <span class="hljs-comment">&lt;!-- &#x5173;&#x8054; User &#x5BF9;&#x8C61; --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">association</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;user&quot;</span>  <span class="hljs-attr">javaType</span>=<span class="hljs-string">&quot;User&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;uid&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;com.itheima.dao.IUserDao.findById&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">association</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- &#x914D;&#x7F6E;&#x67E5;&#x8BE2;&#x6240;&#x6709;&#x8D26;&#x6237;&#xFF0C;&#x5E26;&#x6709;&#x7528;&#x6237;&#x4FE1;&#x606F; --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;findAll&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;AccountWithUserMap&quot;</span>&gt;</span>
        SELECT * from account;
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectUserById&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;int&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;com.itheima.doamin.Account&quot;</span>&gt;</span>
        SELECT * from account where uid =  #{uid};
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span>
</code></pre>
<p>IAccountDao.xml&#xFF1A;</p>
</li>
</ul>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> <span class="hljs-meta">?&gt;</span></span>
<span class="hljs-meta">&lt;!DOCTYPE mapper
        PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;
        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.itheima.dao.IUserDao&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;userAccountMap&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;user&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;id&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;username&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;address&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;address&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;sex&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;sex&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;birthday&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;birthday&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">collection</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;accounts&quot;</span> <span class="hljs-attr">ofType</span>=<span class="hljs-string">&quot;Account&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;com.itheima.dao.IAccountDao.selectUserById&quot;</span>&gt;</span>  <span class="hljs-comment">&lt;!--JavaType&#x548C;ofType&#x90FD;&#x662F;&#x7528;&#x6765;&#x6307;&#x5B9A;&#x5BF9;&#x8C61;&#x7C7B;&#x578B;&#x7684;&#xFF0C;&#x4F46;&#x662F;JavaType&#x662F;&#x7528;&#x6765;&#x6307;&#x5B9A;pojo&#x4E2D;&#x5C5E;&#x6027;&#x7684;&#x7C7B;&#x578B;&#xFF0C;&#x800C;ofType&#x6307;&#x5B9A;&#x7684;&#x662F;&#x6620;&#x5C04;&#x5230;list&#x96C6;&#x5408;&#x5C5E;&#x6027;&#x4E2D;pojo&#x7684;&#x7C7B;&#x578B;&#x3002;--&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">collection</span>&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;findAll&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;userAccountMap&quot;</span>&gt;</span>
        SELECT  * from user;
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;findById&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;int&quot;</span>  <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;User&quot;</span>&gt;</span>
        select * from user where  id = #{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>



<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span>
</code></pre>
<p>test:</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> com.itheima.test;

<span class="hljs-keyword">import</span> com.itheima.dao.IAccountDao;
<span class="hljs-keyword">import</span> com.itheima.dao.IUserDao;
<span class="hljs-keyword">import</span> com.itheima.doamin.Account;
<span class="hljs-keyword">import</span> com.itheima.doamin.User;
<span class="hljs-keyword">import</span> org.apache.ibatis.io.Resources;
<span class="hljs-keyword">import</span> org.apache.ibatis.session.SqlSession;
<span class="hljs-keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;
<span class="hljs-keyword">import</span> org.apache.ibatis.session.SqlSessionFactoryBuilder;
<span class="hljs-keyword">import</span> org.junit.After;
<span class="hljs-keyword">import</span> org.junit.Before;
<span class="hljs-keyword">import</span> org.junit.Test;


<span class="hljs-keyword">import</span> java.io.InputStream;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AccountTest</span> </span>{

    <span class="hljs-keyword">private</span> InputStream in;
    <span class="hljs-keyword">private</span> SqlSession sqlSession;
    <span class="hljs-keyword">private</span> IAccountDao accountDao;

    <span class="hljs-meta">@Before</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span><span class="hljs-keyword">throws</span>  Exception</span>{
        in = Resources.getResourceAsStream(<span class="hljs-string">&quot;SqlMapConfig.xml&quot;</span>);
        SqlSessionFactory factory = <span class="hljs-keyword">new</span> SqlSessionFactoryBuilder().build(in);
        sqlSession = factory.openSession();
        accountDao = sqlSession.getMapper(IAccountDao.class);
    }

    <span class="hljs-meta">@After</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">destory</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span>  Exception</span>{
        sqlSession.commit();
        sqlSession.close();
        in.close();
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFindAll</span><span class="hljs-params">()</span></span>{
        List&lt;Account&gt; accounts = accountDao.findAll();
<span class="hljs-comment">//        for(Account account:accounts){</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">//            System.out.println(account);</span>
<span class="hljs-comment">//            System.out.println(account.getUser());</span>
<span class="hljs-comment">//        }</span>
    }
}
</code></pre>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> com.itheima.test;

<span class="hljs-keyword">import</span> com.itheima.dao.IAccountDao;
<span class="hljs-keyword">import</span> com.itheima.dao.IUserDao;
<span class="hljs-keyword">import</span> com.itheima.doamin.Account;
<span class="hljs-keyword">import</span> com.itheima.doamin.User;
<span class="hljs-keyword">import</span> org.apache.ibatis.io.Resources;
<span class="hljs-keyword">import</span> org.apache.ibatis.session.SqlSession;
<span class="hljs-keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;
<span class="hljs-keyword">import</span> org.apache.ibatis.session.SqlSessionFactoryBuilder;
<span class="hljs-keyword">import</span> org.junit.After;
<span class="hljs-keyword">import</span> org.junit.Before;
<span class="hljs-keyword">import</span> org.junit.Test;

<span class="hljs-keyword">import</span> java.io.InputStream;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserTest</span> </span>{
    <span class="hljs-keyword">private</span> InputStream in;
    <span class="hljs-keyword">private</span> SqlSession sqlSession;
    <span class="hljs-keyword">private</span> IUserDao userDao;

    <span class="hljs-meta">@Before</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span><span class="hljs-keyword">throws</span>  Exception</span>{
        in = Resources.getResourceAsStream(<span class="hljs-string">&quot;SqlMapConfig.xml&quot;</span>);
        SqlSessionFactory factory = <span class="hljs-keyword">new</span> SqlSessionFactoryBuilder().build(in);
        sqlSession = factory.openSession();
        userDao = sqlSession.getMapper(IUserDao.class);
    }

    <span class="hljs-meta">@After</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">destory</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span>  Exception</span>{
        sqlSession.commit();
        sqlSession.close();
        in.close();
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFindAll</span><span class="hljs-params">()</span></span>{
        List&lt;User&gt; users = userDao.findAll();
        <span class="hljs-keyword">for</span>(User user:users){
            System.out.println(user);
            System.out.println(user.getAccounts());
        }
    }

}
</code></pre>
<h3 id="&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x539F;&#x7406;">&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x539F;&#x7406;</h3>
<p>Mybatis &#x4EC5;&#x652F;&#x6301; association &#x5173;&#x8054;&#x5BF9;&#x8C61;&#x548C; collection &#x5173;&#x8054;&#x96C6;&#x5408;&#x5BF9;&#x8C61;&#x7684;&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#xFF0C;association &#x6307;&#x7684;&#x5C31;&#x662F;&#x4E00;&#x5BF9;&#x4E00;&#xFF0C;collection &#x6307;&#x7684;&#x5C31;&#x662F;&#x4E00;&#x5BF9;&#x591A;&#x67E5;&#x8BE2;&#x3002;&#x5728; Mybatis&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x53EF;&#x4EE5;&#x914D;&#x7F6E;&#x662F;&#x5426;&#x542F;&#x7528;&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D; lazyLoadingEnabled=true|false&#x3002;&#x5B83;&#x7684;&#x539F;&#x7406;&#x662F;&#xFF0C;&#x4F7F;&#x7528; CGLIB &#x521B;&#x5EFA;&#x76EE;&#x6807;&#x5BF9;&#x8C61;&#x7684;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#xFF0C;&#x5F53;&#x8C03;&#x7528;&#x76EE;&#x6807;&#x65B9;&#x6CD5;&#x65F6;&#xFF0C;&#x8FDB;&#x5165;&#x62E6;&#x622A;&#x5668;&#x65B9;&#x6CD5;&#xFF0C;&#x6BD4;&#x5982;&#x8C03;&#x7528; a.getB().getName()&#xFF0C;&#x62E6;&#x622A;&#x5668; invoke()&#x65B9;&#x6CD5;&#x53D1;&#x73B0; a.getB()&#x662F;null &#x503C;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x4F1A;&#x5355;&#x72EC;&#x53D1;&#x9001;&#x4E8B;&#x5148;&#x4FDD;&#x5B58;&#x597D;&#x7684;&#x67E5;&#x8BE2;&#x5173;&#x8054; B &#x5BF9;&#x8C61;&#x7684; sql&#xFF0C;&#x628A; B &#x67E5;&#x8BE2;&#x4E0A;&#x6765;&#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528; a.setB(b)&#xFF0C;&#x4E8E;&#x662F; a &#x7684;&#x5BF9;&#x8C61; b &#x5C5E;&#x6027;&#x5C31;&#x6709;&#x503C;&#x4E86;&#xFF0C;&#x63A5;&#x7740;&#x5B8C;&#x6210; a.getB().getName()&#x65B9;&#x6CD5;&#x7684;&#x8C03;&#x7528;&#x3002;&#x8FD9;&#x5C31;&#x662F;&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x7684;&#x57FA;&#x672C;&#x539F;&#x7406;&#x3002;&#x5F53;&#x7136;&#x4E86;&#xFF0C;&#x4E0D;&#x5149;&#x662F; Mybatis&#xFF0C;&#x51E0;&#x4E4E;&#x6240;&#x6709;&#x7684;&#x5305;&#x62EC; Hibernate&#xFF0C;&#x652F;&#x6301;&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x7684;&#x539F;&#x7406;&#x90FD;&#x662F;&#x4E00;&#x6837;&#x7684;&#x3002;</p>
<p><img src="F:\Typora&#x6570;&#x636E;&#x50A8;&#x5B58;\&#x6570;&#x636E;&#x5E93;\mybatis.assets\image-20201116085012615.png" alt="image-20201116085012615"></p>
<h3 id="&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x6E90;&#x7801;&#x89E3;&#x6790;">&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x6E90;&#x7801;&#x89E3;&#x6790;</h3>
<h4 id="setting-&#x914D;&#x7F6E;&#x52A0;&#x8F7D;&#xFF1A;">Setting &#x914D;&#x7F6E;&#x52A0;&#x8F7D;&#xFF1A;</h4>
<pre><code class="lang-Java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Configuration</span> </span>{
   <span class="hljs-comment">/** aggressiveLazyLoading&#xFF1A;
   * &#x5F53;&#x5F00;&#x542F;&#x65F6;&#xFF0C;&#x4EFB;&#x4F55;&#x65B9;&#x6CD5;&#x7684;&#x8C03;&#x7528;&#x90FD;&#x4F1A;&#x52A0;&#x8F7D;&#x8BE5;&#x5BF9;&#x8C61;&#x7684;&#x6240;&#x6709;&#x5C5E;&#x6027;&#x3002;&#x5426;&#x5219;&#xFF0C;&#x6BCF;&#x4E2A;&#x5C5E;&#x6027;&#x4F1A;&#x6309;&#x9700;&#x52A0;&#x8F7D;&#xFF08;&#x53C2;&#x8003;lazyLoadTriggerMethods).
   * &#x9ED8;&#x8BA4;&#x4E3A;true
   * */</span>
  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> aggressiveLazyLoading;
  <span class="hljs-comment">/**
   * &#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x89E6;&#x53D1;&#x65B9;&#x6CD5;
   */</span>
  <span class="hljs-keyword">protected</span> Set&lt;String&gt; lazyLoadTriggerMethods = <span class="hljs-keyword">new</span> HashSet&lt;String&gt;(Arrays.asList(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">&quot;equals&quot;</span>, <span class="hljs-string">&quot;clone&quot;</span>, <span class="hljs-string">&quot;hashCode&quot;</span>, <span class="hljs-string">&quot;toString&quot;</span> }));
  <span class="hljs-comment">/** &#x662F;&#x5426;&#x5F00;&#x542F;&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D; */</span>
  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> lazyLoadingEnabled = <span class="hljs-keyword">false</span>;

  <span class="hljs-comment">/**
   * &#x9ED8;&#x8BA4;&#x4F7F;&#x7528;Javassist&#x4EE3;&#x7406;&#x5DE5;&#x5382;
   * <span class="hljs-doctag">@param</span> proxyFactory
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setProxyFactory</span><span class="hljs-params">(ProxyFactory proxyFactory)</span> </span>{
    <span class="hljs-keyword">if</span> (proxyFactory == <span class="hljs-keyword">null</span>) {
      proxyFactory = <span class="hljs-keyword">new</span> JavassistProxyFactory();
    }
    <span class="hljs-keyword">this</span>.proxyFactory = proxyFactory;
  }

  <span class="hljs-comment">//&#x7701;&#x7565;...</span>
}
</code></pre>
<h4 id="&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x521B;&#x5EFA;">&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x521B;&#x5EFA;</h4>
<p>DefaultResultSetHandler</p>
<pre><code class="lang-Java"><span class="hljs-comment">//#mark &#x521B;&#x5EFA;&#x7ED3;&#x679C;&#x5BF9;&#x8C61;</span>
  <span class="hljs-function"><span class="hljs-keyword">private</span> Object <span class="hljs-title">createResultObject</span><span class="hljs-params">(ResultSetWrapper rsw, ResultMap resultMap, ResultLoaderMap lazyLoader, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException </span>{
    <span class="hljs-keyword">this</span>.useConstructorMappings = <span class="hljs-keyword">false</span>; <span class="hljs-comment">// reset previous mapping result</span>
    <span class="hljs-keyword">final</span> List&lt;Class&lt;?&gt;&gt; constructorArgTypes = <span class="hljs-keyword">new</span> ArrayList&lt;Class&lt;?&gt;&gt;();
    <span class="hljs-keyword">final</span> List&lt;Object&gt; constructorArgs = <span class="hljs-keyword">new</span> ArrayList&lt;Object&gt;();
    <span class="hljs-comment">//#mark &#x521B;&#x5EFA;&#x8FD4;&#x56DE;&#x7684;&#x7ED3;&#x679C;&#x6620;&#x5C04;&#x7684;&#x771F;&#x5B9E;&#x5BF9;&#x8C61;</span>
    Object resultObject = createResultObject(rsw, resultMap, constructorArgTypes, constructorArgs, columnPrefix);
    <span class="hljs-keyword">if</span> (resultObject != <span class="hljs-keyword">null</span> &amp;&amp; !hasTypeHandlerForResultObject(rsw, resultMap.getType())) {
      <span class="hljs-keyword">final</span> List&lt;ResultMapping&gt; propertyMappings = resultMap.getPropertyResultMappings();
      <span class="hljs-keyword">for</span> (ResultMapping propertyMapping : propertyMappings) {
        <span class="hljs-comment">// issue gcode #109 &amp;&amp; issue #149 &#x5224;&#x65AD;&#x5C5E;&#x6027;&#x6709;&#x6CA1;&#x914D;&#x7F6E;&#x5D4C;&#x5957;&#x67E5;&#x8BE2;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x5C31;&#x521B;&#x5EFA;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;</span>
        <span class="hljs-keyword">if</span> (propertyMapping.getNestedQueryId() != <span class="hljs-keyword">null</span> &amp;&amp; propertyMapping.isLazy()) {
          <span class="hljs-comment">//#mark &#x521B;&#x5EFA;&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;</span>
          resultObject = configuration.getProxyFactory().createProxy(resultObject, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);
          <span class="hljs-keyword">break</span>;
        }
      }
    }
    <span class="hljs-keyword">this</span>.useConstructorMappings = resultObject != <span class="hljs-keyword">null</span> &amp;&amp; !constructorArgTypes.isEmpty(); <span class="hljs-comment">// set current mapping result</span>
    <span class="hljs-keyword">return</span> resultObject;
  }
</code></pre>
<h4 id="&#x4EE3;&#x7406;&#x529F;&#x80FD;&#x5B9E;&#x73B0;">&#x4EE3;&#x7406;&#x529F;&#x80FD;&#x5B9E;&#x73B0;</h4>
<blockquote>
<p>&#x7531;&#x4E8E;Javasisst&#x548C;Cglib&#x7684;&#x4EE3;&#x7406;&#x5B9E;&#x73B0;&#x57FA;&#x672C;&#x76F8;&#x540C;&#xFF0C;&#x8FD9;&#x91CC;&#x4E3B;&#x8981;&#x4ECB;&#x7ECD;Javasisst</p>
</blockquote>
<p>ProxyFactory&#x63A5;&#x53E3;&#x5B9A;&#x4E49;</p>
<pre><code class="lang-Java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ProxyFactory</span> </span>{

  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setProperties</span><span class="hljs-params">(Properties properties)</span></span>;

  <span class="hljs-comment">/**
   * &#x521B;&#x5EFA;&#x4EE3;&#x7406;
   * <span class="hljs-doctag">@param</span> target &#x76EE;&#x6807;&#x7ED3;&#x679C;&#x5BF9;&#x8C61;
   * <span class="hljs-doctag">@param</span> lazyLoader &#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x5BF9;&#x8C61;
   * <span class="hljs-doctag">@param</span> configuration &#x914D;&#x7F6E;
   * <span class="hljs-doctag">@param</span> objectFactory &#x5BF9;&#x8C61;&#x5DE5;&#x5382;
   * <span class="hljs-doctag">@param</span> constructorArgTypes &#x6784;&#x9020;&#x53C2;&#x6570;&#x7C7B;&#x578B;
   * <span class="hljs-doctag">@param</span> constructorArgs &#x6784;&#x9020;&#x53C2;&#x6570;&#x503C;
   * <span class="hljs-doctag">@return</span>
   */</span>
  <span class="hljs-function">Object <span class="hljs-title">createProxy</span><span class="hljs-params">(Object target, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span></span>;
}
</code></pre>
<p>JavasisstProxyFactory&#x5B9E;&#x73B0;</p>
<pre><code class="lang-Java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JavassistProxyFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">org</span>.<span class="hljs-title">apache</span>.<span class="hljs-title">ibatis</span>.<span class="hljs-title">executor</span>.<span class="hljs-title">loader</span>.<span class="hljs-title">ProxyFactory</span> </span>{


    <span class="hljs-comment">/**
   * &#x63A5;&#x53E3;&#x5B9E;&#x73B0;
   * <span class="hljs-doctag">@param</span> target &#x76EE;&#x6807;&#x7ED3;&#x679C;&#x5BF9;&#x8C61;
   * <span class="hljs-doctag">@param</span> lazyLoader &#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x5BF9;&#x8C61;
   * <span class="hljs-doctag">@param</span> configuration &#x914D;&#x7F6E;
   * <span class="hljs-doctag">@param</span> objectFactory &#x5BF9;&#x8C61;&#x5DE5;&#x5382;
   * <span class="hljs-doctag">@param</span> constructorArgTypes &#x6784;&#x9020;&#x53C2;&#x6570;&#x7C7B;&#x578B;
   * <span class="hljs-doctag">@param</span> constructorArgs &#x6784;&#x9020;&#x53C2;&#x6570;&#x503C;
   * <span class="hljs-doctag">@return</span>
   */</span>
  <span class="hljs-meta">@Override</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">createProxy</span><span class="hljs-params">(Object target, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>{
    <span class="hljs-keyword">return</span> EnhancedResultObjectProxyImpl.createProxy(target, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);
  }

    <span class="hljs-comment">//&#x7701;&#x7565;...</span>

  <span class="hljs-comment">/**
   * &#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x5B9E;&#x73B0;&#xFF0C;&#x6838;&#x5FC3;&#x903B;&#x8F91;&#x6267;&#x884C;
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EnhancedResultObjectProxyImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MethodHandler</span> </span>{

    <span class="hljs-comment">/**
   * &#x521B;&#x5EFA;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;
   * <span class="hljs-doctag">@param</span> type
   * <span class="hljs-doctag">@param</span> callback
   * <span class="hljs-doctag">@param</span> constructorArgTypes
   * <span class="hljs-doctag">@param</span> constructorArgs
   * <span class="hljs-doctag">@return</span>
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">static</span> Object <span class="hljs-title">crateProxy</span><span class="hljs-params">(Class&lt;?&gt; type, MethodHandler callback, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>{

    ProxyFactory enhancer = <span class="hljs-keyword">new</span> ProxyFactory();
    enhancer.setSuperclass(type);

    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">//&#x901A;&#x8FC7;&#x83B7;&#x53D6;&#x5BF9;&#x8C61;&#x65B9;&#x6CD5;&#xFF0C;&#x5224;&#x65AD;&#x662F;&#x5426;&#x5B58;&#x5728;&#x8BE5;&#x65B9;&#x6CD5;</span>
      type.getDeclaredMethod(WRITE_REPLACE_METHOD);
      <span class="hljs-comment">// ObjectOutputStream will call writeReplace of objects returned by writeReplace</span>
      <span class="hljs-keyword">if</span> (log.isDebugEnabled()) {
        log.debug(WRITE_REPLACE_METHOD + <span class="hljs-string">&quot; method was found on bean &quot;</span> + type + <span class="hljs-string">&quot;, make sure it returns this&quot;</span>);
      }
    } <span class="hljs-keyword">catch</span> (NoSuchMethodException e) {
      <span class="hljs-comment">//&#x6CA1;&#x627E;&#x5230;&#x8BE5;&#x65B9;&#x6CD5;&#xFF0C;&#x5B9E;&#x73B0;&#x63A5;&#x53E3;</span>
      enhancer.setInterfaces(<span class="hljs-keyword">new</span> Class[]{WriteReplaceInterface.class});
    } <span class="hljs-keyword">catch</span> (SecurityException e) {
      <span class="hljs-comment">// nothing to do here</span>
    }

    Object enhanced;
    Class&lt;?&gt;[] typesArray = constructorArgTypes.toArray(<span class="hljs-keyword">new</span> Class[constructorArgTypes.size()]);
    Object[] valuesArray = constructorArgs.toArray(<span class="hljs-keyword">new</span> Object[constructorArgs.size()]);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">//&#x521B;&#x5EFA;&#x65B0;&#x7684;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;</span>
      enhanced = enhancer.create(typesArray, valuesArray);
    } <span class="hljs-keyword">catch</span> (Exception e) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ExecutorException(<span class="hljs-string">&quot;Error creating lazy proxy.  Cause: &quot;</span> + e, e);
    }
    <span class="hljs-comment">//&#x8BBE;&#x7F6E;&#x4EE3;&#x7406;&#x6267;&#x884C;&#x5668;</span>
    ((Proxy) enhanced).setHandler(callback);
    <span class="hljs-keyword">return</span> enhanced;
  }


     <span class="hljs-comment">/**
     * &#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x6267;&#x884C;
     * <span class="hljs-doctag">@param</span> enhanced &#x539F;&#x5BF9;&#x8C61;
     * <span class="hljs-doctag">@param</span> method &#x539F;&#x5BF9;&#x8C61;&#x65B9;&#x6CD5;
     * <span class="hljs-doctag">@param</span> methodProxy &#x4EE3;&#x7406;&#x65B9;&#x6CD5;
     * <span class="hljs-doctag">@param</span> args &#x65B9;&#x6CD5;&#x53C2;&#x6570;
     * <span class="hljs-doctag">@return</span>
     * <span class="hljs-doctag">@throws</span> Throwable
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object enhanced, Method method, Method methodProxy, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable </span>{
      <span class="hljs-keyword">final</span> String methodName = method.getName();
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">synchronized</span> (lazyLoader) {
          <span class="hljs-keyword">if</span> (WRITE_REPLACE_METHOD.equals(methodName)) { 
            <span class="hljs-comment">//&#x5FFD;&#x7565;&#x6682;&#x672A;&#x627E;&#x5230;&#x5177;&#x4F53;&#x4F5C;&#x7528;</span>
            Object original;
            <span class="hljs-keyword">if</span> (constructorArgTypes.isEmpty()) {
              original = objectFactory.create(type);
            } <span class="hljs-keyword">else</span> {
              original = objectFactory.create(type, constructorArgTypes, constructorArgs);
            }
            PropertyCopier.copyBeanProperties(type, enhanced, original);
            <span class="hljs-keyword">if</span> (lazyLoader.size() &gt; <span class="hljs-number">0</span>) {
              <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> JavassistSerialStateHolder(original, lazyLoader.getProperties(), objectFactory, constructorArgTypes, constructorArgs);
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-keyword">return</span> original;
            }
          } <span class="hljs-keyword">else</span> {
              <span class="hljs-comment">//&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x6570;&#x91CF;&#x5927;&#x4E8E;0</span>
            <span class="hljs-keyword">if</span> (lazyLoader.size() &gt; <span class="hljs-number">0</span> &amp;&amp; !FINALIZE_METHOD.equals(methodName)) {
                <span class="hljs-comment">//aggressive &#x4E00;&#x6B21;&#x52A0;&#x8F7D;&#x6027;&#x6240;&#x6709;&#x9700;&#x8981;&#x8981;&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x5C5E;&#x6027;&#x6216;&#x8005;&#x5305;&#x542B;&#x89E6;&#x53D1;&#x5EF6;&#x8FDF;&#x5BF9;&#x8C61;&#x5168;&#x90E8;&#x52A0;&#x8F7D;&#x65B9;&#x6CD5;</span>
              <span class="hljs-keyword">if</span> (aggressive || lazyLoadTriggerMethods.contains(methodName)) {
                log.debug(<span class="hljs-string">&quot;==&gt; laze lod trigger method:&quot;</span> + methodName + <span class="hljs-string">&quot;,proxy method:&quot;</span> + methodProxy.getName() + <span class="hljs-string">&quot; class:&quot;</span> + enhanced.getClass());
                <span class="hljs-comment">//&#x4E00;&#x6B21;&#x5168;&#x90E8;&#x52A0;&#x8F7D;</span>
                lazyLoader.loadAll();
              } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (PropertyNamer.isSetter(methodName)) {
                <span class="hljs-comment">//&#x5224;&#x65AD;&#x662F;&#x5426;&#x4E3A;set&#x65B9;&#x6CD5;&#xFF0C;set&#x65B9;&#x6CD5;&#x4E0D;&#x9700;&#x8981;&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;</span>
                <span class="hljs-keyword">final</span> String property = PropertyNamer.methodToProperty(methodName);
                lazyLoader.remove(property);
              } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (PropertyNamer.isGetter(methodName)) {
                <span class="hljs-keyword">final</span> String property = PropertyNamer.methodToProperty(methodName);
                <span class="hljs-keyword">if</span> (lazyLoader.hasLoader(property)) {
                  <span class="hljs-comment">//&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#x5355;&#x4E2A;&#x5C5E;&#x6027;</span>
                  lazyLoader.load(property);
                  log.debug(<span class="hljs-string">&quot;load one :&quot;</span> + methodName);
                }
              }
            }
          }
        }
        <span class="hljs-keyword">return</span> methodProxy.invoke(enhanced, args);
      } <span class="hljs-keyword">catch</span> (Throwable t) {
        <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(t);
      }
    }
  }
</code></pre>
<h2 id="&#x7F13;&#x5B58;">&#x7F13;&#x5B58;</h2>
<ul>
<li>&#x4EC0;&#x4E48;&#x662F;&#x7F13;&#x5B58;&#xFF1F;
&#x7F13;&#x5B58;&#x5C31;&#x662F;&#x5B58;&#x5728;&#x4E8E;&#x5185;&#x5B58;&#x4E2D;&#x7684;&#x4E34;&#x65F6;&#x6570;&#x636E;&#x3002;</li>
<li>&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x4F7F;&#x7528;&#x7F13;&#x5B58;&#xFF1F;
&#x4E3A;&#x4E86;&#x51CF;&#x5C11;&#x548C;&#x6570;&#x636E;&#x5E93;&#x4EA4;&#x4E92;&#x7684;&#x6B21;&#x6570;&#xFF0C;&#x63D0;&#x9AD8;&#x6267;&#x884C;&#x6548;&#x7387;&#x3002;</li>
<li>&#x9002;&#x7528;&#x4E8E;&#x7F13;&#x5B58;&#x7684;&#x6570;&#x636E;
&#x7ECF;&#x5E38;&#x67E5;&#x8BE2;&#x5E76;&#x4E14;&#x4E0D;&#x7ECF;&#x5E38;&#x6539;&#x53D8;&#x7684;&#x6570;&#x636E;&#x3002;
&#x6570;&#x636E;&#x7684;&#x6B63;&#x786E;&#x4E0E;&#x5426;&#x5BF9;&#x6700;&#x7EC8;&#x7ED3;&#x679C;&#x5F71;&#x54CD;&#x4E0D;&#x5927;&#x7684;&#x3002;</li>
<li>&#x4E0D;&#x9002;&#x7528;&#x4E8E;&#x7F13;&#x5B58;&#x7684;&#x6570;&#x636E;
&#x7ECF;&#x5E38;&#x6539;&#x53D8;&#x7684;&#x6570;&#x636E;&#x3002;
&#x6570;&#x636E;&#x7684;&#x6B63;&#x786E;&#x4E0E;&#x5426;&#x5BF9;&#x6700;&#x7EC8;&#x7ED3;&#x679C;&#x5F71;&#x54CD;&#x5F88;&#x5927;&#x7684;&#x3002;&#x4F8B;&#x5982;&#xFF1A;&#x5546;&#x54C1;&#x7684;&#x5E93;&#x5B58;&#x3001;&#x94F6;&#x884C;&#x7684;&#x6C47;&#x7387;&#x3001;&#x80A1;&#x5E02;&#x7684;&#x724C;&#x4EF7;&#x7B49;&#x3002;</li>
</ul>
<h4 id="&#x4E00;&#x7EA7;&#x7F13;&#x5B58;">&#x4E00;&#x7EA7;&#x7F13;&#x5B58;</h4>
<p>&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#x662F; <strong>SqlSession</strong> &#x7EA7;&#x522B;&#x7684;&#x7F13;&#x5B58;&#xFF0C;&#x53EA;&#x8981; SqlSession &#x6CA1;&#x6709; <strong>flush</strong> &#x6216; <strong>close</strong>&#xFF0C;&#x5B83;&#x5C31;&#x4F1A;&#x5B58;&#x5728;&#x3002;&#x5F53;&#x8C03;&#x7528; SqlSession &#x7684;<strong>&#x4FEE;&#x6539;&#x3001;&#x6DFB;&#x52A0;&#x3001;&#x5220;&#x9664;&#x3001;commit()&#x3001;close()&#x3001;clearCache()</strong> &#x7B49;&#x65B9;&#x6CD5;&#x65F6;&#xFF0C;&#x5C31;&#x4F1A;&#x6E05;&#x7A7A;&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#x3002;</p>
<p>&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#x6D41;&#x7A0B;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://img-blog.csdnimg.cn/20200206103422757.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2ExMDkyODgyNTgw,size_16,color_FFFFFF,t_70#pic_center" alt="&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#x5206;&#x6790;"></p>
<ul>
<li>&#x7B2C;&#x4E00;&#x6B21;&#x53D1;&#x8D77;&#x67E5;&#x8BE2;&#x7528;&#x6237; id &#x4E3A; 1 &#x7684;&#x7528;&#x6237;&#x4FE1;&#x606F;&#xFF0C;Mybatis &#x4F1A;&#x5148;&#x53BB;&#x627E;&#x7F13;&#x5B58;&#x4E2D;&#x662F;&#x5426;&#x6709; id &#x4E3A; 1 &#x7684;&#x7528;&#x6237;&#x4FE1;&#x606F;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#xFF0C;&#x4ECE;&#x6570;&#x636E;&#x5E93;&#x67E5;&#x8BE2;&#x7528;&#x6237;&#x4FE1;&#x606F;&#x3002;
&#x5F97;&#x5230;&#x7528;&#x6237;&#x4FE1;&#x606F;&#xFF0C;&#x5C06;&#x7528;&#x6237;&#x4FE1;&#x606F;&#x5B58;&#x50A8;&#x5230;&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#x4E2D;&#x3002;</li>
<li>&#x5982;&#x679C; sqlSession &#x53BB;&#x6267;&#x884C; commit &#x64CD;&#x4F5C;&#xFF08;&#x6267;&#x884C;&#x63D2;&#x5165;&#x3001;&#x66F4;&#x65B0;&#x3001;&#x5220;&#x9664;&#xFF09;&#xFF0C;&#x90A3;&#x4E48; Mybatis &#x5C31;&#x4F1A;&#x6E05;&#x7A7A; SqlSession &#x4E2D;&#x7684;&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#xFF0C;&#x8FD9;&#x6837;&#x505A;&#x7684;&#x76EE;&#x7684;&#x4E3A;&#x4E86;&#x8BA9;&#x7F13;&#x5B58;&#x4E2D;&#x5B58;&#x50A8;&#x7684;&#x662F;&#x6700;&#x65B0;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x907F;&#x514D;&#x810F;&#x8BFB;&#x3002;</li>
<li>&#x7B2C;&#x4E8C;&#x6B21;&#x53D1;&#x8D77;&#x67E5;&#x8BE2;&#x7528;&#x6237; id &#x4E3A; 1 &#x7684;&#x7528;&#x6237;&#x4FE1;&#x606F;&#xFF0C;&#x5148;&#x53BB;&#x627E;&#x7F13;&#x5B58;&#x4E2D;&#x662F;&#x5426;&#x6709; id &#x4E3A; 1 &#x7684;&#x7528;&#x6237;&#x4FE1;&#x606F;&#xFF0C;&#x7F13;&#x5B58;&#x4E2D;&#x6709;&#xFF0C;&#x76F4;&#x63A5;&#x4ECE;&#x7F13;&#x5B58;&#x4E2D;&#x83B7;&#x53D6;&#x7528;&#x6237;&#x4FE1;&#x606F;&#x3002;</li>
</ul>
<blockquote>
<p>Mybatis &#x9ED8;&#x8BA4;&#x5C31;&#x662F;&#x4F7F;&#x7528;&#x4E00;&#x6B21;&#x7F13;&#x5B58;&#x7684;&#xFF0C;&#x4E0D;&#x9700;&#x8981;&#x914D;&#x7F6E;&#x3002;
<strong>&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#x4E2D;&#x5B58;&#x653E;&#x7684;&#x662F;&#x5BF9;&#x8C61;&#x3002;</strong>&#xFF08;&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#x5176;&#x5B9E;&#x5C31;&#x662F; Map &#x7ED3;&#x6784;&#xFF0C;&#x76F4;&#x63A5;&#x5B58;&#x653E;&#x5BF9;&#x8C61;&#xFF09; </p>
<p>mybatis&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#xFF0C;&#x7F13;&#x5B58;&#x5728;SqlSession&#x4E2D;&#x3002;</p>
<p>&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#x662F;&#x9ED8;&#x8BA4;&#x7684;&#xFF0C;&#x4E0D;&#x9700;&#x8981;&#x914D;&#x7F6E;&#xFF0C;localCache&#x4E2D;&#x6CA1;&#x6709;&#x7F13;&#x5B58;&#x65F6;&#xFF0C;&#x624D;&#x53BB;&#x6267;&#x884C;queryFromDatabase&#x65B9;&#x6CD5;&#xFF0C;&#x53BB;&#x67E5;&#x8BE2;&#x6570;&#x636E;&#x5E93;&#xFF0C;&#x5E76;&#x5C06;&#x7ED3;&#x679C;&#x7F13;&#x5B58;&#x5230;localCache&#x4E2D;&#x3002;</p>
<p>MyBatis&#x7684;&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#x6700;&#x5927;&#x8303;&#x56F4;&#x662F;SqlSession&#x5185;&#x90E8;&#xFF0C;&#x6709;&#x591A;&#x4E2A;SqlSession&#x6216;&#x8005;&#x5206;&#x5E03;&#x5F0F;&#x7684;&#x73AF;&#x5883;&#x4E0B;&#xFF0C;&#x6570;&#x636E;&#x5E93;&#x5199;&#x64CD;&#x4F5C;&#x4F1A;&#x5F15;&#x8D77;&#x810F;&#x6570;&#x636E;&#xFF0C;&#x5EFA;&#x8BAE;&#x8BBE;&#x5B9A;&#x7F13;&#x5B58;&#x7EA7;&#x522B;&#x4E3A;Statement</p>
</blockquote>
<h6 id="&#x6E90;&#x7801;">&#x6E90;&#x7801;</h6>
<pre><code class="lang-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseExecutor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Executor</span> </span>{

<span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-function">List&lt;E&gt; <span class="hljs-title">query</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException </span>{
    ErrorContext.instance().resource(ms.getResource()).activity(<span class="hljs-string">&quot;executing a query&quot;</span>).object(ms.getId());
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.closed) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ExecutorException(<span class="hljs-string">&quot;Executor was closed.&quot;</span>);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.queryStack == <span class="hljs-number">0</span> &amp;&amp; ms.isFlushCacheRequired()) {
            <span class="hljs-keyword">this</span>.clearLocalCache();
        }

        List list;
        <span class="hljs-keyword">try</span> {
            ++<span class="hljs-keyword">this</span>.queryStack;

            <span class="hljs-comment">//&#x5728;&#x7F13;&#x5B58;&#x4E2D;&#x67E5;&#x627E;&#x662F;&#x5426;&#x6709;</span>
            list = resultHandler == <span class="hljs-keyword">null</span> ? (List)<span class="hljs-keyword">this</span>.localCache.getObject(key) : <span class="hljs-keyword">null</span>;
            <span class="hljs-keyword">if</span> (list != <span class="hljs-keyword">null</span>) {
                <span class="hljs-keyword">this</span>.handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);
            } <span class="hljs-keyword">else</span> {
                list = <span class="hljs-keyword">this</span>.queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);
            }
        } <span class="hljs-keyword">finally</span> {
            --<span class="hljs-keyword">this</span>.queryStack;
        }

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.queryStack == <span class="hljs-number">0</span>) {
            Iterator var8 = <span class="hljs-keyword">this</span>.deferredLoads.iterator();

            <span class="hljs-keyword">while</span>(var8.hasNext()) {
                BaseExecutor.DeferredLoad deferredLoad = (BaseExecutor.DeferredLoad)var8.next();
                deferredLoad.load();
            }

            <span class="hljs-keyword">this</span>.deferredLoads.clear();
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) {
                <span class="hljs-keyword">this</span>.clearLocalCache();
            }
        }

        <span class="hljs-keyword">return</span> list;
    }
}
</code></pre>
<h4 id="&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;">&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;</h4>
<ul>
<li>&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x662F; <strong>Mapper</strong> &#x6620;&#x5C04;&#x7EA7;&#x522B;&#x7684;&#x7F13;&#x5B58;&#xFF0C;&#x591A;&#x4E2A; SqlSession &#x53BB;&#x64CD;&#x4F5C;&#x540C;&#x4E00;&#x4E2A; Mapper &#x6620;&#x5C04;&#x7684; SQL &#x8BED;&#x53E5;&#xFF0C;&#x591A;&#x4E2A;SqlSession &#x53EF;&#x4EE5;&#x5171;&#x7528;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#xFF0C;<strong>&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x662F;&#x8DE8; SqlSession &#x7684;</strong>&#x3002;</li>
</ul>
<p>&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x6D41;&#x7A0B;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="https://img-blog.csdnimg.cn/20200206103408586.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2ExMDkyODgyNTgw,size_16,color_FFFFFF,t_70#pic_center" alt="img"></p>
<p><img src="https://img2018.cnblogs.com/blog/1383365/201906/1383365-20190628180149776-546074458.png" alt="img"></p>
<ul>
<li>&#x5F53; sqlSession1 &#x53BB;&#x67E5;&#x8BE2;&#x7528;&#x6237;&#x4FE1;&#x606F;&#x7684;&#x65F6;&#x5019;&#xFF0C;Mybatis &#x4F1A;&#x5C06;&#x67E5;&#x8BE2;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x5230;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x4E2D;&#x3002;</li>
<li>&#x5982;&#x679C; sqlSession3 &#x53BB;&#x6267;&#x884C;&#x76F8;&#x540C; Mapper &#x6620;&#x5C04;&#x4E0B;&#x7684; SQL &#x8BED;&#x53E5;&#xFF0C;&#x5E76;&#x4E14;&#x6267;&#x884C; commit &#x63D0;&#x4EA4;&#xFF0C;&#x90A3;&#x4E48; Mybatis &#x5C06;&#x4F1A;&#x6E05;&#x7A7A;&#x8BE5; Mapper &#x6620;&#x5C04;&#x4E0B;&#x7684;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x533A;&#x57DF;&#x7684;&#x6570;&#x636E;&#x3002;</li>
<li>sqlSession2 &#x53BB;&#x67E5;&#x8BE2;&#x4E0E; sqlSession1 &#x76F8;&#x540C;&#x7684;&#x7528;&#x6237;&#x4FE1;&#x606F;&#xFF0C;Mybatis &#x9996;&#x5148;&#x4F1A;&#x53BB;&#x7F13;&#x5B58;&#x4E2D;&#x627E;&#x662F;&#x5426;&#x5B58;&#x5728;&#x6570;&#x636E;&#xFF0C;&#x5982;&#x679C;&#x5B58;&#x5728;&#x76F4;&#x63A5;&#x4ECE;&#x7F13;&#x5B58;&#x4E2D;&#x53D6;&#x51FA;&#x6570;&#x636E;&#x3002;</li>
<li>&#x5982;&#x679C;&#x60F3;&#x4F7F;&#x7528; Mybatis &#x7684;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#xFF0C;&#x90A3;&#x4E48;&#x5E94;&#x8BE5;&#x505A;&#x4EE5;&#x4E0B;&#x914D;&#x7F6E;<ul>
<li>&#x9996;&#x5148;&#x5728; Mybatis &#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x6DFB;&#x52A0;&#x914D;&#x7F6E; <strong>&#xFF08;&#x8FD9;&#x4E00;&#x6B65;&#x5176;&#x5B9E;&#x53EF;&#x4EE5;&#x5FFD;&#x7565;&#xFF0C;&#x56E0;&#x4E3A;&#x9ED8;&#x8BA4;&#x503C;&#x4E3A; true&#xFF09;</strong></li>
</ul>
</li>
</ul>
<pre><code>&lt;settings&gt;
    &lt;!-- &#x5F00;&#x542F;&#x7F13;&#x5B58; --&gt;
    &lt;setting name=&quot;cacheEnabled&quot; value=&quot;true&quot;/&gt;
&lt;/settings&gt;
</code></pre><ul>
<li>&#x63A5;&#x7740;&#x5728;&#x6620;&#x5C04;&#x6587;&#x4EF6;&#x4E2D;&#x914D;&#x7F6E;</li>
</ul>
<pre><code>&lt;mapper namespace=&quot;cn.ykf.mapper.UserMapper&quot;&gt;
    &lt;!-- &#x4F7F;&#x7528;&#x7F13;&#x5B58; --&gt;
    &lt;cache/&gt;
&lt;/mapper&gt;
</code></pre><ul>
<li>&#x6700;&#x540E;&#x5728;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x7684;&#x64CD;&#x4F5C;&#x4E0A;&#x914D;&#x7F6E; <strong>&#xFF08;&#x9488;&#x5BF9;&#x6BCF;&#x6B21;&#x67E5;&#x8BE2;&#x90FD;&#x9700;&#x8981;&#x6700;&#x65B0;&#x6570;&#x636E;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x8981;&#x8BBE;&#x7F6E;&#x6210; <code>useCache=&quot;false&quot;</code>&#xFF0C;&#x7981;&#x7528;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#xFF09;</strong></li>
</ul>
<p>```<select id="listAllUsers" resultmap="UserWithAccountsMap" usecache="true"></select></p>
<p><select id="listAllUsers" resultmap="UserWithAccountsMap" usecache="true">
    SELECT * FROM user
</select></p>
<pre><code>
&gt; - &#x5F53;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6240;&#x7F13;&#x5B58;&#x7684;&#x7C7B;&#x4E00;&#x5B9A;&#x8981;**&#x5B9E;&#x73B0; `java.io.Serializable` &#x63A5;&#x53E3;**&#xFF0C;&#x8FD9;&#x6837;&#x624D;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x4FDD;&#x5B58;&#x5BF9;&#x8C61;&#x3002;
&gt; - &#x7531;&#x4E8E;&#x662F;&#x5E8F;&#x5217;&#x5316;&#x4FDD;&#x5B58;&#x5BF9;&#x8C61;&#xFF0C;&#x6240;&#x4EE5;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x4E2D;&#x5B58;&#x653E;&#x7684;&#x662F;&#x6570;&#x636E;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x6574;&#x4E2A;&#x5BF9;&#x8C61;&#x3002;

###### &#x6E90;&#x7801;

* &#x9996;&#x5148;&#xFF0C;excutor&#x662F;&#x5728;sqlsessionfactory&#x521B;&#x5EFA;sqlsession&#x65F6;&#x521B;&#x5EFA;&#x7684;&#xFF0C;&#x7528;&#x4EE5;&#x4F5C;&#x4E3A;sqlsession&#x7684;&#x53C2;&#x6570;&#x4F20;&#x5165;

```java
public class DefaultSqlSessionFactory implements SqlSessionFactory {

private SqlSession openSessionFromDataSource(ExecutorType execType, TransactionIsolationLevel level, boolean autoCommit) {
    Transaction tx = null;

    DefaultSqlSession var8;
    try {
        Environment environment = this.configuration.getEnvironment();
        TransactionFactory transactionFactory = this.getTransactionFactoryFromEnvironment(environment);
        tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);
        Executor executor = this.configuration.newExecutor(tx, execType);
        var8 = new DefaultSqlSession(this.configuration, executor, autoCommit);
    } catch (Exception var12) {
        this.closeTransaction(tx);
        throw ExceptionFactory.wrapException(&quot;Error opening session.  Cause: &quot; + var12, var12);
    } finally {
        ErrorContext.instance().reset();
    }

    return var8;
}
</code></pre><ul>
<li>&#x63A5;&#x7740;&#x770B;&#x4E0B;excutor&#x6709;&#x4EC0;&#x4E48;&#x7C7B;&#x578B;</li>
</ul>
<pre><code class="lang-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Configuration</span> </span>{
 <span class="hljs-function"><span class="hljs-keyword">public</span> Executor <span class="hljs-title">newExecutor</span><span class="hljs-params">(Transaction transaction, ExecutorType executorType)</span> </span>{
        executorType = executorType == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">this</span>.defaultExecutorType : executorType;
        executorType = executorType == <span class="hljs-keyword">null</span> ? ExecutorType.SIMPLE : executorType;
        Object executor;
        <span class="hljs-keyword">if</span> (ExecutorType.BATCH == executorType) {
            executor = <span class="hljs-keyword">new</span> BatchExecutor(<span class="hljs-keyword">this</span>, transaction);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ExecutorType.REUSE == executorType) {
            executor = <span class="hljs-keyword">new</span> ReuseExecutor(<span class="hljs-keyword">this</span>, transaction);
        } <span class="hljs-keyword">else</span> {
            executor = <span class="hljs-keyword">new</span> SimpleExecutor(<span class="hljs-keyword">this</span>, transaction);
        }

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cacheEnabled) {
            executor = <span class="hljs-keyword">new</span> CachingExecutor((Executor)executor);<span class="hljs-comment">//&#x88C5;&#x9970;&#x524D;&#x9762;&#x7684;&#x4E09;&#x4E2A;executor</span>
        }

        Executor executor = (Executor)<span class="hljs-keyword">this</span>.interceptorChain.pluginAll(executor);
        <span class="hljs-keyword">return</span> executor;
    }
}
</code></pre>
<ul>
<li>&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x5982;&#x679C;&#x5F00;&#x542F;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#xFF0C;cachingExecutor&#x4F1A;&#x88AB;&#x4F5C;&#x4E3A;&#x88C5;&#x9970;&#x7C7B;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x8BF4;&#x662F;&#x88C5;&#x9970;&#x7C7B;&#x5462;</li>
</ul>
<pre><code class="lang-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CachingExecutor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Executor</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Executor delegate;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TransactionalCacheManager tcm = <span class="hljs-keyword">new</span> TransactionalCacheManager();

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CachingExecutor</span><span class="hljs-params">(Executor delegate)</span> </span>{
        <span class="hljs-keyword">this</span>.delegate = delegate;
        delegate.setExecutorWrapper(<span class="hljs-keyword">this</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Transaction <span class="hljs-title">getTransaction</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.delegate.getTransaction();
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">close</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> forceRollback)</span> </span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (forceRollback) {
                <span class="hljs-keyword">this</span>.tcm.rollback();
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">this</span>.tcm.commit();
            }
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">this</span>.delegate.close(forceRollback);
        }

    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isClosed</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.delegate.isClosed();
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">update</span><span class="hljs-params">(MappedStatement ms, Object parameterObject)</span> <span class="hljs-keyword">throws</span> SQLException </span>{
        <span class="hljs-keyword">this</span>.flushCacheIfRequired(ms);<span class="hljs-comment">//&#x5237;&#x65B0;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.delegate.update(ms, parameterObject);
    }

    <span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-function">List&lt;E&gt; <span class="hljs-title">query</span><span class="hljs-params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException </span>{
        BoundSql boundSql = ms.getBoundSql(parameterObject);
        CacheKey key = <span class="hljs-keyword">this</span>.createCacheKey(ms, parameterObject, rowBounds, boundSql);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);
    }

    <span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-function">List&lt;E&gt; <span class="hljs-title">query</span><span class="hljs-params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException </span>{
        Cache cache = ms.getCache();
        <span class="hljs-keyword">if</span> (cache != <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">this</span>.flushCacheIfRequired(ms);
            <span class="hljs-keyword">if</span> (ms.isUseCache() &amp;&amp; resultHandler == <span class="hljs-keyword">null</span>) {
                <span class="hljs-keyword">this</span>.ensureNoOutParams(ms, parameterObject, boundSql);
                List&lt;E&gt; list = (List)<span class="hljs-keyword">this</span>.tcm.getObject(cache, key);&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x4E2D;&#x5B58;&#x5728;&#x5219;&#x5728;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x4E2D;&#x8BFB;&#x53D6;
                <span class="hljs-keyword">if</span> (list == <span class="hljs-keyword">null</span>) {
                <span class="hljs-comment">//&#x82E5;&#x662F;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x6CA1;&#x6709;&#xFF0C;&#x5219;&#x5230;&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#x4E2D;&#x67E5;&#x8BE2;</span>
                    list = <span class="hljs-keyword">this</span>.delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);
                    <span class="hljs-keyword">this</span>.tcm.putObject(cache, key, list);<span class="hljs-comment">//&#x4FDD;&#x5B58;&#x5230;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x4E2D;</span>
                }

                <span class="hljs-keyword">return</span> list;<span class="hljs-comment">//&#x8FD4;&#x56DE;</span>
            }
        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;BatchResult&gt; <span class="hljs-title">flushStatements</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.delegate.flushStatements();
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">commit</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> required)</span> <span class="hljs-keyword">throws</span> SQLException </span>{
        <span class="hljs-keyword">this</span>.delegate.commit(required);
        <span class="hljs-keyword">this</span>.tcm.commit();
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">rollback</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> required)</span> <span class="hljs-keyword">throws</span> SQLException </span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">this</span>.delegate.rollback(required);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (required) {
                <span class="hljs-keyword">this</span>.tcm.rollback();
            }

        }

    }

}
</code></pre>
<ul>
<li><p>&#x53EF;&#x4EE5;&#x4ECE;commit&#x7B49;&#x4E8B;&#x52A1;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x6765;&#x662F;&#x7531;&#x4F20;&#x5165;&#x7684;excutor&#xFF08;delegate&#xFF09;&#x5B9E;&#x73B0;&#x7684;&#xFF0C;&#x5E76;&#x4E14;&#x4E0E;TransactionalCacheManager tcm&#x8F85;&#x52A9;&#x5B8C;&#x6210;&#x529F;&#x80FD;&#xFF0C;&#x53EA;&#x6709;query&#x81EA;&#x5DF1;&#x5B9E;&#x73B0;&#x4E86;&#x529F;&#x80FD;&#xFF0C;&#x5373;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#xFF0C;&#x4ECE;&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x4ED6;&#x662F;&#x5148;&#x8BFB;&#x53D6;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x6709;&#x65E0;&#x5185;&#x5BB9;&#xFF0C;&#x6CA1;&#x6709;&#x518D;&#x5230;&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#x4E2D;&#x67E5;&#x770B;&#xFF0C;&#x6CA1;&#x6709;&#x518D;&#x53BB;&#x6570;&#x636E;&#x5E93;&#x67E5;&#x8BE2;&#xFF0C;&#x518D;&#x4FDD;&#x5B58;&#x5230;&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#xFF08;&#x82E5;commit&#x6216;&#xFF09;&#xFF0C;&#x6700;&#x540E;&#x8FD4;&#x8FD8;&#x7ED9;&#x7528;&#x6237;&#x3002;</p>
</li>
<li><p>&#x56E0;&#x4E3A;&#x4E00;&#x4E2A;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x5BF9;&#x5E94;&#x591A;&#x4E2A;&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#xFF0C;&#x6240;&#x4EE5;&#x5728;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;sqlsession&#x9700;&#x8981;&#x5237;&#x65B0;&#x5BFC;&#x81F4;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x5237;&#x65B0;&#x65F6;&#xFF0C;&#x5176;&#x4ED6;sqlsession&#x7684;&#x4E0E;&#x8BE5;sqlsession&#x65E0;&#x5173;&#x8054;&#x7684;&#x6570;&#x636E;&#x53EF;&#x4EE5;&#x5728;&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#x4E2D;&#x83B7;&#x53D6;&#x5C31;&#x884C;&#xFF0C;&#x4F46;&#x662F;&#x5982;&#x679C;&#x662F;&#x76F8;&#x5173;&#x8054;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x6B64;&#x65F6;&#x53C8;&#x7528;&#x5176;&#x4ED6;&#x7684;sqlsession&#x6765;&#x67E5;&#x627E;&#xFF0C;&#x5176;&#x4ED6;sqlsession&#x7684;&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x662F;&#x5426;&#x5B58;&#x5728;&#x8FC7;&#x671F;&#x73B0;&#x8C61;&#x3002;&#xFF08;&#x4E0D;&#x540C;&#x547D;&#x540D;&#x7A7A;&#x95F4;&#xFF1F;&#xFF09;<strong>&#x8FD9;&#x5C31;&#x6D89;&#x53CA;&#x5230;&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x63D0;&#x4EA4;&#x6570;&#x636E;&#x5230;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x4E2D;&#x7684;&#x95EE;&#x9898;&#x4E86;</strong>&#xFF1A;</p>
<p><strong>&#x53EA;&#x6709;&#x4F1A;&#x8BDD;&#x5173;&#x95ED;&#x6216;&#x63D0;&#x4EA4;&#x540E;&#xFF0C;&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x624D;&#x4F1A;&#x8F6C;&#x79FB;&#x5230;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x4E2D;,&#x5E76;&#x4E14;&#x53EA;&#x6709;&#x662F;&#x540C;&#x4E00;&#x4E2A;namespace&#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x83B7;&#x53D6;&#x5230;&#x6570;&#x636E;&#xFF1B;&#x56E0;&#x4E3A;mybatis&#x7684;&#x7F13;&#x5B58;&#x4F1A;&#x88AB;&#x4E00;&#x4E2A;transactioncache&#x7C7B;&#x5305;&#x88C5;&#x4F4F;&#xFF0C;&#x6240;&#x6709;&#x7684;cache.putObject&#x5168;&#x90E8;&#x90FD;&#x4F1A;&#x88AB;&#x6682;&#x65F6;&#x5B58;&#x5230;&#x4E00;&#x4E2A;map&#x91CC;&#xFF0C;&#x7B49;&#x4F1A;&#x8BDD;commit/close&#x4EE5;&#x540E;&#xFF0C;&#x8FD9;&#x4E2A;map&#x91CC;&#x7684;&#x7F13;&#x5B58;&#x5BF9;&#x8C61;&#x624D;&#x4F1A;&#x88AB;&#x771F;&#x6B63;&#x7684;cache&#x7C7B;&#x6267;&#x884C;putObject&#x64CD;&#x4F5C;&#x3002;&#x8FD9;&#x4E48;&#x8BBE;&#x8BA1;&#x7684;&#x539F;&#x56E0;&#x662F;&#x4E3A;&#x4E86;&#x9632;&#x6B62;&#x4E8B;&#x52A1;&#x6267;&#x884C;&#x8FC7;&#x7A0B;&#x4E2D;&#x51FA;&#x5F02;&#x5E38;&#x5BFC;&#x81F4;&#x56DE;&#x6EDA;&#xFF0C;&#x5982;&#x679C;get&#x5230;object&#x540E;&#x76F4;&#x63A5;put&#x8FDB;&#x7F13;&#x5B58;&#xFF0C;&#x4E07;&#x4E00;&#x53D1;&#x751F;&#x56DE;&#x6EDA;&#xFF0C;&#x5C31;&#x5F88;&#x5BB9;&#x6613;&#x5BFC;&#x81F4;mybatis&#x7F13;&#x5B58;&#x88AB;&#x810F;&#x8BFB;</strong></p>
<ul>
<li>&#x8FD9;&#x5C31;&#x4FDD;&#x8BC1;&#x4E86;select&#x5C31;&#x4E0D;&#x4F1A;&#x5230;&#x8FBE;&#x540C;&#x7684;&#x5176;&#x4ED6;&#x7684;sqlsession&#x7684;cache&#x4E2D;&#x4E86;&#xFF0C;&#x82E5;&#x662F;update&#x6210;&#x529F;&#xFF0C;&#x5219;commit&#x6210;&#x529F;&#xFF0C;&#x6570;&#x636E;&#x4E0A;&#x4F20;&#x5230;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x4E2D;&#xFF0C;&#x5BF9;&#x8BE5;sqlsession&#x7684;&#x6570;&#x636E;&#x8BBF;&#x95EE;&#x4F1A;&#x76F4;&#x63A5;&#x5728;&#x4E8C;&#x7EA7;&#x5185;&#x5B58;&#x8BFB;&#x53D6;&#xFF0C;&#x82E5;&#x662F;&#x5931;&#x8D25;&#xFF0C;&#x5219;&#x4E0D;&#x4F1A;commit&#xFF0C;&#x5219;&#x4E0D;&#x4F1A;&#x4E0A;&#x4F20;&#x5230;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x4E2D;&#xFF0C;&#x6570;&#x636E;&#x56E0;&#x4E3A;&#x5931;&#x8D25;&#x4ECD;&#x5E94;&#x662F;&#x539F;&#x6765;&#x7684;&#x6570;&#x636E;&#x624D;&#x662F;&#x5BF9;&#x7684;&#xFF0C;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x6CA1;&#x6709;&#x6536;&#x5230;commit&#x6216;close&#x540E;&#x4F20;&#x6765;&#x7684;&#x6570;&#x636E;&#x800C;&#x4E0D;&#x53D8;&#xFF0C;&#x7EE7;&#x7EED;&#x7B49;&#x5F85;&#x76F8;&#x5E94;&#x7684;sqlsession &#x8FDB;&#x884C;commit/close</li>
</ul>
</li>
<li><p>UserMapper&#x6709;&#x4E00;&#x4E2A;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x533A;&#x57DF;&#xFF08;&#x6309;namespace&#x5206;&#xFF0C;&#x5982;&#x679C;namespace&#x76F8;&#x540C;&#x5219;&#x4F7F;&#x7528;&#x540C;&#x4E00;&#x4E2A;&#x76F8;&#x540C;&#x7684;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x533A;&#xFF09;&#xFF0C;&#x5176;&#x5B83;mapper&#x4E5F;&#x6709;&#x81EA;&#x5DF1;&#x7684;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x533A;&#x57DF;&#xFF08;&#x6309;namespace&#x5206;&#xFF09;</p>
</li>
<li><p>&#x6BCF;&#x4E00;&#x4E2A;namespace&#x7684;mapper&#x90FD;&#x6709;&#x4E00;&#x4E2A;&#x4E8C;&#x7F13;&#x5B58;&#x533A;&#x57DF;&#xFF0C;&#x4E24;&#x4E2A;mapper&#x7684;namespace&#x5982;&#x679C;&#x76F8;&#x540C;&#xFF0C;&#x8FD9;&#x4E24;&#x4E2A;mapper&#x6267;&#x884C;sql&#x67E5;&#x8BE2;&#x5230;&#x6570;&#x636E;&#x5C06;&#x5B58;&#x5728;&#x76F8;&#x540C;&#x7684;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x533A;&#x57DF;&#x4E2D;&#x3002;</p>
</li>
<li><p>mybatis&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x7684;&#x5C40;&#x9650;&#x6027;&#xFF1A;</p>
<blockquote>
<p>&#x7EC6;&#x7C92;&#x5EA6;&#x7F13;&#x5B58;&#x5C31;&#x662F;&#xFF0C;&#x9488;&#x5BF9;&#x67D0;&#x4E2A;&#x5546;&#x54C1;&#xFF0C;&#x5982;&#x679C;&#x8981;&#x4FEE;&#x6539;&#x5176;&#x4FE1;&#x606F;&#xFF0C;&#x53EA;&#x4FEE;&#x6539;&#x8BE5;&#x5546;&#x54C1;&#x7684;&#x7F13;&#x5B58;&#x6570;&#x636E;&#xFF0C;&#x7F13;&#x5B58;&#x533A;&#x7684;&#x5176;&#x4ED6;&#x6570;&#x636E;&#x4E0D;&#x52A8;&#xFF08;&#x4E0D;&#x4F1A;&#x56E0;&#x4E3A;&#x67D0;&#x4E2A;&#x5546;&#x54C1;&#x4FE1;&#x606F;&#x7684;&#x4FEE;&#x6539;&#x5C31;&#x76F4;&#x63A5;&#x6E05;&#x7A7A;&#x6574;&#x4E2A;&#x7F13;&#x5B58;&#x533A;&#xFF09;</p>
</blockquote>
<p>mybatis&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x5BF9;&#x7EC6;&#x7C92;&#x5EA6;&#x7EA7;&#x522B;&#x7684;&#x7F13;&#x5B58;&#x5B9E;&#x73B0;&#x4E0D;&#x597D;&#xFF0C;&#x6BD4;&#x5982;&#x5982;&#x4E0B;&#x9700;&#x6C42;&#xFF1A;
&#x5BF9;&#x5546;&#x54C1;&#x4FE1;&#x606F;&#x8FDB;&#x884C;&#x7F13;&#x5B58;&#xFF0C; &#x7531;&#x4E8E;&#x5546;&#x54C1;&#x4FE1;&#x606F;&#x67E5;&#x8BE2;&#x8BBF;&#x95EE;&#x91CF;&#x5927;&#xFF0C;&#x4F46;&#x662F;&#x8981;&#x6C42;&#x7528;&#x6237;&#x6BCF;&#x6B21;&#x90FD;&#x80FD;&#x67E5;&#x8BE2;&#x5230;&#x6700;&#x65B0;&#x7684;&#x5546;&#x54C1;&#x4FE1;&#x606F;&#xFF0C;&#x6B64;&#x65F6;&#x5982;&#x679C;&#x4F7F;&#x7528;mybatis&#x7684;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#xFF0C;&#x5C31;&#x65E0;&#x6CD5;&#x5B9E;&#x73B0;&#x5F53;&#x4E00;&#x4E2A;&#x5546;&#x54C1;&#x4FE1;&#x606F;&#x53D8;&#x5316;&#x65F6;&#xFF0C;&#x53EA;&#x5237;&#x65B0;&#x8BE5;&#x5546;&#x54C1;&#x7684;&#x7F13;&#x5B58;&#x4FE1;&#x606F;&#xFF0C;&#x800C;&#x4E0D;&#x5237;&#x65B0;&#x5176;&#x5B83;&#x5546;&#x54C1;&#x7684;&#x4FE1;&#x606F;&#x3002;&#x8FD9;&#x662F;&#x56E0;&#x4E3A;mybatis&#x7684;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#x533A;&#x57DF;&#x4EE5;mapper&#x4E3A;&#x5355;&#x4F4D;&#x8FDB;&#x884C;&#x5212;&#x5206;&#xFF0C;&#x5F53;&#x4E00;&#x4E2A;&#x5546;&#x54C1;&#x4FE1;&#x606F;&#x53D8;&#x5316;&#x65F6;&#xFF08;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;mapper&#x7684;&#x4EFB;&#x610F;&#x4E00;&#x4E2A;sqlSession&#x6267;&#x884C;commt&#x64CD;&#x4F5C;&#xFF09;&#xFF0C;&#x4F1A;&#x5C06;&#x6240;&#x6709;&#x5546;&#x54C1;&#x4FE1;&#x606F;&#x7684;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x5168;&#x90E8;&#x6E05;&#x7A7A;&#x3002;&#x89E3;&#x51B3;&#x6B64;&#x95EE;&#x9898;&#xFF0C;&#x9700;&#x8981;&#x5728;&#x4E1A;&#x52A1;&#x5C42;&#x6839;&#x636E;&#x9700;&#x6C42;&#x5BF9;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x9488;&#x5BF9;&#x6027;&#x7684;&#x7F13;&#x5B58;&#xFF08;&#x4E09;&#x7EA7;&#x7F13;&#x5B58;&#xFF09;&#x3002;</p>
</li>
</ul>
<h2 id="&#x6CE8;&#x89E3;&#x5F00;&#x53D1;">&#x6CE8;&#x89E3;&#x5F00;&#x53D1;</h2>
<p>Mybatis &#x4E2D;&#x7684;&#x6CE8;&#x89E3;&#x5F00;&#x53D1;
&#x5728; Mybatis &#x7684;&#x6CE8;&#x89E3;&#x5F00;&#x53D1;&#x4E2D;&#xFF0C;&#x5E38;&#x7528;&#x7684;&#x6CE8;&#x89E3;&#x5982;&#x4E0B;&#x8868;&#x6240;&#x793A;&#xFF1A;
&#x6CE8;&#x89E3;    &#x4F5C;&#x7528;
@Intsert    &#x5B9E;&#x73B0;&#x65B0;&#x589E;
@Update    &#x5B9E;&#x73B0;&#x66F4;&#x65B0;
@Delete    &#x5B9E;&#x73B0;&#x5220;&#x9664;
@Select    &#x5B9E;&#x73B0;&#x67E5;&#x8BE2;
@Results    &#x5B9E;&#x73B0;&#x7ED3;&#x679C;&#x96C6;&#x5C01;&#x88C5;
@ResultMap    &#x5B9E;&#x73B0;&#x5F15;&#x7528; @Results &#x5B9A;&#x4E49;&#x7684;&#x5C01;&#x88C5;
@One    &#x5B9E;&#x73B0;&#x4E00;&#x5BF9;&#x4E00;&#x7ED3;&#x679C;&#x96C6;&#x5C01;&#x88C5;
@Many    &#x5B9E;&#x73B0;&#x4E00;&#x5BF9;&#x591A;&#x7ED3;&#x679C;&#x96C6;&#x5C01;&#x88C5;
@SelectProvider    &#x5B9E;&#x73B0;&#x52A8;&#x6001; SQL &#x6620;&#x5C04;</p>
<h3 id="mybatis-&#x4F7F;&#x7528;&#x6CE8;&#x89E3;&#x5B9E;&#x73B0;&#x5355;&#x8868;-curd">Mybatis &#x4F7F;&#x7528;&#x6CE8;&#x89E3;&#x5B9E;&#x73B0;&#x5355;&#x8868; CURD</h3>
<ul>
<li>&#x7528;&#x6237;&#x5B9E;&#x4F53;&#x7C7B;&#x63A5;&#x53E3;&#x5C42; <code>UserMapper</code> &#x4EE3;&#x7801;&#x5982;&#x4E0B;</li>
</ul>
<pre><code>public interface UserMapper {
    /**
     * &#x67E5;&#x8BE2;&#x6240;&#x6709;&#x7528;&#x6237;
     *
     * @return
     */
    @Select(&quot;SELECT * FROM user&quot;)
    List&lt;User&gt; listAllUsers();

    /**
     * &#x6DFB;&#x52A0;&#x7528;&#x6237;
     *
     * @param user
     * @return &#x6210;&#x529F;&#x8FD4;&#x56DE;1&#xFF0C;&#x5931;&#x8D25;&#x8FD4;&#x56DE;0
     */
    @Insert(&quot;INSERT INTO user(username,birthday,sex,address) VALUES(#{username},#{birthday},#{sex},#{address})&quot;)
    @SelectKey(keyProperty = &quot;id&quot;, keyColumn = &quot;id&quot;, statement = &quot;SELECT LAST_INSERT_ID()&quot;, resultType = Integer.class, before = false)
    int saveUser(User user);

    /**
     * &#x6839;&#x636E;id&#x5220;&#x9664;&#x7528;&#x6237;
     *
     * @param userId
     * @return &#x6210;&#x529F;&#x8FD4;&#x56DE;1&#xFF0C;&#x5931;&#x8D25;&#x8FD4;&#x56DE;0
     */
    @Delete(&quot;DELETE FROM user WHERE id = #{id}&quot;)
    int removeUserById(Integer userId);

    /**
     * &#x4FEE;&#x6539;&#x7528;&#x6237;
     *
     * @param user
     * @return &#x6210;&#x529F;&#x8FD4;&#x56DE;1&#xFF0C;&#x5931;&#x8D25;&#x8FD4;&#x56DE;0
     */
    @Update(&quot;UPDATE user SET username = #{username}, birthday = #{birthday}, sex = #{sex}, address = #{address} WHERE id = #{id}&quot;)
    int updateUser(User user);

    /**
     * &#x6839;&#x636E;id&#x67E5;&#x8BE2;&#x5355;&#x4E2A;&#x7528;&#x6237;
     *
     * @param userId
     * @return
     */
    @Select(&quot;SELECT * FROM user WHERE id = #{id}&quot;)
    User getUserById(Integer userId);

    /**
     * &#x6839;&#x636E;&#x59D3;&#x540D;&#x6A21;&#x7CCA;&#x67E5;&#x8BE2;&#x591A;&#x4E2A;&#x7528;&#x6237;
     *
     * @param username
     * @return
     */
    @Select(&quot;SELECT * FROM user WHERE username LIKE CONCAT(&apos;%&apos;,#{username},&apos;%&apos;)&quot;)
    List&lt;User&gt; listUsersByName(String username);

    /**
     * &#x67E5;&#x8BE2;&#x7528;&#x6237;&#x603B;&#x6570;
     *
     * @return
     */
    @Select(&quot;SELECT COUNT(id) FROM user&quot;)
    int countUser();
}
</code></pre><ul>
<li>&#x6CE8;&#x610F;&#xFF0C;&#x5982;&#x679C;&#x6B64;&#x65F6;<strong>&#x5B9E;&#x4F53;&#x7C7B;&#x7684;&#x5C5E;&#x6027;&#x4E0E;&#x6570;&#x636E;&#x5E93;&#x8868;&#x5217;&#x540D;&#x4E0D;&#x4E00;&#x81F4;</strong>&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x5E94;&#x8BE5;&#x4F7F;&#x7528;<code>@Results&#x3001;@Result&#x3001;@ResultMap</code> &#x7B49;&#x6CE8;&#x89E3;&#xFF0C;&#x5982;&#x4E0B;</li>
</ul>
<pre><code>public interface UserMapper {
    /**
     * &#x67E5;&#x8BE2;&#x6240;&#x6709;&#x7528;&#x6237;
     *
     * @return
     */
    @Select(&quot;SELECT * FROM user&quot;)
    @Results(id = &quot;UserMap&quot;,value = {
            @Result(id = true,property = &quot;userId&quot;,column = &quot;id&quot;),
            @Result(property = &quot;userName&quot;,column = &quot;username&quot;),
            @Result(property = &quot;userBirthday&quot;,column = &quot;birthday&quot;),
            @Result(property = &quot;userSex&quot;,column = &quot;sex&quot;),
            @Result(property = &quot;userAddress&quot;,column = &quot;address&quot;),
    })
    List&lt;User&gt; listAllUsers();

    /**
     * &#x6DFB;&#x52A0;&#x7528;&#x6237;
     *
     * @param user
     * @return &#x6210;&#x529F;&#x8FD4;&#x56DE;1&#xFF0C;&#x5931;&#x8D25;&#x8FD4;&#x56DE;0
     */
    @Insert(&quot;INSERT INTO user(username,birthday,sex,address) VALUES(#{username},#{birthday},#{sex},#{address})&quot;)
    @ResultMap(&quot;UserMap&quot;)
    int saveUser(User user);
</code></pre><blockquote>
<p>@Results &#x6CE8;&#x89E3;&#x7528;&#x4E8E;&#x5B9A;&#x4E49;&#x6620;&#x5C04;&#x7ED3;&#x679C;&#x96C6;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x6807;&#x7B7E; <resultmap></resultmap>&#x3002;
&#x5176;&#x4E2D;&#xFF0C;id &#x5C5E;&#x6027;&#x4E3A;&#x552F;&#x4E00;&#x6807;&#x8BC6;&#x3002;
value &#x5C5E;&#x6027;&#x7528;&#x4E8E;&#x63A5;&#x6536; @Result[] &#x6CE8;&#x89E3;&#x7C7B;&#x578B;&#x7684;&#x6570;&#x7EC4;&#x3002;
@Result &#x6CE8;&#x89E3;&#x7528;&#x4E8E;&#x5B9A;&#x4E49;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x6807;&#x7B7E; <id> &#x548C; <result>
&#x5176;&#x4E2D;&#xFF0C;id &#x5C5E;&#x6027;&#x6307;&#x5B9A;&#x4E3B;&#x952E;&#x3002;
property &#x5C5E;&#x6027;&#x6307;&#x5B9A;&#x5B9E;&#x4F53;&#x7C7B;&#x7684;&#x5C5E;&#x6027;&#x540D;&#xFF0C;column &#x5C5E;&#x6027;&#x6307;&#x5B9A;&#x6570;&#x636E;&#x5E93;&#x8868;&#x4E2D;&#x5BF9;&#x5E94;&#x7684;&#x5217;&#x3002;
@ResultMap &#x6CE8;&#x89E3;&#x7528;&#x4E8E;&#x5F15;&#x7528; @Results &#x5B9A;&#x4E49;&#x7684;&#x6620;&#x5C04;&#x7ED3;&#x679C;&#x96C6;&#xFF0C;&#x907F;&#x514D;&#x4E86;&#x91CD;&#x590D;&#x5B9A;&#x4E49;&#x6620;&#x5C04;&#x7ED3;&#x679C;&#x96C6;&#x3002;</result></id></p>
</blockquote>
<h3 id="mybatis-&#x4F7F;&#x7528;&#x6CE8;&#x89E3;&#x5B9E;&#x73B0;&#x591A;&#x5BF9;&#x4E00;&#xFF08;&#x4E00;&#x5BF9;&#x4E00;&#xFF09;">Mybatis &#x4F7F;&#x7528;&#x6CE8;&#x89E3;&#x5B9E;&#x73B0;&#x591A;&#x5BF9;&#x4E00;&#xFF08;&#x4E00;&#x5BF9;&#x4E00;&#xFF09;</h3>
<p>&#x8FD8;&#x662F;&#x4EE5;&#x4E0A;&#x4E00;&#x7BC7;&#x7B14;&#x8BB0;&#x7684;&#x7528;&#x6237;&#x548C;&#x8D26;&#x6237;&#x4E3A;&#x4F8B;&#x5B50;&#x3002;&#x4E00;&#x4E2A;&#x7528;&#x6237;&#x53EF;&#x4EE5;&#x6709;&#x591A;&#x4E2A;&#x8D26;&#x6237;&#xFF0C;&#x800C;&#x4E00;&#x4E2A;&#x8D26;&#x6237;&#x53EA;&#x80FD;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;&#x7528;&#x6237;&#x3002;
&#x5728; Mybatis &#x4E2D;&#xFF0C;&#x591A;&#x5BF9;&#x4E00;&#x662F;&#x4F5C;&#x4E3A;&#x4E00;&#x5BF9;&#x4E00;&#x6765;&#x8FDB;&#x884C;&#x5904;&#x7406;&#x7684;&#x3002;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x867D;&#x7136;&#x591A;&#x4E2A;&#x8D26;&#x6237;&#x53EF;&#x4EE5;&#x5C5E;&#x4E8E;&#x540C;&#x4E00;&#x4E2A;&#x7528;&#x6237;&#xFF08;&#x591A;&#x5BF9;&#x4E00;&#xFF09;&#xFF0C;&#x4F46;&#x662F;&#x5728;&#x5B9E;&#x4F53;&#x7C7B;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x662F;&#x5728;&#x8D26;&#x6237;&#x7C7B;&#x4E2D;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x7528;&#x6237;&#x7C7B;&#x7684;&#x5BF9;&#x8C61;&#x5F15;&#x7528;&#xFF0C;&#x4EE5;&#x6B64;&#x6765;&#x8868;&#x660E;&#x6240;&#x5C5E;&#x7528;&#x6237;&#x3002;(&#x6B64;&#x65F6;&#x5C31;&#x76F8;&#x5F53;&#x4E8E;&#x4E00;&#x5BF9;&#x4E00;)
&#x8D26;&#x6237;&#x5B9E;&#x4F53;&#x7C7B;&#x548C;&#x7528;&#x6237;&#x5B9E;&#x4F53;&#x7C7B;&#x89C1;&#x4E0A;&#x7BC7;&#x7B14;&#x8BB0;&#xFF0C;&#x63A5;&#x53E3;&#x5C42;&#x4EE3;&#x7801;&#x5982;&#x4E0B;</p>
<pre><code>public interface AccountMapper {
    /**
     * &#x67E5;&#x8BE2;&#x6240;&#x6709;&#x8D26;&#x6237;&#xFF0C;&#x5E76;&#x67E5;&#x8BE2;&#x6240;&#x5C5E;&#x7528;&#x6237;&#xFF0C;&#x91C7;&#x7528;&#x7ACB;&#x5373;&#x52A0;&#x8F7D;
     *
     * @return
     */
    @Select(&quot;SELECT * FROM account&quot;)
    @Results(id = &quot;AccountMap&quot;, value = {
            @Result(id = true, property = &quot;id&quot;, column = &quot;id&quot;),
            @Result(property = &quot;uid&quot;, column = &quot;uid&quot;),
            @Result(property = &quot;user&quot;, column = &quot;uid&quot;,
                    one = @One(select = &quot;cn.ykf.mapper.UserMapper.getUserById&quot;, fetchType = FetchType.EAGER))
    })
    List&lt;Account&gt; listAllAccounts();
}
</code></pre><pre><code>public interface UserMapper {
    /**
     * &#x6839;&#x636E;id&#x67E5;&#x8BE2;&#x5355;&#x4E2A;&#x7528;&#x6237;
     *
     * @param userId
     * @return
     */
    @Select(&quot;SELECT * FROM user WHERE id = #{id}&quot;)
    User getUserById(Integer userId);
}
@One &#x6CE8;&#x89E3;&#x76F8;&#x5F53;&#x4E8E;&#x6807;&#x7B7E; &lt;association&gt;&lt;/association&gt;&#xFF0C;&#x662F;&#x591A;&#x8868;&#x67E5;&#x8BE2;&#x7684;&#x5173;&#x952E;&#xFF0C;&#x5728;&#x6CE8;&#x89E3;&#x4E2D;&#x7528;&#x6765;&#x6307;&#x5B9A;&#x5B50;&#x67E5;&#x8BE2;&#x8FD4;&#x56DE;&#x5355;&#x4E00;&#x5BF9;&#x8C61;&#x3002;
&#x5176;&#x4E2D;&#xFF0C;select &#x5C5E;&#x6027;&#x6307;&#x5B9A;&#x7528;&#x4E8E;&#x67E5;&#x8BE2;&#x7684;&#x63A5;&#x53E3;&#x65B9;&#x6CD5;&#xFF0C;fetchType &#x5C5E;&#x6027;&#x7528;&#x4E8E;&#x6307;&#x5B9A;&#x7ACB;&#x5373;&#x52A0;&#x8F7D;&#x6216;&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#xFF0C;&#x5206;&#x522B;&#x5BF9;&#x5E94; FetchType.EAGER &#x548C; FetchType.LAZY
&#x5728;&#x5305;&#x542B; @one &#x6CE8;&#x89E3;&#x7684; @Result &#x4E2D;&#xFF0C;column &#x5C5E;&#x6027;&#x7528;&#x4E8E;&#x6307;&#x5B9A;&#x5C06;&#x8981;&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#x8FDB;&#x884C;&#x67E5;&#x8BE2;&#x7684;&#x6570;&#x636E;&#x5E93;&#x8868;&#x5217;&#x3002;
</code></pre><h3 id="mybatis-&#x4F7F;&#x7528;&#x6CE8;&#x89E3;&#x5B9E;&#x73B0;&#x4E00;&#x5BF9;&#x591A;">Mybatis &#x4F7F;&#x7528;&#x6CE8;&#x89E3;&#x5B9E;&#x73B0;&#x4E00;&#x5BF9;&#x591A;</h3>
<ul>
<li>&#x4E3A;&#x7528;&#x6237;&#x5B9E;&#x4F53;&#x7C7B;&#x6DFB;&#x52A0;&#x5305;&#x542B;&#x8D26;&#x6237;&#x5B9E;&#x4F53;&#x7C7B;&#x7684;&#x96C6;&#x5408;&#x5F15;&#x7528;&#xFF0C;&#x5177;&#x4F53;&#x4EE3;&#x7801;&#x89C1;&#x4E0A;&#x7BC7;&#x7B14;&#x8BB0;&#x3002;&#x63A5;&#x53E3;&#x5C42;&#x4EE3;&#x7801;&#x5982;&#x4E0B;</li>
</ul>
<pre><code>public interface UserMapper {
    /**
     * &#x67E5;&#x8BE2;&#x6240;&#x6709;&#x7528;&#x6237;&#xFF0C;&#x5E76;&#x4E14;&#x67E5;&#x8BE2;&#x62E5;&#x6709;&#x8D26;&#x6237;&#xFF0C;&#x91C7;&#x7528;&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;
     *
     * @return
     */
    @Select(&quot;SELECT * FROM user&quot;)
    @Results(id = &quot;UserMap&quot;, value = {
            @Result(id = true, property = &quot;userId&quot;, column = &quot;id&quot;),
            @Result(property = &quot;userName&quot;, column = &quot;username&quot;),
            @Result(property = &quot;userBirthday&quot;, column = &quot;birthday&quot;),
            @Result(property = &quot;userSex&quot;, column = &quot;sex&quot;),
            @Result(property = &quot;userAddress&quot;, column = &quot;address&quot;),
            @Result(property = &quot;accounts&quot;, column = &quot;id&quot;,
                    many = @Many(select = &quot;cn.ykf.mapper.AccountMapper.getAccountByUid&quot;, fetchType = FetchType.LAZY))
    })
    List&lt;User&gt; listAllUsers();
</code></pre><pre><code>public interface AccountMapper {
    /**
     * &#x6839;&#x636E;&#x7528;&#x6237;id&#x67E5;&#x8BE2;&#x8D26;&#x6237;&#x5217;&#x8868;
     *
     * @param uid
     * @return
     */
    @Select(&quot;SELECT * FROM account WHERE uid = #{uid}&quot;)
    List&lt;Account&gt; listAccountsByUid(Integer uid);
}
@Many &#x6CE8;&#x89E3;&#x76F8;&#x5F53;&#x4E8E;&#x6807;&#x7B7E; &lt;collection&gt;&lt;/collection&gt;&#xFF0C;&#x662F;&#x591A;&#x8868;&#x67E5;&#x8BE2;&#x7684;&#x5173;&#x952E;&#xFF0C;&#x5728;&#x6CE8;&#x89E3;&#x4E2D;&#x7528;&#x6765;&#x6307;&#x5B9A;&#x5B50;&#x67E5;&#x8BE2;&#x8FD4;&#x56DE;&#x5BF9;&#x8C61;&#x96C6;&#x5408;&#x3002;
&#x5176;&#x4E2D;&#xFF0C;select &#x5C5E;&#x6027;&#x6307;&#x5B9A;&#x7528;&#x4E8E;&#x67E5;&#x8BE2;&#x7684;&#x63A5;&#x53E3;&#x65B9;&#x6CD5;&#xFF0C;fetchType &#x5C5E;&#x6027;&#x7528;&#x4E8E;&#x6307;&#x5B9A;&#x7ACB;&#x5373;&#x52A0;&#x8F7D;&#x6216;&#x5EF6;&#x8FDF;&#x52A0;&#x8F7D;&#xFF0C;&#x5206;&#x522B;&#x5BF9;&#x5E94; FetchType.EAGER &#x548C; FetchType.LAZY
&#x5728;&#x5305;&#x542B; @Many &#x6CE8;&#x89E3;&#x7684; @Result &#x4E2D;&#xFF0C;column &#x5C5E;&#x6027;&#x7528;&#x4E8E;&#x6307;&#x5B9A;&#x5C06;&#x8981;&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#x8FDB;&#x884C;&#x67E5;&#x8BE2;&#x7684;&#x6570;&#x636E;&#x5E93;&#x8868;&#x5217;&#x3002;
</code></pre><h3 id="mybatis-&#x4F7F;&#x7528;&#x6CE8;&#x89E3;&#x5B9E;&#x73B0;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;">Mybatis &#x4F7F;&#x7528;&#x6CE8;&#x89E3;&#x5B9E;&#x73B0;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;</h3>
<ul>
<li>&#x5982;&#x679C;&#x4F7F;&#x7528;&#x6CE8;&#x89E3;&#x65F6;&#x60F3;&#x5F00;&#x542F;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#xFF0C;&#x90A3;&#x4E48;&#x9996;&#x5148;&#x5E94;&#x8BE5;&#x5728; Mybatis &#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x5F00;&#x542F;&#x5168;&#x5C40;&#x914D;&#x7F6E;</li>
</ul>
<pre><code> Mybatis &#x4F7F;&#x7528;&#x6CE8;&#x89E3;&#x5B9E;&#x73B0;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;
&#x5982;&#x679C;&#x4F7F;&#x7528;&#x6CE8;&#x89E3;&#x65F6;&#x60F3;&#x5F00;&#x542F;&#x4E8C;&#x7EA7;&#x7F13;&#x5B58;&#xFF0C;&#x90A3;&#x4E48;&#x9996;&#x5148;&#x5E94;&#x8BE5;&#x5728; Mybatis &#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x5F00;&#x542F;&#x5168;&#x5C40;&#x914D;&#x7F6E;&lt;settings&gt;
    &lt;!-- &#x5F00;&#x542F;&#x7F13;&#x5B58; --&gt;
    &lt;setting name=&quot;cacheEnabled&quot; value=&quot;true&quot;/&gt;
&lt;/settings&gt;
</code></pre><pre><code>@CacheNamespace(blocking = true)
public interface UserMapper {
    // .....
}
</code></pre><h2 id="mybatis&#x5206;&#x9875;&#x529F;&#x80FD;">Mybatis&#x5206;&#x9875;&#x529F;&#x80FD;</h2>
<p><a href="https://blog.csdn.net/chenbaige/article/details/70846902" target="_blank">https://blog.csdn.net/chenbaige/article/details/70846902</a></p>
<p><strong>&#x4E00;.&#x501F;&#x52A9;&#x6570;&#x7EC4;&#x8FDB;&#x884C;&#x5206;&#x9875;&#xFF08;Service&#x5C42;&#x7684;&#x6846;&#x67B6;&#x5B9E;&#x73B0;&#xFF09;</strong></p>
<p>&#x539F;&#x7406;&#xFF1A;&#x8FDB;&#x884C;&#x6570;&#x636E;&#x5E93;&#x67E5;&#x8BE2;&#x64CD;&#x4F5C;&#x65F6;&#xFF0C;&#x83B7;&#x53D6;&#x5230;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x6240;&#x6709;&#x6EE1;&#x8DB3;&#x6761;&#x4EF6;&#x7684;&#x8BB0;&#x5F55;&#xFF0C;&#x4FDD;&#x5B58;&#x5728;&#x5E94;&#x7528;&#x7684;&#x4E34;&#x65F6;&#x6570;&#x7EC4;&#x4E2D;&#xFF0C;&#x518D;&#x901A;&#x8FC7;List&#x7684;subList&#x65B9;&#x6CD5;&#xFF0C;&#x83B7;&#x53D6;&#x5230;&#x6EE1;&#x8DB3;&#x6761;&#x4EF6;&#x7684;&#x6240;&#x6709;&#x8BB0;&#x5F55;&#x3002;</p>
<p>&#x7F3A;&#x70B9;&#xFF1A;&#x6570;&#x636E;&#x5E93;&#x67E5;&#x8BE2;&#x5E76;&#x8FD4;&#x56DE;&#x6240;&#x6709;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x800C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x53EA;&#x662F;&#x6781;&#x5C11;&#x6570;&#x7B26;&#x5408;&#x8981;&#x6C42;&#x7684;&#x6570;&#x636E;&#x3002;&#x5F53;&#x6570;&#x636E;&#x91CF;&#x5C11;&#x65F6;&#xFF0C;&#x8FD8;&#x53EF;&#x4EE5;&#x63A5;&#x53D7;&#x3002;&#x5F53;&#x6570;&#x636E;&#x5E93;&#x6570;&#x636E;&#x91CF;&#x8FC7;&#x5927;&#x65F6;&#xFF0C;&#x6BCF;&#x6B21;&#x67E5;&#x8BE2;&#x5BF9;&#x6570;&#x636E;&#x5E93;&#x548C;&#x7A0B;&#x5E8F;&#x7684;&#x6027;&#x80FD;&#x90FD;&#x4F1A;&#x4EA7;&#x751F;&#x6781;&#x5927;&#x7684;&#x5F71;&#x54CD;&#x3002;</p>
<p><strong>&#x4E8C;.&#x501F;&#x52A9;Sql&#x8BED;&#x53E5;&#x8FDB;&#x884C;&#x5206;&#x9875;(Dao&#x5C42;&#x7684;sql limit&#x5B9E;&#x73B0;)</strong></p>
<p>&#x5B9E;&#x73B0;&#xFF1A;&#x901A;&#x8FC7;sql&#x8BED;&#x53E5;&#x5B9E;&#x73B0;&#x5206;&#x9875;&#x4E5F;&#x662F;&#x975E;&#x5E38;&#x7B80;&#x5355;&#x7684;&#xFF0C;&#x53EA;&#x662F;&#x9700;&#x8981;&#x6539;&#x53D8;&#x6211;&#x4EEC;&#x67E5;&#x8BE2;&#x7684;&#x8BED;&#x53E5;&#x5C31;&#x80FD;&#x5B9E;&#x73B0;&#x4E86;&#xFF0C;&#x5373;&#x5728;sql&#x8BED;&#x53E5;&#x540E;&#x9762;&#x6DFB;&#x52A0;limit&#x5206;&#x9875;&#x8BED;&#x53E5;&#x3002;</p>
<p>&#x5728;xxxMapper.xml&#x6587;&#x4EF6;&#x4E2D;&#x7F16;&#x5199;sql&#x8BED;&#x53E5;&#x901A;&#x8FC7;limit&#x5173;&#x952E;&#x5B57;&#x8FDB;&#x884C;&#x5206;&#x9875;&#xFF1A;</p>
<pre><code class="lang-xml"> <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;queryStudentsBySql&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;map&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;studentmapper&quot;</span>&gt;</span>
        select * from student limit #{currIndex} , #{pageSize}
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
</code></pre>
<p><strong>&#x4E09;.&#x62E6;&#x622A;&#x5668;&#x5206;&#x9875;(PageHelper&#x539F;&#x7406;&#x4E5F;&#x662F;&#x5982;&#x6B64;&#xFF0C;&#x5176;&#x4E2D;startPage&#x53EA;&#x662F;&#x501F;&#x52A9;localThread&#x5148;&#x4FDD;&#x5B58;&#x5206;&#x9875;Page&#x4FE1;&#x606F;&#xFF0C;&#x5E76;&#x5728;Intercept&#x65B9;&#x6CD5;&#x4E2D;&#x8F85;&#x4EE5;dialect&#x5BF9;&#x8C61;&#x8FDB;&#x884C;&#x68C0;&#x6D4B;&#x4E0E;&#x6267;&#x884C;&#x76F8;&#x5173;&#x64CD;&#x4F5C;&#xFF0C;sqlsession&#x4E0B;&#x62E6;&#x622A;&#x5668;&#x7684;limit&#x5B9E;&#x73B0;)</strong></p>
<p>PageHelepr&#x7684;Intecepter&#x5728;dao&#x5C42;&#x4E0B;&#x9762;&#x7684;sqlsession.selectlist&#x4E0B;&#x9762;&#x5BF9;statemnehandler&#x7B49;&#x62E6;&#x622A;&#x5BF9;&#x8C61;&#x8FDB;&#x884C;&#x62E6;&#x622A;&#x751F;&#x6210;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x7684;&#xFF0C;&#x53EF;&#x4EE5;&#x8BF4;&#x662F;&#x5BF9;dao&#x5C42;&#xFF08;sql&#x8BED;&#x53E5;execute&#x524D;&#xFF09;&#x7684;&#x62E6;&#x622A;&#x589E;&#x5F3A;</p>
<p>&#x81EA;&#x5B9A;&#x4E49;&#x62E6;&#x622A;&#x5668;&#x5B9E;&#x73B0;&#x4E86;&#x62E6;&#x622A;&#x6240;&#x6709;StatementHandler&#x7684;prepare&#x65B9;&#x6CD5;&#x5904;&#x7406;&#x7684;xml&#x4E2D;id&#x4EE5;ByPage&#x7ED3;&#x5C3E;&#x7684;&#x8BED;&#x53E5;&#xFF0C;&#x5E76;&#x4E14;&#x5229;&#x7528;&#x83B7;&#x53D6;&#x5230;&#x7684;&#x5206;&#x9875;&#x76F8;&#x5173;&#x53C2;&#x6570;&#x7EDF;&#x4E00;&#x5728;sql&#x8BED;&#x53E5;&#x540E;&#x9762;&#x52A0;&#x4E0A;limit&#x5206;&#x9875;&#x7684;&#x76F8;&#x5173;&#x8BED;&#x53E5;</p>
<blockquote>
<p>&#x5982;&#x4F55;&#x4F7F;&#x7528;Interceptor&#x5462;&#xFF1F;</p>
<p>&#x5B9E;&#x4F8B;&#x5316;&#x540E;&#x7684;Interceptor&#x4F1A;&#x5728;ApplicationContext&#x521D;&#x59CB;&#x5316;&#x65F6;&#x8BFB;&#x53D6;&#x5B9E;&#x73B0;&#x4E86;Inteceptor&#x63A5;&#x53E3;&#x7684;&#x5B9E;&#x4F8B;&#x6309;&#x5B9E;&#x4F8B;&#x987A;&#x5E8F;&#x81EA;&#x52A8;&#x6DFB;&#x52A0;&#x5230;&#x8D23;&#x4EFB;&#x94FE;&#x4E2D;</p>
<p>Interceptor&#x4F1A;&#x5728;&#x4F55;&#x65F6;&#x8D77;&#x4F5C;&#x7528;&#xFF1F;</p>
<p>&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5148;&#x901A;&#x8FC7;@Interceptor&#x5224;&#x65AD;&#x6211;&#x4EEC;&#x7684;Interceptor&#x662F;&#x5BF9;&#x4E8E;&#x5728;sql&#x7684;Executor&#x3001;StatementHandler&#x3001;ParameterHandler&#x3001;ResultSetHandler&#x56DB;&#x4E2A;&#x5904;&#x7406;&#x9636;&#x6BB5;&#x4E2D;&#x8FDB;&#x884C;&#x62E6;&#x622A;&#x7684;&#x4E0E;&#x62E6;&#x622A;&#x4E86;&#x56DB;&#x4E2A;&#x7C7B;&#x4E2D;&#x7684;&#x4EC0;&#x4E48;&#x65B9;&#x6CD5;&#xFF0C;&#x4EE5;&#x4FBF;&#x66F4;&#x597D;&#x7684;&#x7406;&#x89E3;Interceptor&#x5728;&#x54EA;&#x4E00;&#x6B65;&#x5C06;Page&#x4FE1;&#x606F;&#x5F80;&#x4E0B;&#x4F20;&#x9012;&#x3002;&#xFF08;&#x56E0;&#x4E3A;&#x5728;&#x521B;&#x5EFA;sqlSession &#x7684;&#x65F6;&#x5019;&#x5C31;&#x4F1A;&#x540C;&#x6B65;&#x521B;&#x5EFA;Executor&#xFF0C;&#x5E76;&#x5728;query&#x6267;&#x884C;sql&#x8BED;&#x53E5;&#x65F6;&#xFF0C;&#x65B0;&#x5EFA;statementHandler&#x5E76;&#x540C;&#x65F6;&#x521B;&#x5EFA;ParameterHandle&#x548C;ResultSetHandler&#xFF0C;&#x6240;&#x4EE5;Interceptor&#x53EF;&#x4EE5;&#x968F;&#x5FC3;&#x5728;&#x54EA;&#x4E2A;&#x9636;&#x6BB5;&#x8FDB;&#x884C;&#x62E6;&#x622A;&#x5E76;&#x987A;&#x5E8F;&#x5904;&#x7406;&#xFF0C;&#x4E5F;&#x56E0;&#x6B64;&#x662F;&#x5206;&#x9875;&#x63D2;&#x4EF6;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#xFF09;</p>
<p><a href="https://www.cnblogs.com/tanghaorong/p/14094521.html" target="_blank">https://www.cnblogs.com/tanghaorong/p/14094521.html</a></p>
<p>&#x5206;&#x9875;&#x9700;&#x8981;&#x5728;Dao&#x5C42;&#x8FDB;&#x884C;&#x54EA;&#x4E9B;&#x6807;&#x8BB0;&#x4F7F;&#x5F97;Inteceptor&#x80FD;&#x5224;&#x65AD;&#x54EA;&#x4E9B;&#x65B9;&#x6CD5;&#x9700;&#x8981;&#x5206;&#x9875;&#x5462;&#xFF1F;</p>
<p>&#x4E0D;&#x540C;&#x7684;Interceptor&#x6709;&#x4E0D;&#x540C;&#x7684;&#x62E6;&#x622A;&#x903B;&#x8F91;&#xFF0C;&#x4F1A;&#x4F7F;&#x7528;&#x4E0D;&#x540C;&#x7684;&#x903B;&#x8F91;&#x5224;&#x65AD;&#x52A8;&#x6001;&#x589E;&#x5F3A;DAO&#x5C42;&#xFF0C;</p>
<p>&#x5728;&#x62E6;&#x622A;&#x5230;&#x6807;&#x8BB0;&#x7684;&#x62E6;&#x622A;&#x7C7B;&#x7684;&#x62E6;&#x622A;&#x65B9;&#x6CD5;&#x65F6;&#xFF0C;&#x5728;intercept&#x65B9;&#x6CD5;&#x4E2D;&#x5BF9;Dao&#x65B9;&#x6CD5;&#x5C01;&#x88C5;&#x6210;&#x7684;statement&#x8FDB;&#x884C;&#x76F8;&#x5E94;&#x6761;&#x4EF6;&#x7684;&#x5224;&#x65AD;</p>
<p>&#x5982;PageHelper&#x4F1A;&#x5728;&#x6267;&#x884C;Dao&#x5C42;&#x65F6;&#x5224;&#x65AD;ThreadLocal&#x4E0A;&#x7684;&#x67E5;&#x770B;&#x6709;&#x6CA1;&#x6709;Page &#x7684;&#x5C5E;&#x6027;&#x5B58;&#x50A8;&#xFF0C;&#x4E2D;&#x95F4;&#x4F1A;&#x8FDB;&#x884C;&#x5224;&#x65AD;&#x8BE5;sql &#x7684;&#x7C7B;&#x578B;&#x662F;&#x67E5;&#x8BE2;&#xFF0C;&#x8FD8;&#x662F;&#x4FEE;&#x6539;&#x64CD;&#x4F5C;&#x3002;&#x82E5;&#x662F;&#x67E5;&#x8BE2;&#x6709;&#x5219;&#x52A8;&#x6001;&#x589E;&#x5F3A;&#xFF0C;&#x5206;&#x9875;&#x5904;&#x7406;</p>
<p>PaginationInterceptor&#x5219;&#x4F1A;&#x5224;&#x65AD;Dao&#x5C42;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x4E2D;&#x6709;&#x6CA1;&#x6709;&#x5B9E;&#x73B0;IPage&#x63A5;&#x53E3;&#x7684;&#x5982;Page&#x7C7B;&#xFF0C;&#x4E5F;&#x4F1A;&#x5224;&#x65AD;&#x662F;&#x5426;&#x4E3A;&#x67E5;&#x8BE2;&#x64CD;&#x4F5C;&#xFF0C;&#x82E5;&#x662F;&#x4E14;&#x6709;&#x5219;&#x8BFB;&#x53D6;Page&#x7C7B;&#x4E2D;&#x5B58;&#x50A8;&#x7684;&#x5C5E;&#x6027;&#xFF0C;&#x52A8;&#x6001;&#x589E;&#x5F3A;&#xFF0C;&#x8FDB;&#x884C;&#x5206;&#x9875;&#x5904;&#x7406;&#x3002;</p>
</blockquote>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> com.cbg.interceptor;

<span class="hljs-keyword">import</span> org.apache.ibatis.executor.Executor;
<span class="hljs-keyword">import</span> org.apache.ibatis.executor.parameter.ParameterHandler;
<span class="hljs-keyword">import</span> org.apache.ibatis.executor.resultset.ResultSetHandler;
<span class="hljs-keyword">import</span> org.apache.ibatis.executor.statement.StatementHandler;
<span class="hljs-keyword">import</span> org.apache.ibatis.mapping.MappedStatement;
<span class="hljs-keyword">import</span> org.apache.ibatis.plugin.*;
<span class="hljs-keyword">import</span> org.apache.ibatis.reflection.MetaObject;
<span class="hljs-keyword">import</span> org.apache.ibatis.reflection.SystemMetaObject;

<span class="hljs-keyword">import</span> java.sql.Connection;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.Properties;

<span class="hljs-comment">/**
 * Created by chenboge on 2017/5/7.
 * &lt;p&gt;
 * Email:baigegechen@gmail.com
 * &lt;p&gt;
 * description:
 */</span>

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@Intercepts</span> &#x8BF4;&#x660E;&#x662F;&#x4E00;&#x4E2A;&#x62E6;&#x622A;&#x5668;
 * <span class="hljs-doctag">@Signature</span> &#x62E6;&#x622A;&#x5668;&#x7684;&#x7B7E;&#x540D;
 * type &#x62E6;&#x622A;&#x7684;&#x7C7B;&#x578B; &#x56DB;&#x5927;&#x5BF9;&#x8C61;&#x4E4B;&#x4E00;( Executor,ResultSetHandler,ParameterHandler,StatementHandler)
 * method &#x62E6;&#x622A;&#x7684;&#x65B9;&#x6CD5;
 * args &#x53C2;&#x6570;
 */</span>
<span class="hljs-meta">@Intercepts</span>({<span class="hljs-meta">@Signature</span>(type = StatementHandler.class, method = <span class="hljs-string">&quot;prepare&quot;</span>, args = {Connection.class, Integer.class})})
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyPageInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Interceptor</span> </span>{

<span class="hljs-comment">//&#x6BCF;&#x9875;&#x663E;&#x793A;&#x7684;&#x6761;&#x76EE;&#x6570;</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> pageSize;
<span class="hljs-comment">//&#x5F53;&#x524D;&#x73B0;&#x5B9E;&#x7684;&#x9875;&#x6570;</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> currPage;

    <span class="hljs-keyword">private</span> String dbType;


    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">intercept</span><span class="hljs-params">(Invocation invocation)</span> <span class="hljs-keyword">throws</span> Throwable </span>{
        <span class="hljs-comment">//&#x83B7;&#x53D6;StatementHandler&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;RoutingStatementHandler</span>
        StatementHandler statementHandler = (StatementHandler) invocation.getTarget();
        <span class="hljs-comment">//&#x83B7;&#x53D6;statementHandler&#x5305;&#x88C5;&#x7C7B;</span>
        MetaObject MetaObjectHandler = SystemMetaObject.forObject(statementHandler);

        <span class="hljs-comment">//&#x5206;&#x79BB;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x94FE;</span>
        <span class="hljs-keyword">while</span> (MetaObjectHandler.hasGetter(<span class="hljs-string">&quot;h&quot;</span>)) {
            Object obj = MetaObjectHandler.getValue(<span class="hljs-string">&quot;h&quot;</span>);
            MetaObjectHandler = SystemMetaObject.forObject(obj);
        }

        <span class="hljs-keyword">while</span> (MetaObjectHandler.hasGetter(<span class="hljs-string">&quot;target&quot;</span>)) {
            Object obj = MetaObjectHandler.getValue(<span class="hljs-string">&quot;target&quot;</span>);
            MetaObjectHandler = SystemMetaObject.forObject(obj);
        }

        <span class="hljs-comment">//&#x83B7;&#x53D6;&#x8FDE;&#x63A5;&#x5BF9;&#x8C61;</span>
        <span class="hljs-comment">//Connection connection = (Connection) invocation.getArgs()[0];</span>


        <span class="hljs-comment">//object.getValue(&quot;delegate&quot;);  &#x83B7;&#x53D6;StatementHandler&#x7684;&#x5B9E;&#x73B0;&#x7C7B;</span>

        <span class="hljs-comment">//&#x83B7;&#x53D6;&#x67E5;&#x8BE2;&#x63A5;&#x53E3;&#x6620;&#x5C04;&#x7684;&#x76F8;&#x5173;&#x4FE1;&#x606F;</span>
        MappedStatement mappedStatement = (MappedStatement) MetaObjectHandler.getValue(<span class="hljs-string">&quot;delegate.mappedStatement&quot;</span>);
        String mapId = mappedStatement.getId();

        <span class="hljs-comment">//statementHandler.getBoundSql().getParameterObject();</span>

        <span class="hljs-comment">//&#x62E6;&#x622A;&#x4EE5;.ByPage&#x7ED3;&#x5C3E;&#x7684;&#x8BF7;&#x6C42;&#xFF0C;&#x5206;&#x9875;&#x529F;&#x80FD;&#x7684;&#x7EDF;&#x4E00;&#x5B9E;&#x73B0;</span>
        <span class="hljs-keyword">if</span> (mapId.matches(<span class="hljs-string">&quot;.+ByPage$&quot;</span>)) {
            <span class="hljs-comment">//&#x83B7;&#x53D6;&#x8FDB;&#x884C;&#x6570;&#x636E;&#x5E93;&#x64CD;&#x4F5C;&#x65F6;&#x7BA1;&#x7406;&#x53C2;&#x6570;&#x7684;handler</span>
            ParameterHandler parameterHandler = (ParameterHandler) MetaObjectHandler.getValue(<span class="hljs-string">&quot;delegate.parameterHandler&quot;</span>);
            <span class="hljs-comment">//&#x83B7;&#x53D6;&#x8BF7;&#x6C42;&#x65F6;&#x7684;&#x53C2;&#x6570;</span>
            Map&lt;String, Object&gt; paraObject = (Map&lt;String, Object&gt;) parameterHandler.getParameterObject();
            <span class="hljs-comment">//&#x4E5F;&#x53EF;&#x4EE5;&#x8FD9;&#x6837;&#x83B7;&#x53D6;</span>
            <span class="hljs-comment">//paraObject = (Map&lt;String, Object&gt;) statementHandler.getBoundSql().getParameterObject();</span>

            <span class="hljs-comment">//&#x53C2;&#x6570;&#x540D;&#x79F0;&#x548C;&#x5728;service&#x4E2D;&#x8BBE;&#x7F6E;&#x5230;map&#x4E2D;&#x7684;&#x540D;&#x79F0;&#x4E00;&#x81F4;</span>
            currPage = (<span class="hljs-keyword">int</span>) paraObject.get(<span class="hljs-string">&quot;currPage&quot;</span>);
            pageSize = (<span class="hljs-keyword">int</span>) paraObject.get(<span class="hljs-string">&quot;pageSize&quot;</span>);

            String sql = (String) MetaObjectHandler.getValue(<span class="hljs-string">&quot;delegate.boundSql.sql&quot;</span>);
            <span class="hljs-comment">//&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;statementHandler&#x76F4;&#x63A5;&#x83B7;&#x53D6;</span>
            <span class="hljs-comment">//sql = statementHandler.getBoundSql().getSql();</span>

            <span class="hljs-comment">//&#x6784;&#x5EFA;&#x5206;&#x9875;&#x529F;&#x80FD;&#x7684;sql&#x8BED;&#x53E5;</span>
            String limitSql;
            sql = sql.trim();
            limitSql = sql + <span class="hljs-string">&quot; limit &quot;</span> + (currPage - <span class="hljs-number">1</span>) * pageSize + <span class="hljs-string">&quot;,&quot;</span> + pageSize;

            <span class="hljs-comment">//&#x5C06;&#x6784;&#x5EFA;&#x5B8C;&#x6210;&#x7684;&#x5206;&#x9875;sql&#x8BED;&#x53E5;&#x8D4B;&#x503C;&#x4E2A;&#x4F53;&apos;delegate.boundSql.sql&apos;&#xFF0C;&#x5077;&#x5929;&#x6362;&#x65E5;</span>
            MetaObjectHandler.setValue(<span class="hljs-string">&quot;delegate.boundSql.sql&quot;</span>, limitSql);
        }
<span class="hljs-comment">//&#x8C03;&#x7528;&#x539F;&#x5BF9;&#x8C61;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x8FDB;&#x5165;&#x8D23;&#x4EFB;&#x94FE;&#x7684;&#x4E0B;&#x4E00;&#x7EA7;</span>
        <span class="hljs-keyword">return</span> invocation.proceed();
    }


    <span class="hljs-comment">//&#x83B7;&#x53D6;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">plugin</span><span class="hljs-params">(Object o)</span> </span>{
    <span class="hljs-comment">//&#x751F;&#x6210;object&#x5BF9;&#x8C61;&#x7684;&#x52A8;&#x6001;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;</span>
        <span class="hljs-keyword">return</span> Plugin.wrap(o, <span class="hljs-keyword">this</span>);
    }

    <span class="hljs-comment">//&#x8BBE;&#x7F6E;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x7684;&#x53C2;&#x6570;</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setProperties</span><span class="hljs-params">(Properties properties)</span> </span>{
<span class="hljs-comment">//&#x5982;&#x679C;&#x9879;&#x76EE;&#x4E2D;&#x5206;&#x9875;&#x7684;pageSize&#x662F;&#x7EDF;&#x4E00;&#x7684;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x5728;&#x8FD9;&#x91CC;&#x7EDF;&#x4E00;&#x914D;&#x7F6E;&#x548C;&#x83B7;&#x53D6;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x4E0D;&#x7528;&#x6BCF;&#x6B21;&#x8BF7;&#x6C42;&#x90FD;&#x4F20;&#x9012;pageSize&#x53C2;&#x6570;&#x4E86;&#x3002;&#x53C2;&#x6570;&#x662F;&#x5728;&#x914D;&#x7F6E;&#x62E6;&#x622A;&#x5668;&#x65F6;&#x914D;&#x7F6E;&#x7684;&#x3002;</span>
        String limit1 = properties.getProperty(<span class="hljs-string">&quot;limit&quot;</span>, <span class="hljs-string">&quot;10&quot;</span>);
        <span class="hljs-keyword">this</span>.pageSize = Integer.valueOf(limit1);
        <span class="hljs-keyword">this</span>.dbType = properties.getProperty(<span class="hljs-string">&quot;dbType&quot;</span>, <span class="hljs-string">&quot;mysql&quot;</span>);
    }
}
</code></pre>
<p>&#x7F16;&#x5199;&#x597D;&#x62E6;&#x622A;&#x5668;&#x540E;&#xFF0C;&#x9700;&#x8981;&#x6CE8;&#x518C;&#x5230;&#x9879;&#x76EE;&#x4E2D;&#xFF0C;&#x624D;&#x80FD;&#x53D1;&#x6325;&#x5B83;&#x7684;&#x4F5C;&#x7528;&#x3002;&#x5728;mybatis&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x6DFB;&#x52A0;&#x5982;&#x4E0B;&#x4EE3;&#x7801;&#xFF1A;</p>
<pre><code class="lang-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span> <span class="hljs-attr">interceptor</span>=<span class="hljs-string">&quot;com.cbg.interceptor.MyPageInterceptor&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;limit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;10&quot;</span>/&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dbType&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;mysql&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
</code></pre>
<p>&#x82E5;&#x662F;&#x81EA;&#x5B9A;&#x4E49;&#x7684;interceptor&#xFF0C;&#x5219;&#x9700;&#x8981;&#x7528;setProperties&#x65B9;&#x6CD5;&#x5904;&#x7406;&#x6211;&#x4EEC;property&#x6807;&#x7B7E;&#x7684;&#x53C2;&#x6570;&#xFF0C;PageHelper&#x7B49;&#x5DF2;&#x7ECF;&#x8BBE;&#x7F6E;&#x597D;&#x76F8;&#x5E94;&#x7684;properties&#xFF0C;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x5728;property&#x4E2D;&#x5199;&#x5165;&#x76F8;&#x5E94;&#x7684;name&#x548C;value&#x5373;&#x53EF;</p>
<pre><code class="lang-java"> <span class="hljs-comment">//&#x8BFB;&#x53D6;&#x914D;&#x7F6E;&#x7684;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x7684;&#x53C2;&#x6570;</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setProperties</span><span class="hljs-params">(Properties properties)</span> </span>{
        String limit1 = properties.getProperty(<span class="hljs-string">&quot;limit&quot;</span>, <span class="hljs-string">&quot;10&quot;</span>);
        <span class="hljs-keyword">this</span>.pageSize = Integer.valueOf(limit1);
        <span class="hljs-keyword">this</span>.dbType = properties.getProperty(<span class="hljs-string">&quot;dbType&quot;</span>, <span class="hljs-string">&quot;mysql&quot;</span>);
    }
</code></pre>
<p><strong>&#x56DB;.RowBounds&#x5B9E;&#x73B0;&#x5206;&#x9875;&#xFF08;sqlsession&#x7684;selectList&#x65B9;&#x6CD5;&#x91CD;&#x8F7D;&#x540E;&#x5728;&#x6846;&#x67B6;&#x4E2D;&#x5206;&#x9875;&#xFF0C;sqlsession&#x7684;&#x6846;&#x67B6;&#x5B9E;&#x73B0;&#xFF09;</strong></p>
<p>&#x539F;&#x7406;&#xFF1A;&#x901A;&#x8FC7;RowBounds&#x5B9E;&#x73B0;&#x5206;&#x9875;&#x548C;&#x901A;&#x8FC7;&#x6570;&#x7EC4;&#x65B9;&#x5F0F;&#x5206;&#x9875;&#x539F;&#x7406;&#x5DEE;&#x4E0D;&#x591A;&#xFF0C;&#x90FD;&#x662F;&#x4E00;&#x6B21;&#x83B7;&#x53D6;&#x6240;&#x6709;&#x7B26;&#x5408;&#x6761;&#x4EF6;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x7136;&#x540E;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x5BF9;&#x5927;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x64CD;&#x4F5C;&#xFF0C;&#x5B9E;&#x73B0;&#x5206;&#x9875;&#x6548;&#x679C;&#x3002;&#x53EA;&#x662F;&#x6570;&#x7EC4;&#x5206;&#x9875;&#x9700;&#x8981;&#x6211;&#x4EEC;&#x81EA;&#x5DF1;&#x53BB;&#x5B9E;&#x73B0;&#x5206;&#x9875;&#x903B;&#x8F91;&#xFF0C;&#x8FD9;&#x91CC;&#x66F4;&#x52A0;&#x7B80;&#x5316;&#x800C;&#x5DF2;&#x3002;</p>
<p>&#x5B58;&#x5728;&#x95EE;&#x9898;&#xFF1A;&#x4E00;&#x6B21;&#x6027;&#x4ECE;&#x6570;&#x636E;&#x5E93;&#x83B7;&#x53D6;&#x7684;&#x6570;&#x636E;&#x53EF;&#x80FD;&#x4F1A;&#x5F88;&#x591A;&#xFF0C;&#x5BF9;&#x5185;&#x5B58;&#x7684;&#x6D88;&#x8017;&#x5F88;&#x5927;&#xFF0C;&#x53EF;&#x80FD;&#x5BFC;&#x5E08;&#x6027;&#x80FD;&#x53D8;&#x5DEE;&#xFF0C;&#x751A;&#x81F3;&#x5F15;&#x53D1;&#x5185;&#x5B58;&#x6EA2;&#x51FA;&#x3002;</p>
<p>&#x5B9E;&#x73B0;&#xFF1A;&#x5728;Dao&#x5C42;&#x4E2D;&#x9700;&#x8981;&#x5206;&#x9875;&#x7684;&#x65B9;&#x6CD5;&#x7684;SelectList&#x65B9;&#x6CD5;&#x4F9D;&#x636E;Page&#x7B49;Service&#x5C42;&#x4F20;&#x9012;&#x7684;&#x5B9E;&#x53C2;&#xFF0C;&#x8F6C;&#x6362;&#x6210;RowBounds&#x5BF9;&#x8C61;&#x6216;&#x8005;DAO&#x63A5;&#x53E3;&#x5199;&#x6210;List<xxx> xxx(RowBounds page)&#xFF0C;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;mybatis&#x4E5F;&#x4F1A;&#x5B8C;&#x6210;&#x5206;&#x9875;&#x67E5;&#x8BE2;&#x3002;(&#x4F46;&#x662F;Dao&#x63A5;&#x53E3;&#x7684;&#x5F62;&#x53C2;&#x4E3A;Page&#x7B49;&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;&#xFF0C;&#x5374;&#x6CA1;&#x6709;&#x5B9E;&#x73B0;&#x5C06;Page&#x8F6C;&#x6362;&#x6210;RowBounds&#x4EA4;&#x7ED9;selectList&#x65B9;&#x6CD5;&#xFF0C;&#x5219;&#x4E0D;&#x4F1A;&#x5B9E;&#x73B0;&#x5206;&#x9875;&#x529F;&#x80FD;)</xxx></p>
<h2 id="spring&#x4E0E;mybatis-&#x4E8B;&#x52A1;&#x7BA1;&#x7406;">spring&#x4E0E;MyBatis &#x4E8B;&#x52A1;&#x7BA1;&#x7406;</h2>
<p><a href="https://coderbee.net/index.php/framework/20191025/2002" target="_blank">https://coderbee.net/index.php/framework/20191025/2002</a></p>
<h4 id="1-&#x8FD0;&#x884C;&#x73AF;&#x5883;-enviroment">1. &#x8FD0;&#x884C;&#x73AF;&#x5883; Enviroment</h4>
<p> &#x5F53; MyBatis &#x4E0E;&#x4E0D;&#x540C;&#x7684;&#x5E94;&#x7528;&#x7ED3;&#x5408;&#x65F6;&#xFF0C;&#x9700;&#x8981;&#x4E0D;&#x540C;&#x7684;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x673A;&#x5236;&#x3002;&#x4E0E; Spring &#x7ED3;&#x5408;&#x65F6;&#xFF0C;&#x7531; Spring &#x6765;&#x7BA1;&#x7406;&#x4E8B;&#x52A1;&#xFF1B;&#x5355;&#x72EC;&#x4F7F;&#x7528;&#x65F6;&#x9700;&#x8981;&#x81EA;&#x884C;&#x7BA1;&#x7406;&#x4E8B;&#x52A1;&#xFF0C;&#x5728;&#x5BB9;&#x5668;&#x91CC;&#x8FD0;&#x884C;&#x65F6;&#x53EF;&#x80FD;&#x7531;&#x5BB9;&#x5668;&#x8FDB;&#x884C;&#x7BA1;&#x7406;&#x3002;</p>
<p>MyBatis &#x7528; Enviroment &#x6765;&#x8868;&#x793A;&#x8FD0;&#x884C;&#x73AF;&#x5883;&#xFF0C;&#x5176;&#x5C01;&#x88C5;&#x4E86;&#x4E09;&#x4E2A;&#x5C5E;&#x6027;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Configuration</span> </span>{
    <span class="hljs-comment">// &#x4E00;&#x4E2A; MyBatis &#x7684;&#x914D;&#x7F6E;&#x53EA;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;&#x73AF;&#x5883;</span>
    <span class="hljs-keyword">protected</span> Environment environment;
    <span class="hljs-comment">// &#x5176;&#x4ED6;&#x5C5E;&#x6027; .....</span>
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Environment</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String id;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TransactionFactory transactionFactory;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DataSource dataSource;
}
</code></pre>
<h4 id="2-&#x4E8B;&#x52A1;&#x62BD;&#x8C61;">2. &#x4E8B;&#x52A1;&#x62BD;&#x8C61;</h4>
<p>MyBatis &#x628A;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x62BD;&#x8C61;&#x51FA; <code>Transaction</code> &#x63A5;&#x53E3;&#xFF0C;&#x7531; <code>TransactionFactory</code> &#x63A5;&#x53E3;&#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#x8D1F;&#x8D23;&#x521B;&#x5EFA;&#x3002;</p>
<pre><code>public interface Transaction {
    Connection getConnection() throws SQLException;
    void commit() throws SQLException;
    void rollback() throws SQLException;
    void close() throws SQLException;
    Integer getTimeout() throws SQLException;
}

public interface TransactionFactory {
    void setProperties(Properties props);
    Transaction newTransaction(Connection conn);
    Transaction newTransaction(DataSource dataSource, TransactionIsolationLevel level, boolean autoCommit);
}
</code></pre><p>Executor &#x7684;&#x5B9E;&#x73B0;&#x6301;&#x6709;&#x4E00;&#x4E2A; SqlSession &#x5B9E;&#x73B0;&#xFF0C;&#x4E8B;&#x52A1;&#x63A7;&#x5236;&#x662F;&#x59D4;&#x6258;&#x7ED9; SqlSession &#x7684;&#x65B9;&#x6CD5;&#x6765;&#x5B9E;&#x73B0;&#x7684;&#x3002;</p>
<pre><code class="lang-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseExecutor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Executor</span> </span>{
    <span class="hljs-keyword">protected</span> Transaction transaction;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">commit</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> required)</span> <span class="hljs-keyword">throws</span> SQLException </span>{
        <span class="hljs-keyword">if</span> (closed) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ExecutorException(<span class="hljs-string">&quot;Cannot commit, transaction is already closed&quot;</span>);
        }
        clearLocalCache();
        flushStatements();
        <span class="hljs-keyword">if</span> (required) {
            transaction.commit();
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">rollback</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> required)</span> <span class="hljs-keyword">throws</span> SQLException </span>{
        <span class="hljs-keyword">if</span> (!closed) {
            <span class="hljs-keyword">try</span> {
                clearLocalCache();
                flushStatements(<span class="hljs-keyword">true</span>);
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-keyword">if</span> (required) {
                    transaction.rollback();
                }
            }
        }
    }

    <span class="hljs-comment">// &#x7701;&#x7565;&#x5176;&#x4ED6;&#x65B9;&#x6CD5;&#x3001;&#x5C5E;&#x6027;</span>
}
</code></pre>
<h4 id="3-&#x4E0E;-spring-&#x96C6;&#x6210;&#x7684;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;">3. &#x4E0E; Spring &#x96C6;&#x6210;&#x7684;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;</h4>
<h5 id="31-&#x914D;&#x7F6E;-transactionfactory">3.1 &#x914D;&#x7F6E; TransactionFactory</h5>
<p>&#x4E0E; Spring &#x96C6;&#x6210;&#x65F6;&#xFF0C;&#x901A;&#x8FC7; SqlSessionFactoryBean &#x6765;&#x521D;&#x59CB;&#x5316; MyBatis &#x3002;</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">protected</span> SqlSessionFactory <span class="hljs-title">buildSqlSessionFactory</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{
    Configuration configuration;

    XMLConfigBuilder xmlConfigBuilder = <span class="hljs-keyword">null</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.configuration != <span class="hljs-keyword">null</span>) {
        configuration = <span class="hljs-keyword">this</span>.configuration;
        <span class="hljs-keyword">if</span> (configuration.getVariables() == <span class="hljs-keyword">null</span>) {
            configuration.setVariables(<span class="hljs-keyword">this</span>.configurationProperties);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.configurationProperties != <span class="hljs-keyword">null</span>) {
            configuration.getVariables().putAll(<span class="hljs-keyword">this</span>.configurationProperties);
        }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.configLocation != <span class="hljs-keyword">null</span>) {
        xmlConfigBuilder = <span class="hljs-keyword">new</span> XMLConfigBuilder(<span class="hljs-keyword">this</span>.configLocation.getInputStream(), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">this</span>.configurationProperties);
        configuration = xmlConfigBuilder.getConfiguration();
    } <span class="hljs-keyword">else</span> {
        configuration = <span class="hljs-keyword">new</span> Configuration();
        configuration.setVariables(<span class="hljs-keyword">this</span>.configurationProperties);
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.objectFactory != <span class="hljs-keyword">null</span>) {
        configuration.setObjectFactory(<span class="hljs-keyword">this</span>.objectFactory);
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.objectWrapperFactory != <span class="hljs-keyword">null</span>) {
        configuration.setObjectWrapperFactory(<span class="hljs-keyword">this</span>.objectWrapperFactory);
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.vfs != <span class="hljs-keyword">null</span>) {
        configuration.setVfsImpl(<span class="hljs-keyword">this</span>.vfs);
    }

    <span class="hljs-keyword">if</span> (hasLength(<span class="hljs-keyword">this</span>.typeAliasesPackage)) {
        String[] typeAliasPackageArray = tokenizeToStringArray(<span class="hljs-keyword">this</span>.typeAliasesPackage,
        ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS);
        <span class="hljs-keyword">for</span> (String packageToScan : typeAliasPackageArray) {
            configuration.getTypeAliasRegistry().registerAliases(packageToScan,
            typeAliasesSuperType == <span class="hljs-keyword">null</span> ? Object.class : typeAliasesSuperType);
        }
    }

    <span class="hljs-keyword">if</span> (!isEmpty(<span class="hljs-keyword">this</span>.typeAliases)) {
        <span class="hljs-keyword">for</span> (Class&lt;?&gt; typeAlias : <span class="hljs-keyword">this</span>.typeAliases) {
            configuration.getTypeAliasRegistry().registerAlias(typeAlias);
        }
    }

    <span class="hljs-keyword">if</span> (!isEmpty(<span class="hljs-keyword">this</span>.plugins)) {
        <span class="hljs-keyword">for</span> (Interceptor plugin : <span class="hljs-keyword">this</span>.plugins) {
            configuration.addInterceptor(plugin);
        }
    }

    <span class="hljs-keyword">if</span> (hasLength(<span class="hljs-keyword">this</span>.typeHandlersPackage)) {
        String[] typeHandlersPackageArray = tokenizeToStringArray(<span class="hljs-keyword">this</span>.typeHandlersPackage,
        ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS);
        <span class="hljs-keyword">for</span> (String packageToScan : typeHandlersPackageArray) {
            configuration.getTypeHandlerRegistry().register(packageToScan);
        }
    }

    <span class="hljs-keyword">if</span> (!isEmpty(<span class="hljs-keyword">this</span>.typeHandlers)) {
        <span class="hljs-keyword">for</span> (TypeHandler&lt;?&gt; typeHandler : <span class="hljs-keyword">this</span>.typeHandlers) {
            configuration.getTypeHandlerRegistry().register(typeHandler);
        }
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.databaseIdProvider != <span class="hljs-keyword">null</span>) {<span class="hljs-comment">//fix #64 set databaseId before parse mapper xmls</span>
        <span class="hljs-keyword">try</span> {
            configuration.setDatabaseId(<span class="hljs-keyword">this</span>.databaseIdProvider.getDatabaseId(<span class="hljs-keyword">this</span>.dataSource));
        } <span class="hljs-keyword">catch</span> (SQLException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NestedIOException(<span class="hljs-string">&quot;Failed getting a databaseId&quot;</span>, e);
        }
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cache != <span class="hljs-keyword">null</span>) {
        configuration.addCache(<span class="hljs-keyword">this</span>.cache);
    }

    <span class="hljs-keyword">if</span> (xmlConfigBuilder != <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">try</span> {
            xmlConfigBuilder.parse();
        } <span class="hljs-keyword">catch</span> (Exception ex) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NestedIOException(<span class="hljs-string">&quot;Failed to parse config resource: &quot;</span> + <span class="hljs-keyword">this</span>.configLocation, ex);
        } <span class="hljs-keyword">finally</span> {
            ErrorContext.instance().reset();
        }
    }

    <span class="hljs-comment">// &#x521B;&#x5EFA; SpringManagedTransactionFactory</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.transactionFactory == <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">this</span>.transactionFactory = <span class="hljs-keyword">new</span> SpringManagedTransactionFactory();
    }

    <span class="hljs-comment">// &#x5C01;&#x88C5;&#x6210; Environment</span>
    configuration.setEnvironment(<span class="hljs-keyword">new</span> Environment(<span class="hljs-keyword">this</span>.environment, <span class="hljs-keyword">this</span>.transactionFactory, <span class="hljs-keyword">this</span>.dataSource));

    <span class="hljs-keyword">if</span> (!isEmpty(<span class="hljs-keyword">this</span>.mapperLocations)) {
        <span class="hljs-keyword">for</span> (Resource mapperLocation : <span class="hljs-keyword">this</span>.mapperLocations) {
            <span class="hljs-keyword">if</span> (mapperLocation == <span class="hljs-keyword">null</span>) {
                <span class="hljs-keyword">continue</span>;
            }

            <span class="hljs-keyword">try</span> {
                XMLMapperBuilder xmlMapperBuilder = <span class="hljs-keyword">new</span> XMLMapperBuilder(mapperLocation.getInputStream(),
                configuration, mapperLocation.toString(), configuration.getSqlFragments());
                xmlMapperBuilder.parse();
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NestedIOException(<span class="hljs-string">&quot;Failed to parse mapping resource: &apos;&quot;</span> + mapperLocation + <span class="hljs-string">&quot;&apos;&quot;</span>, e);
            } <span class="hljs-keyword">finally</span> {
                ErrorContext.instance().reset();
            }
        }
    } <span class="hljs-keyword">else</span> {
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.sqlSessionFactoryBuilder.build(configuration);
}
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SqlSessionFactoryBuilder</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title">build</span><span class="hljs-params">(Configuration config)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultSqlSessionFactory(config);
    }
}
</code></pre>
<p>&#x91CD;&#x70B9;&#x662F;&#x5728;&#x6784;&#x5EFA; MyBatis Configuration &#x5BF9;&#x8C61;&#x65F6;&#xFF0C;&#x628A; transactionFactory &#x914D;&#x7F6E;&#x6210; SpringManagedTransactionFactory&#xFF0C;&#x518D;&#x5C01;&#x88C5;&#x6210; Environment &#x5BF9;&#x8C61;&#x3002;</p>
<h5 id="32-&#x8FD0;&#x884C;&#x65F6;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;">3.2 &#x8FD0;&#x884C;&#x65F6;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;</h5>
<p>Mapper &#x7684;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x6301;&#x6709;&#x7684;&#x662F; <code>SqlSessionTemplate</code>&#xFF0C;&#x5176;&#x5B9E;&#x73B0;&#x4E86; <code>SqlSession</code> &#x63A5;&#x53E3;&#x3002;</p>
<p><code>SqlSessionTemplate</code> &#x7684;&#x65B9;&#x6CD5;&#x5E76;&#x4E0D;&#x76F4;&#x63A5;&#x8C03;&#x7528;&#x5177;&#x4F53;&#x7684; <code>SqlSession</code> &#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x800C;&#x662F;&#x59D4;&#x6258;&#x7ED9;&#x4E00;&#x4E2A;&#x52A8;&#x6001;&#x4EE3;&#x7406;&#xFF0C;&#x901A;&#x8FC7;&#x4EE3;&#x7406; <code>SqlSessionInterceptor</code> &#x5BF9;&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x8FDB;&#x884C;&#x62E6;&#x622A;&#x3002;</p>
<p><code>SqlSessionInterceptor</code> &#x8D1F;&#x8D23;&#x83B7;&#x53D6;&#x771F;&#x5B9E;&#x7684;&#x4E0E;&#x6570;&#x636E;&#x5E93;&#x5173;&#x8054;&#x7684; <code>SqlSession</code> &#x5B9E;&#x73B0;&#xFF0C;&#x5E76;&#x5728;&#x65B9;&#x6CD5;&#x6267;&#x884C;&#x5B8C;&#x540E;&#x51B3;&#x5B9A;&#x63D0;&#x4EA4;&#x6216;&#x56DE;&#x6EDA;&#x4E8B;&#x52A1;&#x3001;&#x5173;&#x95ED;&#x4F1A;&#x8BDD;&#x3002;</p>
<pre><code class="lang-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SqlSessionTemplate</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">SqlSession</span>, <span class="hljs-title">DisposableBean</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SqlSessionFactory sqlSessionFactory;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ExecutorType executorType;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SqlSession sqlSessionProxy;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PersistenceExceptionTranslator exceptionTranslator;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SqlSessionTemplate</span><span class="hljs-params">(SqlSessionFactory sqlSessionFactory, ExecutorType executorType,
        PersistenceExceptionTranslator exceptionTranslator)</span> </span>{

        notNull(sqlSessionFactory, <span class="hljs-string">&quot;Property &apos;sqlSessionFactory&apos; is required&quot;</span>);
        notNull(executorType, <span class="hljs-string">&quot;Property &apos;executorType&apos; is required&quot;</span>);

        <span class="hljs-keyword">this</span>.sqlSessionFactory = sqlSessionFactory;
        <span class="hljs-keyword">this</span>.executorType = executorType;
        <span class="hljs-keyword">this</span>.exceptionTranslator = exceptionTranslator;

        <span class="hljs-comment">// &#x56E0;&#x4E3A; SqlSession &#x63A5;&#x53E3;&#x58F0;&#x660E;&#x7684;&#x65B9;&#x6CD5;&#x4E5F;&#x4E0D;&#x5C11;&#xFF0C;</span>
        <span class="hljs-comment">// &#x5728;&#x6BCF;&#x4E2A;&#x65B9;&#x6CD5;&#x91CC;&#x6DFB;&#x52A0;&#x4E8B;&#x52A1;&#x76F8;&#x5173;&#x7684;&#x62E6;&#x622A;&#x6BD4;&#x8F83;&#x9EBB;&#x70E6;&#xFF0C;</span>
        <span class="hljs-comment">// &#x4E0D;&#x5982;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5185;&#x90E8;&#x7684;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x8FDB;&#x884C;&#x7EDF;&#x4E00;&#x5904;&#x7406;&#x3002;</span>
        <span class="hljs-keyword">this</span>.sqlSessionProxy = (SqlSession) newProxyInstance(
            SqlSessionFactory.class.getClassLoader(),
            <span class="hljs-keyword">new</span> Class[] { SqlSession.class },
            <span class="hljs-keyword">new</span> SqlSessionInterceptor());
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">update</span><span class="hljs-params">(String statement)</span> </span>{
        <span class="hljs-comment">// &#x5728;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x4E0A;&#x6267;&#x884C;&#x65B9;&#x6CD5;&#x8C03;&#x7528;</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.sqlSessionProxy.update(statement);
    }

    <span class="hljs-comment">// &#x5BF9;&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x8FDB;&#x884C;&#x62E6;&#x622A;&#xFF0C;&#x52A0;&#x5165;&#x4E8B;&#x52A1;&#x63A7;&#x5236;&#x903B;&#x8F91;</span>
    <span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SqlSessionInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">InvocationHandler</span> </span>{
        <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable </span>{
            <span class="hljs-comment">// &#x83B7;&#x53D6;&#x4E0E;&#x6570;&#x636E;&#x5E93;&#x5173;&#x8054;&#x7684;&#x4F1A;&#x8BDD;</span>
            SqlSession sqlSession = SqlSessionUtils.getSqlSession(
                SqlSessionTemplate.<span class="hljs-keyword">this</span>.sqlSessionFactory,
                SqlSessionTemplate.<span class="hljs-keyword">this</span>.executorType,
                SqlSessionTemplate.<span class="hljs-keyword">this</span>.exceptionTranslator);
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// &#x6267;&#x884C; SQL &#x64CD;&#x4F5C;</span>
                Object result = method.invoke(sqlSession, args);
                <span class="hljs-keyword">if</span> (!SqlSessionUtils.isSqlSessionTransactional(sqlSession, SqlSessionTemplate.<span class="hljs-keyword">this</span>.sqlSessionFactory)) {
                    <span class="hljs-comment">// &#x5982;&#x679C; sqlSession &#x4E0D;&#x662F; Spring &#x7BA1;&#x7406;&#x7684;&#xFF0C;&#x5219;&#x8981;&#x81EA;&#x884C;&#x63D0;&#x4EA4;&#x4E8B;&#x52A1;</span>
                    sqlSession.commit(<span class="hljs-keyword">true</span>);
                }
                <span class="hljs-keyword">return</span> result;
            } <span class="hljs-keyword">catch</span> (Throwable t) {
                Throwable unwrapped = unwrapThrowable(t);
                <span class="hljs-keyword">if</span> (SqlSessionTemplate.<span class="hljs-keyword">this</span>.exceptionTranslator != <span class="hljs-keyword">null</span> &amp;&amp; unwrapped <span class="hljs-keyword">instanceof</span> PersistenceException) {

                    SqlSessionUtils.closeSqlSession(sqlSession, SqlSessionTemplate.<span class="hljs-keyword">this</span>.sqlSessionFactory);
                    sqlSession = <span class="hljs-keyword">null</span>;
                    Throwable translated = SqlSessionTemplate.<span class="hljs-keyword">this</span>.exceptionTranslator.translateExceptionIfPossible((PersistenceException) unwrapped);
                    <span class="hljs-keyword">if</span> (translated != <span class="hljs-keyword">null</span>) {
                        unwrapped = translated;
                    }
                }
                <span class="hljs-keyword">throw</span> unwrapped;
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-keyword">if</span> (sqlSession != <span class="hljs-keyword">null</span>) {
                    SqlSessionUtils.closeSqlSession(sqlSession, SqlSessionTemplate.<span class="hljs-keyword">this</span>.sqlSessionFactory);
                }
            }
        }
    }
}
</code></pre>
<p><code>SqlSessionUtils</code> &#x5C01;&#x88C5;&#x4E86;&#x5BF9; Spring &#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x673A;&#x5236;&#x7684;&#x8BBF;&#x95EE;&#x3002;</p>
<pre><code class="lang-java"><span class="hljs-comment">// SqlSessionUtils</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SqlSession <span class="hljs-title">getSqlSession</span><span class="hljs-params">(SqlSessionFactory sessionFactory, ExecutorType executorType, PersistenceExceptionTranslator exceptionTranslator)</span> </span>{
    <span class="hljs-comment">// &#x4ECE; Spring &#x7684;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x673A;&#x5236;&#x90A3;&#x91CC;&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x4E8B;&#x52A1;&#x5173;&#x8054;&#x7684;&#x4F1A;&#x8BDD;</span>
    SqlSessionHolder holder = (SqlSessionHolder) TransactionSynchronizationManager.getResource(sessionFactory);

    SqlSession session = sessionHolder(executorType, holder);
    <span class="hljs-keyword">if</span> (session != <span class="hljs-keyword">null</span>) {
        <span class="hljs-comment">// &#x5DF2;&#x7ECF;&#x6709;&#x4E00;&#x4E2A;&#x4F1A;&#x8BDD;&#x5219;&#x590D;&#x7528;</span>
        <span class="hljs-keyword">return</span> session;
    }

    <span class="hljs-comment">// &#x521B;&#x5EFA;&#x65B0;&#x7684; &#x4F1A;&#x8BDD;</span>
    session = sessionFactory.openSession(executorType);

    <span class="hljs-comment">// &#x6CE8;&#x518C;&#x5230; Spring &#x7684;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x673A;&#x5236;&#x91CC;</span>
    registerSessionHolder(sessionFactory, executorType, exceptionTranslator, session);

    <span class="hljs-keyword">return</span> session;
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerSessionHolder</span><span class="hljs-params">(SqlSessionFactory sessionFactory, ExecutorType executorType,
        PersistenceExceptionTranslator exceptionTranslator, SqlSession session)</span> </span>{
    SqlSessionHolder holder;
    <span class="hljs-keyword">if</span> (TransactionSynchronizationManager.isSynchronizationActive()) {
        Environment environment = sessionFactory.getConfiguration().getEnvironment();

        <span class="hljs-keyword">if</span> (environment.getTransactionFactory() <span class="hljs-keyword">instanceof</span> SpringManagedTransactionFactory) {
            holder = <span class="hljs-keyword">new</span> SqlSessionHolder(session, executorType, exceptionTranslator);
            TransactionSynchronizationManager.bindResource(sessionFactory, holder);

            <span class="hljs-comment">// &#x91CD;&#x70B9;&#xFF1A;&#x6CE8;&#x518C;&#x4F1A;&#x8BDD;&#x7BA1;&#x7406;&#x7684;&#x56DE;&#x8C03;&#x94A9;&#x5B50;&#xFF0C;&#x771F;&#x6B63;&#x7684;&#x5173;&#x95ED;&#x52A8;&#x4F5C;&#x662F;&#x5728;&#x56DE;&#x8C03;&#x91CC;&#x5B8C;&#x6210;&#x7684;&#x3002;</span>
            TransactionSynchronizationManager.registerSynchronization(<span class="hljs-keyword">new</span> SqlSessionSynchronization(holder, sessionFactory));
            holder.setSynchronizedWithTransaction(<span class="hljs-keyword">true</span>);

            <span class="hljs-comment">// &#x7EF4;&#x62A4;&#x4F1A;&#x8BDD;&#x7684;&#x5F15;&#x7528;&#x8BA1;&#x6570;</span>
            holder.requested();
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (TransactionSynchronizationManager.getResource(environment.getDataSource()) == <span class="hljs-keyword">null</span>) {
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> TransientDataAccessResourceException(
                    <span class="hljs-string">&quot;SqlSessionFactory must be using a SpringManagedTransactionFactory in order to use Spring transaction synchronization&quot;</span>);
            }
        }
    } <span class="hljs-keyword">else</span> {
    }
}

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">closeSqlSession</span><span class="hljs-params">(SqlSession session, SqlSessionFactory sessionFactory)</span> </span>{
    <span class="hljs-comment">// &#x4ECE;&#x7EBF;&#x7A0B;&#x672C;&#x5730;&#x53D8;&#x91CF;&#x91CC;&#x83B7;&#x53D6; Spring &#x7BA1;&#x7406;&#x7684;&#x4F1A;&#x8BDD;</span>
    SqlSessionHolder holder = (SqlSessionHolder) TransactionSynchronizationManager.getResource(sessionFactory);
    <span class="hljs-keyword">if</span> ((holder != <span class="hljs-keyword">null</span>) &amp;&amp; (holder.getSqlSession() == session)) {
        <span class="hljs-comment">// Spring &#x7BA1;&#x7406;&#x7684;&#x4E0D;&#x76F4;&#x63A5;&#x5173;&#x95ED;&#xFF0C;&#x7531;&#x56DE;&#x8C03;&#x94A9;&#x5B50;&#x6765;&#x5173;&#x95ED;</span>
        holder.released();
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// &#x975E; Spring &#x7BA1;&#x7406;&#x7684;&#x76F4;&#x63A5;&#x5173;&#x95ED;</span>
        session.close();
    }
}
</code></pre>
<p><code>SqlSessionSynchronization</code> &#x662F; <code>SqlSessionUtils</code> &#x7684;&#x5185;&#x90E8;&#x79C1;&#x6709;&#x7C7B;&#xFF0C;&#x7528;&#x4E8E;&#x4F5C;&#x4E3A;&#x56DE;&#x8C03;&#x94A9;&#x5B50;&#x4E0E; Spring &#x7684;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x673A;&#x5236;&#x534F;&#x8C03;&#x5DE5;&#x4F5C;&#xFF0C;<code>TransactionSynchronizationManager</code> &#x5728;&#x9002;&#x5F53;&#x7684;&#x65F6;&#x5019;&#x56DE;&#x8C03;&#x5176;&#x65B9;&#x6CD5;&#x3002;</p>
<pre><code class="lang-java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SqlSessionSynchronization</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TransactionSynchronizationAdapter</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SqlSessionHolder holder;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SqlSessionFactory sessionFactory;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> holderActive = <span class="hljs-keyword">true</span>;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SqlSessionSynchronization</span><span class="hljs-params">(SqlSessionHolder holder, SqlSessionFactory sessionFactory)</span> </span>{
        <span class="hljs-keyword">this</span>.holder = holder;
        <span class="hljs-keyword">this</span>.sessionFactory = sessionFactory;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getOrder</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> DataSourceUtils.CONNECTION_SYNCHRONIZATION_ORDER - <span class="hljs-number">1</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">suspend</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.holderActive) {
            TransactionSynchronizationManager.unbindResource(<span class="hljs-keyword">this</span>.sessionFactory);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">resume</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.holderActive) {
            TransactionSynchronizationManager.bindResource(<span class="hljs-keyword">this</span>.sessionFactory, <span class="hljs-keyword">this</span>.holder);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beforeCommit</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> readOnly)</span> </span>{
        <span class="hljs-keyword">if</span> (TransactionSynchronizationManager.isActualTransactionActive()) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">this</span>.holder.getSqlSession().commit();
            } <span class="hljs-keyword">catch</span> (PersistenceException p) {
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.holder.getPersistenceExceptionTranslator() != <span class="hljs-keyword">null</span>) {
                    DataAccessException translated = <span class="hljs-keyword">this</span>.holder
                        .getPersistenceExceptionTranslator()
                        .translateExceptionIfPossible(p);
                    <span class="hljs-keyword">if</span> (translated != <span class="hljs-keyword">null</span>) {
                        <span class="hljs-keyword">throw</span> translated;
                    }
                }
                <span class="hljs-keyword">throw</span> p;
            }
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beforeCompletion</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.holder.isOpen()) {
            TransactionSynchronizationManager.unbindResource(sessionFactory);
            <span class="hljs-keyword">this</span>.holderActive = <span class="hljs-keyword">false</span>;

            <span class="hljs-comment">// &#x771F;&#x6B63;&#x5173;&#x95ED;&#x6570;&#x636E;&#x5E93;&#x4F1A;&#x8BDD;</span>
            <span class="hljs-keyword">this</span>.holder.getSqlSession().close();
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterCompletion</span><span class="hljs-params">(<span class="hljs-keyword">int</span> status)</span> </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.holderActive) {
            TransactionSynchronizationManager.unbindResourceIfPossible(sessionFactory);
            <span class="hljs-keyword">this</span>.holderActive = <span class="hljs-keyword">false</span>;

            <span class="hljs-comment">// &#x771F;&#x6B63;&#x5173;&#x95ED;&#x6570;&#x636E;&#x5E93;&#x4F1A;&#x8BDD;</span>
            <span class="hljs-keyword">this</span>.holder.getSqlSession().close();
        }
        <span class="hljs-keyword">this</span>.holder.reset();
    }
}
</code></pre>
<h5 id="33-&#x521B;&#x5EFA;&#x65B0;&#x4F1A;&#x8BDD;">3.3 &#x521B;&#x5EFA;&#x65B0;&#x4F1A;&#x8BDD;</h5>
<pre><code class="lang-java"><span class="hljs-comment">// DefaultSqlSessionFactory</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> SqlSession <span class="hljs-title">openSessionFromDataSource</span><span class="hljs-params">(ExecutorType execType, TransactionIsolationLevel level, <span class="hljs-keyword">boolean</span> autoCommit)</span> </span>{
    Transaction tx = <span class="hljs-keyword">null</span>;
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">final</span> Environment environment = configuration.getEnvironment();

        <span class="hljs-comment">// &#x83B7;&#x53D6;&#x4E8B;&#x52A1;&#x5DE5;&#x5382;&#x5B9E;&#x73B0;</span>
        <span class="hljs-keyword">final</span> TransactionFactory transactionFactory = getTransactionFactoryFromEnvironment(environment);

        tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);

        <span class="hljs-keyword">final</span> Executor executor = configuration.newExecutor(tx, execType);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultSqlSession(configuration, executor, autoCommit);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        closeTransaction(tx); <span class="hljs-comment">// may have fetched a connection so lets call close()</span>
        <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error opening session.  Cause: &quot;</span> + e, e);
    } <span class="hljs-keyword">finally</span> {
        ErrorContext.instance().reset();
    }
}

<span class="hljs-function"><span class="hljs-keyword">private</span> TransactionFactory <span class="hljs-title">getTransactionFactoryFromEnvironment</span><span class="hljs-params">(Environment environment)</span> </span>{
    <span class="hljs-keyword">if</span> (environment == <span class="hljs-keyword">null</span> || environment.getTransactionFactory() == <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ManagedTransactionFactory();
    }
    <span class="hljs-keyword">return</span> environment.getTransactionFactory();
}
</code></pre>
<h4 id="4-&#x5C0F;&#x7ED3;">4. &#x5C0F;&#x7ED3;</h4>
<ol>
<li>MyBatis &#x7684;&#x6838;&#x5FC3;&#x7EC4;&#x4EF6; Executor &#x901A;&#x8FC7; Transaction &#x63A5;&#x53E3;&#x6765;&#x8FDB;&#x884C;&#x4E8B;&#x52A1;&#x63A7;&#x5236;&#x3002;</li>
<li>&#x4E0E; Spring &#x96C6;&#x6210;&#x65F6;&#xFF0C;&#x521D;&#x59CB;&#x5316; Configuration &#x65F6;&#x4F1A;&#x628A; transactionFactory &#x8BBE;&#x7F6E;&#x4E3A; SpringManagedTransactionFactory &#x7684;&#x5B9E;&#x4F8B;&#x3002;</li>
<li>&#x6BCF;&#x4E2A; Mapper &#x4EE3;&#x7406;&#x91CC;&#x6CE8;&#x5165;&#x7684; SqlSession &#x662F; SqlSessionTemplate &#x7684;&#x5B9E;&#x4F8B;&#xFF0C;&#x5176;&#x5B9E;&#x73B0;&#x4E86; SqlSession &#x63A5;&#x53E3;&#xFF1B;</li>
<li>SqlSessionTemplate &#x628A;&#x5BF9; SqlSession &#x63A5;&#x53E3;&#x91CC;&#x58F0;&#x660E;&#x7684;&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x59D4;&#x6258;&#x7ED9;&#x5185;&#x90E8;&#x7684;&#x4E00;&#x4E2A;&#x52A8;&#x6001;&#x4EE3;&#x7406;&#xFF0C;&#x8BE5;&#x4EE3;&#x7406;&#x7684;&#x65B9;&#x6CD5;&#x5904;&#x7406;&#x5668;&#x4E3A;&#x5185;&#x90E8;&#x7C7B; SqlSessionInterceptor &#x3002;</li>
<li>SqlSessionInterceptor &#x63A5;&#x6536;&#x5230;&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x65F6;&#xFF0C;&#x901A;&#x8FC7; SqlSessionUtil &#x8BBF;&#x95EE; Spring &#x7684;&#x4E8B;&#x52A1;&#x8BBE;&#x65BD;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x4E0E; Spring &#x5F53;&#x524D;&#x4E8B;&#x52A1;&#x5173;&#x8054;&#x7684; SqlSession &#x5219;&#x590D;&#x7528;&#xFF1B;&#x6CA1;&#x6709;&#x5219;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x3002;</li>
<li>SqlSessionInterceptor &#x6839;&#x636E; Spring &#x5F53;&#x524D;&#x4E8B;&#x52A1;&#x7684;&#x72B6;&#x6001;&#x6765;&#x51B3;&#x5B9A;&#x662F;&#x5426;&#x63D0;&#x4EA4;&#x6216;&#x56DE;&#x6EDA;&#x4E8B;&#x52A1;&#x3002;&#x4F1A;&#x8BDD;&#x7684;&#x771F;&#x6B63;&#x5173;&#x95ED;&#x662F;&#x901A;&#x8FC7;&#x6CE8;&#x518C;&#x5728; TransactionSynchronizationManager &#x4E0A;&#x7684;&#x56DE;&#x8C03;&#x94A9;&#x5B50;&#x5B9E;&#x73B0;&#x7684;&#x3002;</li>
</ol>
<p><img src="https://coderbee.net/wp-content/uploads/2019/10/mybatis-mapper-call.png" alt="img"></p>
<p>&#x5982;&#x4E0A;&#x56FE;&#xFF1A;</p>
<ol>
<li>&#x6B65;&#x9AA4; 1 &#x662F; Spring AOP &#x6DFB;&#x52A0;&#x7684;&#x5207;&#x9762;&#x7684;&#x6267;&#x884C;&#xFF0C;&#x4E8B;&#x52A1;&#x662F;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x5207;&#x9762;&#x3002;</li>
<li>&#x6B65;&#x9AA4; 2 &#x662F; Spring &#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x673A;&#x5236;&#x7684;&#x90E8;&#x5206;&#x3002;</li>
<li>&#x6B65;&#x9AA4; 3 &#x662F;&#x4E1A;&#x52A1;&#x4EE3;&#x7801;&#xFF0C;&#x8C03;&#x7528; Mapper &#x4EE3;&#x7406;&#x4E0A;&#x7684;&#x65B9;&#x6CD5;&#x3002;</li>
<li>&#x6B65;&#x9AA4; 4 &#x662F;&#x4EE3;&#x7406;&#x4E0A;&#x7684;&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x88AB; MapperProxy.invoke &#x62E6;&#x622A;&#x3002;</li>
<li>&#x6B65;&#x9AA4; 5&#x3001;6 &#x662F;&#x56E0;&#x4E3A; MapperProxy &#x6301;&#x6709;&#x7684; sqlSession &#x662F; SqlSessionTemplate&#xFF0C;&#x8C03;&#x7528;&#x5230; template &#x4E0A;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x53C8;&#x88AB;&#x8F6C;&#x53D1;&#x7ED9;&#x5185;&#x90E8;&#x7C7B; SqlSessionInterceptor &#xFF0C;&#x8BE5;&#x7C7B;&#x83B7;&#x5F97; Spring &#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x6301;&#x6709;&#x7684;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;&#xFF0C;&#x7528;&#x4EE5;&#x521B;&#x5EFA; Executor h&#x548C; DefaultSqlSession&#x3002;</li>
<li>&#x6B65;&#x9AA4; 7 &#x7528; DefaultSqlSession &#x53D1;&#x8D77;&#x6570;&#x636E;&#x5E93;&#x8C03;&#x7528;&#x3002;</li>
</ol>
<h2 id="spring-&#x4E0E;-mybatis">Spring &#x4E0E; MyBatis</h2>
<h4 id="&#x7B80;&#x8981;&#x6982;&#x8FF0;">&#x7B80;&#x8981;&#x6982;&#x8FF0;</h4>
<ul>
<li>&#x5728;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x5BF9;service&#x5C42;&#x7684;AOP&#x5B9E;&#x73B0;&#xFF0C;&#x4F7F;&#x5F97;SpringMVC&#x7B49;servlet&#x8C03;&#x7528;&#x5BB9;&#x5668;&#x4E2D;&#x7684;Service&#x5BF9;&#x8C61;&#x65F6;&#xFF0C;&#x4F1A;&#x7528;TransactionInterceptor&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x52A8;&#x6001;&#x5904;&#x7406;&#xFF0C;&#x4E3A;&#x5176;&#x8C03;&#x7528;DataSourceTransactionManager&#x4E3A;&#x5176;&#x521B;&#x5EFA;transaction&#x5E76;&#x5C06;connection&#x7ED1;&#x5B9A;&#x5230;ThreadLocal&#xFF08;&#x5173;&#x952E;&#x5B57;&#x4E3A;datasource&#xFF0C;&#x4E4B;&#x540E;&#x7528;&#x5230;&#x8BE5;datasource&#x7684;&#x5C31;&#x7528;&#x8BE5;connectionholder&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x7528;&#x6765;&#x5224;&#x65AD;&#x662F;&#x5426;&#x5B58;&#x5728;&#x4E8B;&#x52A1;Spring&#x7684;&#x4E8B;&#x52A1;&#x63A7;&#x5236;&#xFF09;&#x4E2D;</li>
<li><strong>&#xFF08;service&#x5BF9;&#x8C61;&#x4E00;&#x7ECF;&#x4ECE;&#x5BB9;&#x5668;&#x4E2D;&#x83B7;&#x53D6;&#x5C31;&#x6267;&#x884C;&#xFF0C;&#x4F7F;&#x5F97;commit&#x7B49;&#x4EA4;&#x6613;transaction&#x7BA1;&#x7406;&#xFF0C;sqlsession&#x4FDD;&#x5B58;&#x5728;&#x7EBF;&#x7A0B;&#x4E2D;&#xFF0C;&#x53EF;&#x91CD;&#x590D;&#x4F7F;&#x7528;&#xFF0C;&#x5426;&#x5219;sqlsession&#x662F;&#x7531;&#x6BCF;&#x4E2A;&#x5355;&#x72EC;&#x7684;MapperFactoryBean&#x8C03;&#x7528;&#x7684;&#xFF0C;&#x6BCF;&#x4E2A;&#x6267;&#x884C;&#x5B8C;&#x4FBF;&#x63D0;&#x4EA4;&#xFF0C;&#x518D;&#x6B21;&#x8C03;&#x7528;&#x4F1A;&#x83B7;&#x53D6;&#x4E0D;&#x540C;&#x7684;connection&#xFF0C;&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#x5931;&#x6548;&#xFF1B;&#x5C31;&#x7B97;&#x4F60;&#x4E0D;&#x81EA;&#x52A8;&#x63D0;&#x4EA4;&#xFF08;&#x6CA1;&#x5F00;&#x542F;&#x4E8B;&#x52A1;&#x4E00;&#x822C;&#x662F;&#x81EA;&#x52A8;commit&#xFF09;&#xFF0C;&#x4E0D;&#x5F00;&#x542F;&#x4E8B;&#x52A1;&#x4E5F;&#x4E0D;&#x80FD;&#x4FDD;&#x8BC1;&#x540C;&#x4E00;&#x4E2A;sqlsession&#x8C03;&#x7528;&#x7684;&#x662F;&#x540C;&#x4E00;&#x4E2A;connection&#xFF0C;&#x53EF;&#x80FD;&#x51FA;&#x73B0;&#x66F4;&#x5927;&#x7684;&#x95EE;&#x9898;&#x5982;&#x810F;&#x8BFB;&#x7B49;&#xFF0C;&#x82E5;&#x662F;&#x7ED1;&#x5B9A;&#x540C;&#x4E00;&#x4E2A;&#x5219;&#x53C8;&#x662F;&#x4E8B;&#x52A1;&#x7684;&#x539F;&#x7406;&#x4E86;&#xFF09;</strong></li>
<li>&#x5BF9;service&#x4E2D;&#x7684;&#x65B9;&#x6CD5;&#x8FDB;&#x884C;&#x8C03;&#x7528;&#x65F6;&#xFF0C;&#x5C31;&#x9700;&#x8981;&#x8C03;&#x7528;&#x5230;dao&#x5C42;&#x7684;&#x65B9;&#x6CD5;&#x4E0E;mysql&#x8FDB;&#x884C;&#x4EA4;&#x4E92;&#xFF0C;&#x800C;dao&#x5C42;&#x7684;&#x7ECF;&#x8FC7;MapperScannerConfigurer&#x7684;&#x81EA;&#x52A8;&#x626B;&#x63CF;&#x4EE5;&#x53CA;&#x5C06;&#x65B9;&#x6CD5;&#x5C01;&#x88C5;&#x6210;&#x5404;&#x4E2A;MapperFactoryBean</li>
<li>MapperFactoryBean&#x521B;&#x5EFA;&#x65F6;&#x82E5;&#x6CA1;&#x6709;&#x6307;&#x5B9A;&#x7279;&#x5B9A;&#x7684;&#x6CE8;&#x5165;&#x5BF9;&#x8C61;&#xFF0C;&#x5728;&#x521D;&#x59CB;&#x5316;&#x65F6;Spring&#x4F1A;&#x81EA;&#x52A8;&#x6CE8;&#x5165;&#x76F8;&#x5E94;&#x7684;sqlsessionTemplate&#x7B49;sqlsession&#x5BF9;&#x8C61;&#xFF08;&#x5B9E;&#x73B0;&#x4E86;sqlsession&#x63A5;&#x53E3;&#xFF0C;&#x4F46;&#x90FD;&#x4E0D;&#x662F;&#x5B9E;&#x9645;&#x8D1F;&#x8D23;sql&#x8BED;&#x53E5;&#x6267;&#x884C;&#x7684;&#xFF09;</li>
<li>&#x82E5;&#x662F;&#x5B9E;&#x73B0;&#x4E86;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#xFF0C;&#x5219;&#x4F1A;&#x5728;TransactionSynchronizationManager&#x5BFB;&#x627E;&#x771F;&#x6B63;&#x6267;&#x884C;sql&#x8BED;&#x53E5;&#x7684;&#x4E14;&#x5728;&#x540C;&#x4E00;&#x4E8B;&#x52A1;&#x4E2D;&#x7684;DefaultSqlsession&#x8FD9;&#x7C7B;sqlsession&#x771F;&#x6B63;&#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#xFF0C;&#x901A;&#x8FC7;SpringManageTransaction&#x8C03;&#x7528;datasourceUtils&#xFF0C;&#x4ECE;TransactionSynchronizationManager&#x83B7;&#x53D6;&#x552F;&#x4E00;&#x7684;connection&#x53BB;&#x6267;&#x884C;&#x76F8;&#x5E94;&#x7684;sql&#x8BED;&#x53E5;&#x3002;</li>
<li>&#x82E5;&#x662F;&#x58F0;&#x660E;&#x5F0F;&#x4E8B;&#x52A1;&#xFF0C;&#x5219;&#x5728;service&#x65B9;&#x6CD5;&#x6267;&#x884C;&#x5B8C;&#x540E;&#x81EA;&#x52A8;commit&#xFF1B;&#x82E5;&#x7F16;&#x7A0B;&#x5F0F;&#x5219;&#x4ECE;status&#x83B7;&#x53D6;transaction&#x8FDB;&#x884C;commit</li>
</ul>
<pre><code>&lt;context:component-scan base-package=&quot;cn.itcast&quot;&gt;//&#x626B;&#x63CF;&#x7684;&#x5305;
&lt;context:exclude-filter type=&quot;annotation&quot; expression=&quot;org.springframework.stereotype.Controller&quot;/&gt;
&lt;/context:component-scan&gt;

&lt;bean id=&quot;comboPooledDataSource&quot; class=&quot;com.mchange.v2.c3p0.ComboPooledDataSource&quot;&gt;//&#x6570;&#x636E;&#x6E90;
&lt;property name=&quot;driverClass&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;
&lt;property name=&quot;jdbcUrl&quot; value=&quot;jdbc:mysql://localhost:3306/ssm&quot;/&gt;
&lt;property name=&quot;user&quot; value=&quot;root&quot;/&gt;
&lt;property name=&quot;password&quot; value=&quot;123456&quot;/&gt;
&lt;/bean&gt;

//&#x521B;&#x5EFA;&#x7279;&#x5B9A;&#x7684;SqlSessionFactory
&lt;bean id=&quot;sqlSessionFactory&quot; class=&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;&gt;
&lt;property name=&quot;dataSource&quot; ref=&quot;comboPooledDataSource&quot;/&gt;
&lt;/bean&gt;

// &#x67E5; &#x627E; &#x7C7B; &#x8DEF; &#x5F84; &#x4E0B; &#x7684; &#x6620; &#x5C04; &#x5668; &#x5E76;&#x81EA; &#x52A8; &#x5C06; &#x5B83; &#x4EEC; &#x521B; &#x5EFA; &#x6210; MapperFactoryBean
&lt;bean id=&quot;mapperScannerConfigurer&quot; class=&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt;
&lt;property name=&quot;basePackage&quot; value=&quot;cn.itcast.dao&quot;/&gt;
&lt;/bean&gt;

//&#x4E8B;&#x52A1;&#x7BA1;&#x7406;
&lt;bean id=&quot;dataSourceTransactionManager&quot; class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;
&lt;property name=&quot;dataSource&quot; ref=&quot;comboPooledDataSource&quot;&gt;&lt;/property&gt;
&lt;/bean&gt;

&lt;tx:advice id=&quot;txAdvice&quot; transaction-manager=&quot;dataSourceTransactionManager&quot;&gt;
&lt;tx:attributes&gt;
&lt;tx:method name=&quot;find*&quot; read-only=&quot;true&quot;/&gt;
&lt;tx:method name=&quot;*&quot; isolation=&quot;DEFAULT&quot;/&gt;
&lt;/tx:attributes&gt;
&lt;/tx:advice&gt;

&lt;aop:config&gt;
&lt;aop:advisor advice-ref=&quot;txAdvice&quot; pointcut=&quot;execution(* cn.itcast.service.impl.*ServiceImpl.*(..))&quot;/&gt;
&lt;/aop:config&gt;
</code></pre><hr>
<h4 id="mapperscannerconfigurer&#x4E0E;mapperfactorybean">MapperScannerConfigurer&#x4E0E;MapperFactoryBean</h4>
<ul>
<li>MapperScannerConfigurer&#x67E5; &#x627E; &#x7C7B; &#x8DEF; &#x5F84; &#x4E0B; &#x7684; &#x6620; &#x5C04; &#x5668; &#x5E76;&#x81EA; &#x52A8; &#x5C06; &#x5B83; &#x4EEC; &#x521B; &#x5EFA; &#x6210; MapperFactoryBean</li>
</ul>
<blockquote>
<p>basePackage &#x5C5E;&#x6027;&#x662F;&#x8BA9;&#x4F60;&#x4E3A;&#x6620;&#x5C04;&#x5668;&#x63A5;&#x53E3;&#x6587;&#x4EF6;&#x8BBE;&#x7F6E;&#x57FA;&#x672C;&#x7684;&#x5305;&#x8DEF;&#x5F84;&#x3002; &#x4F60;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x5206;&#x53F7;&#x6216;&#x9017;&#x53F7; &#x4F5C;&#x4E3A;&#x5206;&#x9694;&#x7B26;&#x8BBE;&#x7F6E;&#x591A;&#x4E8E;&#x4E00;&#x4E2A;&#x7684;&#x5305;&#x8DEF;&#x5F84;&#x3002;&#x6BCF;&#x4E2A;&#x6620;&#x5C04;&#x5668;&#x5C06;&#x4F1A;&#x5728;&#x6307;&#x5B9A;&#x7684;&#x5305;&#x8DEF;&#x5F84;&#x4E2D;&#x9012;&#x5F52;&#x5730;&#x88AB;&#x641C;&#x7D22;&#x5230;&#x3002;</p>
<p>&#x5982;&#x679C;&#x4E0D;&#x662F;&#x6709;&#x7279;&#x6B8A;&#x9700;&#x6C42;&#xFF0C;&#x4E0D;&#x9700;&#x8981; &#x53BB; &#x6307; &#x5B9A; SqlSessionFactory &#x6216; SqlSessionTemplate , &#x56E0; &#x4E3A; MapperScannerConfigurer &#x5C06;&#x4F1A;&#x521B;&#x5EFA; MapperFactoryBean,&#x4E4B;&#x540E;&#x81EA;&#x52A8;&#x88C5;&#x914D;&#x3002;&#x4F46;&#x662F;,&#x5982;&#x679C;&#x4F60;&#x4F7F; &#x7528;&#x4E86;&#x4E00;&#x4E2A; &#x4EE5;&#x4E0A;&#x7684; DataSource ,&#x90A3; &#x4E48;&#x81EA;&#x52A8; &#x88C5;&#x914D;&#x53EF; &#x80FD;&#x4F1A;&#x5931;&#x6548; &#x3002;&#x8FD9;&#x79CD; &#x60C5;&#x51B5;&#x4E0B; ,&#x4F60;&#x53EF; &#x4EE5;&#x4F7F;&#x7528; <strong>sqlSessionFactoryBeanName &#x6216; sqlSessionTemplateBeanName</strong> &#x5C5E;&#x6027;&#x6765;&#x8BBE;&#x7F6E;&#x6B63;&#x786E;&#x7684; bean &#x540D; &#x79F0;&#x6765;&#x4F7F;&#x7528;&#x3002;</p>
<pre><code>&lt;property name=&quot;sqlSessionFactoryBeanName&quot; value=&quot;sqlSessionFactory&quot; /&gt;
</code></pre></blockquote>
<pre><code>public class MapperScannerConfigurer implements BeanDefinitionRegistryPostProcessor, InitializingBean, ApplicationContextAware, BeanNameAware {

    //&#x63A5;&#x53E3;&#x5305;

    private String basePackage;
    private boolean addToConfig = true;
    private SqlSessionFactory sqlSessionFactory;
    private SqlSessionTemplate sqlSessionTemplate;
    private String sqlSessionFactoryBeanName;
    private String sqlSessionTemplateBeanName;
    private Class&lt;? extends Annotation&gt; annotationClass;
    private Class&lt;?&gt; markerInterface;
    private ApplicationContext applicationContext;
    private String beanName;
    private boolean processPropertyPlaceHolders;
    private BeanNameGenerator nameGenerator;
     &#xB7;&#xB7;&#xB7;
     get/set&#x65B9;&#x6CD5;&#x7528;&#x4EE5;&#x6CE8;&#x5165;
     &#xB7;&#xB7;&#xB7;
}
private void processPropertyPlaceHolders() {
        Map&lt;String, PropertyResourceConfigurer&gt; prcs = this.applicationContext.getBeansOfType(PropertyResourceConfigurer.class);
        if (!prcs.isEmpty() &amp;&amp; this.applicationContext instanceof GenericApplicationContext) {
            BeanDefinition mapperScannerBean = ((GenericApplicationContext)this.applicationContext).getBeanFactory().getBeanDefinition(this.beanName);
            DefaultListableBeanFactory factory = new DefaultListableBeanFactory();
            factory.registerBeanDefinition(this.beanName, mapperScannerBean);
            Iterator var4 = prcs.values().iterator();

            while(var4.hasNext()) {
                PropertyResourceConfigurer prc = (PropertyResourceConfigurer)var4.next();
                prc.postProcessBeanFactory(factory);
            }

            PropertyValues values = mapperScannerBean.getPropertyValues();
            this.basePackage = this.updatePropertyValue(&quot;basePackage&quot;, values);
            this.sqlSessionFactoryBeanName = this.updatePropertyValue(&quot;sqlSessionFactoryBeanName&quot;, values);
            this.sqlSessionTemplateBeanName = this.updatePropertyValue(&quot;sqlSessionTemplateBeanName&quot;, values);
        }

    }
</code></pre><ul>
<li>MapperFactoryBean</li>
</ul>
<blockquote>
<p>&#x6570;&#x636E;&#x6620;&#x5C04;&#x5668;&#x63A5;&#x53E3;&#x53EF;&#x4EE5;&#x6309;&#x7167;&#x5982;&#x4E0B;&#x505A;&#x6CD5;&#x52A0;&#x5165;&#x5230; Spring &#x4E2D;:</p>
<pre><code>&lt;bean id=&quot;userMapper&quot; class=&quot;org.mybatis.spring.mapper.MapperFactoryBean&quot;&gt;
&lt;property name=&quot;mapperInterface&quot; value=&quot;org.mybatis.spring.sample.mapper.UserMapper&quot; /&gt;
&lt;property name=&quot;sqlSessionFactory&quot; ref=&quot;sqlSessionFactory&quot; /&gt;
&lt;/bean&gt;
</code></pre><p>MapperFactoryBean &#x521B;&#x5EFA;&#x7684;&#x4EE3;&#x7406;&#x7C7B;&#x5B9E;&#x73B0;&#x4E86; UserMapper &#x63A5;&#x53E3;,&#x5E76;&#x4E14;&#x6CE8;&#x5165;&#x5230;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#x3002; &#x56E0;&#x4E3A;&#x4EE3;&#x7406;&#x521B;&#x5EFA;&#x5728;&#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;&#x4E2D; ,&#x90A3;&#x4E48;&#x6307;&#x5B9A;&#x7684;&#x6620;&#x5C04;&#x5668;&#x5FC5;&#x987B;&#x662F;&#x4E00;&#x4E2A;&#x63A5;&#x53E3;,&#x800C; &#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#x5177;&#x4F53;&#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#x3002;</p>
<p>&#x5982;&#x679C; UserMapper &#x6709;&#x4E00;&#x4E2A;&#x5BF9;&#x5E94;&#x7684; MyBatis &#x7684; XML &#x6620;&#x5C04;&#x5668;&#x6587;&#x4EF6;, &#x5982;&#x679C; XML &#x6587;&#x4EF6;&#x5728;&#x7C7B;&#x8DEF;&#x5F84;&#x7684; &#x4F4D;&#x7F6E;&#x548C;&#x6620;&#x5C04;&#x5668;&#x7C7B;&#x76F8;&#x540C;&#x65F6;, &#x5B83;&#x4F1A;&#x88AB; MapperFactoryBean &#x81EA;&#x52A8;&#x89E3;&#x6790;&#x3002; &#x6CA1;&#x6709;&#x5FC5;&#x8981;&#x5728; MyBatis &#x914D;&#x7F6E;&#x6587; &#x4EF6; &#x4E2D; &#x53BB; &#x6307; &#x5B9A; &#x6620; &#x5C04; &#x5668; , &#x9664; &#x975E; &#x6620; &#x5C04; &#x5668; &#x7684; XML &#x6587; &#x4EF6; &#x5728; &#x4E0D; &#x540C; &#x7684; &#x7C7B; &#x8DEF; &#x5F84; &#x4E0B; &#x3002;</p>
<p>&#x5F53; MapperFactoryBean &#x9700;&#x8981; SqlSessionFactory &#x6216; SqlSessionTemplate &#x65F6;&#x3002; &#x8FD9;&#x4E9B;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5404;&#x81EA;&#x7684; SqlSessionFactory &#x6216; SqlSessionTemplate &#x5C5E;&#x6027;&#x6765;&#x8BBE;&#x7F6E;, &#x6216;&#x8005;&#x53EF;&#x4EE5;&#x7531; Spring &#x6765;&#x81EA;&#x52A8;&#x88C5;&#x914D;&#x3002;&#x5982;&#x679C;&#x4E24;&#x4E2A;&#x5C5E;&#x6027;&#x90FD;&#x8BBE;&#x7F6E;&#x4E86;,&#x90A3;&#x4E48; SqlSessionFactory &#x5C31;&#x4F1A;&#x88AB;&#x5FFD;&#x7565;,&#x56E0;&#x4E3A; SqlSessionTemplate &#x662F;&#x9700;&#x8981;&#x6709;&#x4E00;&#x4E2A; session &#x5DE5;&#x5382;&#x7684;&#x8BBE;&#x7F6E;; &#x90A3;&#x4E2A;&#x5DE5;&#x5382;&#x4F1A;&#x7531; MapperFactoryBean. &#x6765;&#x4F7F;&#x7528;&#x3002;</p>
</blockquote>
<ul>
<li><p>&#x7531;&#x4E8E;&#x4F7F;&#x7528;spring&#x7BA1;&#x7406;bean&#xFF0C;&#x5F53;&#x6211;&#x4EEC;&#x5728;&#x4EE3;&#x7801;&#x4E2D;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;bean&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x9996;&#x5148;&#x53BB;&#x5BB9;&#x5668;&#x4E2D;&#x627E;&#xFF0C;&#x7B2C;&#x4E00;&#x6B21;&#x9700;&#x8981;&#x8C03;&#x7528;MapperFactoryBean&#x7684;getObject&#x65B9;&#x6CD5;&#x83B7;&#x53D6;&#x4E00;&#x4E2A;bean&#xFF0C;&#x5E76;&#x4FDD;&#x5B58;&#x5230;&#x5BB9;&#x5668;&#x4E2D;&#x3002;&#xFF08;&#x8FD9;&#x91CC;&#x751F;&#x6210;&#x7684;&#x5BF9;&#x8C61;&#x6700;&#x7EC8;&#x4E5F;&#x662F;&#x7528;sqlssion&#x7684;getMapper&#x751F;&#x6210;&#x7684;&#xFF0C;&#x4E0E;mybatis&#x4E00;&#x81F4;&#xFF09;</p>
<p>MapperFactoryBean&#x7684;getObject&#x65B9;&#x6CD5;&#x5982;&#x4E0B;&#xFF1A;</p>
</li>
</ul>
<blockquote>
<pre><code>public class MapperFactoryBean&lt;T&gt; extends SqlSessionDaoSupport implements FactoryBean&lt;T&gt; {
public T getObject() throws Exception {
    return this.getSqlSession().getMapper(this.mapperInterface);
}
}
</code></pre></blockquote>
<ul>
<li>&#x53C8;&#x5230;SqlSessionDaoSupport&#x4E2D;&#x53BB;&#x83B7;&#x53D6;</li>
</ul>
<blockquote>
<pre><code>public abstract class SqlSessionDaoSupport extends DaoSupport {
    private SqlSession sqlSession;
    private boolean externalSqlSession;

public SqlSession getSqlSession() {
    return this.sqlSession;
}

// &#x5728;MapperScannerConfigurer&#x81EA;&#x52A8;&#x626B;&#x63CF;&#x751F;&#x6210;/&#x81EA;&#x5DF1;&#x521B;&#x5EFA;MapperFactoryBean&#x65F6;&#xFF0C;&#x7531;&#x4F20;&#x5165;&#x7684;&#x5DE5;&#x5382;&#x7C7B;&#x578B;/Spring&#x81EA;&#x52A8;&#x914D;&#x7F6E;&#x7684;&#x5DE5;&#x5382;&#x7C7B;&#x578B;
&#x65F6;&#xFF0C;&#x5C31;&#x521B;&#x5EFA;&#x4E86;SqlSessionTemplate&#xFF08;&#x5B9E;&#x73B0;&#x4E86;sqlsession&#x63A5;&#x53E3;&#xFF09;&#xFF0C;&#x56E0;&#x6B64;&#x8C03;&#x7528;&#x65B9;&#x6CD5;&#x65F6;&#x4F1A;&#x901A;&#x8FC7;SqlSessionTemplate&#x7684;proxysqlsession&#xFF08;&#x52A8;&#x6001;&#x4EE3;&#x7406;&#x751F;&#x6210;&#x7684;&#x4EE3;&#x7406;&#x7C7B;&#xFF09;&#x53BB;TransactionSynchronizationManager&#x5BFB;&#x627E;&#x771F;&#x6B63;&#x7684;sqlsession&#x6216;&#x521B;&#x5EFA;

 public void setSqlSessionFactory(SqlSessionFactory sqlSessionFactory) {
        if (!this.externalSqlSession) {
            this.sqlSession = new SqlSessionTemplate(sqlSessionFactory);
        }

    }
}

//spring&#x6574;&#x5408;mybatis&#x540E;&#xFF0C;&#x975E;&#x4E8B;&#x52A1;&#x73AF;&#x5883;&#x4E0B;&#xFF0C;&#x6BCF;&#x4E2A;&#x6267;&#x884C;&#x5B8C;&#x4FBF;&#x63D0;&#x4EA4;&#xFF0C;&#x6BCF;&#x6B21;&#x64CD;&#x4F5C;&#x6570;&#x636E;&#x5E93;&#x90FD;&#x4F7F;&#x7528;&#x65B0;&#x7684;sqlSession&#x5BF9;&#x8C61;&#xFF0C;&#x83B7;&#x53D6;&#x4E0D;&#x540C;&#x7684;connection&#x3002;&#x56E0;&#x6B64;mybatis&#x7684;&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#x65E0;&#x6CD5;&#x4F7F;&#x7528;&#xFF0C;&#x82E5;&#x6709;&#x5219;&#x53D6;TransactionSynchronizationManager&#x4E2D;&#x7684;sqlsession&#x5219;&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#x751F;&#x6548;&#xFF08;&#x4E00;&#x7EA7;&#x7F13;&#x5B58;&#x9488;&#x5BF9;&#x540C;&#x4E00;&#x4E2A;sqlsession&#x6709;&#x6548;&#xFF09;
</code></pre></blockquote>
<hr>
<h4 id="transactiondefinition&#x4E0E;transactionattributes">TransactionDefinition&#x4E0E;TransactionAttributes</h4>
<ul>
<li><p><strong>&#x83B7;&#x53D6;&#x4E8B;&#x52A1;&#x5C5E;&#x6027;&#x5BF9;&#x8C61;(TransactionAttributes&#x82E5;&#x65E0;&#x8BBE;&#x7F6E;attributes&#x5219;&#x9ED8;&#x8BA4;&#x4E3A;DefaultTransactionDefinition)&#xFF0C;&#x653E;&#x7F6E;&#x5728;&#x5BB9;&#x5668;&#x4E2D;&#xFF0C;transactionManager&#x8C03;&#x7528;getTransaction&#x65F6;&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#x4F20;&#x5165;</strong></p>
<p>&#x4E8B;&#x52A1;&#x5C5E;&#x6027;&#x5BF9;&#x8C61;&#x6301;&#x6709;&#x4E8B;&#x52A1;&#x7684;&#x76F8;&#x5173;&#x914D;&#x7F6E;&#xFF0C;&#x6BD4;&#x5982;&#x4E8B;&#x52A1;&#x7684;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#xFF0C;&#x4F20;&#x64AD;&#x884C;&#x4E3A;&#xFF0C;&#x662F;&#x5426;&#x53EA;&#x8BFB;&#x7B49;&#x3002;&#x6211;&#x4EEC;&#x5F00;&#x542F;spring&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x65F6;&#xFF0C;&#x901A;&#x5E38;&#x90FD;&#x4F1A;&#x5728;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x91CC;&#x52A0;&#x5165;&#x8FD9;&#x6837;&#x4E00;&#x6BB5;&#x914D;&#x7F6E;&#x3002;</p>
<pre><code>&lt;tx:advice id=&quot;txAdvice&quot; transaction-manager=&quot;transactionManager&quot;&gt;
    &lt;tx:attributes&gt;
        &lt;tx:method name=&quot;get*&quot; read-only=&quot;true&quot;/&gt;
        &lt;tx:method name=&quot;*&quot;/&gt;
    &lt;/tx:attributes&gt;
&lt;/tx:advice&gt;
</code></pre><blockquote>
<ul>
<li><p>TransactionDefinition&#x4E3B;&#x8981;&#x5B9A;&#x4E49;&#x4E86;&#x6709;&#x54EA;&#x4E9B;&#x4E8B;&#x52A1;&#x5C5E;&#x6027;&#x53EF;&#x4EE5;&#x6307;&#x5B9A;&#xFF1A;</p>
<ul>
<li><p>&#x4E8B;&#x52A1;&#x7684;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#xFF08;Isolation&#xFF09;</p>
</li>
<li><p>&#x4E8B;&#x52A1;&#x7684;&#x4F20;&#x64AD;&#x884C;&#x4E3A;&#xFF08;Propagation Behavior&#xFF09;</p>
<blockquote>
<p> &#x9ED8;&#x8BA4;&#x4E3A;PROPAGATION_REQUIRED ,&#x82E5;&#x5B58;&#x5728;&#x4E8B;&#x52A1;&#x5219;&#x52A0;&#x5165;&#x5F53;&#x524D;&#x4E8B;&#x52A1;&#xFF0C;&#x82E5;&#x6CA1;&#x6709;&#x5219;&#x81EA;&#x5DF1;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#x3002;</p>
<p> Propagation Behavior&#x6CE8;&#x610F;PROPAGATION_REQUIRES_NEW&#x548C;PROPAGATION_NESTED&#x7684;&#x533A;&#x522B;&#xFF0C;&#x524D;&#x8005;&#x5C06;&#x5F53;&#x524D;&#x4E8B;&#x52A1;&#x6302;&#x8D77;&#xFF0C;&#x521B;&#x5EFA;&#x65B0;&#x7684;&#x4E8B;&#x52A1;&#x6267;&#x884C;&#xFF1B;&#x540E;&#x8005;&#xFF0C;&#x5219;&#x662F;&#x5728;&#x5F53;&#x524D;&#x4E8B;&#x52A1;&#x79CD;&#x7684;&#x4E00;&#x4E2A;&#x5D4C;&#x5957;&#x4E8B;&#x52A1;&#x4E2D;&#x6267;&#x884C;</p>
</blockquote>
</li>
<li><p>&#x4E8B;&#x52A1;&#x7684;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#xFF08;Timeout&#xFF09;</p>
</li>
<li><p>&#x662F;&#x5426;&#x4E3A;&#x53EA;&#x8BFB;&#x4E8B;&#x52A1;(ReadOnly)</p>
</li>
<li><p>SQL&#x6807;&#x51C6;&#x5B9A;&#x4E49;&#x4E86;4&#x7C7B;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#xFF0C;&#x5305;&#x62EC;&#x4E86;&#x4E00;&#x4E9B;&#x5177;&#x4F53;&#x89C4;&#x5219;&#xFF0C;&#x7528;&#x6765;&#x9650;&#x5B9A;&#x4E8B;&#x52A1;&#x5185;&#x5916;&#x7684;&#x54EA;&#x4E9B;&#x6539;&#x53D8;&#x662F;&#x53EF;&#x89C1;&#x7684;&#xFF0C;&#x54EA;&#x4E9B;&#x662F;&#x4E0D;&#x53EF;&#x89C1;&#x7684;&#x3002;&#x4F4E;&#x7EA7;&#x522B;&#x7684;&#x9694;&#x79BB;&#x7EA7;&#x4E00;&#x822C;&#x652F;&#x6301;&#x66F4;&#x9AD8;&#x7684;&#x5E76;&#x53D1;&#x5904;&#x7406;&#xFF0C;&#x5E76;&#x62E5;&#x6709;&#x66F4;&#x4F4E;&#x7684;&#x7CFB;&#x7EDF;&#x5F00;&#x9500;&#x3002;</p>
</li>
<li><p>ISOLATION_DEFAULT &#x6570;&#x636E;&#x5E93;&#x7684;&#x9ED8;&#x8BA4;&#x7EA7;&#x522B;&#xFF1A;mysql&#x4E3A;<strong>Repeatable Read&#xFF08;&#x53EF;&#x91CD;&#x8BFB;&#xFF09;</strong>&#xFF0C;&#x5176;&#x4ED6;&#x7684;&#x4E00;&#x822C;&#x4E3A;<strong>Read Committed&#xFF08;&#x8BFB;&#x53D6;&#x63D0;&#x4EA4;&#x5185;&#x5BB9;&#xFF09;</strong></p>
</li>
</ul>
</li>
</ul>
<ul>
<li><strong>Read Uncommitted&#xFF08;&#x8BFB;&#x53D6;&#x672A;&#x63D0;&#x4EA4;&#x5185;&#x5BB9;&#xFF09;</strong> ISOLATION_READ_UNCOMITTED</li>
</ul>
<pre><code>&#x5728;&#x8BE5;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#xFF0C;&#x6240;&#x6709;&#x4E8B;&#x52A1;&#x90FD;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5176;&#x4ED6;&#x672A;&#x63D0;&#x4EA4;&#x4E8B;&#x52A1;&#x7684;&#x6267;&#x884C;&#x7ED3;&#x679C;&#x3002;&#x672C;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#x5F88;&#x5C11;&#x7528;&#x4E8E;&#x5B9E;&#x9645;&#x5E94;&#x7528;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x7684;&#x6027;&#x80FD;&#x4E5F;&#x4E0D;&#x6BD4;&#x5176;&#x4ED6;&#x7EA7;&#x522B;&#x597D;&#x591A;&#x5C11;&#x3002;**&#x8BFB;&#x53D6;&#x672A;&#x63D0;&#x4EA4;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x4E5F;&#x88AB;&#x79F0;&#x4E4B;&#x4E3A;&#x810F;&#x8BFB;&#xFF08;Dirty Read&#xFF09;&#x3002;**
</code></pre><ul>
<li><strong>Read Committed&#xFF08;&#x8BFB;&#x53D6;&#x63D0;&#x4EA4;&#x5185;&#x5BB9;&#xFF09;</strong>ISOLATION_READ_COMITTED</li>
</ul>
<p>  &#x200B;        &#x8FD9;&#x662F;&#x5927;&#x591A;&#x6570;&#x6570;&#x636E;&#x5E93;&#x7CFB;&#x7EDF;&#x7684;&#x9ED8;&#x8BA4;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#xFF08;&#x4F46;&#x4E0D;&#x662F;MySQL&#x9ED8;&#x8BA4;&#x7684;&#xFF09;&#x3002;&#x5B83;&#x6EE1;&#x8DB3;&#x4E86;&#x9694;&#x79BB;&#x7684;&#x7B80;&#x5355;&#x5B9A;&#x4E49;&#xFF1A;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#x53EA;&#x80FD;&#x770B;&#x89C1;&#x5DF2;&#x7ECF;&#x63D0;&#x4EA4;&#x4E8B;&#x52A1;&#x6240;&#x505A;&#x7684;&#x6539;&#x53D8;&#x3002;&#x8FD9;&#x79CD;&#x9694;&#x79BB;&#x7EA7;&#x522B; &#x4E5F;&#x652F;&#x6301;&#x6240;&#x8C13;&#x7684;<strong>&#x4E0D;&#x53EF;&#x91CD;&#x590D;&#x8BFB;&#xFF08;Nonrepeatable Read&#xFF09;&#xFF0C;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x7528;&#x6237;&#x5728;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#x4E2D;&#x591A;&#x6B21;&#x8BFB;&#x53D6;&#x4E00;&#x6761;&#x6570;&#x636E;&#xFF0C;&#x800C;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x7528;&#x6237;&#x5219;&#x540C;&#x65F6;&#x66F4;&#x65B0;&#x5566;&#x8FD9;&#x6761;&#x6570;&#x636E;&#xFF0C;&#x9020;&#x6210;&#x7B2C;&#x4E00;&#x4E2A;&#x7528;&#x6237;&#x591A;&#x6B21;&#x8BFB;&#x53D6;&#x6570;&#x636E;&#x4E0D;&#x4E00;&#x81F4;&#x3002;**</strong></p>
<ul>
<li><strong>Repeatable Read&#xFF08;&#x53EF;&#x91CD;&#x8BFB;&#xFF09;</strong>ISOLATION_REPEATABLE_READ</li>
</ul>
<p>  &#x8FD9;&#x662F;MySQL&#x7684;&#x9ED8;&#x8BA4;&#x4E8B;&#x52A1;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#xFF0C;&#x5B83;&#x786E;&#x4FDD;&#x540C;&#x4E00;&#x4E8B;&#x52A1;&#x7684;&#x591A;&#x4E2A;&#x5B9E;&#x4F8B;&#x5728;&#x5E76;&#x53D1;&#x8BFB;&#x53D6;&#x6570;&#x636E;&#x65F6;&#xFF0C;&#x4F1A;&#x770B;&#x5230;&#x540C;&#x6837;&#x7684;&#x6570;&#x636E;&#x884C;&#x3002;&#x4E0D;&#x8FC7;&#x7406;&#x8BBA;&#x4E0A;&#xFF0C;&#x8FD9;&#x4F1A;&#x5BFC;&#x81F4;&#x53E6;&#x4E00;&#x4E2A;&#x68D8;&#x624B;&#x7684;&#x95EE;&#x9898;&#xFF1A;<strong>&#x5E7B;&#x8BFB; &#xFF08;Phantom Read&#xFF09;</strong>&#x3002;&#x7B80;&#x5355;&#x7684;&#x8BF4;&#xFF0C;&#x5E7B;&#x8BFB;&#x6307;&#x7B2C;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#x8BFB;&#x53D6;&#x4E00;&#x4E2A;&#x7ED3;&#x679C;&#x96C6;&#x540E;&#xFF0C;&#x7B2C;&#x4E8C;&#x4E2A;&#x4E8B;&#x52A1;&#xFF0C;&#x5BF9;&#x8FD9;&#x4E2A;&#x7ED3;&#x679C;&#x96C6;&#x7ECF;&#x884C;&#x589E;&#x5220;&#x64CD;&#x4F5C;&#xFF08;&#x7B2C;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#x6682;&#x65F6;&#x6CA1;&#x7528;&#x5230;&#xFF0C;&#x6CA1;&#x6DFB;&#x52A0;&#x884C;&#x9501;&#xFF09;&#xFF0C;&#x7136;&#x800C;&#x7B2C;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#x4E2D;&#x518D;&#x6B21;&#x5BF9;&#x8FD9;&#x4E2A;&#x7ED3;&#x679C;&#x96C6;&#x8FDB;&#x884C;&#x67E5;&#x8BE2;&#x65F6;&#xFF0C;&#x6570;&#x636E;&#x53D1;&#x73B0;&#x4E22;&#x5931;&#x6216;&#x65B0;&#x589E;&#xFF0C;&#x51FA;&#x73B0;&#x4E86;&#x201C;&#x5E7B;&#x5F71;&#x201D;&#x3002;<strong>&#x901A;&#x8FC7;&#x52A0;&#x8868;&#x7EA7;&#x9501;&#x89E3;&#x51B3;&#xFF0C;&#x5982;&#x95F4;&#x9699;&#x9501;</strong>InnoDB&#x548C;Falcon&#x5B58;&#x50A8;&#x5F15;&#x64CE;&#x901A;&#x8FC7;&#x591A;&#x7248;&#x672C;&#x5E76;&#x53D1;&#x63A7;&#x5236;&#xFF08;MVCC&#xFF0C;Multiversion Concurrency Control&#xFF09;&#x673A;&#x5236;&#x89E3;&#x51B3;&#x4E86;&#x8BE5;&#x95EE;&#x9898;&#x3002;</p>
<p>  <strong>Serializable&#xFF08;&#x53EF;&#x4E32;&#x884C;&#x5316;&#xFF09;</strong>ISOLATION_SERIALIZABLE</p>
<p>  &#x8FD9;&#x662F;&#x6700;&#x9AD8;&#x7684;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#xFF0C;&#x5B83;&#x901A;&#x8FC7;&#x5F3A;&#x5236;&#x4E8B;&#x52A1;&#x6392;&#x5E8F;&#xFF0C;&#x4F7F;&#x4E4B;&#x4E0D;&#x53EF;&#x80FD;&#x76F8;&#x4E92;&#x51B2;&#x7A81;&#xFF0C;&#x4ECE;&#x800C;&#x89E3;&#x51B3;&#x5E7B;&#x8BFB;&#x95EE;&#x9898;&#x3002;&#x7B80;&#x8A00;&#x4E4B;&#xFF0C;&#x5B83;&#x662F;&#x5728;&#x6BCF;&#x4E2A;&#x8BFB;&#x7684;&#x6570;&#x636E;&#x884C;&#x4E0A;&#x52A0;&#x4E0A;&#x5171;&#x4EAB;&#x9501;&#x3002;&#x5728;&#x8FD9;&#x4E2A;&#x7EA7;&#x522B;&#xFF0C;&#x53EF;&#x80FD;&#x5BFC;&#x81F4;&#x5927;&#x91CF;&#x7684;&#x8D85;&#x65F6;&#x73B0;&#x8C61;&#x548C;&#x9501;&#x7ADE;&#x4E89;&#x3002;</p>
<ul>
<li>TransactionAttribute&#x5728;TransactionDefinition&#x7684;&#x57FA;&#x7840;&#x4E0A;&#x6DFB;&#x52A0;&#x4E86;rollbackon&#x65B9;&#x6CD5;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x58F0;&#x660E;&#x7684;&#x65B9;&#x5F0F;&#x6307;&#x5B9A;&#x4E1A;&#x52A1;&#x65B9;&#x6CD5;&#x5728;&#x629B;&#x51FA;&#x7684;&#x54EA;&#x4E9B;&#x7684;&#x5F02;&#x5E38;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x53EF;&#x4EE5;&#x56DE;&#x6EDA;&#x4E8B;&#x52A1;&#x3002;&#xFF08;&#x8BE5;&#x63A5;&#x53E3;&#x4E3B;&#x8981;&#x9762;&#x5411;&#x4F7F;&#x7528;Spring AOP&#x8FDB;&#x884C;&#x58F0;&#x660E;&#x5F0F;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x7684;&#x573A;&#x5408;&#xFF09;</li>
</ul>
<p><img src="F:\Typora&#x6570;&#x636E;&#x50A8;&#x5B58;\&#x6570;&#x636E;&#x5E93;\mybatis.assets\image-20200728132052202.png" alt="image-20200728132052202"></p>
</blockquote>
<hr>
</li>
</ul>
<h4 id="&#x7F16;&#x7A0B;&#x5F0F;&#x7684;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x4E0E;&#x58F0;&#x660E;&#x5F0F;&#x4E8B;&#x52A1;&#x5904;&#x7406;">&#x7F16;&#x7A0B;&#x5F0F;&#x7684;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x4E0E;&#x58F0;&#x660E;&#x5F0F;&#x4E8B;&#x52A1;&#x5904;&#x7406;</h4>
<ul>
<li><p>spring&#x63D0;&#x4F9B;<strong>&#x7F16;&#x7A0B;&#x5F0F;&#x7684;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#xFF08;&#x81EA;&#x5DF1;&#x521B;&#x5EFA;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x5668;&#xFF0C;&#x7531;&#x81EA;&#x5DF1;&#x8C03;&#x7528;&#x7BA1;&#x7406;&#x5668;&#x7684;&#x65B9;&#x6CD5;&#x521B;&#x5EFA;&#x4E8B;&#x52A1;&#x6216;&#x5904;&#x7406;&#x4E8B;&#x52A1;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x52A8;&#x6001;&#x4EE3;&#x7406;&#x51CF;&#x5C11;&#x4EE3;&#x7406;&#x7C7B;&#x7684;&#x7F16;&#x5199;&#xFF0C;&#x4F46;&#x662F;&#x8FD8;&#x662F;&#x8981;&#x7F16;&#x5199;&#x5F88;&#x591A;&#x4E8B;&#x52A1;&#x7684;&#x4EE3;&#x7801;&#x5728;&#x4E1A;&#x52A1;&#x4EE3;&#x7801;&#x7684;&#x524D;&#x540E;&#xFF0C;&#x4E0D;&#x662F;&#x5F88;&#x65B9;&#x4FBF;&#x7BA1;&#x7406;&#xFF0C;&#x5BF9;&#x4E8E;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x8FD9;&#x79CD;&#x7279;&#x6027;&#x57FA;&#x672C;&#x4E00;&#x81F4;&#x7684;&#x64CD;&#x4F5C;&#x7528;&#x58F0;&#x660E;&#x53CD;&#x800C;&#x66F4;&#x5229;&#x4E8E;&#x7EF4;&#x62A4;&#xFF09;&#x548C;&#x58F0;&#x660E;&#x5F0F;&#x4E8B;&#x52A1;&#x5904;&#x7406;&#xFF08;&#x58F0;&#x660E;&#x540E;&#x7531;&#x5BB9;&#x5668;&#x521B;&#x5EFA;&#xFF0C;&#x7531;&#x58F0;&#x660E;&#x6765;&#x8C03;&#x7528;&#x76F8;&#x5E94;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x58F0;&#x660E;&#x5F0F;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x7528;AOP&#x907F;&#x514D;&#x4E86;&#x6211;&#x4EEC;&#x4E3A;&#x6BCF;&#x4E00;&#x4E2A;&#x9700;&#x8981;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x7684;&#x7C7B;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x4EE3;&#x7406;&#x7C7B;&#xFF09;&#x3002;</strong></p>
</li>
<li><p>&#x82E5;&#x662F;&#x58F0;&#x660E;&#x5F0F;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x53D1;&#x73B0;&#xFF0C;&#x6211;&#x4EEC;&#x6CA1;&#x6709;&#x81EA;&#x5DF1;&#x64CD;&#x4F5C;commit&#x7684;&#x7A7A;&#x95F4;&#xFF0C;&#x4ED6;&#x4F1A;&#x5728;&#x4F60;&#x4E8B;&#x52A1;&#x58F0;&#x660E;&#x7684;&#x65B9;&#x6CD5;&#x7ED3;&#x675F;&#x65F6;&#x5C31;commit&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x628A;&#x5F88;&#x591A;&#x4E1A;&#x52A1;&#x4EE3;&#x7801;&#x653E;&#x5728;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;service&#x65B9;&#x6CD5;&#x4E2D;&#x5B9E;&#x73B0;&#x540C;&#x4E00;&#x4E8B;&#x52A1;&#xFF0C;&#x4F46;&#x82E5;&#x662F;&#x4E0D;&#x60F3;&#x5219;&#x53EF;&#x4EE5;&#x7F16;&#x7801;&#x5F0F;&#x4E8B;&#x52A1;&#x63A7;&#x5236;&#x3002;</p>
<blockquote>
<p>&#x58F0;&#x660E;&#x5F0F;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x4E2D;&#x6211;&#x4EEC;&#x7528;&#x5230;org.springframework.transaction.interceptor.TransactionInterceptor&#x5E2E;&#x6211;&#x4EEC;&#x62E6;&#x622A;&#x4E1A;&#x52A1;&#x65B9;&#x6CD5;&#xFF0C;&#x4F7F;&#x5F97;&#x6211;&#x4EEC;&#x5728;springMVc&#x4E2D;&#x8C03;&#x7528;serviece&#x4E2D;&#x7684;&#x65B9;&#x6CD5;&#x65F6;&#xFF08;&#x6211;&#x4EEC;&#x4ECE;&#x5BB9;&#x5668;&#x62FF;&#x5230;&#x7684;Service&#x662F;&#x7ECF;&#x8FC7;AOP&#xFF08;&#x4E5F;&#x5C31;&#x662F;&#x52A8;&#x6001;&#x4EE3;&#x7406;&#xFF09;&#x5904;&#x7406;&#x7684;&#x4E86;&#xFF09;&#xFF0C;&#x9700;&#x8981;&#x5148;&#x7ECF;&#x8FC7;&#x5B83;&#x3002;</p>
<p>&#x9700;&#x8981;&#x4E00;&#x4E2A;&#x5BB9;&#x5668;&#x53BB;&#x653E;&#x7F6E;&#x7528;&#x4E0D;&#x540C;ORM&#x6846;&#x67B6;&#x65F6;&#xFF0C;&#x5728;TransactionInterceptor&#x5E2E;&#x6211;&#x4EEC;&#x62E6;&#x622A;&#x540E;&#xFF0C;&#x5C06;service&#x589E;&#x5F3A;&#x6210;&#x6211;&#x4EEC;&#x60F3;&#x8981;&#x7684;&#x6A21;&#x677F;&#xFF0C;&#x52A0;&#x5165;&#x5230;&#x50CF;JdbcTempalte/SqlsessionTemplate&#x8FD9;&#x6837;&#x4E0D;&#x540C;&#x7684;&#x6A21;&#x677F;&#x4E2D;&#xFF0C;&#x4EE5;&#x4FBF;&#x5728;&#x8C03;&#x7528;service&#x7684;&#x65B9;&#x6CD5;&#x65F6;&#xFF0C;&#x81EA;&#x52A8;&#x53BB;&#x8C03;&#x7528;&#x76F8;&#x5E94;&#x7684;&#x6570;&#x636E;&#x5E93;&#x6846;&#x67B6;&#x6267;&#x884C;sql&#x8BED;&#x53E5;&#x65F6;&#x9700;&#x8981;&#x7684;&#x6D41;&#x7A0B;&#xFF0C;&#x5982;SqlsessionTemplate&#xFF08;&#x5B83;&#x7684;&#x539F;&#x7406;&#x8DDF;sqlsession.getMapper&#x76F8;&#x4F3C;&#xFF09;&#x4F1A;&#x81EA;&#x52A8;&#x5BF9;sqlsession&#x8FDB;&#x884C;&#x521B;&#x5EFA;&#xFF0C;&#x518D;&#x8FDB;&#x884C;&#x8BE5;&#x6846;&#x67B6;&#x5BF9;sql&#x8BED;&#x53E5;&#x6267;&#x884C;&#x6D41;&#x7A0B;&#xFF0C;&#x8FD9;&#x4E2A;&#x5BB9;&#x5668;&#x53EF;&#x4EE5;&#x662F;ProxyFactory&#xFF08;ProxyFactoryBean&#xFF09;&#x6216;&#x8005;&#x5176;&#x4ED6;&#x7684;interceptor&#x7684;&#x5B9E;&#x73B0;&#x7C7B;</p>
<p>&#x800C;sqlsessionTemplate&#x6240;&#x9700;&#x8981;&#x7684;springMapConfig&#x5DF2;&#x7ECF;&#x7528;SqlSessionFactoryBean&#x521B;&#x5EFA;&#x7684;SqlSessionFactory&#x4E2D;&#x4E86;&#xFF0C;sqlsessionTemplate&#x4F1A;&#x5C06;SqlSessionFactory&#x6CE8;&#x5165;&#x5176;&#x4E2D;&#xFF0C;&#x4FBF;&#x53EF;&#x4EE5;&#x62E5;&#x6709;&#x9700;&#x8981;&#x7684;Dao&#x5C42;&#x4FE1;&#x606F;&#x548C;&#x9700;&#x8981;&#x7684;sql&#x8BED;&#x53E5;&#x7B49;&#x4E86;</p>
<blockquote>
<p>&#x5728;spring 1.x&#x5230;2.x&#x4E2D;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;4&#x79CD;&#x914D;&#x7F6E;&#x7684;&#x65B9;&#x5F0F;&#x5728;IoC&#x5BB9;&#x5668;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x79CD;&#x6307;&#x5B9A;&#x4E8B;&#x52A1;&#x9700;&#x8981;&#x7684;&#x5143;&#x6570;&#x636E;</p>
<ol>
<li><p>&#x4F7F;&#x7528;ProxyFactory&#xFF08;ProxyFactoryBean&#xFF09;+TransactionIntercepter</p>
<blockquote>
<pre><code>&lt;!-- TransactionInterceptor --&gt;//&#x62E6;&#x622A;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;service&#x65B9;&#x6CD5;
&lt;bean id=&quot;transactionInterceptor&quot;
  class=&quot;org.springframework.transaction.interceptor.TransactionInterceptor&quot;&gt;
  &lt;property name=&quot;transactionManager&quot;&gt;
      &lt;ref bean=&quot;transactionManager&quot; /&gt;
  &lt;/property&gt;
  &lt;property name=&quot;transactionAttributeSource&quot;&gt;
      &lt;value&gt;
          org.springframework.prospring.ticket.service.PaymentService.transfer=PROPAGATION_REQUIRED,ISOLATION_SERIALIZABLE,timeout_30,-Exception
      &lt;/value&gt;
  &lt;/property&gt;
&lt;/bean&gt;
&lt;!-- Business Object --&gt;
&lt;bean id=&quot;paymentServiceTarget&quot;
  class=&quot;org.springframework.prospring.ticket.service.PaymentServiceImpl&quot;&gt;
  &lt;property name=&quot;paymentDao&quot;&gt;
      &lt;ref local=&quot;paymentDao&quot; /&gt;
  &lt;/property&gt;
&lt;/bean&gt;

// &#x5C06;&#x9700;&#x8981;&#x7684;&#x6846;&#x67B6;Template/&#x76F8;&#x5E94;&#x7684;dao&#x5B9E;&#x73B0;&#xFF0C;&#x4E0E;Service&#x5C42;&#x63A5;&#x53E3;&#x4EE5;&#x53CA;transactionInterceptor&#x96C6;&#x6210;&#x4E00;&#x4E2A;Bean&#x65B9;&#x4FBF;Client&#x8C03;&#x7528;

&lt;!-- Transactional proxy for the primary business object --&gt;
&lt;bean id=&quot;paymentService&quot; class=&quot;org.springframework.aop.framework.ProxyFactoryBean&quot;&gt;
  &lt;property name=&quot;target&quot;&gt;
      &lt;ref local=&quot;paymentServiceTarget&quot; /&gt;
  &lt;/property&gt;
  &lt;property name=&quot;proxyInterfaces&quot;&gt;
      &lt;value&gt;org.springframework.prospring.ticket.service.PaymentService
      &lt;/value&gt;
  &lt;/property&gt;
  &lt;property name=&quot;interceptorNames&quot;&gt;
    &lt;list&gt;
      &lt;value&gt;transactionInterceptor&lt;/value&gt;
    &lt;/list&gt;
  &lt;/property&gt;
&lt;/bean&gt;
</code></pre></blockquote>
</li>
<li><p>&#x4F7F;&#x7528;&#x201C;&#x4E00;&#x7AD9;&#x5F0F;&#x201D;&#x7684;TransactionProxyFactoryBean</p>
</li>
<li><p>&#x4F7F;&#x7528;BeanNameAutoProxyCreater</p>
</li>
<li><p>&#x4F7F;&#x7528;Spring2.x&#x7684;&#x58F0;&#x660E;&#x4E8B;&#x52A1;&#x914D;&#x7F6E;&#x65B9;&#x5F0F;&#xFF08;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x7684;&#xFF09;</p>
</li>
</ol>
<pre><code>&lt;context:component-scan base-package=&quot;cn.itcast&quot;&gt;
    &lt;context:exclude-filter type=&quot;annotation&quot; expression=&quot;org.springframework.stereotype.Controller&quot;/&gt;
&lt;/context:component-scan&gt;

&lt;bean id=&quot;comboPooledDataSource&quot; class=&quot;com.mchange.v2.c3p0.ComboPooledDataSource&quot;&gt;
    &lt;property name=&quot;driverClass&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;
    &lt;property name=&quot;jdbcUrl&quot; value=&quot;jdbc:mysql://localhost:3306/ssm&quot;/&gt;
    &lt;property name=&quot;user&quot; value=&quot;root&quot;/&gt;
    &lt;property name=&quot;password&quot; value=&quot;123456&quot;/&gt;
&lt;/bean&gt;

&lt;bean id=&quot;sqlSessionFactory&quot; class=&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;&gt;
    &lt;property name=&quot;dataSource&quot; ref=&quot;comboPooledDataSource&quot;/&gt;
&lt;/bean&gt;

&lt;bean id=&quot;mapperScannerConfigurer&quot; class=&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt;
    &lt;property name=&quot;basePackage&quot; value=&quot;cn.itcast.dao&quot;/&gt;
&lt;/bean&gt;

&lt;bean id=&quot;dataSourceTransactionManager&quot; class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;
    &lt;property name=&quot;dataSource&quot; ref=&quot;comboPooledDataSource&quot;&gt;&lt;/property&gt;
&lt;/bean&gt;

// &lt;tx:advice&gt;&#x4E13;&#x95E8;&#x4E3A;&#x58F0;&#x660E;&#x4E8B;&#x52A1;Advice&#x800C;&#x8BBE;&#x7F6E;&#x7684;&#x914D;&#x7F6E;&#x5143;&#x7D20;&#xFF0C;&#x5E95;&#x5C42;&#x8FD8;&#x662F;TransactionInterceptor
        &#x82E5;&#x4E0D;&#x6307;&#x5B9A;&lt;tx:attributes&gt;&#xFF0C;&#x5219;&#x91C7;&#x7528;DefaultTransactionDefinition

&lt;tx:advice id=&quot;txAdvice&quot; transaction-manager=&quot;dataSourceTransactionManager&quot;&gt;
    &lt;tx:attributes&gt;
        &lt;tx:method name=&quot;find*&quot; read-only=&quot;true&quot;/&gt;
        &lt;tx:method name=&quot;*&quot; isolation=&quot;DEFAULT&quot;/&gt;
    &lt;/tx:attributes&gt;
&lt;/tx:advice&gt;


// &#x4F5C;&#x7528;&#x5982;&#x540C;ProxyFactoryBean&#x4E00;&#x76F4;&#xFF0C;&#x4E0D;&#x8FC7;&#x4F7F;&#x7528;&#x4E86;aop&#x5B9E;&#x73B0;&#xFF0C;&#x53EA;&#x9700;&#x6307;&#x5B9A;ServiceTarget&#x7684;class&#xFF0C;&#x4E4B;&#x540E;&#x7684;&#x4FBF;&#x4F9D;&#x9760;&#x52A8;&#x6001;&#x4EE3;&#x7406;&#x5B9E;&#x73B0;

&lt;aop:config&gt;
    &lt;aop:advisor advice-ref=&quot;txAdvice&quot; pointcut=&quot;execution(* cn.itcast.service.impl.*ServiceImpl.*(..))&quot;/&gt;
&lt;/aop:config&gt;

//&#x8FD9;&#x4E2A;&#x5B9E;&#x73B0;&#x4F7F;&#x5F97;&#x6211;&#x4EEC;&#x5728;MVC&#x5C42;&#x8C03;&#x7528;&#x7684;service&#x5BF9;&#x8C61;&#x5DF2;&#x7ECF;&#x662F;&#x7ECF;&#x8FC7;&#x4EE3;&#x7406;&#x5B9E;&#x73B0;&#x4E86;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x7528;&#x5176;&#x4E2D;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x5E95;&#x5C42;&#x90FD;&#x4F1A;&#x4F9D;&#x636E;&#x6D41;&#x7A0B;&#x81EA;&#x5DF1;&#x5B8C;&#x6210;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x53D1;&#x73B0;&#xFF0C;&#x6211;&#x4EEC;&#x6CA1;&#x6709;&#x81EA;&#x5DF1;&#x64CD;&#x4F5C;commit&#x7684;&#x7A7A;&#x95F4;&#xFF0C;&#x4ED6;&#x4F1A;&#x5728;&#x4F60;&#x4E8B;&#x52A1;&#x58F0;&#x660E;&#x7684;&#x65B9;&#x6CD5;&#x7ED3;&#x675F;&#x65F6;&#x5C31;commit&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x628A;&#x5F88;&#x591A;&#x4E1A;&#x52A1;&#x4EE3;&#x7801;&#x653E;&#x5728;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;service&#x65B9;&#x6CD5;&#x4E2D;&#x5B9E;&#x73B0;&#x540C;&#x4E00;&#x4E8B;&#x52A1;&#xFF0C;&#x4F46;&#x82E5;&#x662F;&#x4E0D;&#x60F3;&#x5219;&#x53EF;&#x4EE5;&#x7F16;&#x7801;&#x5F0F;&#x4E8B;&#x52A1;&#x63A7;&#x5236;&#x3002;
</code></pre></blockquote>
</blockquote>
</li>
</ul>
<hr>
<h4 id="spring&#x7684;&#x4E8B;&#x52A1;&#x5904;&#x7406;">Spring&#x7684;&#x4E8B;&#x52A1;&#x5904;&#x7406;</h4>
<ul>
<li>&#x6211;&#x4EEC;&#x4E00;&#x822C;&#x901A;&#x8FC7;TransactionTemplate&#x6765;&#x5BF9;PlatformTransactionManager&#x7684;&#x4E8B;&#x52A1;&#x8FDB;&#x884C;&#x5C01;&#x88C5;&#xFF0C;&#x4F7F;&#x5F97;&#x51FA;&#x73B0;&#x5F02;&#x5E38;&#x9700;&#x8981;callback&#x65F6;&#xFF0C;&#x5C06;&#x5176;&#x4F9D;&#x636E;callback&#x63A5;&#x53E3;&#x7684;&#x5B9E;&#x73B0;&#x53EF;&#x4EE5;&#x5728;TransactionTemplate&#x7C7B;&#x7684;excute&#x65B9;&#x6CD5;&#x4E2D;&#x4FBF;&#x5904;&#x7406;&#x6210;&#x529F;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x53EA;&#x9700;&#x8981;<strong>&#x6CE8;&#x610F;call back&#x63A5;&#x53E3;&#x7684;&#x8BBE;&#x8BA1;&#x4E0E;&#x5B9E;&#x73B0;</strong>&#xFF0C;&#x5C31;&#x80FD;&#x5C06;PlatformTransactionManager&#x7684;callback&#x90FD;&#x7531;&#x8BE5;&#x6A21;&#x677F;&#x5B9E;&#x73B0;&#xFF0C;<strong>&#x51CF;&#x5C11;&#x91CD;&#x590D;&#x4EE3;&#x7801;&#x7684;&#x7F16;&#x5199;</strong>&#x3002;&#x5F53;&#x7136;&#x5C0F;&#x578B;&#x6D4B;&#x8BD5;&#x76F4;&#x63A5;&#x7528;&#x4E5F;&#x53EF;&#x4EE5;&#x3002;</li>
</ul>
<ul>
<li><p>Spring&#x7684;&#x4E8B;&#x52A1;&#x5904;&#x7406;&#x4E2D;&#xFF0C;&#x901A;&#x7528;&#x7684;&#x4E8B;&#x52A1;&#x5904;&#x7406;&#x6D41;&#x7A0B;&#x662F;&#x7531;&#x62BD;&#x8C61;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x5668;AbstractPlatformTransactionManager&#x6765;&#x63D0;&#x4F9B;&#x7684;&#xFF0C;&#x800C;&#x5177;&#x4F53;&#x7684;&#x5E95;&#x5C42;&#x4E8B;&#x52A1;&#x5904;&#x7406;&#x5B9E;&#x73B0;&#xFF0C;&#x7531;PlatformTransactionManager&#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x7C7B;&#x6765;&#x5B9E;&#x73B0;&#xFF0C;&#x5982; DataSourceTransactionManager &#x3001;JtaTransactionManager&#x548C; HibernateTransactionManager&#x7B49;&#x3002;&#xFF08;<strong>&#x6211;&#x4EEC;&#x901A;&#x5E38;&#x4F7F;&#x7528;&#x7684;&#x662F;DataSourceTransactionManager&#x6765;&#x4E0E;mybatis&#x96C6;&#x6210;</strong>&#xFF09;</p>
</li>
<li><p>spring&#x4E8B;&#x52A1;&#x5904;&#x7406;&#x7684;&#x4E00;&#x4E2A;&#x5173;&#x952E;&#x662F;&#x4FDD;&#x8BC1;&#x5728;&#x6574;&#x4E2A;&#x4E8B;&#x52A1;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x91CC;&#x6240;&#x6709;&#x6267;&#x884C;sql&#x7684;jdbc connection&#x548C;&#x5904;&#x7406;&#x4E8B;&#x52A1;&#x7684;jdbc connection&#x59CB;&#x7EC8;&#x662F;&#x540C;&#x4E00;&#x4E2A;&#xFF08;&#x4E0D;&#x7136;&#x4E8B;&#x52A1;&#x901A;&#x8FC7;&#x4E0D;&#x540C;connection commit&#x7684;&#x65F6;&#x5019;&#x53EF;&#x80FD;&#x4F1A;&#x76F8;&#x4E92;&#x8986;&#x76D6;&#xFF0C;&#x987A;&#x5E8F;&#x4E5F;&#x96BE;&#x4EE5;&#x786E;&#x5B9A;&#xFF09;&#x3002;&#x7136;&#x540E;&#x6267;&#x884C;sql&#x7684;&#x4E1A;&#x52A1;&#x4EE3;&#x7801;&#x4E00;&#x822C;&#x90FD;&#x5206;&#x6563;&#x5728;&#x7A0B;&#x5E8F;&#x7684;&#x4E0D;&#x540C;&#x5730;&#x65B9;&#xFF0C;&#x5982;&#x4F55;&#x8BA9;&#x5B83;&#x4EEC;&#x5171;&#x4EAB;&#x4E00;&#x4E2A;jdbc connection&#x5462;&#xFF1F;</p>
</li>
</ul>
<ul>
<li>&#x8FD9;&#x91CC;spring&#x505A;&#x4E86;&#x4E00;&#x4E2A;&#x524D;&#x63D0;&#x5047;&#x8BBE;&#xFF1A;&#x5373;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#x7684;&#x64CD;&#x4F5C;&#x4E00;&#x5B9A;&#x662F;&#x5728;&#x4E00;&#x4E2A;thread&#x4E2D;&#x6267;&#x884C;&#xFF0C;&#x5728;&#x4E8B;&#x52A1;&#x672A;&#x7ED3;&#x675F;&#x524D;&#x8BE5;&#x4E8B;&#x52A1;&#x4E00;&#x76F4;&#x5B58;&#x5728;&#x4E8E;&#x8BE5;thread&#x4E2D;&#xFF0C;&#x4E14;&#x4E00;&#x4E2A;thread&#x4E2D;&#x5982;&#x679C;&#x6709;&#x591A;&#x4E2A;&#x4E8B;&#x52A1;&#x5728;&#x4E0D;&#x540C;&#x7684;jdbc connection&#x7684;&#x8BDD;&#xFF0C;&#x4ED6;&#x4EEC;&#x5FC5;&#x987B;&#x987A;&#x5E8F;&#x6267;&#x884C;&#xFF08;&#x5728;&#x4E0A;&#x4E00;&#x4E2A;&#x7ED3;&#x675F;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF09;&#xFF0C;<strong>&#x4E0D;&#x80FD;&#x540C;&#x65F6;&#x5B58;&#x5728;</strong>&#xFF0C;&#x6B64;&#x65F6;&#x82E5;&#x662F;&#x5C06;connection&#x4E5F;&#x7ED1;&#x5B9A;&#x5230;&#x7EBF;&#x7A0B;&#x4E2D;&#xFF0C;&#x90A3;&#xFF08;&#x8FD9;&#x4E2A;&#x5047;&#x8BBE;&#x5728;&#x7EDD;&#x5927;&#x591A;&#x6570;&#x60C5;&#x51B5;&#x4E0B;&#x90FD;&#x662F;&#x6210;&#x7ACB;&#x7684;&#xFF0C;mybatis&#x81EA;&#x8EAB;&#x7684;&#x4E8B;&#x52A1;&#x5904;&#x7406;&#x4E2D;&#xFF0C;sqlsession&#x4E5F;&#x53EF;&#x4EE5;&#x591A;&#x6B21;&#x6267;&#x884C;commit&#xFF0C;connection&#x7684;&#x83B7;&#x53D6;&#x662F;&#x5728;sqlsession&#x6267;&#x884C;sql&#x65F6;&#x8FDB;&#x884C;&#x7684;&#xFF0C;&#x56E0;&#x6B64;sqlsession&#x4E5F;&#x53EF;&#x6709;&#x591A;&#x4E2A;&#x4E0D;&#x540C;jdbc connection&#x751F;&#x6210;&#x7684;&#x4E8B;&#x52A1;&#xFF0C;&#x5FC5;&#x987B;&#x987A;&#x5E8F;&#x6267;&#x884C;&#xFF09;&#x3002;</li>
</ul>
<ul>
<li>&#x57FA;&#x4E8E;&#x8FD9;&#x4E2A;&#x5047;&#x8BBE;&#xFF0C;spring&#x5728;transaction&#x521B;&#x5EFA;&#x65F6;&#xFF0C;&#x4F1A;&#x7528;ThreadLocal&#x628A;&#x521B;&#x5EFA;&#x8FD9;&#x4E2A;&#x4E8B;&#x52A1;&#x7684;jdbc connection&#x7ED1;&#x5B9A;&#x5230;&#x5F53;&#x524D;thread&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x5728;&#x4E8B;&#x52A1;&#x7684;&#x6574;&#x4E2A;&#x751F;&#x547D;&#x5468;&#x671F;&#x4E2D;&#x90FD;&#x4F1A;&#x4ECE;ThreadLocal&#x4E2D;&#x83B7;&#x53D6;&#x540C;&#x4E00;&#x4E2A;jdbc connection&#xFF08;&#x53EA;&#x8981;&#x6CA1;&#x6709;&#x4E3B;&#x52A8;&#x65AD;&#x5F00;connection&#xFF09;&#x3002;</li>
</ul>
<ul>
<li>Spring&#x672C;&#x8EAB;&#x7684;&#x4E8B;&#x52A1;&#x6D41;&#x7A0B;&#xFF08;&#x914D;&#x5408;JdbcTemplate&#xFF09;</li>
</ul>
<p><img src="https://static.oschina.net/uploads/space/2016/1110/143421_Bmpa_1452390.png" alt="143421_Bmpa_1452390.png"></p>
<ul>
<li><strong>&#x4ECE;&#x4E0A;&#x9762;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C;Spring&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x4E00;&#x5171;&#x53EF;&#x5206;&#x4E3A;&#x4E09;&#x4E2A;&#x6B65;&#x9AA4;&#xFF0C;&#x5206;&#x522B;&#x662F;&#x521D;&#x59CB;&#x5316;&#x4E8B;&#x52A1;&#x3001;&#x63D0;&#x4EA4;&#x4E8B;&#x52A1;&#x3001;&#x56DE;&#x6EDA;&#x4E8B;&#x52A1;&#xFF0C;spring&#x4E8B;&#x52A1;&#x5DE5;&#x4F5C;&#x6D41;&#x76F8;&#x5F53;&#x4E8E;&#x4E3A;&#x7528;&#x6237;&#x5C4F;&#x853D;&#x4E86;&#x5177;&#x4F53;orm&#x6846;&#x67B6;&#x7684;&#x5E95;&#x5C42;&#x5904;&#x7406;&#x903B;&#x8F91;&#xFF0C;&#x57FA;&#x4E8E;spring&#x5F00;&#x53D1;&#x7684;&#x7A0B;&#x5E8F;&#xFF0C;&#x5373;&#x4FBF;&#x66F4;&#x6362;&#x4E86;orm&#x6846;&#x67B6;&#x4E5F;&#x662F;&#x8DDF;&#x6362;&#x4E86;&#x8C03;&#x7528;&#x7684;sqlTemplate&#xFF0C;&#x6211;&#x4EEC;&#x7684;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x5668;&#x66F4;&#x6362;&#x6210;&#x9002;&#x5408;&#x4E8E;&#x4ED6;&#x7684;&#x4FBF;&#x53EF;&#xFF0C;&#x57FA;&#x672C;&#x4E0D;&#x7528;&#x6539;&#x53D8;&#x5176;&#x4ED6;&#x7684;&#x5B9E;&#x73B0;&#x3002;&#x8FD9;&#x662F;Spring&#x7684;&#x4F18;&#x70B9;</strong></li>
</ul>
<ul>
<li>Spring&#x63A7;&#x5236;datasourcetransaction &#xFF0C;mybaitis&#x7528;springManagedTransaction&#x5BF9;&#x6570;&#x636E;&#x5E93;&#x8FDB;&#x884C;sql&#x64CD;&#x4F5C;&#xFF0C;&#x4F46;commit&#x7B49;&#x90FD;&#x662F;&#x6700;&#x540E;&#x7531;datasourceTransaction &#x8FDB;&#x884C;.</li>
</ul>
<h6 id="sqlsessionfactorybean">SqlSessionFactoryBean</h6>
<ul>
<li>&#x518D;&#x770B;&#x8FD9;&#x4E2A;&#x5BB9;&#x5668;&#x4E2D;&#x7684;&#x53C2;&#x6570;&#xFF0C;<strong>&#x65E0;&#x8BBA;&#x5982;&#x4F55;&#x6211;&#x4EEC;&#x90FD;&#x9700;&#x8981;SqlSessionFactoryBean&#xFF08;&#x65E0;&#x8BBA;&#x662F;&#x5426;&#x6709;&#x7528;Spring&#x7684;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x90FD;&#x9700;&#x8981;&#xFF09;&#x548C;DataSourceTransactionManager</strong></li>
</ul>
<ul>
<li>&#x7531;SqlSessionFactoryBean&#x521B;&#x5EFA;&#x5DE5;&#x5382;&#xFF0C;&#x6B64;&#x5DE5;&#x5382;&#x5C06;<strong>&#x751F;&#x6210;SpringManagedTransactionFactory</strong>&#xFF08;&#x53EF;&#x80FD;&#x6709;&#x4EBA;&#x4F1A;&#x597D;&#x5947;&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x5927;&#x8D39;&#x5468;&#x7AE0;&#x91CD;&#x65B0;&#x5B9E;&#x73B0;&#x4E00;&#x4E2A;TransactionFactory&#xFF0C;&#x5230;&#x4E0B;&#x9762;&#x8FDB;&#x5165;sqlsession&#x7684;&#x90E8;&#x5206;&#x5C31;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x7B54;&#x6848;&#x4E86;&#xFF09;&#xFF0C;&#x518D;&#x5C01;&#x88C5;&#x6210; Environment &#x5BF9;&#x8C61;&#x3002;&#x6700;&#x540E;&#x5C01;&#x88C5;&#x6210;configuration&#x5BF9;&#x8C61;&#x6765;&#x8C03;&#x7528;sqlSessionFactoryBuilder.build(configuration);</li>
</ul>
<blockquote>
<p>&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F; SqlSessionFactoryBean &#x5B9E;&#x73B0;&#x4E86; Spring &#x7684; FactoryBean &#x63A5;&#x53E3;&#x3002;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x7531; Spring &#x6700;&#x7EC8;&#x521B;&#x5EFA;&#x7684; bean &#x5E76;&#x4E0D;&#x662F; SqlSessionFactoryBean &#x672C;&#x8EAB;&#xFF0C;&#x800C;&#x662F;&#x5DE5;&#x5382;&#x7C7B;&#xFF08;SqlSessionFactoryBean&#xFF09;&#x7684; getObject() &#x65B9;&#x6CD5;&#x7684;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x3002;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;Spring &#x5C06;&#x4F1A;&#x5728;&#x5E94;&#x7528;&#x542F;&#x52A8;&#x65F6;&#x4E3A;&#x4F60;&#x521B;&#x5EFA; SqlSessionFactory&#xFF0C;&#x5E76;&#x4F7F;&#x7528; sqlSessionFactory &#x8FD9;&#x4E2A;&#x540D;&#x5B57;&#x5B58;&#x50A8;&#x8D77;&#x6765;&#x3002;&#x56E0;&#x4E3A;&#x662F;spring&#x5BB9;&#x5668;&#x751F;&#x6210;&#x7684;&#xFF0C;&#x6240;&#x4EE5;xml&#x89E3;&#x6790;&#x65F6;&#x5BF9;&#x5B9E;&#x73B0;&#x8FD9;&#x4E2A;&#x63A5;&#x53E3;&#x7684;&#x5BF9;&#x8C61;&#x4F1A;&#x81EA;&#x52A8;&#x8C03;&#x7528;getObject() &#x65B9;&#x6CD5;</p>
<p>&#x7B49;&#x6548;&#x7684; Java &#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-meta">@Bean</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title">sqlSessionFactory</span><span class="hljs-params">()</span> </span>{
  SqlSessionFactoryBean factoryBean = <span class="hljs-keyword">new</span> SqlSessionFactoryBean();
  factoryBean.setDataSource(dataSource());
  <span class="hljs-keyword">return</span> factoryBean.getObject();
}
</code></pre>
</blockquote>
<ul>
<li><p>&#x751F;&#x6210;sqlsqlSessionFactory&#xFF0C;&#x7531;XMLConfigBuilder&#x8BFB;&#x53D6;parse&#x6210;&#x4E00;&#x4E2A;sqlsqlSessionFactory&#xFF0C;<strong>&#x4EA4;&#x7531;SqlsessionTemplate&#x4F7F;&#x7528;</strong>&#xFF08;&#x5176;&#x5B9E;&#x73B0;&#x4E86; <code>SqlSession</code> &#x63A5;&#x53E3;&#xFF0C;&#x5E76;&#x4E0D;&#x76F4;&#x63A5;&#x8C03;&#x7528;&#x5177;&#x4F53;&#x7684; <code>SqlSession</code> &#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x800C;&#x662F;&#x59D4;&#x6258;&#x7ED9;&#x4E00;&#x4E2A;&#x52A8;&#x6001;&#x4EE3;&#x7406;&#xFF0C;&#x901A;&#x8FC7;&#x4EE3;&#x7406; <code>SqlSessionInterceptor</code> &#x5BF9;&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x8FDB;&#x884C;&#x62E6;&#x622A;&#xFF0C;&#x7528;&#x8C03;&#x7528;&#x63A5;&#x53E3;&#x7684;&#x65B9;&#x6CD5;&#x65F6;&#xFF0C;&#x4F1A;&#x53BB;&#x5BFB;&#x627E;&#x662F;&#x5426;&#x6709;&#x4E86;&#x505C;&#x7559;&#x5728;resources&#x4E2D;&#x7684;&#x672A;&#x5173;&#x95ED;&#x7684;sqlsession&#xFF09;</p>
<blockquote>
<p> &#x82E5;&#x662F;&#x7F16;&#x7A0B;&#x5F0F;&#x4E8B;&#x52A1;&#x63A7;&#x5236;&#x7684;&#x8BDD;&#x6211;&#x4EEC;&#x5E94;&#x8BE5;&#x5148;&#x521B;&#x5EFA;SqlSessionFactoryBean&#x521B;&#x5EFA;sqlsqlSessionFactory&#xFF0C;&#x518D;&#x5C06;&#x5176;&#x6CE8;&#x5165;&#x81EA;&#x5DF1;&#x521B;&#x5EFA;&#x7684;SqlsessionTemplate&#x5BF9;&#x8C61;&#x4E2D;&#xFF0C;&#x518D;&#x5229;&#x7528;SqlsessionTemplate&#x8FDB;&#x884C;&#x589E;&#x5220;&#x67E5;&#x6539;</p>
</blockquote>
<pre><code>public class SqlSessionFactoryBean implements FactoryBean&lt;SqlSessionFactory&gt;, InitializingBean, ApplicationListener&lt;ApplicationEvent&gt; {

protected SqlSessionFactory buildSqlSessionFactory() throws IOException {
    XMLConfigBuilder xmlConfigBuilder = null;
    Configuration configuration;
    &#xB7;&#xB7;&#xB7;
    &#x5404;&#x79CD;configuration&#x7684;&#x53C2;&#x6570;&#x5224;&#x65AD;
    &#xB7;&#xB7;&#xB7;&#xB7;
     //&#x751F;&#x6210;SpringManagedTransactionFactory
    if (this.transactionFactory == null) {
        this.transactionFactory = new SpringManagedTransactionFactory();

    }

    //&#x5C01;&#x88C5;&#x6210; Environment &#x5BF9;&#x8C61;
    //&#x5C01;&#x88C5;&#x6210;configuration&#x5BF9;&#x8C61;
    configuration.setEnvironment(new Environment(this.environment, this.transactionFactory, this.dataSource));
    &#xB7;&#xB7;&#xB7;
    &#x53C2;&#x6570;&#x68C0;&#x67E5;
    &#xB7;&#xB7;&#xB7;

    //&#x8C03;&#x7528;sqlSessionFactoryBuilder.build(configuration);&#x751F;&#x6210;sqlsqlSessionFactory&#xFF0C;
    return this.sqlSessionFactoryBuilder.build(configuration);
}
}
</code></pre></li>
</ul>
<h6 id="datasourcetransactionmanager">DataSourceTransactionManager</h6>
<ul>
<li>&#x82E5;&#x8981;&#x4F7F;&#x7528;spring&#x7684;&#x4E8B;&#x52A1;&#xFF0C;&#x4F7F;&#x7528;sqlsessionTemplate&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x8981;&#x5206;&#x6790;DataSourceTransactionManager&#x6574;&#x4E2A;&#x6D41;&#x7A0B;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4E00;&#x6B65;&#x4E00;&#x6B65;&#x6765;&#xFF0C;&#x4ECE;&#x6700;&#x9876;&#x5C42;&#x5F00;&#x59CB;</li>
</ul>
<ul>
<li>Spring&#x7684;PlatformTransactionManager&#x662F;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x7684;&#x9876;&#x5C42;&#x63A5;&#x53E3;&#xFF0C;&#x5176;&#x4E2D;&#x5B9A;&#x4E49;&#x7684;&#x4E09;&#x4E2A;&#x65B9;&#x6CD5;&#x5BF9;&#x5E94;&#x7684;&#x5C31;&#x662F;&#x521D;&#x59CB;&#x5316;&#x4E8B;&#x52A1;&#x3001;&#x63D0;&#x4EA4;&#x4E8B;&#x52A1;&#x3001;&#x56DE;&#x6EDA;&#x4E8B;&#x52A1;&#xFF0C;&#xFF0C;&#x7136;&#x540E;AbstractPlatformTransactionManager&#x62BD;&#x8C61;&#x7C7B;&#xFF08;&#x4F5C;&#x4E3A;&#x6A21;&#x677F;&#xFF09;&#x7ED9;&#x51FA;&#x4E86;&#x4E09;&#x4E2A;&#x6B65;&#x9AA4;&#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x3002;</li>
</ul>
<ul>
<li><strong>&#x4F46;&#x5BF9;&#x8BF8;&#x5982;doGetTransaction()&#x4E4B;&#x7C7B;&#x7684;&#x548C;doBegin&#x7B49;&#x8FD8;&#x662F;&#x5F04;&#x6210;&#x4E86;&#x62BD;&#x8C61;&#x65B9;&#x6CD5;&#x7531;DataSourceTransactionManager&#x7B49;&#x5B9E;&#x73B0;&#xFF0C;&#x4EE5;&#x4FBF;&#x81EA;&#x5DF1;&#x51B3;&#x5B9A;&#x5BF9; TransactionSynchronization&#x63A5;&#x53E3;&#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#x8FDB;&#x884C;&#x8C03;&#x7528;&#xFF0C;&#x81EA;&#x5DF1;&#x5B9E;&#x73B0;&#x7EBF;&#x7A0B;&#x5B89;&#x5168;&#x3001;&#x83B7;&#x5F97;ConnectionHolder&#x548C;&#x521B;&#x5EFA;&#x65B0;&#x4E8B;&#x52A1;&#x65F6;&#x6309;&#x4F55;&#x79CD;&#x65B9;&#x5F0F;dobgin&#xFF0C;&#x8FDE;&#x63A5;&#x65B9;&#x5F0F;&#x548C;&#x6CE8;&#x5165;&#x5404;&#x79CD;&#x53C2;&#x6570;&#x3002;</strong></li>
</ul>
<blockquote>
<pre><code>public abstract class AbstractPlatformTransactionManager implements PlatformTransactionManager, Serializable {

public final TransactionzhuangtStatus getTransaction(@Nullable TransactionDefinition definition) throws TransactionException {

//&#x5728;DataSourceTransactionManager&#x4E2D;&#x91CD;&#x5199;&#x4E86;&#x7684;&#x7C7B;&#xFF0C;&#x67E5;&#x8BE2;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x4E2D;&#x662F;&#x5426;&#x6709;&#x4F20;&#x5165;&#x7684;datasource&#x5BF9;&#x5E94;&#x7684;ConnectionHolder&#xFF0C;&#x6709;&#x5219;&#x4F9D;&#x636E;&#x4ED6;&#x521B;&#x5EFA;transaction

Object transaction = this.doGetTransaction();
boolean debugEnabled = this.logger.isDebugEnabled();
if (definition == null) {
  definition = new DefaultTransactionDefinition();
}

if (this.isExistingTransaction(transaction)) {
  return this.handleExistingTransaction((TransactionDefinition)definition, transaction, debugEnabled);
}
&#xB7;&#xB7;&#xB7;
&#x5404;&#x79CD;&#x6761;&#x4EF6;&#x5224;&#x65AD;
&#xB7;&#xB7;&#xB7;
  try {
      boolean newSynchronization = this.getTransactionSynchronization() != 2;

      //&#x88AB;&#x521B;&#x5EFA;&#x7684;&#x4E8B;&#x52A1;&#x72B6;&#x6001;&#x5BF9;&#x8C61;&#x7C7B;&#x578B;&#x662F;DefaultTransactionStatus&#xFF0C;&#x5B83;&#x6301;&#x6709;&#x4E0A;&#x8FF0;&#x521B;&#x5EFA;&#x7684;&#x4E8B;&#x52A1;&#x5BF9;&#x8C61;&#x3002;&#x4E8B;&#x52A1;&#x72B6;&#x6001;&#x5BF9;&#x8C61;&#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x4E8B;&#x52A1;&#x5BF9;&#x8C61;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x6BD4;&#x5982;&#x4E8B;&#x52A1;&#x662F;&#x5426;&#x88AB;&#x6807;&#x8BB0;&#x4E86;&#x56DE;&#x6EDA;&#xFF0C;&#x662F;&#x5426;&#x662F;&#x4E00;&#x4E2A;&#x65B0;&#x4E8B;&#x52A1;&#x7B49;&#x7B49;&#x3002;
      DefaultTransactionStatus status = this.newTransactionStatus((TransactionDefinition)definition, transaction, true, newSynchronization, debugEnabled, suspendedResources);

      //&#x4E8B;&#x52A1;&#x5F00;&#x59CB;&#x5904;&#x7406;&#xFF0C;&#x8FDB;&#x884C;&#x4FC3;&#x4F7F;&#x5316;&#xFF0C;&#x8FDE;&#x63A5;&#x83B7;&#x53D6;
      this.doBegin(transaction, (TransactionDefinition)definition);

      //&#x5BF9;&#x8C61;&#x90FD;&#x4EA4;&#x7531;TransactionSynchronizationManager&#x7BA1;&#x7406;&#xFF0C;TransactionSynchronizationManager&#x628A;&#x8FD9;&#x4E9B;&#x5BF9;&#x8C61;&#x90FD;&#x4FDD;&#x5B58;&#x5728;ThreadLocal&#x4E2D;&#x3002;&#x5728;&#x8BE5;transaction&#x672A;commit/&#x5173;&#x95ED;&#x524D;&#xFF0C;&#x8BE5;&#x7EBF;&#x7A0B;&#x5C31;&#x4F1A;&#x4E0E;&#x8BE5;connection&#x4E00;&#x76F4;&#x7ED1;&#x5B9A;&#x5728;&#x4E00;&#x8D77;&#xFF0C;&#x901A;&#x8FC7;&#x53EA;&#x80FD;&#x540C;&#x65F6;&#x7ED1;&#x5B9A;&#x4E00;&#x4E2A;connection&#x7684;&#x539F;&#x7406;&#xFF0C;&#x5B9E;&#x73B0;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x3002;

      this.prepareSynchronization(status, (TransactionDefinition)definition);

      &#x8FD4;&#x56DE;&#x4E8B;&#x52A1;&#x72B6;&#x6001;&#x5BF9;&#x8C61;&#xFF1A;&#xFF08;&#x4E3B;&#x8981;&#x8FDB;&#x884C;&#xFF1A;&#x67E5;&#x8BE2;&#x4E8B;&#x52A1;&#x72B6;&#x6001;&#x3001;&#x901A;&#x8FC7;setRollbackOnly&#xFF08;&#xFF09;&#x65B9;&#x6CD5;&#x6807;&#x8BB0;&#x5F53;&#x524D;&#x4E8B;&#x52A1;&#x4F7F;&#x5176;&#x56DE;&#x6EDA;&#xFF0C;&#x6839;&#x636E;&#x4E8B;&#x52A1;&#x53C2;&#x6570;&#x521B;&#x5EFA;&#x5185;&#x5D4C;&#x4E8B;&#x52A1;&#xFF09;&#xFF0C;statu&#x7684;&#x610F;&#x601D;&#x662F;&#x65B9;&#x4FBF;&#x5148;&#x5BF9;&#x4E8B;&#x52A1;&#x8FDB;&#x884C;&#x5224;&#x65AD;&#x518D;&#x83B7;&#x53D6;transaction&#x8FDB;&#x884C;&#x64CD;&#x4F5C;&#x3002;
      return status;
  } catch (Error | RuntimeException var7) {
      this.resume((Object)null, suspendedResources);
      throw var7;
  }
}
}
}
</code></pre></blockquote>
<ul>
<li>DataSourceTransactionManager&#xFF08;&#x7EE7;&#x627F;&#x4E86;AbstractPlatformTransactionManager&#xFF09;&#x7684;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#x662F;&#x521B;&#x5EFA;transaction&#x548C;&#x5BF9;transaction&#x7684;&#x521D;&#x59CB;&#x5316;</li>
</ul>
<blockquote>
<pre><code>public class DataSourceTransactionManager extends AbstractPlatformTransactionManager
        implements ResourceTransactionManager, InitializingBean {

@Override//&#x4E3B;&#x8981;&#x589E;&#x52A0;&#x4E86;&#x5BF9;TransactionSynchronizationManager&#x4E2D;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x662F;&#x5426;&#x6709;connectionHolder
    protected Object doGetTransaction() {

        // &#x521B;&#x5EFA;&#x4E8B;&#x52A1;&#x5BF9;&#x8C61;

        DataSourceTransactionObject txObject = new DataSourceTransactionObject();
        txObject.setSavepointAllowed(isNestedTransactionAllowed());
        ConnectionHolder conHolder =
                (ConnectionHolder) TransactionSynchronizationManager.getResource(obtainDataSource());
        //ConnectionHolder&#x8D4B;&#x503C;&#x7ED9;&#x4E8B;&#x52A1;&#x5BF9;&#x8C61;txObject
        txObject.setConnectionHolder(conHolder, false);
        return txObject;        
        }
}

//&#x5904;&#x7406;&#x4E8B;&#x52A1;&#x5F00;&#x59CB;&#x7684;&#x65B9;&#x6CD5;  
    protected void doBegin(Object transaction, TransactionDefinition definition) {  
        DataSourceTransactionObject txObject = (DataSourceTransactionObject) transaction;  
        Connection con = null;  
        try {  
            //&#x5982;&#x679C;&#x6570;&#x636E;&#x6E90;&#x4E8B;&#x52A1;&#x5BF9;&#x8C61;&#x7684;ConnectionHolder&#x4E3A;null&#x6216;&#x8005;&#x662F;&#x4E8B;&#x52A1;&#x540C;&#x6B65;&#x7684;  
            if (txObject.getConnectionHolder() == null ||  
        txObject.getConnectionHolder().isSynchronizedWithTransaction()) {  
                //&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x6570;&#x636E;&#x6E90;&#x7684;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;  
                Connection newCon = this.dataSource.getConnection();  
                if (logger.isDebugEnabled()) {  
                    logger.debug(&quot;Acquired Connection [&quot; + newCon + &quot;] for JDBC transaction&quot;);  
                }  
                //&#x4E3A;&#x6570;&#x636E;&#x6E90;&#x4E8B;&#x52A1;&#x5BF9;&#x8C61;&#x8BBE;&#x7F6E;ConnectionHolder  
                txObject.setConnectionHolder(new ConnectionHolder(newCon), true);  
            }  
    //&#x8BBE;&#x7F6E;&#x6570;&#x636E;&#x6E90;&#x4E8B;&#x52A1;&#x5BF9;&#x8C61;&#x7684;&#x4E8B;&#x52A1;&#x540C;&#x6B65;    txObject.getConnectionHolder().setSynchronizedWithTransaction(true);  
            //&#x83B7;&#x53D6;&#x6570;&#x636E;&#x6E90;&#x4E8B;&#x52A1;&#x5BF9;&#x8C61;&#x7684;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;  
            con = txObject.getConnectionHolder().getConnection();  
            //&#x6839;&#x636E;&#x6570;&#x636E;&#x8FDE;&#x63A5;&#x548C;&#x4E8B;&#x52A1;&#x5C5E;&#x6027;&#xFF0C;&#x83B7;&#x53D6;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;&#x7684;&#x4E8B;&#x52A1;&#x9694;&#x79BB;&#x7EA7;&#x522B;  
            Integer previousIsolationLevel = DataSourceUtils.prepareConnectionForTransaction(con, definition);  
    //&#x4E3A;&#x6570;&#x636E;&#x6E90;&#x4E8B;&#x52A1;&#x5BF9;&#x8C61;&#x8BBE;&#x7F6E;&#x4E8B;&#x52A1;&#x9694;&#x79BB;&#x7EA7;&#x522B;  
    txObject.setPreviousIsolationLevel(previousIsolationLevel);  
            //&#x5982;&#x679C;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;&#x8BBE;&#x7F6E;&#x4E86;&#x81EA;&#x52A8;&#x4E8B;&#x52A1;&#x63D0;&#x4EA4;&#x5C5E;&#x6027;&#xFF0C;&#x5219;&#x5173;&#x95ED;&#x81EA;&#x52A8;&#x63D0;&#x4EA4;  
            if (con.getAutoCommit()) {  
                //&#x4FDD;&#x5B58;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;&#x8BBE;&#x7F6E;&#x7684;&#x81EA;&#x52A8;&#x8FDE;&#x63A5;&#x5230;&#x6570;&#x636E;&#x6E90;&#x4E8B;&#x52A1;&#x5BF9;&#x8C61;&#x4E2D;  
                txObject.setMustRestoreAutoCommit(true);  
                if (logger.isDebugEnabled()) {  
                    logger.debug(&quot;Switching JDBC Connection [&quot; + con + &quot;] to manual commit&quot;);  
                }  
                //&#x8BBE;&#x7F6E;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;&#x81EA;&#x52A8;&#x4E8B;&#x52A1;&#x63D0;&#x4EA4;&#x5C5E;&#x6027;&#x4E3A;false&#xFF0C;&#x5373;&#x7981;&#x6B62;&#x81EA;&#x52A8;&#x4E8B;&#x52A1;&#x63D0;&#x4EA4;  
                con.setAutoCommit(false);  
            }  
            //&#x6FC0;&#x6D3B;&#x5F53;&#x524D;&#x6570;&#x636E;&#x6E90;&#x4E8B;&#x52A1;&#x5BF9;&#x8C61;&#x7684;&#x4E8B;&#x52A1;&#x914D;&#x7F6E;  
            txObject.getConnectionHolder().setTransactionActive(true);  
            //&#x83B7;&#x53D6;&#x4E8B;&#x52A1;&#x914D;&#x7F6E;&#x7684;&#x8D85;&#x65F6;&#x65F6;&#x957F;  
int timeout = determineTimeout(definition);  
//&#x5982;&#x679C;&#x4E8B;&#x52A1;&#x914D;&#x7F6E;&#x7684;&#x8D85;&#x65F6;&#x65F6;&#x957F;&#x4E0D;&#x7B49;&#x4E8E;&#x4E8B;&#x52A1;&#x7684;&#x9ED8;&#x8BA4;&#x8D85;&#x65F6;&#x65F6;&#x957F;  
            if (timeout != TransactionDefinition.TIMEOUT_DEFAULT) {  
        //&#x6570;&#x636E;&#x6E90;&#x4E8B;&#x52A1;&#x5BF9;&#x8C61;&#x8BBE;&#x7F6E;&#x8D85;&#x65F6;&#x65F6;&#x957F;  
        txObject.getConnectionHolder().setTimeoutInSeconds(timeout);  
            }  
            //&#x628A;&#x5F53;&#x524D;&#x6570;&#x636E;&#x5E93;Connection&#x548C;&#x7EBF;&#x7A0B;ThreadLocal&#x7ED1;&#x5B9A;&#xFF08;key&#x4E3A;DataSource&#xFF0C;value&#x4E3A;getConnectionHolder&#xFF09;spring&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x7684;&#x5173;&#x952E;&#x4E00;&#x6B65;
            if (txObject.isNewConnectionHolder()) {  
        TransactionSynchronizationManager.bindResource(getDataSource(), txObject.getConnectionHolder());  
            }  
        }  
        catch (Exception ex) {  
            DataSourceUtils.releaseConnection(con, this.dataSource);  
            throw new CannotCreateTransactionException(&quot;Could not open JDBC Connection for transaction&quot;, ex);  
        }  
    }
</code></pre></blockquote>
<h6 id="transactionsynchronizationmanager">TransactionSynchronizationManager</h6>
<ul>
<li>&#x4E3B;&#x8981;&#x4ECE;&#x7EBF;&#x7A0B;&#x4E2D;&#x6839;&#x636E;&#x952E;&#x503C;&#x83B7;&#x53D6;&#x8D44;&#x6E90;</li>
</ul>
<pre><code>public abstract class TransactionSynchronizationManager {
    private static final Log logger = LogFactory.getLog(TransactionSynchronizationManager.class);
    private static final ThreadLocal&lt;Map&lt;Object, Object&gt;&gt; resources = new NamedThreadLocal(&quot;Transactional resources&quot;);
    private static final ThreadLocal&lt;Set&lt;TransactionSynchronization&gt;&gt; synchronizations = new NamedThreadLocal(&quot;Transaction synchronizations&quot;);
    private static final ThreadLocal&lt;String&gt; currentTransactionName = new NamedThreadLocal(&quot;Current transaction name&quot;);
    private static final ThreadLocal&lt;Boolean&gt; currentTransactionReadOnly = new NamedThreadLocal(&quot;Current transaction read-only status&quot;);
    private static final ThreadLocal&lt;Integer&gt; currentTransactionIsolationLevel = new NamedThreadLocal(&quot;Current transaction isolation level&quot;);
    private static final ThreadLocal&lt;Boolean&gt; actualTransactionActive = new NamedThreadLocal(&quot;Actual transaction active&quot;);

     //&#x83B7;&#x53D6;&#x76F8;&#x5E94;&#x7684;&#x8D44;&#x6E90;&#xFF0C;&#x952E;&#x503C;&#x5148;unwrapResourceIfNecessary&#x5904;&#x7406;&#xFF0C;&#x4EA4;&#x7531;doget&#x83B7;&#x53D6;
     public static Object getResource(Object key) {
        Object actualKey = TransactionSynchronizationUtils.unwrapResourceIfNecessary(key);
        Object value = doGetResource(actualKey);
        if (value != null &amp;&amp; logger.isTraceEnabled()) {
            logger.trace(&quot;Retrieved value [&quot; + value + &quot;] for key [&quot; + actualKey + &quot;] bound to thread [&quot; + Thread.currentThread().getName() + &quot;]&quot;);
        }

        return value;
    }

    //&#x4ECE;&#x4FDD;&#x5B58;&#x5728;&#x7EBF;&#x7A0B;&#x7684;resource&#x83B7;&#x53D6;
    @Nullable
    private static Object doGetResource(Object actualKey) {
        Map&lt;Object, Object&gt; map = (Map)resources.get();
        if (map == null) {
            return null;
        } else {
            Object value = map.get(actualKey);
            if (value instanceof ResourceHolder &amp;&amp; ((ResourceHolder)value).isVoid()) {
                map.remove(actualKey);
                if (map.isEmpty()) {
                    resources.remove();
                }

                value = null;
            }

            return value;
        }
    }

    public static void bindResource(Object key, Object value) throws IllegalStateException {
        Object actualKey = TransactionSynchronizationUtils.unwrapResourceIfNecessary(key);
        Assert.notNull(value, &quot;Value must not be null&quot;);
        Map&lt;Object, Object&gt; map = (Map)resources.get();
        if (map == null) {
            map = new HashMap();
            resources.set(map);
        }

        Object oldValue = ((Map)map).put(actualKey, value);
        if (oldValue instanceof ResourceHolder &amp;&amp; ((ResourceHolder)oldValue).isVoid()) {
            oldValue = null;
        }

        if (oldValue != null) {
            throw new IllegalStateException(&quot;Already value [&quot; + oldValue + &quot;] for key [&quot; + actualKey + &quot;] bound to thread [&quot; + Thread.currentThread().getName() + &quot;]&quot;);
        } else {
            if (logger.isTraceEnabled()) {
                logger.trace(&quot;Bound value [&quot; + value + &quot;] for key [&quot; + actualKey + &quot;] to thread [&quot; + Thread.currentThread().getName() + &quot;]&quot;);
            }

        }
    }
</code></pre><ul>
<li><strong>&#x6B64;&#x65F6;&#x82E5;&#x662F;&#x6CE8;&#x91CA;&#x8FD0;&#x884C;&#x7684;&#x4FBF;&#x9700;&#x8981;&#x628A;PlatformTransactionManager&#xFF0C;&#x4ED6;&#x751F;&#x6210;&#x7684;TransactionStatus&#x3001;TransactionAttribute&#x7B49;&#x5C01;&#x88C5;&#x5230;TransactionInfo&#x4E2D;&#x4EE5;&#x4FBF;&#x6CE8;&#x89E3;&#x80FD;&#x81EA;&#x5DF1;&#x8C03;&#x7528;</strong></li>
</ul>
<hr>
<h4 id="springmybatis">Spring+mybatis</h4>
<ul>
<li><p>&#x5B8C;&#x6210;&#x4E86;&#x5BF9;&#x4E8B;&#x52A1;&#x7684;&#x521B;&#x5EFA;&#xFF0C;&#x5E76;&#x5C06;&#x5176;&#x7528;TransactionSynchronizationManager&#x7ED1;&#x5B9A;&#x5230;&#x4E86;thread local&#x4E0A;&#xFF0C;&#x63A5;&#x7740;&#x4FBF;&#x662F;&#x5BF9;sqlsessionTemplate&#x7684;&#x8C03;&#x7528;&#x4E86;&#x5373;&#x5BF9;mybatis&#x6846;&#x67B6;&#x7684;sqlsession&#x7684;&#x6574;&#x5408;&#x4E86;</p>
</li>
<li><p>Spring+mybatis&#x7684;&#x4E8B;&#x52A1;&#x63A7;&#x5236;&#x6D41;&#x7A0B;</p>
</li>
</ul>
<p><img src="http://static.oschina.net/uploads/space/2016/1110/143554_iORI_1452390.png" alt="img"></p>
<h4 id="sqlsessiontemplate">SqlsessionTemplate</h4>
<ul>
<li>SqlsessionTemplate&#x7684;&#x4F7F;&#x7528;&#x5E76;&#x4E0D;&#x662F;&#x76F4;&#x63A5;&#x7528;sqlsession&#x8FDB;&#x884C;&#x589E;&#x5220;&#x67E5;&#x6539;&#xFF08;&#x5B9E;&#x9645;&#x4E0A;&#x662F;sqlsession&#x7684;&#x4E00;&#x4E2A;&#x4EE3;&#x7406;&#x7C7B;&#xFF0C;&#x5176;&#x5B9E;&#x73B0;&#x4E86; <code>SqlSession</code> &#x63A5;&#x53E3;&#xFF0C;&#x5E76;&#x4E0D;&#x76F4;&#x63A5;&#x8C03;&#x7528;&#x5177;&#x4F53;&#x7684; <code>SqlSession</code> &#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x800C;&#x662F;&#x59D4;&#x6258;&#x7ED9;&#x4E00;&#x4E2A;&#x52A8;&#x6001;&#x4EE3;&#x7406;&#xFF0C;&#x901A;&#x8FC7;&#x4EE3;&#x7406; <code>SqlSessionInterceptor</code> &#x5BF9;&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x8FDB;&#x884C;&#x62E6;&#x622A;&#xFF0C;&#x7528;&#x8C03;&#x7528;&#x63A5;&#x53E3;&#x7684;&#x65B9;&#x6CD5;&#x65F6;&#xFF0C;&#x4F1A;&#x53BB;&#x5BFB;&#x627E;&#x662F;&#x5426;&#x6709;&#x4E86;&#x505C;&#x7559;&#x5728;resources&#x4E2D;&#x7684;&#x672A;&#x5173;&#x95ED;&#x7684;sqlsession&#xFF09;</li>
</ul>
<pre><code>public class SqlSessionTemplate implements SqlSession, DisposableBean {
public SqlSessionTemplate(SqlSessionFactory sqlSessionFactory, ExecutorType executorType, PersistenceExceptionTranslator exceptionTranslator) {
    Assert.notNull(sqlSessionFactory, &quot;Property &apos;sqlSessionFactory&apos; is required&quot;);
    Assert.notNull(executorType, &quot;Property &apos;executorType&apos; is required&quot;);
    this.sqlSessionFactory = sqlSessionFactory;
    this.executorType = executorType;
    this.exceptionTranslator = exceptionTranslator;
    this.sqlSessionProxy = (SqlSession)Proxy.newProxyInstance(SqlSessionFactory.class.getClassLoader(), new Class[]{SqlSession.class}, new SqlSessionTemplate.SqlSessionInterceptor());
}



// &#x52A8;&#x6001;&#x4EE3;&#x7406;&#x4E2D;&#x7684; InvocationHandler&#x7C7B;&#xFF0C;&#x771F;&#x6B63;&#x5BF9;&#x65B9;&#x6CD5;&#x7684;&#x524D;&#x540E;&#x8FDB;&#x884C;&#x901A;&#x77E5;&#x7684;&#x7C7B;&#xFF0C;&#x4EE3;&#x7406;&#x7C7B;&#x5BF9;&#x8C61;&#x53EA;&#x662F;&#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x76EE;&#x6807;&#x5BF9;&#x8C61;&#x7684;&#x5C01;&#x88C5;&#x4EE5;&#x8C03;&#x7528;&#x800C;&#x5DF2;
 private class SqlSessionInterceptor implements InvocationHandler {
        private SqlSessionInterceptor() {
        }

        public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {

            //&#x67E5;&#x770B;&#x662F;&#x5426;&#x6709;&#x4E3A;&#x5173;&#x95ED;&#x7684;&#x95F2;&#x7F6E;&#x7684;&#x540C;&#x4E2A;&#x914D;&#x7F6E;&#x7684;sqlsession&#xFF0C;&#x6709;&#x5219;&#x8C03;&#x7528;&#xFF0C;&#x8FD9;&#x4E5F;&#x662F;&#x4F60;&#x7528;sqlsessionTemplate&#x4EE3;&#x7406;&#x6267;&#x884C;&#x589E;&#x5220;&#x67E5;&#x6539;&#x4E00;&#x76F4;&#x662F;&#x540C;&#x4E00;&#x4E2A;sqlsession&#x5B8C;&#x6210;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x7684;&#x539F;&#x56E0;&#xFF0C;&#x6CA1;&#x6709;&#x5219;&#x751F;&#x6210;&#x3002;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x662F;&#x7531;SqlSessionUtils&#x5B9E;&#x73B0;&#x7684;

    SqlSession sqlSession = SqlSessionUtils.getSqlSession(SqlSessionTemplate.this.sqlSessionFactory, SqlSessionTemplate.this.executorType, SqlSessionTemplate.this.exceptionTranslator);

            Object unwrapped;
            try {
                Object result = method.invoke(sqlSession, args);
                if (!SqlSessionUtils.isSqlSessionTransactional(sqlSession, SqlSessionTemplate.this.sqlSessionFactory)) {
                //&#x67E5;&#x8BE2;&#x8BE5;sqlsession&#x662F;&#x5426;&#x5728;Spring&#x4E8B;&#x52A1;&#x4E2D;&#xFF0C;&#x82E5;&#x662F;&#x5219;&#x6B65;&#x4E0D;&#x81EA;&#x52A8;&#x63D0;&#x4EA4;
                //&#x82E5;&#x662F;&#x81EA;&#x52A8;&#x5219;&#x4E3A;&#x4E00;&#x6761;sql&#x4E00;&#x6B21;commit&#xFF0C;&#x662F;&#x4E3A;&#x65B0;&#x624B;&#x8BBE;&#x7F6E;&#x7684;&#xFF0C;&#x4E00;&#x822C;&#x624B;&#x52A8;&#x63D0;&#x4EA4;&#x3002;
                    sqlSession.commit(true);
                }

                unwrapped = result;
            } catch (Throwable var11) {
                unwrapped = ExceptionUtil.unwrapThrowable(var11);
                if (SqlSessionTemplate.this.exceptionTranslator != null &amp;&amp; unwrapped instanceof PersistenceException) {
                    SqlSessionUtils.closeSqlSession(sqlSession, SqlSessionTemplate.this.sqlSessionFactory);
                    sqlSession = null;
                    Throwable translated = SqlSessionTemplate.this.exceptionTranslator.translateExceptionIfPossible((PersistenceException)unwrapped);
                    if (translated != null) {
                        unwrapped = translated;
                    }
                }

                throw (Throwable)unwrapped;
            } finally {

            //&#x5173;&#x95ED;sqlsession&#xFF0C;&#x540C;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#x53EF;&#x4EE5;&#x6709;&#x591A;&#x4E2A;sqlsession

                if (sqlSession != null) {
                    SqlSessionUtils.closeSqlSession(sqlSession, SqlSessionTemplate.this.sqlSessionFactory);
                }

            }

            return unwrapped;
        }
    }
}
</code></pre><h4 id="sqlsessionutils">SqlSessionUtils</h4>
<ul>
<li>&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E0B;SqlSessionUtils&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x8FD9;&#x91CC;&#x7684;sqlsession&#x7684;&#x521B;&#x5EFA;&#x9700;&#x8981;&#x6CE8;&#x610F;<strong>transactionFactory&#x662F;SpringManageTransactionFactory&#x3002;</strong></li>
</ul>
<pre><code>public final class SqlSessionUtils {
        public static SqlSession getSqlSession(SqlSessionFactory sessionFactory, ExecutorType executorType, PersistenceExceptionTranslator exceptionTranslator) {
        Assert.notNull(sessionFactory, &quot;No SqlSessionFactory specified&quot;);
        Assert.notNull(executorType, &quot;No ExecutorType specified&quot;);

        //&#x6709;&#x76F8;&#x5E94;&#x7684;sqlsessionHolder&#x5219;&#x53D6;&#x51FA;&#x91CC;&#x9762;&#x7684;SqlSession

        SqlSessionHolder holder = (SqlSessionHolder)TransactionSynchronizationManager.getResource(sessionFactory);
        SqlSession session = sessionHolder(executorType, holder);
        if (session != null) {
            return session;
        } else {
            if (LOGGER.isDebugEnabled()) {
                LOGGER.debug(&quot;Creating a new SqlSession&quot;);
            }

            //&#x6CA1;&#x6709;&#x5219;&#x7528;&#x5DE5;&#x5382;&#x521B;&#x5EFA;sqlsession&#xFF0C;&#x6CE8;&#x610F;&#xFF1A;&#x6B64;&#x65F6;&#x7684;sqlsessionfactory&#x662F;sqlsessionfactoryBean&#x521B;&#x5EFA;&#x7684;&#xFF0C;&#x5373;&#x4ED6;&#x7684;configuration&#x4E2D;&#x7684;Enviroment&#x4E2D;&#x7684;transactionFactory&#x662F;SpringManageTransactionFactory&#x3002;

            session = sessionFactory.openSession(executorType);

           // &#x6CE8;&#x518C;sqlsession&#x5230;TransactionSyncronizedMager&#xFF0C;


            registerSessionHolder(sessionFactory, executorType, exceptionTranslator, session);
            return session;
        }
    }
}
</code></pre><ul>
<li><p>&#x5173;&#x4E8E;SqlSessionUtils&#x4E2D;&#x7684;registerSessionHolder&#x65B9;&#x6CD5;&#xFF0C;&#x6CE8;&#x518C;sqlsession&#x5230;TransactionSyncronizedMager&#x4E2D;&#xFF0C;</p>
</li>
<li><p><strong>&#x5305;&#x542B;&#x4E24;&#x4E2A;&#x65B9;&#x6CD5;</strong></p>
<blockquote>
<p><strong>bindResource(sessionFactory, holder);
 registerSynchronization(new SqlSessionUtils.SqlSessionSynchronization(holder, sessionFactory))&#xFF1B;</strong></p>
</blockquote>
</li>
</ul>
<pre><code>private static void registerSessionHolder(SqlSessionFactory sessionFactory, ExecutorType executorType, PersistenceExceptionTranslator exceptionTranslator, SqlSession session) {
    if (TransactionSynchronizationManager.isSynchronizationActive()) {

        //&#x4ECE;sessionFactory&#x4E2D;&#x83B7;&#x53D6;Environment

        Environment environment = sessionFactory.getConfiguration().getEnvironment();

        //&#x5224;&#x65AD;environment&#x4E2D;&#x5C01;&#x88C5;&#x7684;TransactionFactorySpringManagedTransactionFactory&#xFF0C;&#x662F;&#x5426;&#x7528;&#x5230;&#x4E86;Spring&#x7684;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x670D;&#x52A1;&#xFF0C;sqlsession&#x4E2D;&#x5BF9;TransactionSyncronizedMager&#x7684;&#x5E94;&#x7528;&#x53EA;&#x6709;&#x4E0E;Spring&#x96C6;&#x6210;&#x65F6;&#x624D;&#x7528;&#x5230;&#xFF0C;mybatis&#x81EA;&#x8EAB;&#x7684;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x5E76;&#x4E0D;&#x4F1A;&#x7528;&#x5230;&#x3002;

        if (environment.getTransactionFactory() instanceof SpringManagedTransactionFactory) {
            if (LOGGER.isDebugEnabled()) {
                LOGGER.debug(&quot;Registering transaction synchronization for SqlSession [&quot; + session + &quot;]&quot;);
            }

            SqlSessionHolder holder = new SqlSessionHolder(session, executorType, exceptionTranslator);

            //&#x7ED1;&#x5B9A;&#x3001;&#x6CE8;&#x518C;&#x5230;TransactionSynchronizationManager
            TransactionSynchronizationManager.bindResource(sessionFactory, holder);
            TransactionSynchronizationManager.registerSynchronization(new SqlSessionUtils.SqlSessionSynchronization(holder, sessionFactory));

            holder.setSynchronizedWithTransaction(true);
            holder.requested();
        } else {
            if (TransactionSynchronizationManager.getResource(environment.getDataSource()) != null) {
                throw new TransientDataAccessResourceException(&quot;SqlSessionFactory must be using a SpringManagedTransactionFactory in order to use Spring transaction synchronization&quot;);
            }

            if (LOGGER.isDebugEnabled()) {
                LOGGER.debug(&quot;SqlSession [&quot; + session + &quot;] was not registered for synchronization because DataSource is not transactional&quot;);
            }
        }
    } else if (LOGGER.isDebugEnabled()) {
        LOGGER.debug(&quot;SqlSession [&quot; + session + &quot;] was not registered for synchronization because synchronization is not active&quot;);
    }

}
</code></pre><h4 id="sqlsessionsynchronization">SqlSessionSynchronization</h4>
<ul>
<li><p>&#x5176;&#x4E2D;SqlSessionSynchronization&#x662F;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#x751F;&#x547D;&#x5468;&#x671F;&#x7684;callback&#x63A5;&#x53E3;&#xFF0C;mybatis-spring&#x901A;&#x8FC7;SqlSessionSynchronization&#x5728;&#x4E8B;&#x52A1;&#x63D0;&#x4EA4;&#x548C;&#x56DE;&#x6EDA;&#x524D;&#x5206;&#x522B;&#x8C03;&#x7528;DefaultSqlSession.commit()&#x548C;DefaultSqlSession.rollback()</p>
<pre><code>private static final class SqlSessionSynchronization extends TransactionSynchronizationAdapter {
public void beforeCommit(boolean readOnly) {
            if (TransactionSynchronizationManager.isActualTransactionActive()) {
                try {
                    if (SqlSessionUtils.LOGGER.isDebugEnabled()) {
                        SqlSessionUtils.LOGGER.debug(&quot;Transaction synchronization committing SqlSession [&quot; + this.holder.getSqlSession() + &quot;]&quot;);
                    }

                    this.holder.getSqlSession().commit();
                } catch (PersistenceException var4) {
                    if (this.holder.getPersistenceExceptionTranslator() != null) {
                        DataAccessException translated = this.holder.getPersistenceExceptionTranslator().translateExceptionIfPossible(var4);
                        if (translated != null) {
                            throw translated;
                        }
                    }
                    throw var4;
                }
            }

        }

        public void beforeCompletion() {
            if (!this.holder.isOpen()) {
                if (SqlSessionUtils.LOGGER.isDebugEnabled()) {
                    SqlSessionUtils.LOGGER.debug(&quot;Transaction synchronization deregistering SqlSession [&quot; + this.holder.getSqlSession() + &quot;]&quot;);
                }

                TransactionSynchronizationManager.unbindResource(this.sessionFactory);
                this.holderActive = false;
                if (SqlSessionUtils.LOGGER.isDebugEnabled()) {
                    SqlSessionUtils.LOGGER.debug(&quot;Transaction synchronization closing SqlSession [&quot; + this.holder.getSqlSession() + &quot;]&quot;);
                }

                this.holder.getSqlSession().close();
            }

        }

        public void afterCompletion(int status) {
            if (this.holderActive) {
                if (SqlSessionUtils.LOGGER.isDebugEnabled()) {
                    SqlSessionUtils.LOGGER.debug(&quot;Transaction synchronization deregistering SqlSession [&quot; + this.holder.getSqlSession() + &quot;]&quot;);
                }

                TransactionSynchronizationManager.unbindResourceIfPossible(this.sessionFactory);
                this.holderActive = false;
                if (SqlSessionUtils.LOGGER.isDebugEnabled()) {
                    SqlSessionUtils.LOGGER.debug(&quot;Transaction synchronization closing SqlSession [&quot; + this.holder.getSqlSession() + &quot;]&quot;);
                }

                this.holder.getSqlSession().close();
            }

            this.holder.reset();
        }
</code></pre></li>
</ul>
<h4 id="datasourceutils&#x548C;springmanagedtransaction">datasourceUtils&#x548C;SpringManagedTransaction</h4>
<ul>
<li>&#x4E00;&#x756A;&#x5468;&#x6298;&#x7EC8;&#x4E8E;&#x62FF;&#x5230;&#x4E86;sqlsession&#x5230;&#x4E86;&#x4EE3;&#x7406;&#x7C7B;SqlsessionTemplate&#x4E2D;&#xFF0C;&#x63A5;&#x7740;&#x4FBF;&#x662F;&#x76EE;&#x6807;&#x4EE3;&#x7801;&#x672C;&#x8EAB;(sql&#x8BED;&#x53E5;)&#x7684;&#x6267;&#x884C;&#x4E86;</li>
<li>&#x5728;&#x6B64;&#x4E4B;&#x524D;&#x6211;&#x4EEC;&#x8C08;&#x53CA;&#x4E3A;&#x4F55;&#x8981;&#x4E13;&#x95E8;&#x7528;SpringManagedTransaction&#xFF0C;&#x73B0;&#x5728;&#x5C31;&#x8981;&#x63ED;&#x6653;&#x4E86;&#xFF0C;&#x4E4B;&#x524D;&#x6211;&#x4EEC;&#x521B;&#x5EFA;&#x4E86;sqlsession&#x5230;&#x4E86;SpringTemplate&#xFF0C;&#x4F46;&#x662F;&#x8FD8;&#x672A;&#x83B7;&#x53D6;connection&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x6267;&#x884C;&#x8BED;&#x53E5;&#x524D;&#x5C31;&#x8981;&#x83B7;&#x53D6;connection&#xFF0C;&#x6211;&#x4EEC;&#x7528;mybatis&#x7684;Executor&#x6267;&#x884C;&#x8BED;&#x53E5;&#xFF0C;&#x4F1A;&#x5728;prepareStatement&#x4E2D;&#x83B7;&#x5F97;connection</li>
</ul>
<pre><code>protected Connection getConnection(Log statementLog) throws SQLException {
    Connection connection = this.transaction.getConnection();
    return statementLog.isDebugEnabled() ? ConnectionLogger.newInstance(connection, statementLog, this.queryStack) : connection;
}
</code></pre><ul>
<li>&#x770B;&#x5230;&#x4E0A;&#x9762;&#x7684;transsaction&#x4FBF;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4E00;&#x4E2A;transaction&#x6765;&#x5B9E;&#x73B0;&#x8FDE;&#x63A5;&#x7684;&#x83B7;&#x53D6;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x7684;&#x8FDE;&#x63A5;&#x662F;&#x4E4B;&#x524D;&#x7ED1;&#x5B9A;&#x5230;&#x4E86;ThreadLocal&#x4E2D;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;Spring&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x7684;&#x5173;&#x952E;&#x8981;&#x8BA9;&#x6B64;&#x65F6;Thread&#x4E2D;&#x7684;connection&#x7528;&#x4E0A;&#xFF0C;&#x8FD9;&#x65F6;&#x5019;&#x6211;&#x4EEC;&#x5C31;&#x9700;&#x8981;&#x7528;&#x5230;DataSourceUtils&#x6765;&#x83B7;&#x53D6;&#x4E86;    </li>
</ul>
<ul>
<li><strong>datasourceUtils:&#x4E5F;&#x662F;&#x4ECE;TransactionSynchronizationManager&#x83B7;&#x53D6;connection</strong></li>
</ul>
<ul>
<li><p>SqlSessionUtils&#x4ECE;TransactionSynchronizationManager&#x83B7;&#x53D6;ConnectionHolder&#x4EA4;&#x7ED9;SpringManagedTransaction&#xFF0C;&#x5E76;&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#x5C01;&#x88C5;&#x8FDB;Executor&#xFF0C;&#x6700;&#x540E;&#x5C01;&#x88C5;&#x8FDB;DefaultSqlSession&#xFF0C;<strong>&#x5C06;Spring&#x7684;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x4E0E;&#x5B83;&#x7684;&#x6570;&#x636E;&#x8BBF;&#x95EE;&#x6846;&#x67B6;&#x662F;&#x7D27;&#x5BC6;&#x7ED3;&#x5408;&#x7684;</strong></p>
</li>
<li><p><strong>SpringManagedTransaction&#x4E2D;&#x4FDD;&#x7559;&#x7531;datasource&#x7B49;&#x4FE1;&#x606F;&#xFF0C;&#x800C;&#x4E14;&#x5B83;&#x7279;&#x522B;&#x5B9E;&#x73B0;&#x4E86;&#x5BF9;SqlSessionUtils&#x7684;&#x8C03;&#x7528;&#xFF08;&#x5176;&#x4ED6;&#x7684;jdbcTransaction&#x548C;managedTransaction&#x90FD;&#x6CA1;&#x6709;&#x5BF9;SqlSessionUtils&#x8C03;&#x7528;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x4E24;&#x8005;&#x53EA;&#x9002;&#x7528;&#x4E8E;mybaitis&#x81EA;&#x8EAB;&#x4E8B;&#x52A1;&#x60C5;&#x51B5;&#xFF0C;&#x4E0D;&#x9002;&#x7528;&#x4E8E;&#x96C6;&#x6210;&#xFF09;</strong></p>
</li>
<li><p><strong>&#x5E76;&#x4E14;&#x53EF;&#x4EE5;&#x7528;&#x6765;&#x7ED9;datasourceUtils&#x63D0;&#x4F9B;&#x53C2;&#x6570;&#xFF0C;&#x8BA9;&#x5176;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4ECE;TransactionSynchronizationManager&#x4E2D;&#x8C03;&#x7528;&#x76F8;&#x5E94;&#x7684;connection&#xFF0C;&#x56E0;&#x4E3A;&#x662F;&#x540C;&#x4E00;&#x7EBF;&#x7A0B;&#x4E14;&#x4E8B;&#x52A1;&#x6CA1;&#x7ED3;&#x675F;&#x6240;&#x4EE5;&#x80FD;&#x4FDD;&#x8BC1;&#x662F;&#x540C;&#x4E00;&#x4E2A;&#x4E86;</strong></p>
</li>
</ul>
<ul>
<li>SpringManagedTransaction&#x7684;&#x610F;&#x4E49;&#x4FBF;&#x5728;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;&#x7684;&#x95EE;&#x9898;&#x4E5F;&#x5C31;&#x89E3;&#x51B3;&#x4E86;&#xFF0C;&#x6700;&#x540E;&#x4FBF;&#x662F;jdbc.connection&#x7684;excute&#x64CD;&#x4F5C;&#x4E86;</li>
</ul>
<blockquote>
<pre><code>public abstract class DataSourceUtils {
public static Connection doGetConnection(DataSource dataSource) throws SQLException {
Assert.notNull(dataSource, &quot;No DataSource specified&quot;);

ConnectionHolder conHolder = (ConnectionHolder) TransactionSynchronizationManager.getResource(dataSource);
if (conHolder != null &amp;&amp; (conHolder.hasConnection() || conHolder.isSynchronizedWithTransaction())) {
   conHolder.requested();
   if (!conHolder.hasConnection()) {
      logger.debug(&quot;Fetching resumed JDBC Connection from DataSource&quot;);
      conHolder.setConnection(fetchConnection(dataSource));
   }
   return conHolder.getConnection();
}
// Else we either got no holder or an empty thread-bound holder here.

logger.debug(&quot;Fetching JDBC Connection from DataSource&quot;);
Connection con = fetchConnection(dataSource);

if (TransactionSynchronizationManager.isSynchronizationActive()) {
   logger.debug(&quot;Registering transaction synchronization for JDBC Connection&quot;);
   // Use same Connection for further JDBC actions within the transaction.
   // Thread-bound object will get removed by synchronization at transaction completion.
   ConnectionHolder holderToUse = conHolder;
   if (holderToUse == null) {
      holderToUse = new ConnectionHolder(con);
   }
   else {
      holderToUse.setConnection(con);
   }
   holderToUse.requested();
   TransactionSynchronizationManager.registerSynchronization(
         new ConnectionSynchronization(holderToUse, dataSource));
   holderToUse.setSynchronizedWithTransaction(true);
   if (holderToUse != conHolder) {
      TransactionSynchronizationManager.bindResource(dataSource, holderToUse);
   }
}
return con;
}
</code></pre></blockquote>
<ul>
<li>&#x53EF;&#x4EE5;&#x770B;&#x5230;<strong>mybatis-spring&#x5904;&#x7406;&#x4E8B;&#x52A1;&#x7684;&#x4E3B;&#x8981;&#x6D41;&#x7A0B;&#x548C;spring jdbc&#x5904;&#x7406;&#x4E8B;&#x52A1;&#x5E76;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x533A;&#x522B;&#xFF0C;</strong>&#x90FD;&#x662F;&#x901A;&#x8FC7;DataSourceTransactionManager&#x7684;getTransaction(), rollback(), commit()&#x5B8C;&#x6210;&#x4E8B;&#x52A1;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x7BA1;&#x7406;&#xFF0C;&#x800C;&#x4E14;jdbc connection&#x7684;&#x521B;&#x5EFA;&#x4E5F;&#x662F;&#x901A;&#x8FC7;DataSourceTransactionManager.getTransaction()&#x5B8C;&#x6210;&#xFF0C;mybatis&#x5E76;&#x6CA1;&#x6709;&#x53C2;&#x4E0E;&#x5176;&#x4E2D;&#xFF0C;mybatis&#x53EA;&#x662F;&#x5728;&#x6267;&#x884C;sql&#x65F6;&#x901A;&#x8FC7;DataSourceUtils.getConnection()&#x83B7;&#x5F97;&#x5F53;&#x524D;thread&#x7684;jdbc connection&#xFF0C;&#x7136;&#x540E;&#x5728;&#x5176;&#x4E0A;&#x6267;&#x884C;sql&#x3002;</li>
</ul>
<h4 id="commit">commit</h4>
<ul>
<li><strong>&#x6700;&#x540E;&#x5199;&#x4E00;&#x4E0B;commit&#x7684;&#x6D41;&#x7A0B;</strong>&#xFF08;rollback&#x5B9E;&#x73B0;&#x5DEE;&#x4E0D;&#x591A;&#xFF0C;&#x56DE;&#x5230;&#x4FDD;&#x5B58;&#x7684;&#x56DE;&#x8C03;&#x70B9;&#x800C;&#x5DF2;&#xFF09;</li>
</ul>
<ul>
<li>&#x8C03;&#x7528;DataSourceTransactionManager&#x7684;&#x7236;&#x7C7B;AbstractPlatformTransactionManager&#x7684;commit</li>
</ul>
<pre><code>public abstract class AbstractPlatformTransactionManager implements PlatformTransactionManager, Serializable {

 public final void commit(TransactionStatus status) throws TransactionException {
     &#xB7;&#xB7;&#xB7;
     status &#x662F;&#x5426;&#x5DF2;&#x5B8C;&#x6210;&#x6216;&#x662F;&#x5426;&#x9700;&#x8981;rollback
    &#xB7;&#xB7;&#xB7;    
        //&#x6B63;&#x5E38;&#x6D41;&#x7A0B;&#x4F1A;&#x8C03;&#x7528;processCommit         
            this.processCommit(defStatus);
        }   
        }
        }
  }
&#x200B;
</code></pre><pre><code>

</code></pre><p>private void processCommit(DefaultTransactionStatus status) throws TransactionException {
    try {
        boolean beforeCompletionInvoked = false;</p>
<pre><code>    try {
        boolean unexpectedRollback = false;         
        //commit&#x51C6;&#x5907;      
        this.prepareForCommit(status);

        //BeforeCommit&#xFF1A;commit&#x524D;&#x5BF9;springTransaciton&#x3001;sqlsession&#x7684;commit&#xFF0C;&#x5927;&#x90E8;&#x5206;&#x672A;&#x5B9E;&#x73B0;&#x8FD9;&#x4E2A;&#x7684;&#x529F;&#x80FD;

        this.triggerBeforeCommit(status);

        //BeforeCompletion&#xFF1A;Complete&#x524D;&#x5BF9;springTransaciton&#x3001;sqlsession&#x7684;commit

        this.triggerBeforeCompletion(status);
        beforeCompletionInvoked = true;
        &#xB7;&#xB7;&#xB7;
        &#x662F;&#x5426;&#x6709;&#x8BB0;&#x5F55;&#x56DE;&#x8C03;&#x70B9;/&#x662F;&#x5426;&#x9700;&#x8981;&#x56DE;&#x8C03;
        &#xB7;&#xB7;&#xB7;
        // &#x5728;DataSourceTransactionManager&#x4E2D;&#x5B9E;&#x73B0;&#x5BF9;connection&#x7684;commit
        this.doCommit(status);

        &#xB7;&#xB7;&#xB7;          
       &#x5F02;&#x5E38;&#x5904;&#x7406;
        &#xB7;&#xB7;&#xB7;

    try {

        //&#x5BF9;TransactionSynchronizationManager&#x4E2D;&#x7684;synchronizations&#x7528;Iterator&#x8BA1;&#x6570;&#x5668;&#x904D;&#x5386;&#x5220;&#x9664;
        this.triggerAfterCommit(status);

    } finally {

    // &#x82E5;&#x4E0A;&#x4E00;&#x6B65;&#x6CA1;&#x6E05;&#x7406;&#x5B8C;&#x6210;&#xFF0C;&#x5219;&#x518D;&#x6B21;&#x6E05;&#x7406;&#x4E00;&#x6B21;&#xFF0C;&#x7528;synchronizations&#x7528;Iterator&#x8BA1;&#x6570;&#x5668;&#x904D;&#x5386;&#x5220;&#x9664;
        this.triggerAfterCompletion(status, 0);

    }
} finally {

    // &#x6E05;&#x7A7A;TransactionSynchronizationManager&#xFF0C;&#x82E5;&#x6709;&#x6302;&#x8D77;&#x7684;&#x4E8B;&#x52A1;&#xFF0C;&#x5219;&#x6062;&#x590D;&#x6267;&#x884C;
    this.cleanupAfterCompletion(status);
}
</code></pre><p>}</p>
<pre><code>

</code></pre><p>// &#x6E05;&#x7A7A;TransactionSynchronizationManager&#xFF0C;&#x82E5;&#x6709;&#x6302;&#x8D77;&#x7684;&#x4E8B;&#x52A1;&#xFF0C;&#x5219;&#x6062;&#x590D;&#x6267;&#x884C;&#xFF0C;&#x8FD9;&#x548C;definiton&#x8BBE;&#x7F6E;&#x7684;&#x4E8B;&#x52A1;&#x7EA7;&#x522B;&#x6709;&#x5173;
private void cleanupAfterCompletion(DefaultTransactionStatus status) {
        status.setCompleted();
        if (status.isNewSynchronization()) {
            TransactionSynchronizationManager.clear();
        }</p>
<pre><code>    if (status.isNewTransaction()) {
        this.doCleanupAfterCompletion(status.getTransaction());
    }

    if (status.getSuspendedResources() != null) {
        if (status.isDebug()) {
            this.logger.debug(&quot;Resuming suspended transaction after completion of inner transaction&quot;);
        }

        Object transaction = status.hasTransaction() ? status.getTransaction() : null;

        //SuspendedResourcesHolder&#x7528;&#x9759;&#x6001;&#x65B9;&#x6CD5;&#x653E;&#x7F6E;&#x5728;JVM&#x7684;&#x65B9;&#x6CD5;&#x533A;&#xFF0C;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x8C03;&#x7528;

        this.resume(transaction, (AbstractPlatformTransactionManager.SuspendedResourcesHolder)status.getSuspendedResources());
    }
</code></pre><p>```</p>
<ul>
<li>&#x8FD9;&#x4FBF;&#x662F;&#x6574;&#x4E2A;spring&#x4E0E;mybatis&#x96C6;&#x6210;&#x7684;&#x4E8B;&#x52A1;&#x63A7;&#x5236;&#x4E86;&#x3002;</li>
</ul>
</user></user></user></user></role></role></role></account></account></account></e></e></e></e>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Mybatis","level":"1.5","depth":1,"next":{"title":"MybatisPlus.Assets","level":"1.6","depth":1,"ref":"","articles":[]},"previous":{"title":"Mybatis.Assets","level":"1.4","depth":1,"ref":"","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["summary"],"pluginsConfig":{"summary":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"数据库/mybatis.md","mtime":"2021-04-20T16:29:42.126Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2021-08-07T08:00:57.642Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

